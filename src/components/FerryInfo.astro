---
// Ferry schedule for Starnberger See - Saison 2026
// Dynamic display showing next departures from Possenhofen
// Source: seenschifffahrt.de
---

<div class="ferry-widget">
  <div class="ferry-header">
    <div class="ferry-title">
      <svg class="ferry-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/>
        <path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.94 5.34 2.81 7.76"/>
        <path d="M19 13V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v6"/>
        <path d="M12 10v4"/>
        <path d="M12 2v3"/>
      </svg>
      <span>Schiff Possenhofen</span>
    </div>
    <a href="https://www.seenschifffahrt.de/de/starnberger-see/fahrplan/fahrplan/" target="_blank" class="ferry-link">
      Fahrplan
      <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
        <polyline points="15 3 21 3 21 9"></polyline>
        <line x1="10" y1="14" x2="21" y2="3"></line>
      </svg>
    </a>
  </div>
  <div class="ferry-body" id="ferry-table">
    <div class="ferry-loading">
      <span class="spinner"></span>
      Fahrplan laden...
    </div>
  </div>
</div>

<style>
  .ferry-widget {
    background: var(--color-card);
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1px solid var(--color-border-light);
    transition: all 0.2s ease;
  }

  .ferry-widget:hover {
    box-shadow: var(--shadow-md);
  }

  .ferry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #0369a1;
    color: white;
  }

  .ferry-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .ferry-logo {
    width: 22px;
    height: 22px;
    stroke: white;
  }

  .icon-sm {
    width: 14px;
    height: 14px;
  }

  .ferry-link {
    color: white;
    opacity: 0.9;
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: rgba(255,255,255,0.15);
    border-radius: var(--radius-full);
    transition: all 0.2s;
  }

  .ferry-link:hover {
    opacity: 1;
    background: rgba(255,255,255,0.25);
    text-decoration: none;
  }

  .ferry-body {
    min-height: 100px;
  }

  .ferry-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 32px;
    color: var(--color-muted);
    font-size: 0.9rem;
  }

  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid var(--color-border);
    border-top-color: #0369a1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  // Hauptsaison schedule from Possenhofen (01.05. - 04.10.2026)
  // Times extracted from official PDF
  const schedule = [
    { time: "10:50", dest: "Tutzing", arrival: "11:14", dir: "süd" },
    { time: "11:30", dest: "Starnberg", arrival: "12:05", dir: "nord" },
    { time: "12:10", dest: "Tutzing", arrival: "12:34", dir: "süd" },
    { time: "13:55", dest: "Tutzing", arrival: "14:19", dir: "süd" },
    { time: "14:25", dest: "Starnberg", arrival: "15:00", dir: "nord" },
    { time: "15:05", dest: "Tutzing", arrival: "15:29", dir: "süd" },
    { time: "15:35", dest: "Starnberg", arrival: "16:10", dir: "nord" },
    { time: "16:30", dest: "Starnberg", arrival: "17:05", dir: "nord" },
    { time: "17:50", dest: "Starnberg", arrival: "18:25", dir: "nord" },
  ];

  // Check if we're in season (rough check)
  function isInSeason(): boolean {
    const now = new Date();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    // Saison: 05.04. - 18.10.
    if (month < 4 || month > 10) return false;
    if (month === 4 && day < 5) return false;
    if (month === 10 && day > 18) return false;
    return true;
  }

  function getNextDepartures(): typeof schedule {
    const now = new Date();
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    
    // Find departures that haven't left yet
    const upcoming = schedule.filter(dep => {
      const [h, m] = dep.time.split(':').map(Number);
      return h * 60 + m > currentMinutes;
    });
    
    // If no more today, show first departures of tomorrow
    if (upcoming.length === 0) {
      return schedule.slice(0, 4);
    }
    
    return upcoming.slice(0, 4);
  }

  function getMinutesUntil(timeStr: string): number {
    const now = new Date();
    const [h, m] = timeStr.split(':').map(Number);
    const depMinutes = h * 60 + m;
    const nowMinutes = now.getHours() * 60 + now.getMinutes();
    return depMinutes - nowMinutes;
  }

  function render(): void {
    const container = document.getElementById('ferry-table');
    if (!container) return;

    const inSeason = isInSeason();
    
    if (!inSeason) {
      container.innerHTML = `
        <div style="padding:24px;text-align:center;color:var(--color-text-secondary)">
          <p style="font-weight:600;margin-bottom:8px">Winterpause</p>
          <p style="font-size:0.85rem;opacity:0.8;margin-bottom:12px">Saison 2026: 05.04. – 18.10.</p>
          <a href="https://www.seenschifffahrt.de" target="_blank" style="color:#0369a1;font-weight:500;font-size:0.85rem">
            → seenschifffahrt.de
          </a>
        </div>
      `;
      return;
    }

    const departures = getNextDepartures();
    const isNextDay = getMinutesUntil(departures[0]?.time || "10:00") < 0;

    let html = `
      <div style="padding:8px 16px;background:var(--color-bg);border-bottom:1px solid var(--color-border);font-size:0.75rem;color:var(--color-muted);display:flex;justify-content:space-between;align-items:center">
        <span>Saison 2026 · 05.04.–18.10.</span>
        ${isNextDay ? '<span style="color:var(--color-text-secondary)">Morgen</span>' : ''}
      </div>
      <div style="display:grid;grid-template-columns:auto auto 1fr auto auto;gap:0 12px;font-size:0.85rem">
        <div style="grid-column:1/-1;display:grid;grid-template-columns:subgrid;padding:8px 16px;background:var(--color-bg);border-bottom:1px solid var(--color-border);font-size:0.7rem;font-weight:600;color:var(--color-muted);text-transform:uppercase;letter-spacing:0.3px">
          <span>Zeit</span>
          <span></span>
          <span>Richtung</span>
          <span>Ankunft</span>
          <span></span>
        </div>
    `;

    departures.forEach((dep, i) => {
      const minutesUntil = getMinutesUntil(dep.time);
      const isNext = i === 0 && minutesUntil > 0 && minutesUntil <= 60;
      const bg = i % 2 === 0 ? 'var(--color-card)' : 'var(--color-bg)';
      const dirColor = dep.dir === 'süd' ? '#0284c7' : '#16a34a';
      const dirArrow = dep.dir === 'süd' ? '↓' : '↑';
      
      const countdown = minutesUntil > 0 && minutesUntil <= 60 
        ? `<span style="background:${isNext ? '#16a34a' : 'var(--color-bg)'};color:${isNext ? 'white' : 'var(--color-text-secondary)'};padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:600">${minutesUntil} min</span>`
        : '';

      html += `
        <div style="grid-column:1/-1;display:grid;grid-template-columns:subgrid;padding:10px 16px;background:${bg};align-items:center;border-bottom:1px solid var(--color-border)">
          <span style="font-weight:600;color:var(--color-primary)">${dep.time}</span>
          <span style="color:${dirColor};font-weight:600">${dirArrow}</span>
          <span style="font-weight:500;color:var(--color-text)">${dep.dest}</span>
          <span style="font-size:0.75rem;color:var(--color-text-secondary)">an ${dep.arrival}</span>
          ${countdown}
        </div>
      `;
    });

    html += `</div>
      <div style="padding:10px 16px;background:var(--color-bg);border-top:1px solid var(--color-border);font-size:0.75rem;color:var(--color-muted);display:flex;gap:8px;align-items:center">
        <a href="tel:+4981518061" style="color:#0369a1;font-weight:500">08151 8061</a>
        <span>•</span>
        <span style="font-style:italic">Bei Nebel/Sturm: Ausfälle möglich</span>
      </div>
    `;
    
    container.innerHTML = html;
  }

  document.addEventListener('DOMContentLoaded', () => {
    render();
    // Update every minute for countdown
    setInterval(render, 60000);
  });
</script>
