---
// EventModal.astro - Mobile-optimized bottom sheet modal for event details
---

<!-- Modal Backdrop -->
<div class="event-modal-backdrop" id="event-modal-backdrop"></div>

<!-- Modal Container -->
<div class="event-modal" id="event-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal-content">
    <!-- Drag Handle (mobile only) -->
    <div class="modal-drag-handle" id="modal-drag-handle">
      <div class="drag-indicator"></div>
    </div>

    <!-- Close Button -->
    <button class="modal-close" id="modal-close" aria-label="Modal schlie√üen">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    <!-- Scrollable area: header + body together -->
    <div class="modal-scroll" id="modal-scroll">
      <!-- Modal Header -->
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title"></h2>
        <div class="modal-category"></div>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div class="modal-datetime">
          <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <span class="modal-datetime-text"></span>
        </div>

        <div class="modal-location">
          <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle>
          </svg>
          <span class="modal-location-text"></span>
        </div>

        <!-- Map with touch-through overlay to prevent scroll hijacking -->
        <div class="modal-map-wrapper" id="modal-map-wrapper">
          <div class="modal-map" id="modal-map"></div>
          <div class="modal-map-overlay" id="modal-map-overlay">
            <span class="map-overlay-label">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              Karte antippen zum Interagieren
            </span>
          </div>
        </div>

        <!-- AI Curation Section -->
        <div class="modal-ai-curation" id="modal-ai-curation" style="display:none;">
          <div class="ai-curation-header">
            <span class="ai-curation-label">‚ú® KI-Bewertung</span>
          </div>
          <p class="ai-curation-summary" id="ai-summary-text"></p>
          <div class="ai-scores-grid" id="ai-scores-grid">
            <div class="ai-score-item">
              <span class="ai-score-emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
              <span class="ai-score-label">Familien</span>
              <div class="ai-score-bar"><div class="ai-score-fill" id="ai-score-family"></div></div>
            </div>
            <div class="ai-score-item">
              <span class="ai-score-emoji">üßí</span>
              <span class="ai-score-label">Kinder</span>
              <div class="ai-score-bar"><div class="ai-score-fill" id="ai-score-kids"></div></div>
            </div>
            <div class="ai-score-item">
              <span class="ai-score-emoji">üë´</span>
              <span class="ai-score-label">Erwachsene</span>
              <div class="ai-score-bar"><div class="ai-score-fill" id="ai-score-adults"></div></div>
            </div>
          </div>
          <div class="ai-details" id="ai-details">
            <div class="ai-detail-row" id="ai-age-row">
              <span class="ai-detail-icon">üéÇ</span>
              <span class="ai-detail-text" id="ai-age-text"></span>
            </div>
            <div class="ai-detail-row" id="ai-price-row">
              <span class="ai-detail-icon">üí∞</span>
              <span class="ai-detail-text" id="ai-price-text"></span>
            </div>
            <div class="ai-detail-row" id="ai-tips-row">
              <span class="ai-detail-icon">üí°</span>
              <span class="ai-detail-text" id="ai-tips-text"></span>
            </div>
          </div>
        </div>

        <!-- Description -->
        <div class="modal-description" id="modal-description"></div>

        <!-- Tags -->
        <div class="modal-tags" id="modal-tags"></div>
      </div>
    </div>

    <!-- Modal Footer (always visible at bottom) -->
    <div class="modal-footer">
      <button class="modal-btn modal-btn-icon" id="modal-download-ics" aria-label="In Kalender speichern" title="In Kalender speichern">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
      </button>
      <button class="modal-btn modal-btn-share" id="modal-share-btn" aria-label="Event teilen" title="Event teilen">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
          <polyline points="16 6 12 2 8 6"></polyline>
          <line x1="12" y1="2" x2="12" y2="15"></line>
        </svg>
        Teilen
      </button>
      <a class="modal-btn modal-btn-primary" id="modal-external-link" target="_blank" rel="noopener">
        Event-Seite
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
      </a>
    </div>

    <!-- Share toast notification -->
    <div class="share-toast" id="share-toast">Link kopiert!</div>
  </div>
</div>

<style>
  /* === BACKDROP === */
  .event-modal-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 400;
    opacity: 0;
    transition: opacity 0.25s ease;
    touch-action: none;
  }

  .event-modal-backdrop.visible {
    display: block;
    opacity: 1;
  }

  /* === MODAL (Mobile-first: bottom sheet) === */
  .event-modal {
    display: none;
    position: fixed;
    z-index: 401;
    bottom: 0;
    left: 0;
    right: 0;
    max-height: 75vh;
    background: var(--color-card);
    border-radius: 16px 16px 0 0;
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.25);
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    overflow: hidden;
    /* Prevent overscroll bounce from leaking to body */
    overscroll-behavior: contain;
  }

  .event-modal.visible {
    display: flex;
    flex-direction: column;
    transform: translateY(0);
  }

  /* Swipe-dismiss transition */
  .event-modal.dragging {
    transition: none;
  }

  /* Desktop: centered dialog */
  @media (min-width: 768px) {
    .event-modal {
      top: 50%;
      left: 50%;
      right: auto;
      bottom: auto;
      transform: translate(-50%, -50%) scale(0.95);
      opacity: 0;
      max-width: 560px;
      width: 90%;
      max-height: 80vh;
      border-radius: 16px;
    }

    .event-modal.visible {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
  }

  /* === MODAL CONTENT === */
  .modal-content {
    display: flex;
    flex-direction: column;
    min-height: 0;
    max-height: 75vh;
    flex: 1;
  }

  @media (min-width: 768px) {
    .modal-content {
      max-height: 80vh;
    }
  }

  /* === DRAG HANDLE === */
  .modal-drag-handle {
    display: flex;
    justify-content: center;
    padding: 12px 0 4px;
    flex-shrink: 0;
    cursor: grab;
    touch-action: none;
  }

  .modal-drag-handle:active {
    cursor: grabbing;
  }

  .drag-indicator {
    width: 36px;
    height: 4px;
    border-radius: 2px;
    background: var(--color-border);
    opacity: 0.6;
  }

  @media (min-width: 768px) {
    .modal-drag-handle {
      display: none;
    }
  }

  /* === CLOSE BUTTON === */
  .modal-close {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-secondary);
    border: none;
    border-radius: 50%;
    color: var(--color-text);
    cursor: pointer;
    z-index: 10;
    transition: background 0.15s ease, transform 0.15s ease;
  }

  .modal-close:hover {
    background: var(--color-border);
    transform: scale(1.05);
  }

  .modal-close svg {
    width: 18px;
    height: 18px;
  }

  /* === SCROLLABLE AREA === */
  .modal-scroll {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior-y: contain;
    touch-action: pan-y;
    scrollbar-width: thin;
    scrollbar-color: var(--color-border) transparent;
  }

  .modal-scroll::-webkit-scrollbar {
    width: 4px;
  }

  .modal-scroll::-webkit-scrollbar-track {
    background: transparent;
  }

  .modal-scroll::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
  }

  /* === HEADER (inside scroll) === */
  .modal-header {
    padding: 8px 20px 16px;
    padding-right: 56px; /* space for close btn */
  }

  @media (min-width: 768px) {
    .modal-header {
      padding: 20px 24px 16px;
      padding-right: 60px;
    }
  }

  .modal-title {
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1.3;
    color: var(--color-text);
    margin-bottom: 8px;
  }

  @media (min-width: 768px) {
    .modal-title {
      font-size: 1.5rem;
    }
  }

  .modal-category {
    display: inline-flex;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 3px 10px;
    border-radius: var(--radius-sm);
  }

  .modal-category[data-cat="kinder"] {
    background: color-mix(in srgb, var(--color-kinder) 12%, transparent);
    color: var(--color-kinder);
  }

  .modal-category[data-cat="familie"] {
    background: color-mix(in srgb, var(--color-familie) 12%, transparent);
    color: var(--color-familie);
  }

  .modal-category[data-cat="erwachsene"] {
    background: color-mix(in srgb, var(--color-erwachsene) 12%, transparent);
    color: var(--color-erwachsene);
  }

  /* === BODY (inside scroll) === */
  .modal-body {
    padding: 0 20px 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  @media (min-width: 768px) {
    .modal-body {
      padding: 0 24px 24px;
      gap: 20px;
    }
  }

  .modal-datetime,
  .modal-location {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .modal-icon {
    width: 18px;
    height: 18px;
    color: var(--color-primary);
    flex-shrink: 0;
  }

  .modal-datetime-text,
  .modal-location-text {
    font-size: 0.875rem;
    color: var(--color-text);
    font-weight: 500;
  }

  /* === MAP (with overlay to prevent scroll hijacking) === */
  .modal-map-wrapper {
    position: relative;
    width: 100%;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--color-border-light);
  }

  .modal-map {
    width: 100%;
    aspect-ratio: 2 / 1;
    background: var(--color-bg-secondary);
  }

  .modal-map iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  /* Overlay prevents iframe from stealing touch ‚Äî user taps to activate */
  .modal-map-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 10px;
    cursor: pointer;
    background: transparent;
    transition: background 0.2s ease;
  }

  .modal-map-overlay:active {
    background: rgba(0, 0, 0, 0.05);
  }

  .map-overlay-label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    background: rgba(255, 255, 255, 0.92);
    padding: 5px 12px;
    border-radius: 20px;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
    pointer-events: none;
  }

  .modal-map-overlay.hidden {
    display: none;
  }

  /* === AI CURATION === */
  .modal-ai-curation {
    background: var(--color-bg-secondary);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .ai-curation-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .ai-curation-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .ai-curation-summary {
    font-size: 0.8125rem;
    line-height: 1.5;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .ai-scores-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .ai-score-item {
    display: grid;
    grid-template-columns: 24px 80px 1fr;
    align-items: center;
    gap: 8px;
  }

  .ai-score-emoji {
    font-size: 0.875rem;
    text-align: center;
  }

  .ai-score-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .ai-score-bar {
    height: 6px;
    background: var(--color-border-light);
    border-radius: 3px;
    overflow: hidden;
  }

  .ai-score-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.5s ease;
    background: var(--color-primary);
  }

  .ai-score-fill[data-score="0"],
  .ai-score-fill[data-score="1"],
  .ai-score-fill[data-score="2"] { background: #ef4444; }
  .ai-score-fill[data-score="3"],
  .ai-score-fill[data-score="4"] { background: #f97316; }
  .ai-score-fill[data-score="5"],
  .ai-score-fill[data-score="6"] { background: #eab308; }
  .ai-score-fill[data-score="7"],
  .ai-score-fill[data-score="8"] { background: #22c55e; }
  .ai-score-fill[data-score="9"],
  .ai-score-fill[data-score="10"] { background: #10b981; }

  .ai-details {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .ai-detail-row {
    display: flex;
    align-items: start;
    gap: 8px;
  }

  .ai-detail-icon {
    font-size: 0.8125rem;
    flex-shrink: 0;
    width: 20px;
    text-align: center;
  }

  .ai-detail-text {
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--color-text-secondary);
  }

  .modal-description {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
  }

  .modal-description:empty {
    display: none;
  }

  .modal-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .modal-tags:empty {
    display: none;
  }

  .modal-tag {
    display: inline-flex;
    align-items: center;
    padding: 3px 10px;
    background: var(--color-bg-secondary);
    border-radius: 20px;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  /* === FOOTER (sticky at bottom) === */
  .modal-footer {
    padding: 12px 20px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
    border-top: 1px solid var(--color-border-light);
    display: flex;
    gap: 10px;
    flex-shrink: 0;
    background: var(--color-card);
  }

  @media (min-width: 768px) {
    .modal-footer {
      padding: 16px 24px;
    }
  }

  .modal-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    text-decoration: none;
    min-height: 44px;
  }

  .modal-btn svg {
    width: 16px;
    height: 16px;
  }

  .modal-btn-primary {
    background: var(--color-primary);
    color: white;
    border: none;
    flex: 1;
  }

  .modal-btn-primary:hover {
    filter: brightness(0.9);
    transform: translateY(-1px);
  }

  .modal-btn-icon {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    flex: 0 0 auto;
    padding: 12px;
  }

  .modal-btn-icon:hover {
    background: var(--color-border);
  }

  .modal-btn-share {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
    flex: 1;
  }

  .modal-btn-share:hover {
    background: var(--color-border);
  }

  .modal-btn-share:active {
    transform: scale(0.97);
  }

  /* === SHARE TOAST === */
  .share-toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--color-text);
    color: var(--color-card);
    padding: 10px 20px;
    border-radius: 10px;
    font-size: 0.875rem;
    font-weight: 600;
    z-index: 500;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease, transform 0.2s ease;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  }

  .share-toast.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
</style>

<script>
  // Modal state
  let currentEventData: any = null;

  const modal = document.getElementById('event-modal');
  const backdrop = document.getElementById('event-modal-backdrop');
  const closeBtn = document.getElementById('modal-close');
  const downloadIcsBtn = document.getElementById('modal-download-ics');
  const dragHandle = document.getElementById('modal-drag-handle');
  const modalScroll = document.getElementById('modal-scroll');
  const mapOverlay = document.getElementById('modal-map-overlay');
  const shareBtn = document.getElementById('modal-share-btn');
  const shareToast = document.getElementById('share-toast');

  // ‚îÄ‚îÄ‚îÄ Map overlay: tap to activate iframe interaction ‚îÄ‚îÄ‚îÄ
  mapOverlay?.addEventListener('click', () => {
    mapOverlay.classList.add('hidden');
  });

  // Re-enable overlay when modal closes (handled in closeEventModal)

  // ‚îÄ‚îÄ‚îÄ Swipe-to-dismiss ‚îÄ‚îÄ‚îÄ
  let dragStartY = 0;
  let dragCurrentY = 0;
  let isDragging = false;

  function onDragStart(e: TouchEvent) {
    // Only allow drag from handle area or when scroll is at top
    const touch = e.touches[0];
    dragStartY = touch.clientY;
    dragCurrentY = touch.clientY;
    isDragging = true;
    modal?.classList.add('dragging');
  }

  function onDragMove(e: TouchEvent) {
    if (!isDragging) return;
    const touch = e.touches[0];
    dragCurrentY = touch.clientY;
    const deltaY = dragCurrentY - dragStartY;
    
    // Only allow dragging downward
    if (deltaY > 0 && modal) {
      modal.style.transform = `translateY(${deltaY}px)`;
      // Fade backdrop
      if (backdrop) {
        backdrop.style.opacity = `${Math.max(0, 1 - deltaY / 300)}`;
      }
    }
  }

  function onDragEnd() {
    if (!isDragging) return;
    isDragging = false;
    modal?.classList.remove('dragging');
    
    const deltaY = dragCurrentY - dragStartY;
    
    if (deltaY > 120) {
      // Dismiss
      closeEventModal();
    } else {
      // Snap back
      if (modal) {
        modal.style.transform = '';
      }
      if (backdrop) {
        backdrop.style.opacity = '';
      }
    }
  }

  // Attach drag listeners to handle
  dragHandle?.addEventListener('touchstart', onDragStart, { passive: true });
  dragHandle?.addEventListener('touchmove', onDragMove, { passive: true });
  dragHandle?.addEventListener('touchend', onDragEnd);

  // Also allow swipe-down from scroll area when scrolled to top
  let scrollDragActive = false;

  modalScroll?.addEventListener('touchstart', (e) => {
    if (modalScroll.scrollTop <= 0) {
      scrollDragActive = true;
      const touch = e.touches[0];
      dragStartY = touch.clientY;
      dragCurrentY = touch.clientY;
    }
  }, { passive: true });

  modalScroll?.addEventListener('touchmove', (e) => {
    if (!scrollDragActive) return;
    const touch = e.touches[0];
    const deltaY = touch.clientY - dragStartY;
    
    // If we're pulling down and scroll is at top, start dragging modal
    if (deltaY > 10 && modalScroll.scrollTop <= 0) {
      isDragging = true;
      modal?.classList.add('dragging');
      dragCurrentY = touch.clientY;
      if (modal) {
        modal.style.transform = `translateY(${deltaY}px)`;
      }
      if (backdrop) {
        backdrop.style.opacity = `${Math.max(0, 1 - deltaY / 300)}`;
      }
      e.preventDefault();
    }
  }, { passive: false });

  modalScroll?.addEventListener('touchend', () => {
    if (scrollDragActive) {
      scrollDragActive = false;
      if (isDragging) {
        onDragEnd();
      }
    }
  });

  // ‚îÄ‚îÄ‚îÄ Open modal ‚îÄ‚îÄ‚îÄ
  function openEventModal(eventData: any) {
    currentEventData = eventData;
    
    const titleEl = document.getElementById('modal-title');
    const categoryEl = document.querySelector('.modal-category') as HTMLElement;
    const datetimeEl = document.querySelector('.modal-datetime-text');
    const locationEl = document.querySelector('.modal-location-text');
    const mapEl = document.getElementById('modal-map');
    const descriptionEl = document.getElementById('modal-description');
    const tagsEl = document.getElementById('modal-tags');
    const externalLinkEl = document.getElementById('modal-external-link') as HTMLAnchorElement;

    // Title
    if (titleEl) titleEl.textContent = eventData.title;

    // Category
    const categoryLabels: Record<string, string> = {
      kinder: 'Kinder',
      familie: 'Familie',
      erwachsene: 'Erwachsene'
    };
    if (categoryEl) {
      categoryEl.textContent = categoryLabels[eventData.category] || 'Familie';
      categoryEl.setAttribute('data-cat', eventData.category);
    }

    // Date & Time
    if (datetimeEl) {
      const date = new Date(eventData.date);
      const dateStr = date.toLocaleDateString('de-DE', { 
        weekday: 'long', 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
      });
      const timeStr = eventData.time ? `, ${eventData.time} Uhr` : '';
      datetimeEl.textContent = dateStr + timeStr;
    }

    // Location
    if (locationEl) {
      locationEl.textContent = eventData.address || eventData.location;
    }

    // Map
    if (mapEl) {
      const mapQuery = eventData.address || (eventData.location + ', Bayern, Deutschland');
      const mapUrl = `https://maps.google.com/maps?q=${encodeURIComponent(mapQuery)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
      mapEl.innerHTML = `
        <iframe
          loading="lazy"
          allowfullscreen
          referrerpolicy="no-referrer-when-downgrade"
          src="${mapUrl}"
          title="Karte: ${eventData.address || eventData.location}"
          style="width:100%;height:100%;border:0;"
        ></iframe>
      `;
    }

    // Reset map overlay
    mapOverlay?.classList.remove('hidden');

    // AI Curation
    const aiSection = document.getElementById('modal-ai-curation');
    const aiSummaryText = document.getElementById('ai-summary-text');
    const aiScoreFamily = document.getElementById('ai-score-family');
    const aiScoreKids = document.getElementById('ai-score-kids');
    const aiScoreAdults = document.getElementById('ai-score-adults');
    const aiAgeRow = document.getElementById('ai-age-row');
    const aiAgeText = document.getElementById('ai-age-text');
    const aiPriceRow = document.getElementById('ai-price-row');
    const aiPriceText = document.getElementById('ai-price-text');
    const aiTipsRow = document.getElementById('ai-tips-row');
    const aiTipsText = document.getElementById('ai-tips-text');

    if (eventData.aiSummary && aiSection) {
      aiSection.style.display = '';
      if (aiSummaryText) aiSummaryText.textContent = eventData.aiSummary;

      // Score bars
      const setScoreBar = (el: HTMLElement | null, score: number) => {
        if (!el) return;
        el.style.width = `${score * 10}%`;
        el.setAttribute('data-score', String(score));
      };
      setScoreBar(aiScoreFamily, eventData.aiFamilyScore ?? 0);
      setScoreBar(aiScoreKids, eventData.aiKidsScore ?? 0);
      setScoreBar(aiScoreAdults, eventData.aiAdultsScore ?? 0);

      // Detail rows
      if (aiAgeRow && aiAgeText) {
        if (eventData.aiAgeRange) { aiAgeRow.style.display = ''; aiAgeText.textContent = eventData.aiAgeRange; }
        else aiAgeRow.style.display = 'none';
      }
      if (aiPriceRow && aiPriceText) {
        if (eventData.aiPrice) { aiPriceRow.style.display = ''; aiPriceText.textContent = eventData.aiPrice; }
        else aiPriceRow.style.display = 'none';
      }
      if (aiTipsRow && aiTipsText) {
        if (eventData.aiTips) { aiTipsRow.style.display = ''; aiTipsText.textContent = eventData.aiTips; }
        else aiTipsRow.style.display = 'none';
      }
    } else if (aiSection) {
      aiSection.style.display = 'none';
    }

    // Description
    if (descriptionEl) {
      descriptionEl.textContent = eventData.description || '';
    }

    // Tags ‚Äî use global artTags config if available, fallback to hardcoded
    const globalArtTags = (window as any).__artTagsData || {};
    const artTagLabels: Record<string, string> = {};
    // Build label map from global config
    for (const [key, val] of Object.entries(globalArtTags)) {
      const t = val as any;
      if (t?.emoji && t?.name) artTagLabels[key] = `${t.emoji} ${t.name}`;
    }
    // Fallback if no global config
    if (Object.keys(artTagLabels).length === 0) {
      Object.assign(artTagLabels, {
        musik: 'üéµ Musik', theater: 'üé≠ Theater', kunst: 'üé® Kunst',
        kultur: 'üèõÔ∏è Kultur', sport: 'üèÉ Sport', natur: 'üå≤ Natur',
        markt: 'üõí Markt', bildung: 'üìö Bildung', fest: 'üéâ Fest',
        show: 'üé™ Show', indoor: 'üè† Indoor', tanz: 'üíÉ Tanz',
        yoga: 'üßò Yoga', wellness: 'üßñ Wellness', radsport: 'üö¥ Radsport',
        radtour: 'üö≤ Radtour', wandern: 'ü•æ Wandern', laufen: 'üèÉ‚Äç‚ôÇÔ∏è Laufen',
        schwimmen: 'üèä Schwimmen', fasching: 'üé≠ Fasching',
        ferienprogramm: '‚òÄÔ∏è Ferienprogramm', meditation: 'üßò‚Äç‚ôÇÔ∏è Meditation'
      });
    }
    if (tagsEl) {
      tagsEl.innerHTML = (eventData.tags && eventData.tags.length > 0)
        ? eventData.tags.map((tag: string) => `<span class="modal-tag">${artTagLabels[tag] || tag}</span>`).join('')
        : '';
    }

    // External link
    if (externalLinkEl) {
      if (eventData.url) {
        externalLinkEl.href = eventData.url;
        externalLinkEl.style.display = '';
      } else {
        externalLinkEl.style.display = 'none';
      }
    }

    // Reset scroll position
    if (modalScroll) modalScroll.scrollTop = 0;

    // Update URL with event ID for deep-linking
    if (eventData.id) {
      updateUrlForEvent(eventData.id);
    }

    // Show modal
    modal?.classList.add('visible');
    backdrop?.classList.add('visible');
    lockBodyScroll();

    closeBtn?.focus();
  }

  // ‚îÄ‚îÄ‚îÄ Close modal ‚îÄ‚îÄ‚îÄ
  function closeEventModal() {
    if (modal) {
      modal.style.transform = '';
    }
    if (backdrop) {
      backdrop.style.opacity = '';
    }
    modal?.classList.remove('visible', 'dragging');
    backdrop?.classList.remove('visible');
    unlockBodyScroll();
    
    // Remove event param from URL
    updateUrlForEvent(null);
    
    // Reset map overlay for next open
    mapOverlay?.classList.remove('hidden');
    
    // Clear map iframe to stop loading
    const mapEl = document.getElementById('modal-map');
    if (mapEl) mapEl.innerHTML = '';
    
    currentEventData = null;
  }

  // ‚îÄ‚îÄ‚îÄ iOS-safe body scroll lock ‚îÄ‚îÄ‚îÄ
  let savedScrollY = 0;

  function lockBodyScroll() {
    savedScrollY = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${savedScrollY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.style.overflow = 'hidden';
  }

  function unlockBodyScroll() {
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.overflow = '';
    window.scrollTo(0, savedScrollY);
  }

  // Prevent scroll-through on backdrop
  backdrop?.addEventListener('touchmove', (e) => {
    e.preventDefault();
  }, { passive: false });

  // Event listeners
  closeBtn?.addEventListener('click', closeEventModal);
  backdrop?.addEventListener('click', closeEventModal);

  // ESC key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('visible')) {
      closeEventModal();
    }
  });

  // ‚îÄ‚îÄ‚îÄ Download ICS ‚îÄ‚îÄ‚îÄ
  downloadIcsBtn?.addEventListener('click', () => {
    if (!currentEventData) return;

    const icsContent = generateICS(currentEventData);
    const ua = navigator.userAgent;
    const isAppleSafari = /Macintosh|iPhone|iPad|iPod/.test(ua)
                          && /Safari/.test(ua)
                          && !/Chrome|CriOS|FxiOS|Edg/.test(ua);

    if (isAppleSafari) {
      const link = document.createElement('a');
      link.href = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icsContent);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const safeTitle = currentEventData.title
        .replace(/[^a-zA-Z0-9√§√∂√º√Ñ√ñ√ú√ü\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-');
      link.download = `${safeTitle}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }
  });

  function generateICS(event: any): string {
    const formatDate = (dateStr: string, timeStr?: string) => {
      const date = new Date(dateStr);
      if (timeStr) {
        const [hours, minutes] = timeStr.split(':');
        date.setHours(parseInt(hours), parseInt(minutes));
      }
      return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    };

    const dtstart = formatDate(event.date, event.time);
    const dtend = formatDate(event.date, event.endTime || event.time);
    
    const escapeText = (text: string) => {
      return text.replace(/\n/g, '\\n').replace(/,/g, '\\,').replace(/;/g, '\\;');
    };

    return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Starnberg Events//DE
BEGIN:VEVENT
UID:${event.id}@starnberg-events
DTSTAMP:${formatDate(new Date().toISOString().split('T')[0])}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${escapeText(event.title)}
DESCRIPTION:${escapeText(event.description || '')}
LOCATION:${escapeText(event.address || event.location)}
URL:${event.url || ''}
END:VEVENT
END:VCALENDAR`;
  }

  // ‚îÄ‚îÄ‚îÄ Share Event ‚îÄ‚îÄ‚îÄ
  function getEventShareUrl(eventId: string): string {
    const url = new URL(window.location.href);
    url.search = '';
    url.hash = '';
    url.searchParams.set('event', eventId);
    return url.toString();
  }

  function getShareText(eventData: any): string {
    const date = new Date(eventData.date);
    const dateStr = date.toLocaleDateString('de-DE', { 
      weekday: 'short', day: '2-digit', month: 'short' 
    });
    const timeStr = eventData.time ? ` um ${eventData.time} Uhr` : '';
    const location = eventData.address || eventData.location;
    return `${eventData.title}\nüìÖ ${dateStr}${timeStr}\nüìç ${location}`;
  }

  function showToast(message: string) {
    if (!shareToast) return;
    shareToast.textContent = message;
    shareToast.classList.add('visible');
    setTimeout(() => shareToast.classList.remove('visible'), 2000);
  }

  shareBtn?.addEventListener('click', async () => {
    if (!currentEventData) return;

    const shareUrl = getEventShareUrl(currentEventData.id);
    const shareText = getShareText(currentEventData);

    // Try Web Share API first (native share sheet on mobile)
    if (navigator.share) {
      try {
        await navigator.share({
          title: currentEventData.title,
          text: shareText,
          url: shareUrl
        });
        return; // user shared or cancelled ‚Äî either way, done
      } catch (err: any) {
        // AbortError = user cancelled, that's fine
        if (err?.name === 'AbortError') return;
        // Other error ‚Äî fall through to clipboard
      }
    }

    // Fallback: copy link to clipboard
    try {
      await navigator.clipboard.writeText(`${shareText}\n\n${shareUrl}`);
      showToast('üìã Link kopiert!');
    } catch {
      // Last resort: select + copy
      const textarea = document.createElement('textarea');
      textarea.value = `${shareText}\n\n${shareUrl}`;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showToast('üìã Link kopiert!');
    }
  });

  // ‚îÄ‚îÄ‚îÄ URL management: update URL when modal opens/closes ‚îÄ‚îÄ‚îÄ
  function updateUrlForEvent(eventId: string | null) {
    const url = new URL(window.location.href);
    if (eventId) {
      url.searchParams.set('event', eventId);
    } else {
      url.searchParams.delete('event');
    }
    history.replaceState(null, '', url.toString());
  }

  // ‚îÄ‚îÄ‚îÄ Deep-linking: open modal from URL param on page load ‚îÄ‚îÄ‚îÄ
  function checkDeepLink() {
    const params = new URLSearchParams(window.location.search);
    const eventId = params.get('event');
    if (!eventId) return;

    // Find the event card with this ID and extract its data
    const card = document.querySelector(`.event-card[data-event-id="${eventId}"]`) as HTMLElement;
    if (!card) return;

    const eventData = {
      id: card.dataset.eventId,
      title: card.dataset.eventTitle,
      date: card.dataset.date,
      time: card.dataset.eventTime,
      location: card.dataset.location,
      address: card.dataset.eventAddress,
      description: card.dataset.eventDescription,
      category: card.dataset.category,
      url: card.dataset.eventUrl,
      tags: card.dataset.artTags?.split(',').filter(Boolean) || []
    };

    // Small delay to ensure DOM is ready
    requestAnimationFrame(() => openEventModal(eventData));
  }

  // Global
  (window as any).openEventModal = openEventModal;
  (window as any).closeEventModal = closeEventModal;

  // Check for deep link on load
  document.addEventListener('DOMContentLoaded', checkDeepLink);
</script>
