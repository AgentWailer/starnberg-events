---
// EventModal.astro - Modal component for event details
---

<!-- Modal Backdrop -->
<div class="event-modal-backdrop" id="event-modal-backdrop"></div>

<!-- Modal Container -->
<div class="event-modal" id="event-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="modal-content">
    <!-- Close Button -->
    <button class="modal-close" id="modal-close" aria-label="Modal schlieÃŸen">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    <!-- Modal Header -->
    <div class="modal-header">
      <h2 class="modal-title" id="modal-title"></h2>
      <div class="modal-category"></div>
    </div>

    <!-- Modal Body -->
    <div class="modal-body">
      <div class="modal-datetime">
        <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        <span class="modal-datetime-text"></span>
      </div>

      <div class="modal-location">
        <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <span class="modal-location-text"></span>
      </div>

      <!-- Map -->
      <div class="modal-map" id="modal-map"></div>

      <!-- Description -->
      <div class="modal-description" id="modal-description"></div>

      <!-- Tags -->
      <div class="modal-tags" id="modal-tags"></div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" id="modal-download-ics">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="15" x2="12" y2="3"></line>
        </svg>
        In Kalender speichern
      </button>
      <a class="modal-btn modal-btn-primary" id="modal-external-link" target="_blank" rel="noopener">
        Zur Event-Seite
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
      </a>
    </div>
  </div>
</div>

<style>
  /* === BACKDROP === */
  .event-modal-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 400;
    opacity: 0;
    transition: opacity var(--duration-normal) ease;
  }

  .event-modal-backdrop.visible {
    display: block;
    opacity: 1;
  }

  .event-modal-backdrop {
    touch-action: none;
  }

  /* === MODAL === */
  .event-modal {
    display: none;
    position: fixed;
    z-index: 401;
    bottom: 0;
    left: 0;
    right: 0;
    max-height: 90vh;
    background: var(--color-card);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
    transform: translateY(100%);
    transition: transform var(--duration-normal) ease;
    overflow: hidden;
    overscroll-behavior: contain;
  }

  .event-modal.visible {
    display: flex;
    flex-direction: column;
    transform: translateY(0);
  }

  @media (min-width: 768px) {
    .event-modal {
      top: 50%;
      left: 50%;
      right: auto;
      bottom: auto;
      transform: translate(-50%, -50%) scale(0.9);
      max-width: 600px;
      width: 90%;
      max-height: 85vh;
      border-radius: var(--radius-xl);
    }

    .event-modal.visible {
      transform: translate(-50%, -50%) scale(1);
    }
  }

  /* === MODAL CONTENT === */
  .modal-content {
    display: flex;
    flex-direction: column;
    min-height: 0; /* Allow flex shrinking */
    max-height: 90vh;
    flex: 1;
  }

  @media (min-width: 768px) {
    .modal-content {
      max-height: 85vh;
    }
  }

  /* === CLOSE BUTTON === */
  .modal-close {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-secondary);
    border: none;
    border-radius: var(--radius-full);
    color: var(--color-text);
    cursor: pointer;
    z-index: 10;
    transition: all var(--duration-fast) ease;
  }

  .modal-close:hover {
    background: var(--color-border);
    transform: scale(1.05);
  }

  .modal-close svg {
    width: 20px;
    height: 20px;
  }

  /* === HEADER === */
  .modal-header {
    padding: var(--space-6) var(--space-5);
    padding-right: calc(var(--space-5) + 52px); /* Space for close button */
    border-bottom: 1px solid var(--color-border-light);
    flex-shrink: 0;
  }

  @media (min-width: 768px) {
    .modal-header {
      padding: var(--space-8) var(--space-6);
      padding-right: calc(var(--space-6) + 52px);
    }
  }

  .modal-title {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.3;
    color: var(--color-text);
    margin-bottom: var(--space-3);
  }

  @media (min-width: 768px) {
    .modal-title {
      font-size: 1.75rem;
    }
  }

  .modal-category {
    display: inline-flex;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-sm);
  }

  .modal-category[data-cat="kinder"] {
    background: color-mix(in srgb, var(--color-kinder) 12%, transparent);
    color: var(--color-kinder);
  }

  .modal-category[data-cat="familie"] {
    background: color-mix(in srgb, var(--color-familie) 12%, transparent);
    color: var(--color-familie);
  }

  .modal-category[data-cat="erwachsene"] {
    background: color-mix(in srgb, var(--color-erwachsene) 12%, transparent);
    color: var(--color-erwachsene);
  }

  /* === BODY === */
  .modal-body {
    flex: 1;
    min-height: 0; /* Critical: allow flex item to shrink below content height */
    overflow-y: auto;
    padding: var(--space-5);
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  @media (min-width: 768px) {
    .modal-body {
      padding: var(--space-6);
    }
  }

  .modal-datetime,
  .modal-location {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .modal-icon {
    width: 20px;
    height: 20px;
    color: var(--color-primary);
    flex-shrink: 0;
  }

  .modal-datetime-text,
  .modal-location-text {
    font-size: 0.9375rem;
    color: var(--color-text);
    font-weight: 500;
  }

  .modal-map {
    width: 100%;
    aspect-ratio: 16 / 9;
    max-height: 240px;
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-light);
    box-shadow: var(--shadow-sm);
  }

  .modal-map iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: block;
  }

  .modal-description {
    font-size: 0.9375rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
  }

  .modal-description:empty {
    display: none;
  }

  .modal-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .modal-tags:empty {
    display: none;
  }

  .modal-tag {
    display: inline-flex;
    align-items: center;
    padding: var(--space-1) var(--space-3);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-full);
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
  }

  /* === FOOTER === */
  .modal-footer {
    padding: var(--space-5);
    border-top: 1px solid var(--color-border-light);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    flex-shrink: 0;
  }

  @media (min-width: 640px) {
    .modal-footer {
      flex-direction: row;
    }
  }

  .modal-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-4) var(--space-5);
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--duration-fast) ease;
    text-decoration: none;
    min-height: 48px;
    flex: 1;
  }

  .modal-btn svg {
    width: 18px;
    height: 18px;
  }

  .modal-btn-primary {
    background: var(--color-primary);
    color: white;
    border: none;
  }

  .modal-btn-primary:hover {
    background: color-mix(in srgb, var(--color-primary) 90%, black);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .modal-btn-secondary {
    background: var(--color-bg-secondary);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .modal-btn-secondary:hover {
    background: var(--color-border);
  }

  /* Smooth scrolling in modal â€” prevent scroll-through on mobile */
  .modal-body {
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    touch-action: pan-y; /* Explicitly allow vertical scroll via touch */
    scrollbar-width: thin;
    scrollbar-color: var(--color-border) transparent;
  }

  .modal-body::-webkit-scrollbar {
    width: 6px;
  }

  .modal-body::-webkit-scrollbar-track {
    background: transparent;
  }

  .modal-body::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;
  }
</style>

<script>
  // Modal state
  let currentEventData: any = null;

  const modal = document.getElementById('event-modal');
  const backdrop = document.getElementById('event-modal-backdrop');
  const closeBtn = document.getElementById('modal-close');
  const downloadIcsBtn = document.getElementById('modal-download-ics');

  // Open modal with event data
  function openEventModal(eventData: any) {
    currentEventData = eventData;
    
    // Populate modal
    const titleEl = document.getElementById('modal-title');
    const categoryEl = document.querySelector('.modal-category') as HTMLElement;
    const datetimeEl = document.querySelector('.modal-datetime-text');
    const locationEl = document.querySelector('.modal-location-text');
    const mapEl = document.getElementById('modal-map');
    const descriptionEl = document.getElementById('modal-description');
    const tagsEl = document.getElementById('modal-tags');
    const externalLinkEl = document.getElementById('modal-external-link') as HTMLAnchorElement;

    // Title
    if (titleEl) titleEl.textContent = eventData.title;

    // Category
    const categoryLabels: Record<string, string> = {
      kinder: 'Kinder',
      familie: 'Familie',
      erwachsene: 'Erwachsene'
    };
    if (categoryEl) {
      categoryEl.textContent = categoryLabels[eventData.category] || 'Familie';
      categoryEl.setAttribute('data-cat', eventData.category);
    }

    // Date & Time
    if (datetimeEl) {
      const date = new Date(eventData.date);
      const dateStr = date.toLocaleDateString('de-DE', { 
        weekday: 'long', 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric' 
      });
      const timeStr = eventData.time ? `, ${eventData.time} Uhr` : '';
      datetimeEl.textContent = dateStr + timeStr;
    }

    // Location â€” show full address if available, otherwise city name
    if (locationEl) {
      locationEl.textContent = eventData.address || eventData.location;
    }

    // Map â€” Google Maps Embed using address for precise pin
    if (mapEl) {
      const mapQuery = eventData.address || (eventData.location + ', Bayern, Deutschland');
      const mapUrl = `https://maps.google.com/maps?q=${encodeURIComponent(mapQuery)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
      mapEl.innerHTML = `
        <iframe
          loading="lazy"
          allowfullscreen
          referrerpolicy="no-referrer-when-downgrade"
          src="${mapUrl}"
          title="Karte: ${eventData.address || eventData.location}"
          style="width:100%;height:100%;border:0;"
        ></iframe>
      `;
    }

    // Description
    if (descriptionEl) {
      if (eventData.description) {
        descriptionEl.textContent = eventData.description;
      } else {
        descriptionEl.textContent = '';
      }
    }

    // Tags â€” show emoji + label instead of raw IDs
    const artTagLabels: Record<string, string> = {
      musik: 'ðŸŽµ Musik', theater: 'ðŸŽ­ Theater', kunst: 'ðŸŽ¨ Kunst',
      sport: 'ðŸƒ Sport', natur: 'ðŸŒ² Natur', markt: 'ðŸ›’ Markt',
      bildung: 'ðŸ“š Bildung', fest: 'ðŸŽ‰ Fest', show: 'ðŸŽª Show', indoor: 'â˜‚ï¸ Indoor'
    };
    if (tagsEl) {
      if (eventData.tags && eventData.tags.length > 0) {
        tagsEl.innerHTML = eventData.tags
          .map((tag: string) => `<span class="modal-tag">${artTagLabels[tag] || tag}</span>`)
          .join('');
      } else {
        tagsEl.innerHTML = '';
      }
    }

    // External link
    if (externalLinkEl) {
      if (eventData.url) {
        externalLinkEl.href = eventData.url;
        externalLinkEl.style.display = '';
      } else {
        externalLinkEl.style.display = 'none';
      }
    }

    // Show modal â€” lock body scroll (iOS-safe)
    modal?.classList.add('visible');
    backdrop?.classList.add('visible');
    lockBodyScroll();

    // Focus close button for accessibility
    closeBtn?.focus();
  }

  // Close modal
  function closeEventModal() {
    modal?.classList.remove('visible');
    backdrop?.classList.remove('visible');
    unlockBodyScroll();
    currentEventData = null;
  }

  // iOS-safe body scroll lock
  let savedScrollY = 0;

  function lockBodyScroll() {
    savedScrollY = window.scrollY;
    document.body.style.position = 'fixed';
    document.body.style.top = `-${savedScrollY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.style.overflow = 'hidden';
  }

  function unlockBodyScroll() {
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.overflow = '';
    window.scrollTo(0, savedScrollY);
  }

  // Prevent background scrolling via touch on backdrop
  backdrop?.addEventListener('touchmove', (e) => {
    e.preventDefault();
  }, { passive: false });

  // Event listeners
  closeBtn?.addEventListener('click', closeEventModal);
  backdrop?.addEventListener('click', closeEventModal);

  // ESC key closes modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('visible')) {
      closeEventModal();
    }
  });

  // Download ICS â€” opens Apple Calendar directly on Safari, downloads .ics otherwise
  downloadIcsBtn?.addEventListener('click', () => {
    if (!currentEventData) return;

    const icsContent = generateICS(currentEventData);
    const ua = navigator.userAgent;
    // Detect Safari on Apple devices (not Chrome/Firefox/Edge on macOS)
    const isAppleSafari = /Macintosh|iPhone|iPad|iPod/.test(ua)
                          && /Safari/.test(ua)
                          && !/Chrome|CriOS|FxiOS|Edg/.test(ua);

    if (isAppleSafari) {
      // Safari handles text/calendar natively â€” opens "Add to Calendar" dialog
      // Using an <a> click with data URI (no download attr) lets Safari intercept the MIME type
      const link = document.createElement('a');
      link.href = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icsContent);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      // Other browsers: download the .ics file
      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      const safeTitle = currentEventData.title
        .replace(/[^a-zA-Z0-9Ã¤Ã¶Ã¼Ã„Ã–ÃœÃŸ\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-');
      link.download = `${safeTitle}.ics`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }
  });

  // Generate ICS file content
  function generateICS(event: any): string {
    const formatDate = (dateStr: string, timeStr?: string) => {
      const date = new Date(dateStr);
      if (timeStr) {
        const [hours, minutes] = timeStr.split(':');
        date.setHours(parseInt(hours), parseInt(minutes));
      }
      return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
    };

    const dtstart = formatDate(event.date, event.time);
    const dtend = formatDate(event.date, event.endTime || event.time);
    
    const escapeText = (text: string) => {
      return text.replace(/\n/g, '\\n').replace(/,/g, '\\,').replace(/;/g, '\\;');
    };

    return `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Starnberg Events//DE
BEGIN:VEVENT
UID:${event.id}@starnberg-events
DTSTAMP:${formatDate(new Date().toISOString().split('T')[0])}
DTSTART:${dtstart}
DTEND:${dtend}
SUMMARY:${escapeText(event.title)}
DESCRIPTION:${escapeText(event.description || '')}
LOCATION:${escapeText(event.address || event.location)}
URL:${event.url || ''}
END:VEVENT
END:VCALENDAR`;
  }

  // Make function globally available
  (window as any).openEventModal = openEventModal;
</script>
