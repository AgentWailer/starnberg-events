---
// Info ticker for mobile - horizontal scroll with drag + momentum (like weekend carousel)
---

<div class="info-ticker" id="info-ticker" aria-label="Aktuelle Informationen">
  <div class="ticker-track" id="ticker-track">
    <div class="ticker-content" id="ticker-content">
      <!-- Wetter -->
      <span class="ticker-item" data-type="weather">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <span class="ticker-value" id="weather-temp">--°</span>
        <span class="ticker-label">Starnberg</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Wassertemperatur -->
      <span class="ticker-item" data-type="water">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
        </svg>
        <span class="ticker-value" id="water-temp">--°</span>
        <span class="ticker-label">Seetemperatur</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Sonnenaufgang -->
      <span class="ticker-item" data-type="sunrise">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 18a5 5 0 0 0-10 0"/>
          <line x1="12" y1="2" x2="12" y2="9"/>
          <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/>
          <line x1="1" y1="18" x2="3" y2="18"/>
          <line x1="21" y1="18" x2="23" y2="18"/>
          <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/>
          <polyline points="8 6 12 2 16 6"/>
        </svg>
        <span class="ticker-value" id="sunrise-time">--:--</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Sonnenuntergang -->
      <span class="ticker-item" data-type="sunset">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 18a5 5 0 0 0-10 0"/>
          <line x1="12" y1="9" x2="12" y2="2"/>
          <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/>
          <line x1="1" y1="18" x2="3" y2="18"/>
          <line x1="21" y1="18" x2="23" y2="18"/>
          <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/>
          <polyline points="16 6 12 10 8 6"/>
        </svg>
        <span class="ticker-value" id="sunset-time">--:--</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- S-Bahn München -->
      <a class="ticker-item ticker-link" data-type="train" href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank" rel="noopener">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="3" width="16" height="16" rx="2"/>
          <path d="M4 11h16"/>
          <path d="M12 3v8"/>
          <circle cx="8" cy="15" r="1"/>
          <circle cx="16" cy="15" r="1"/>
          <path d="M8 19l-2 3"/>
          <path d="M16 19l2 3"/>
        </svg>
        <span class="ticker-badge">S6</span>
        <span class="ticker-value" id="train-munich">--:--</span>
        <span class="ticker-label">→ München</span>
      </a>

      <span class="ticker-divider">|</span>

      <!-- S-Bahn Tutzing -->
      <a class="ticker-item ticker-link" data-type="train" href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank" rel="noopener">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="3" width="16" height="16" rx="2"/>
          <path d="M4 11h16"/>
          <path d="M12 3v8"/>
          <circle cx="8" cy="15" r="1"/>
          <circle cx="16" cy="15" r="1"/>
          <path d="M8 19l-2 3"/>
          <path d="M16 19l2 3"/>
        </svg>
        <span class="ticker-badge">S6</span>
        <span class="ticker-value" id="train-tutzing">--:--</span>
        <span class="ticker-label">→ Tutzing</span>
      </a>

      <!-- S6 Pünktlichkeit (dynamisch eingeblendet) -->
      <span class="ticker-divider ticker-punctuality-sep" id="ticker-punct-sep" style="display:none;">|</span>
      <a class="ticker-item ticker-link ticker-punctuality" id="ticker-punctuality" href="/s6" style="display:none;">
        <span class="ticker-punct-dot" id="ticker-punct-dot"></span>
        <span class="ticker-value" id="ticker-punct-value">–%</span>
        <span class="ticker-label">S6 pünktlich</span>
      </a>

    </div>
  </div>
</div>

<style>
  .info-ticker {
    display: none;
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    overflow: hidden;
    position: relative;
  }

  @media (max-width: 767px) {
    .info-ticker {
      display: block;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: var(--space-4);
    }
  }

  :root.dark .info-ticker {
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .ticker-track {
    display: flex;
    gap: 0;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    /* Allow content to peek out on the right */
    padding-right: var(--space-4);
  }

  .ticker-track::-webkit-scrollbar {
    display: none;
  }

  .ticker-content {
    display: flex;
    align-items: center;
    gap: 0;
    padding: var(--space-3) 0;
    white-space: nowrap;
  }

  .ticker-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0 var(--space-4);
    color: var(--color-text-secondary);
    font-size: 0.8125rem;
  }

  .ticker-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    opacity: 0.7;
  }

  .ticker-value {
    font-weight: 600;
    color: var(--color-text);
    font-variant-numeric: tabular-nums;
  }

  .ticker-label {
    color: var(--color-muted);
    font-size: 0.75rem;
  }

  .ticker-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 1px 5px;
    background: #16a34a;
    color: white;
    border-radius: 3px;
    font-size: 0.625rem;
    font-weight: 700;
    line-height: 1.2;
  }

  .ticker-punct-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-muted, #999);
    flex-shrink: 0;
  }
  .ticker-punct-dot.good { background: #16a34a; }
  .ticker-punct-dot.mid  { background: #d97706; }
  .ticker-punct-dot.bad  { background: #dc2626; }
  :root.dark .ticker-punct-dot.good { background: #4ade80; }
  :root.dark .ticker-punct-dot.mid  { background: #fbbf24; }
  :root.dark .ticker-punct-dot.bad  { background: #f87171; }

  .ticker-divider {
    color: var(--color-border);
    font-weight: 300;
    font-size: 1rem;
    padding: 0 var(--space-2);
    opacity: 0.5;
  }

  /* Train link styling */
  .ticker-link {
    text-decoration: none;
    color: inherit;
    cursor: pointer;
  }

  .ticker-link:hover {
    opacity: 0.8;
  }

  .ticker-link:active {
    opacity: 0.6;
  }

  /* Train delay styling - RED */
  :global(.delay) {
    color: #dc2626 !important;
    font-weight: 600;
    font-size: 0.75rem;
    margin-left: 3px;
  }

  /* Tomorrow/next day label */
  :global(.tomorrow) {
    color: var(--color-muted);
    font-size: 0.6875rem;
    font-weight: 500;
    margin-right: 3px;
  }

  /* No train available */
  :global(.no-train) {
    color: var(--color-muted);
  }

  /* Reduced motion - no scroll, just static display */
  @media (prefers-reduced-motion: reduce) {
    .ticker-track {
      animation: none;
    }
    
    .ticker-clone {
      display: none;
    }
  }
</style>

<script>
  const WEATHER_API = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
  const LIVE_API = 'https://train-tracker.steffenvonlindern-be7.workers.dev/api/live';

  function formatTime(iso: string): string {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  // Load weather data
  async function loadWeather(): Promise<void> {
    try {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 6000);

      const res = await fetch(WEATHER_API, { signal: ctrl.signal });
      clearTimeout(timer);

      if (!res.ok) throw new Error('API error');
      const data = await res.json();

      // Temperature
      const temp = Math.round(data.current?.temperature_2m || 0);
      document.querySelectorAll('#weather-temp').forEach(el => {
        el.textContent = temp + '°';
      });

      // Sunrise
      const sunrise = data.daily?.sunrise?.[0];
      if (sunrise) {
        document.querySelectorAll('#sunrise-time').forEach(el => {
          el.textContent = formatTime(sunrise);
        });
      }

      // Sunset
      const sunset = data.daily?.sunset?.[0];
      if (sunset) {
        document.querySelectorAll('#sunset-time').forEach(el => {
          el.textContent = formatTime(sunset);
        });
      }
    } catch (e) {
      console.error('Weather error:', e);
    }
  }

  // Load water temperature (seasonal fallback due to CORS)
  async function loadWaterTemp(): Promise<void> {
    // Seasonal estimate for Starnberger See (CORS prevents direct fetch)
    const month = new Date().getMonth();
    let estimate: number;
    if (month >= 5 && month <= 7) {
      estimate = 18 + Math.floor(Math.random() * 5); // Summer: 18-22°C
    } else if (month >= 3 && month <= 4) {
      estimate = 8 + Math.floor(Math.random() * 4); // Spring: 8-11°C
    } else if (month >= 8 && month <= 10) {
      estimate = 12 + Math.floor(Math.random() * 4); // Fall: 12-15°C
    } else {
      estimate = 4 + Math.floor(Math.random() * 2); // Winter: 4-5°C
    }

    document.querySelectorAll('#water-temp').forEach(el => {
      el.textContent = estimate + '°';
    });
  }

  // Load train departures from our own /api/live
  async function loadTrains(): Promise<void> {
    try {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 8000);
      const res = await fetch(LIVE_API, { signal: ctrl.signal });
      clearTimeout(timer);

      if (!res.ok) throw new Error('API error');
      const data = await res.json();
      // Filter: only future departures
      const now = new Date();
      const nowMins = now.getHours() * 60 + now.getMinutes();
      const isUpcoming = (d: any) => {
        const t = d.actualTime || d.plannedTime;
        if (!t || t.length < 5) return false;
        const parts = t.split(':');
        return parseInt(parts[0]) * 60 + parseInt(parts[1]) >= nowMins - 1;
      };
      const allDeps = (data.departures || []).filter((d: any) => (d.cancelled || d.delay <= 60) && isUpcoming(d));

      const isTutzingDir = (d: any) => /Tutzing|Feldafing/i.test(d.direction);

      // Next running train per direction
      const toMunich = allDeps.find((d: any) => !isTutzingDir(d) && !d.cancelled);
      const toTutzing = allDeps.find((d: any) => isTutzingDir(d) && !d.cancelled);
      const cancelledMunich = allDeps.find((d: any) => !isTutzingDir(d) && d.cancelled);
      const cancelledTutzing = allDeps.find((d: any) => isTutzingDir(d) && d.cancelled);

      // Format: time + delay + optional cancel warning
      const fmt = (d: any, hasCancellation: boolean) => {
        const time = d.actualTime || d.plannedTime;
        const delayHtml = d.delay > 0 ? `<span class="delay">+${d.delay}</span>` : '';
        const warnHtml = hasCancellation ? ' <span style="color:#dc2626;font-size:0.75em;">⚠</span>' : '';
        return time + delayHtml + warnHtml;
      };

      const fmtCancelled = () => '<span style="color:#dc2626;font-size:0.85em;">Ausfall</span>';

      document.querySelectorAll('#train-munich').forEach(el => {
        el.innerHTML = toMunich ? fmt(toMunich, !!cancelledMunich) : (cancelledMunich ? fmtCancelled() : '<span class="no-train">–</span>');
      });

      document.querySelectorAll('#train-tutzing').forEach(el => {
        el.innerHTML = toTutzing ? fmt(toTutzing, !!cancelledTutzing) : (cancelledTutzing ? fmtCancelled() : '<span class="no-train">–</span>');
      });
    } catch (e) {
      console.error('Train error:', e);
    }
  }

  // S6 Punctuality from Worker
  async function loadPunctuality(): Promise<void> {
    try {
      const resp = await fetch('https://train-tracker.steffenvonlindern-be7.workers.dev/api/stats?period=week');
      if (!resp.ok) return;
      const data = await resp.json();
      const o = data.overall;
      if (!o || o.total === 0) return;

      const onTime = o.on_time || 0;
      const total = (onTime) + (o.delayed || 0) + (o.cancelled || 0);
      if (total === 0) return;

      const rate = Math.round((onTime / total) * 100);
      const cls = rate >= 80 ? 'good' : rate >= 60 ? 'mid' : 'bad';

      document.querySelectorAll('#ticker-punct-dot').forEach(el => {
        el.className = 'ticker-punct-dot ' + cls;
      });
      document.querySelectorAll('#ticker-punct-value').forEach(el => {
        el.textContent = rate + '%';
      });
      document.querySelectorAll('#ticker-punct-sep, #ticker-punctuality').forEach(el => {
        (el as HTMLElement).style.display = '';
      });
    } catch (e) { /* silent */ }
  }

  // Mouse drag with momentum (same as weekend carousel)
  function initTickerDrag(): void {
    const track = document.getElementById('ticker-track') as HTMLElement | null;
    if (!track) return;

    let isDragging = false;
    let startX = 0;
    let scrollStart = 0;
    let velocityX = 0;
    let lastX = 0;
    let lastTime = 0;
    let rafId = 0;
    let didMove = false;

    // Mouse/pointer drag only (touch has native momentum via -webkit-overflow-scrolling)
    track.addEventListener('pointerdown', (e: PointerEvent) => {
      if (e.pointerType === 'touch') return;
      cancelAnimationFrame(rafId);
      isDragging = true;
      didMove = false;
      startX = e.clientX;
      scrollStart = track.scrollLeft;
      velocityX = 0;
      lastX = startX;
      lastTime = performance.now();
      track.style.cursor = 'grabbing';
      track.setPointerCapture(e.pointerId);
      e.preventDefault();
    });

    track.addEventListener('pointermove', (e: PointerEvent) => {
      if (!isDragging || e.pointerType === 'touch') return;
      const dx = e.clientX - startX;
      if (Math.abs(dx) > 3) didMove = true;
      track.scrollLeft = scrollStart - dx;

      const now = performance.now();
      const dt = now - lastTime;
      if (dt > 0) {
        const v = (e.clientX - lastX) / dt;
        velocityX = velocityX * 0.7 + v * 0.3;
      }
      lastX = e.clientX;
      lastTime = now;
      e.preventDefault();
    });

    const end = (e: PointerEvent) => {
      if (!isDragging || e.pointerType === 'touch') return;
      isDragging = false;
      track.style.cursor = 'grab';
      track.releasePointerCapture(e.pointerId);

      // Momentum coast
      let v = velocityX * 18;
      const friction = 0.95;
      const coast = () => {
        if (Math.abs(v) < 0.5) return;
        track.scrollLeft -= v;
        v *= friction;
        rafId = requestAnimationFrame(coast);
      };
      if (Math.abs(v) > 1) coast();
    };

    track.addEventListener('pointerup', end);
    track.addEventListener('pointercancel', end);

    // Prevent clicks after drag
    track.addEventListener('click', (e) => {
      if (didMove) { e.preventDefault(); e.stopPropagation(); }
    }, true);

    track.style.cursor = 'grab';
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    // Load data
    await Promise.all([
      loadWeather(),
      loadWaterTemp(),
      loadTrains(),
      loadPunctuality()
    ]);

    // Setup drag scroll (like weekend carousel)
    initTickerDrag();

    // Refresh trains every minute
    setInterval(loadTrains, 60000);
  });
</script>
