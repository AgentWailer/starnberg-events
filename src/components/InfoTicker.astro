---
// Continuous scrolling ticker for mobile
// Matches site design system
---

<div class="ticker" id="ticker">
  <div class="ticker-content" id="ticker-content">
    <!-- Content duplicated for seamless loop -->
  </div>
</div>

<style>
  .ticker {
    display: none;
    background: var(--color-card);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border-light);
    overflow: hidden;
    height: 48px;
  }

  @media (max-width: 767px) {
    .ticker {
      display: block;
    }
  }

  .ticker-content {
    display: flex;
    align-items: center;
    height: 100%;
    animation: scroll 20s linear infinite;
    width: max-content;
  }

  .ticker-content:hover {
    animation-play-state: paused;
  }

  @keyframes scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  :global(.ticker-item) {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: 0 var(--space-5);
    white-space: nowrap;
    font-size: 0.875rem;
    color: var(--color-text);
    border-right: 1px solid var(--color-border-light);
    height: 100%;
  }

  :global(.ticker-item:last-child) {
    border-right: none;
  }

  :global(.ticker-icon) {
    width: 16px;
    height: 16px;
    opacity: 0.6;
  }

  :global(.ticker-label) {
    color: var(--color-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  :global(.ticker-value) {
    font-weight: 600;
    color: var(--color-text);
  }

  :global(.ticker-badge) {
    background: var(--color-primary);
    color: white;
    padding: 2px 8px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 0.75rem;
  }

  :global(.ticker-muted) {
    color: var(--color-muted);
  }
</style>

<script>
  const WEATHER_API = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
  const TRAIN_API = 'https://dbf.finalrewind.org';

  const icons = {
    sun: `<svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg>`,
    cloud: `<svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
    droplet: `<svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
    sunrise: `<svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><polyline points="8 6 12 2 16 6"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/></svg>`,
    train: `<svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="3" width="16" height="16" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><circle cx="8" cy="15" r="1"/><circle cx="16" cy="15" r="1"/><path d="M8 19l-2 3"/><path d="M16 19l2 3"/></svg>`,
  };

  function getWeatherIcon(code: number): string {
    if (code === 0) return icons.sun;
    if (code <= 3) return icons.sun;
    return icons.cloud;
  }

  function formatTime(iso: string): string {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  async function buildTicker(): Promise<string> {
    const items: string[] = [];

    // Fetch weather
    try {
      const res = await fetch(WEATHER_API);
      const data = await res.json();
      const temp = Math.round(data.current?.temperature_2m || 0);
      const code = data.current?.weather_code || 0;
      const sunrise = data.daily?.sunrise?.[0] ? formatTime(data.daily.sunrise[0]) : '7:30';
      const sunset = data.daily?.sunset?.[0] ? formatTime(data.daily.sunset[0]) : '17:20';

      items.push(`
        <div class="ticker-item">
          ${getWeatherIcon(code)}
          <span class="ticker-value">${temp}°</span>
          <span class="ticker-label">Starnberg</span>
        </div>
      `);

      items.push(`
        <div class="ticker-item">
          ${icons.droplet}
          <span class="ticker-value">4°</span>
          <span class="ticker-label">See</span>
        </div>
      `);

      items.push(`
        <div class="ticker-item">
          ${icons.sunrise}
          <span class="ticker-value">↑${sunrise}</span>
          <span class="ticker-muted">&nbsp;↓${sunset}</span>
        </div>
      `);
    } catch {
      items.push(`<div class="ticker-item">${icons.sun}<span class="ticker-muted">Wetter lädt...</span></div>`);
    }

    // Fetch trains
    try {
      const res = await fetch(`${TRAIN_API}/Possenhofen.json?version=3`);
      const data = await res.json();
      const trains = (data.departures || [])
        .filter((d: any) => !d.isCancelled && d.train.startsWith('S '))
        .slice(0, 2);

      if (trains.length > 0) {
        const t = trains[0];
        const dest = t.destination
          .replace(/\s*\([^)]*\)/g, '')
          .replace(/ Hbf$/, '')
          .replace(/^München /, 'M-');
        const delay = t.delayDeparture > 0 ? `<span class="ticker-muted"> +${t.delayDeparture}</span>` : '';
        
        items.push(`
          <div class="ticker-item">
            ${icons.train}
            <span class="ticker-badge">S6</span>
            <span class="ticker-value">${t.scheduledDeparture}${delay}</span>
            <span class="ticker-muted">→ ${dest}</span>
          </div>
        `);
      }
    } catch {
      // Skip
    }

    // Duplicate for seamless loop
    const content = items.join('');
    return content + content;
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const container = document.getElementById('ticker-content');
    if (!container) return;
    
    container.innerHTML = await buildTicker();
  });
</script>
