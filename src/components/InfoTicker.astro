---
// Elegant info bar for mobile - matches site design
---

<div class="info-bar" id="info-bar">
  <div class="info-bar-inner" id="info-bar-inner">
    <span class="info-item loading">Lädt...</span>
  </div>
</div>

<style>
  .info-bar {
    display: none;
    background: var(--color-primary);
    color: white;
    overflow: hidden;
    position: relative;
  }

  @media (max-width: 767px) {
    .info-bar {
      display: block;
    }
  }

  .info-bar-inner {
    display: inline-flex;
    white-space: nowrap;
    padding: var(--space-3) 0;
    animation: marquee 20s linear infinite;
    will-change: transform;
  }

  @keyframes marquee {
    from { transform: translateX(0); }
    to { transform: translateX(-50%); }
  }

  .info-bar .info-item {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: 0 var(--space-5);
    font-size: 0.8125rem;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0.95;
  }

  .info-bar .info-item::after {
    content: "·";
    margin-left: var(--space-5);
    opacity: 0.4;
  }

  .info-bar .info-item:last-child::after {
    content: none;
  }

  .info-bar .info-value {
    font-weight: 700;
  }

  .info-bar .info-label {
    opacity: 0.7;
    font-weight: 400;
  }

  .info-bar .info-badge {
    background: rgba(255,255,255,0.2);
    padding: 1px 6px;
    border-radius: var(--radius-sm);
    font-size: 0.6875rem;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  .info-bar .loading {
    opacity: 0.6;
    font-style: italic;
  }
</style>

<script>
  const WEATHER_API = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
  const TRAIN_API = 'https://dbf.finalrewind.org';

  const icons = {
    sun: `<svg style="width:14px;height:14px;opacity:0.8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg>`,
    droplet: `<svg style="width:14px;height:14px;opacity:0.8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
    sunrise: `<svg style="width:14px;height:14px;opacity:0.8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><polyline points="8 6 12 2 16 6"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/></svg>`,
    train: `<svg style="width:14px;height:14px;opacity:0.8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="3" width="16" height="16" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><circle cx="8" cy="15" r="1"/><circle cx="16" cy="15" r="1"/></svg>`,
  };

  function formatTime(iso: string): string {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  async function loadInfo(): Promise<void> {
    const container = document.getElementById('info-bar-inner');
    if (!container) return;

    const items: string[] = [];

    // Weather
    try {
      const res = await fetch(WEATHER_API);
      const data = await res.json();
      const temp = Math.round(data.current?.temperature_2m || 0);
      const sunrise = data.daily?.sunrise?.[0] ? formatTime(data.daily.sunrise[0]) : '';
      const sunset = data.daily?.sunset?.[0] ? formatTime(data.daily.sunset[0]) : '';

      items.push(`<span class="info-item">${icons.sun} <span class="info-value">${temp}°</span> <span class="info-label">Starnberg</span></span>`);
      items.push(`<span class="info-item">${icons.droplet} <span class="info-value">4°</span> <span class="info-label">Wassertemp</span></span>`);
      if (sunrise && sunset) {
        items.push(`<span class="info-item">${icons.sunrise} <span class="info-value">${sunrise}</span> – <span class="info-value">${sunset}</span></span>`);
      }
    } catch {
      items.push(`<span class="info-item">Wetter nicht verfügbar</span>`);
    }

    // Train
    try {
      const res = await fetch(`${TRAIN_API}/Possenhofen.json?version=3`);
      const data = await res.json();
      const train = (data.departures || [])
        .filter((d: any) => !d.isCancelled && d.train.startsWith('S '))
        .slice(0, 1)[0];

      if (train) {
        const dest = train.destination
          .replace(/\s*\([^)]*\)/g, '')
          .replace(/ Hbf$/, '')
          .replace(/^München /, 'M-');
        const delay = train.delayDeparture > 0 ? ` +${train.delayDeparture}` : '';
        
        items.push(`<span class="info-item">${icons.train} <span class="info-badge">S6</span> <span class="info-value">${train.scheduledDeparture}${delay}</span> → ${dest}</span>`);
      }
    } catch {
      // Skip
    }

    // Duplicate for seamless loop
    const content = items.join('');
    container.innerHTML = content + content;
  }

  document.addEventListener('DOMContentLoaded', loadInfo);
</script>
