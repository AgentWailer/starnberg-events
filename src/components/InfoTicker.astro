---
// Compact info ticker for mobile
// Shows: Weather, Water temp, Sunrise/Sunset, Train departures
// Auto-advances or swipeable
---

<div class="info-ticker" id="info-ticker">
  <div class="ticker-track" id="ticker-track">
    <!-- Slides populated by JS -->
    <div class="ticker-slide" data-slide="weather">
      <span class="ticker-icon">‚òÄÔ∏è</span>
      <span class="ticker-text">Wetter laden...</span>
    </div>
  </div>
  
  <div class="ticker-dots" id="ticker-dots"></div>
</div>

<style>
  .info-ticker {
    display: none;
    background: var(--color-card);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border-light);
    overflow: hidden;
    position: relative;
  }

  @media (max-width: 767px) {
    .info-ticker {
      display: block;
    }
  }

  .ticker-track {
    display: flex;
    transition: transform 0.4s ease;
  }

  .ticker-slide {
    min-width: 100%;
    padding: var(--space-4) var(--space-5);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
  }

  .ticker-icon {
    font-size: 1.25rem;
  }

  .ticker-text {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--color-text);
  }

  .ticker-subtext {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    margin-left: var(--space-1);
  }

  .ticker-dots {
    position: absolute;
    bottom: 6px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
  }

  .ticker-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-border);
    transition: all 0.2s ease;
  }

  .ticker-dot.active {
    background: var(--color-primary);
    width: 18px;
    border-radius: 3px;
  }

  /* Train specific styling */
  .ticker-train {
    display: flex;
    align-items: center;
    gap: var(--space-2);
  }

  .ticker-badge {
    background: #16a34a;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .ticker-time {
    font-weight: 700;
    color: var(--color-primary);
  }

  .ticker-dest {
    color: var(--color-text-secondary);
    font-size: 0.8125rem;
  }
</style>

<script>
  interface Slide {
    icon: string;
    text: string;
    subtext?: string;
    html?: string;
  }

  const WEATHER_API = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
  const TRAIN_API = 'https://dbf.finalrewind.org';

  function getWeatherEmoji(code: number): string {
    if (code === 0) return '‚òÄÔ∏è';
    if (code <= 3) return '‚õÖ';
    if (code <= 48) return '‚òÅÔ∏è';
    if (code <= 67) return 'üåßÔ∏è';
    if (code <= 77) return 'üå®Ô∏è';
    return '‚òÅÔ∏è';
  }

  function formatTime(iso: string): string {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  async function fetchData(): Promise<Slide[]> {
    const slides: Slide[] = [];

    // Fetch weather
    try {
      const res = await fetch(WEATHER_API);
      const data = await res.json();
      const temp = Math.round(data.current?.temperature_2m || 0);
      const code = data.current?.weather_code || 0;
      const sunrise = data.daily?.sunrise?.[0] ? formatTime(data.daily.sunrise[0]) : '7:30';
      const sunset = data.daily?.sunset?.[0] ? formatTime(data.daily.sunset[0]) : '17:20';

      slides.push({
        icon: getWeatherEmoji(code),
        text: `${temp}¬∞C`,
        subtext: 'Starnberg'
      });

      slides.push({
        icon: 'üíß',
        text: '4¬∞C',
        subtext: 'Wassertemp.'
      });

      slides.push({
        icon: 'üåÖ',
        text: `‚Üë ${sunrise}`,
        subtext: `‚Üì ${sunset}`
      });
    } catch {
      slides.push({ icon: 'üå°Ô∏è', text: 'Wetter nicht verf√ºgbar' });
    }

    // Fetch trains
    try {
      const res = await fetch(`${TRAIN_API}/Possenhofen.json?version=3`);
      const data = await res.json();
      const trains = (data.departures || [])
        .filter((d: any) => !d.isCancelled && d.train.startsWith('S '))
        .slice(0, 2);

      if (trains.length > 0) {
        const t = trains[0];
        const dest = t.destination
          .replace(/\s*\([^)]*\)/g, '')
          .replace(/ Hbf$/, '')
          .replace(/^M√ºnchen /, 'M-');
        const delay = t.delayDeparture > 0 ? ` +${t.delayDeparture}` : '';
        
        slides.push({
          icon: 'üöÜ',
          text: '',
          html: `<span class="ticker-train">
            <span class="ticker-badge">S6</span>
            <span class="ticker-time">${t.scheduledDeparture}${delay}</span>
            <span class="ticker-dest">‚Üí ${dest}</span>
          </span>`
        });
      }
    } catch {
      // Skip train if error
    }

    return slides;
  }

  function renderSlides(slides: Slide[]): void {
    const track = document.getElementById('ticker-track');
    const dots = document.getElementById('ticker-dots');
    if (!track || !dots) return;

    track.innerHTML = slides.map((s, i) => `
      <div class="ticker-slide" data-slide="${i}">
        <span class="ticker-icon">${s.icon}</span>
        ${s.html || `<span class="ticker-text">${s.text}</span>${s.subtext ? `<span class="ticker-subtext">${s.subtext}</span>` : ''}`}
      </div>
    `).join('');

    dots.innerHTML = slides.map((_, i) => `
      <div class="ticker-dot${i === 0 ? ' active' : ''}" data-dot="${i}"></div>
    `).join('');
  }

  function startCarousel(slideCount: number): void {
    const track = document.getElementById('ticker-track');
    const dots = document.getElementById('ticker-dots');
    if (!track || !dots || slideCount < 2) return;

    let current = 0;
    const interval = 4000; // 4 seconds per slide

    setInterval(() => {
      current = (current + 1) % slideCount;
      track.style.transform = `translateX(-${current * 100}%)`;
      
      dots.querySelectorAll('.ticker-dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === current);
      });
    }, interval);

    // Touch swipe support
    let touchStart = 0;
    track.addEventListener('touchstart', (e) => {
      touchStart = e.touches[0].clientX;
    }, { passive: true });

    track.addEventListener('touchend', (e) => {
      const diff = touchStart - e.changedTouches[0].clientX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          current = (current + 1) % slideCount;
        } else {
          current = (current - 1 + slideCount) % slideCount;
        }
        track.style.transform = `translateX(-${current * 100}%)`;
        dots.querySelectorAll('.ticker-dot').forEach((dot, i) => {
          dot.classList.toggle('active', i === current);
        });
      }
    }, { passive: true });
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const slides = await fetchData();
    renderSlides(slides);
    startCarousel(slides.length);
  });
</script>
