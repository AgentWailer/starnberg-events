---
// Continuous news ticker for mobile - horizontal scrolling marquee
---

<div class="info-ticker" id="info-ticker" role="marquee" aria-label="Aktuelle Informationen">
  <div class="ticker-track" id="ticker-track">
    <!-- Content will be duplicated for seamless loop -->
    <div class="ticker-content" id="ticker-content">
      <!-- Wetter -->
      <span class="ticker-item" data-type="weather">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <span class="ticker-value" id="weather-temp">--Â°</span>
        <span class="ticker-label">Starnberg</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Wassertemperatur -->
      <span class="ticker-item" data-type="water">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
        </svg>
        <span class="ticker-value" id="water-temp">--Â°</span>
        <span class="ticker-label">Seetemperatur</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Sonnenaufgang -->
      <span class="ticker-item" data-type="sunrise">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 18a5 5 0 0 0-10 0"/>
          <line x1="12" y1="2" x2="12" y2="9"/>
          <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/>
          <line x1="1" y1="18" x2="3" y2="18"/>
          <line x1="21" y1="18" x2="23" y2="18"/>
          <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/>
          <polyline points="8 6 12 2 16 6"/>
        </svg>
        <span class="ticker-value" id="sunrise-time">--:--</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Sonnenuntergang -->
      <span class="ticker-item" data-type="sunset">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 18a5 5 0 0 0-10 0"/>
          <line x1="12" y1="9" x2="12" y2="2"/>
          <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/>
          <line x1="1" y1="18" x2="3" y2="18"/>
          <line x1="21" y1="18" x2="23" y2="18"/>
          <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/>
          <polyline points="16 6 12 10 8 6"/>
        </svg>
        <span class="ticker-value" id="sunset-time">--:--</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- S-Bahn MÃ¼nchen -->
      <a class="ticker-item ticker-link" data-type="train" href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank" rel="noopener">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="3" width="16" height="16" rx="2"/>
          <path d="M4 11h16"/>
          <path d="M12 3v8"/>
          <circle cx="8" cy="15" r="1"/>
          <circle cx="16" cy="15" r="1"/>
          <path d="M8 19l-2 3"/>
          <path d="M16 19l2 3"/>
        </svg>
        <span class="ticker-badge">S6</span>
        <span class="ticker-value" id="train-munich">--:--</span>
        <span class="ticker-label">â†’ MÃ¼nchen</span>
      </a>

      <span class="ticker-divider">|</span>

      <!-- S-Bahn Tutzing -->
      <a class="ticker-item ticker-link" data-type="train" href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank" rel="noopener">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="3" width="16" height="16" rx="2"/>
          <path d="M4 11h16"/>
          <path d="M12 3v8"/>
          <circle cx="8" cy="15" r="1"/>
          <circle cx="16" cy="15" r="1"/>
          <path d="M8 19l-2 3"/>
          <path d="M16 19l2 3"/>
        </svg>
        <span class="ticker-badge">S6</span>
        <span class="ticker-value" id="train-tutzing">--:--</span>
        <span class="ticker-label">â†’ Tutzing</span>
      </a>

      <!-- S6 PÃ¼nktlichkeit (dynamisch eingeblendet) -->
      <span class="ticker-divider ticker-punctuality-sep" id="ticker-punct-sep" style="display:none;">|</span>
      <a class="ticker-item ticker-link ticker-punctuality" id="ticker-punctuality" href="/s6" style="display:none;">
        <span class="ticker-punct-dot" id="ticker-punct-dot"></span>
        <span class="ticker-value" id="ticker-punct-value">â€“%</span>
        <span class="ticker-label">S6 pÃ¼nktlich</span>
      </a>

      <span class="ticker-divider">|</span>
    </div>
    <!-- Duplicate for seamless loop -->
    <div class="ticker-content ticker-clone" aria-hidden="true"></div>
  </div>
</div>

<style>
  .info-ticker {
    display: none;
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    overflow: hidden;
    position: relative;
  }

  @media (max-width: 767px) {
    .info-ticker {
      display: block;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: var(--space-4);
    }
  }

  :root.dark .info-ticker {
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .ticker-track {
    display: flex;
    width: max-content;
    will-change: transform;
    /* Animation controlled by JS for drag support */
  }

  .ticker-track.animating {
    transition: none;
  }

  .ticker-content {
    display: flex;
    align-items: center;
    gap: 0;
    padding: var(--space-3) 0;
    white-space: nowrap;
  }

  .ticker-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0 var(--space-4);
    color: var(--color-text-secondary);
    font-size: 0.8125rem;
  }

  .ticker-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    opacity: 0.7;
  }

  .ticker-value {
    font-weight: 600;
    color: var(--color-text);
    font-variant-numeric: tabular-nums;
  }

  .ticker-label {
    color: var(--color-muted);
    font-size: 0.75rem;
  }

  .ticker-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 1px 5px;
    background: #16a34a;
    color: white;
    border-radius: 3px;
    font-size: 0.625rem;
    font-weight: 700;
    line-height: 1.2;
  }

  .ticker-punct-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--color-muted, #999);
    flex-shrink: 0;
  }
  .ticker-punct-dot.good { background: #16a34a; }
  .ticker-punct-dot.mid  { background: #d97706; }
  .ticker-punct-dot.bad  { background: #dc2626; }
  :root.dark .ticker-punct-dot.good { background: #4ade80; }
  :root.dark .ticker-punct-dot.mid  { background: #fbbf24; }
  :root.dark .ticker-punct-dot.bad  { background: #f87171; }

  .ticker-divider {
    color: var(--color-border);
    font-weight: 300;
    font-size: 1rem;
    padding: 0 var(--space-2);
    opacity: 0.5;
  }

  /* Train link styling */
  .ticker-link {
    text-decoration: none;
    color: inherit;
    cursor: pointer;
  }

  .ticker-link:hover {
    opacity: 0.8;
  }

  .ticker-link:active {
    opacity: 0.6;
  }

  /* Train delay styling - RED */
  :global(.delay) {
    color: #dc2626 !important;
    font-weight: 600;
    font-size: 0.75rem;
    margin-left: 3px;
  }

  /* Tomorrow/next day label */
  :global(.tomorrow) {
    color: var(--color-muted);
    font-size: 0.6875rem;
    font-weight: 500;
    margin-right: 3px;
  }

  /* No train available */
  :global(.no-train) {
    color: var(--color-muted);
  }

  /* Reduced motion - no scroll, just static display */
  @media (prefers-reduced-motion: reduce) {
    .ticker-track {
      animation: none;
    }
    
    .ticker-clone {
      display: none;
    }
  }
</style>

<script>
  const WEATHER_API = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
  // Use transport.rest API - shows more departures including next day
  const TRAIN_API = 'https://v6.db.transport.rest/stops/8004874/departures?duration=1440&suburban=true';

  // Ticker state
  let track: HTMLElement | null = null;
  let contentWidth = 0;
  let position = 0;
  let speed = 50; // pixels per second
  let lastTime = 0;
  let isDragging = false;
  let startX = 0;
  let startPosition = 0;
  let animationId: number | null = null;

  function formatTime(iso: string): string {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  // Clone ticker content for seamless loop
  function setupTickerLoop(): void {
    const content = document.getElementById('ticker-content');
    const clone = document.querySelector('.ticker-clone') as HTMLElement;
    if (content && clone) {
      clone.innerHTML = content.innerHTML;
      // Get width of single content block
      contentWidth = content.offsetWidth;
    }
  }

  // Animation loop
  function animate(currentTime: number): void {
    if (!track) return;

    if (lastTime === 0) lastTime = currentTime;
    const delta = (currentTime - lastTime) / 1000; // seconds
    lastTime = currentTime;

    if (!isDragging) {
      // Auto-scroll
      position -= speed * delta;

      // Loop when scrolled past content width
      if (position <= -contentWidth) {
        position += contentWidth;
      }
      if (position > 0) {
        position -= contentWidth;
      }

      track.style.transform = `translateX(${position}px)`;
    }

    animationId = requestAnimationFrame(animate);
  }

  // Touch/drag handling
  function setupDragHandling(): void {
    if (!track) return;
    const ticker = document.getElementById('info-ticker');
    if (!ticker) return;

    let hasMoved = false;
    let touchTarget: EventTarget | null = null;
    const TAP_THRESHOLD = 10; // pixels - if moved less, it's a tap

    // Touch start
    ticker.addEventListener('touchstart', (e) => {
      isDragging = true;
      hasMoved = false;
      touchTarget = e.target;
      startX = e.touches[0].clientX;
      startPosition = position;
      track!.classList.add('animating');
    }, { passive: true });

    // Touch move - drag the ticker
    ticker.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      const currentX = e.touches[0].clientX;
      const diff = currentX - startX;
      
      // Check if user has moved enough to consider it a drag
      if (Math.abs(diff) > TAP_THRESHOLD) {
        hasMoved = true;
      }
      
      position = startPosition + diff;

      // Keep position in bounds
      while (position <= -contentWidth) position += contentWidth;
      while (position > 0) position -= contentWidth;

      track!.style.transform = `translateX(${position}px)`;
    }, { passive: true });

    // Touch end - handle tap vs drag
    ticker.addEventListener('touchend', (e) => {
      isDragging = false;
      track!.classList.remove('animating');
      
      // If it was a tap (not a drag), check if target was a link
      if (!hasMoved && touchTarget) {
        const link = (touchTarget as Element).closest('a.ticker-link');
        if (link) {
          // Open the link
          window.open((link as HTMLAnchorElement).href, '_blank');
        }
      }
      // Auto-scroll continues from current position
    }, { passive: true });

    // Mouse support for desktop testing
    ticker.addEventListener('mousedown', (e) => {
      // Don't prevent default on links
      if ((e.target as Element).closest('a.ticker-link')) {
        return; // Let the link work normally
      }
      isDragging = true;
      startX = e.clientX;
      startPosition = position;
      track!.classList.add('animating');
      e.preventDefault();
    });

    window.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      const diff = e.clientX - startX;
      position = startPosition + diff;

      while (position <= -contentWidth) position += contentWidth;
      while (position > 0) position -= contentWidth;

      track!.style.transform = `translateX(${position}px)`;
    });

    window.addEventListener('mouseup', () => {
      if (isDragging) {
        isDragging = false;
        track!.classList.remove('animating');
      }
    });
  }

  // Load weather data
  async function loadWeather(): Promise<void> {
    try {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 6000);

      const res = await fetch(WEATHER_API, { signal: ctrl.signal });
      clearTimeout(timer);

      if (!res.ok) throw new Error('API error');
      const data = await res.json();

      // Temperature
      const temp = Math.round(data.current?.temperature_2m || 0);
      document.querySelectorAll('#weather-temp').forEach(el => {
        el.textContent = temp + 'Â°';
      });

      // Sunrise
      const sunrise = data.daily?.sunrise?.[0];
      if (sunrise) {
        document.querySelectorAll('#sunrise-time').forEach(el => {
          el.textContent = formatTime(sunrise);
        });
      }

      // Sunset
      const sunset = data.daily?.sunset?.[0];
      if (sunset) {
        document.querySelectorAll('#sunset-time').forEach(el => {
          el.textContent = formatTime(sunset);
        });
      }
    } catch (e) {
      console.error('Weather error:', e);
    }
  }

  // Load water temperature (seasonal fallback due to CORS)
  async function loadWaterTemp(): Promise<void> {
    // Seasonal estimate for Starnberger See (CORS prevents direct fetch)
    const month = new Date().getMonth();
    let estimate: number;
    if (month >= 5 && month <= 7) {
      estimate = 18 + Math.floor(Math.random() * 5); // Summer: 18-22Â°C
    } else if (month >= 3 && month <= 4) {
      estimate = 8 + Math.floor(Math.random() * 4); // Spring: 8-11Â°C
    } else if (month >= 8 && month <= 10) {
      estimate = 12 + Math.floor(Math.random() * 4); // Fall: 12-15Â°C
    } else {
      estimate = 4 + Math.floor(Math.random() * 2); // Winter: 4-5Â°C
    }

    document.querySelectorAll('#water-temp').forEach(el => {
      el.textContent = estimate + 'Â°';
    });
  }

  // Format train time - show "morgen" if next day (using local time!)
  function formatTrainTime(dep: any): string {
    const when = new Date(dep.when || dep.plannedWhen);
    const time = when.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
    
    // Calculate delay in minutes
    const delayMin = dep.delay ? Math.round(dep.delay / 60) : 0;
    const delayHtml = delayMin > 0 ? `<span class="delay">+${delayMin}</span>` : '';
    
    // Check if departure is tomorrow or later (LOCAL time comparison!)
    const today = new Date();
    const todayDate = today.toLocaleDateString('de-DE');
    const depDate = when.toLocaleDateString('de-DE');
    
    if (depDate !== todayDate) {
      // Tomorrow or later - show day
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowDate = tomorrow.toLocaleDateString('de-DE');
      
      if (depDate === tomorrowDate) {
        return `<span class="tomorrow">morgen</span> ${time}${delayHtml}`;
      } else {
        // Show weekday
        const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
        const dayName = days[when.getDay()];
        return `<span class="tomorrow">${dayName}</span> ${time}${delayHtml}`;
      }
    }
    
    return time + delayHtml;
  }

  // Load train departures
  async function loadTrains(): Promise<void> {
    try {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 8000);

      const res = await fetch(TRAIN_API, { signal: ctrl.signal });
      clearTimeout(timer);

      if (!res.ok) throw new Error('API error');
      const data = await res.json();

      // API returns { departures: [...] }
      const departures = data.departures || [];

      // Filter for S-Bahn or SEV Bus (line.name contains 'S6' or similar)
      // Also filter out "ghost trains" - trains with huge delays (>60 min) are likely cancelled
      const validDepartures = departures.filter((d: any) => {
        const line = d.line;
        if (!line) return false;
        
        // Must be S-Bahn or SEV Bus
        const isS6 = line.name && (line.name.includes('S6') || line.name === 'S6');
        if (!isS6) return false;
        
        // Filter out cancelled
        if (d.cancelled) return false;
        
        // Filter out ghost trains (delay > 60 minutes likely means cancelled)
        const delayMin = d.delay ? d.delay / 60 : 0;
        if (delayMin > 60) return false;
        
        return true;
      });

      // Classify by direction: from Possenhofen, only Tutzing and Feldafing are south.
      // Everything else (Haar, Ebersberg, Erding, Grafing, MÃ¼nchen, etc.) is direction MÃ¼nchen.
      const isTutzingDir = (d: any) => {
        const dir = d.direction || '';
        return dir.includes('Tutzing') || dir.includes('Feldafing');
      };

      const toMunich = validDepartures.find((d: any) => !isTutzingDir(d));
      const toTutzing = validDepartures.find((d: any) => isTutzingDir(d));

      // Update MÃ¼nchen
      if (toMunich) {
        const timeHtml = formatTrainTime(toMunich);
        const isBus = toMunich.line?.name?.includes('Bus');
        document.querySelectorAll('#train-munich').forEach(el => {
          el.innerHTML = (isBus ? 'ðŸšŒ ' : '') + timeHtml;
        });
      } else {
        document.querySelectorAll('#train-munich').forEach(el => {
          el.innerHTML = '<span class="no-train">â€“</span>';
        });
      }

      // Update Tutzing
      if (toTutzing) {
        const timeHtml = formatTrainTime(toTutzing);
        const isBus = toTutzing.line?.name?.includes('Bus');
        document.querySelectorAll('#train-tutzing').forEach(el => {
          el.innerHTML = (isBus ? 'ðŸšŒ ' : '') + timeHtml;
        });
      } else {
        document.querySelectorAll('#train-tutzing').forEach(el => {
          el.innerHTML = '<span class="no-train">â€“</span>';
        });
      }
    } catch (e) {
      console.error('Train error:', e);
    }
  }

  // S6 Punctuality from Worker
  async function loadPunctuality(): Promise<void> {
    try {
      const resp = await fetch('https://train-tracker.steffenvonlindern-be7.workers.dev/api/stats?period=week');
      if (!resp.ok) return;
      const data = await resp.json();
      const o = data.overall;
      if (!o || o.total === 0) return;

      const onTime = o.on_time || 0;
      const total = (onTime) + (o.delayed || 0) + (o.cancelled || 0);
      if (total === 0) return;

      const rate = Math.round((onTime / total) * 100);
      const cls = rate >= 80 ? 'good' : rate >= 60 ? 'mid' : 'bad';

      document.querySelectorAll('#ticker-punct-dot').forEach(el => {
        el.className = 'ticker-punct-dot ' + cls;
      });
      document.querySelectorAll('#ticker-punct-value').forEach(el => {
        el.textContent = rate + '%';
      });
      document.querySelectorAll('#ticker-punct-sep, #ticker-punctuality').forEach(el => {
        (el as HTMLElement).style.display = '';
      });
    } catch (e) { /* silent */ }
  }

  // Update cloned content after data loads
  function updateClone(): void {
    const content = document.getElementById('ticker-content');
    const clone = document.querySelector('.ticker-clone') as HTMLElement;
    if (content && clone) {
      clone.innerHTML = content.innerHTML;
      contentWidth = content.offsetWidth;
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    track = document.getElementById('ticker-track');
    
    setupTickerLoop();
    setupDragHandling();

    // Load data
    await Promise.all([
      loadWeather(),
      loadWaterTemp(),
      loadTrains(),
      loadPunctuality()
    ]);

    // Update clone after data loaded
    updateClone();

    // Start animation (respects reduced motion)
    if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      animationId = requestAnimationFrame(animate);
    }

    // Refresh trains every minute
    setInterval(async () => {
      await loadTrains();
      updateClone();
    }, 60000);
  });

  // Cleanup
  window.addEventListener('pagehide', () => {
    if (animationId) cancelAnimationFrame(animationId);
  });
</script>
