---
// Mobile info carousel - cycles through weather, water, sun times, train
---

<div class="info-carousel" id="info-carousel">
  <div class="carousel-track" id="carousel-track">
    <div class="carousel-slide active" data-slide="0">
      <span class="slide-icon">‚òÄÔ∏è</span>
      <span class="slide-content">
        <span class="slide-value" id="temp-value">--¬∞</span>
        <span class="slide-label">Starnberg</span>
      </span>
    </div>
    <div class="carousel-slide" data-slide="1">
      <span class="slide-icon">üíß</span>
      <span class="slide-content">
        <span class="slide-value">4¬∞</span>
        <span class="slide-label">Wassertemperatur</span>
      </span>
    </div>
    <div class="carousel-slide" data-slide="2">
      <span class="slide-icon">üåÖ</span>
      <span class="slide-content">
        <span class="slide-value" id="sun-value">--:-- ‚Äì --:--</span>
        <span class="slide-label">Sonnenauf- & untergang</span>
      </span>
    </div>
    <div class="carousel-slide" data-slide="3">
      <span class="slide-icon">üöÜ</span>
      <span class="slide-content">
        <span class="slide-value" id="train-value">--:--</span>
        <span class="slide-label" id="train-label">S-Bahn Possenhofen</span>
      </span>
    </div>
  </div>
  <div class="carousel-dots">
    <button class="dot active" data-dot="0" aria-label="Wetter"></button>
    <button class="dot" data-dot="1" aria-label="Wassertemperatur"></button>
    <button class="dot" data-dot="2" aria-label="Sonnenzeiten"></button>
    <button class="dot" data-dot="3" aria-label="S-Bahn"></button>
  </div>
</div>

<style>
  .info-carousel {
    display: none;
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-4) var(--space-5);
    position: relative;
    overflow: hidden;
  }

  @media (max-width: 767px) {
    .info-carousel {
      display: block;
    }
  }

  .carousel-track {
    position: relative;
    height: 48px;
  }

  .carousel-slide {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    gap: var(--space-3);
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    pointer-events: none;
  }

  .carousel-slide.active {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .slide-icon {
    font-size: 1.5rem;
    line-height: 1;
  }

  .slide-content {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .slide-value {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    letter-spacing: -0.02em;
  }

  .slide-label {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .carousel-dots {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-3);
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: var(--color-border);
    cursor: pointer;
    padding: 18px;
    margin: -18px var(--space-1);
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .dot:hover {
    background: var(--color-muted);
  }

  .dot.active {
    background: var(--color-primary);
    transform: scale(1.2);
  }

  .dot:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  .dot:focus:not(:focus-visible) {
    outline: none;
  }

  @media (prefers-reduced-motion: reduce) {
    .carousel-slide {
      transition: none;
    }
    
    .dot {
      transition: none;
    }
  }
</style>

<script>
  const WEATHER_API = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
  const TRAIN_API = 'https://dbf.finalrewind.org/Possenhofen.json?version=3';

  let currentSlide = 0;
  const totalSlides = 4;
  let autoplayInterval = null;
  let isPaused = false;

  function showSlide(index) {
    const slides = document.querySelectorAll('.carousel-slide');
    const dots = document.querySelectorAll('.dot');
    
    slides.forEach((slide, i) => {
      slide.classList.toggle('active', i === index);
    });
    
    dots.forEach((dot, i) => {
      dot.classList.toggle('active', i === index);
    });
    
    currentSlide = index;
  }

  function nextSlide() {
    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    if (!isPaused && !prefersReducedMotion) {
      showSlide((currentSlide + 1) % totalSlides);
    }
  }

  function startAutoplay() {
    if (autoplayInterval) clearInterval(autoplayInterval);
    autoplayInterval = setInterval(nextSlide, 4000);
  }

  function formatTime(iso) {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  async function loadWeather() {
    try {
      const res = await fetch(WEATHER_API);
      const data = await res.json();
      
      // Temperature
      const temp = Math.round(data.current?.temperature_2m || 0);
      const tempEl = document.getElementById('temp-value');
      if (tempEl) tempEl.textContent = temp + '¬∞';
      
      // Sunrise/Sunset
      const sunrise = data.daily?.sunrise?.[0];
      const sunset = data.daily?.sunset?.[0];
      if (sunrise && sunset) {
        const sunEl = document.getElementById('sun-value');
        if (sunEl) sunEl.textContent = formatTime(sunrise) + ' ‚Äì ' + formatTime(sunset);
      }
    } catch (e) {
      console.error('Weather error:', e);
    }
  }

  async function loadTrain() {
    try {
      const res = await fetch(TRAIN_API);
      const data = await res.json();
      
      const train = (data.departures || [])
        .filter(function(d) { return !d.isCancelled && d.train && d.train.startsWith('S '); })
        .slice(0, 1)[0];
      
      if (train) {
        const trainEl = document.getElementById('train-value');
        const labelEl = document.getElementById('train-label');
        
        const delay = train.delayDeparture > 0 ? ' +' + train.delayDeparture : '';
        const dest = train.destination
          .replace(/\s*\([^)]*\)/g, '')
          .replace(/ Hbf$/, '')
          .replace(/^M√ºnchen /, 'M-');
        
        if (trainEl) trainEl.textContent = train.scheduledDeparture + delay;
        if (labelEl) labelEl.textContent = 'S6 ‚Üí ' + dest;
      }
    } catch (e) {
      console.error('Train error:', e);
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('info-carousel');
    let touchStartX = 0;
    let touchEndX = 0;

    // Pause on hover
    if (carousel) {
      carousel.addEventListener('mouseenter', function() {
        isPaused = true;
      });
      
      carousel.addEventListener('mouseleave', function() {
        isPaused = false;
      });
    }

    // Dot click handlers
    document.querySelectorAll('.dot').forEach(function(dot) {
      dot.addEventListener('click', function() {
        const index = parseInt(this.getAttribute('data-dot') || '0');
        showSlide(index);
        startAutoplay(); // Reset autoplay on manual navigation
      });
    });

    // Touch swipe support

    if (carousel) {
      carousel.addEventListener('touchstart', function(e) {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      carousel.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].screenX;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            // Swipe left - next slide
            showSlide((currentSlide + 1) % totalSlides);
          } else {
            // Swipe right - previous slide
            showSlide((currentSlide - 1 + totalSlides) % totalSlides);
          }
          startAutoplay();
        }
      }, { passive: true });
    }

    // Load data and start
    loadWeather();
    loadTrain();
    startAutoplay();
  });

  // Cleanup interval on navigation
  window.addEventListener('pagehide', function() {
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
    }
  });
</script>
