---
// Continuous news ticker for mobile - horizontal scrolling marquee
---

<div class="info-ticker" id="info-ticker" role="marquee" aria-label="Aktuelle Informationen">
  <div class="ticker-track" id="ticker-track">
    <!-- Content will be duplicated for seamless loop -->
    <div class="ticker-content" id="ticker-content">
      <!-- Wetter -->
      <span class="ticker-item" data-type="weather">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <span class="ticker-value" id="weather-temp">--°</span>
        <span class="ticker-label">Starnberg</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Wassertemperatur -->
      <span class="ticker-item" data-type="water">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
        </svg>
        <span class="ticker-value" id="water-temp">--°</span>
        <span class="ticker-label">Seetemperatur</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Sonnenaufgang -->
      <span class="ticker-item" data-type="sunrise">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 18a5 5 0 0 0-10 0"/>
          <line x1="12" y1="2" x2="12" y2="9"/>
          <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/>
          <line x1="1" y1="18" x2="3" y2="18"/>
          <line x1="21" y1="18" x2="23" y2="18"/>
          <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/>
          <polyline points="8 6 12 2 16 6"/>
        </svg>
        <span class="ticker-value" id="sunrise-time">--:--</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- Sonnenuntergang -->
      <span class="ticker-item" data-type="sunset">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 18a5 5 0 0 0-10 0"/>
          <line x1="12" y1="9" x2="12" y2="2"/>
          <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/>
          <line x1="1" y1="18" x2="3" y2="18"/>
          <line x1="21" y1="18" x2="23" y2="18"/>
          <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/>
          <polyline points="16 6 12 10 8 6"/>
        </svg>
        <span class="ticker-value" id="sunset-time">--:--</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- S-Bahn München -->
      <span class="ticker-item" data-type="train">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="3" width="16" height="16" rx="2"/>
          <path d="M4 11h16"/>
          <path d="M12 3v8"/>
          <circle cx="8" cy="15" r="1"/>
          <circle cx="16" cy="15" r="1"/>
          <path d="M8 19l-2 3"/>
          <path d="M16 19l2 3"/>
        </svg>
        <span class="ticker-badge">S6</span>
        <span class="ticker-value" id="train-munich">--:--</span>
        <span class="ticker-label">→ München</span>
      </span>

      <span class="ticker-divider">|</span>

      <!-- S-Bahn Tutzing -->
      <span class="ticker-item" data-type="train">
        <svg class="ticker-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="4" y="3" width="16" height="16" rx="2"/>
          <path d="M4 11h16"/>
          <path d="M12 3v8"/>
          <circle cx="8" cy="15" r="1"/>
          <circle cx="16" cy="15" r="1"/>
          <path d="M8 19l-2 3"/>
          <path d="M16 19l2 3"/>
        </svg>
        <span class="ticker-badge">S6</span>
        <span class="ticker-value" id="train-tutzing">--:--</span>
        <span class="ticker-label">→ Tutzing</span>
      </span>

      <span class="ticker-divider">|</span>
    </div>
    <!-- Duplicate for seamless loop -->
    <div class="ticker-content ticker-clone" aria-hidden="true"></div>
  </div>
</div>

<style>
  .info-ticker {
    display: none;
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
    overflow: hidden;
    position: relative;
  }

  @media (max-width: 767px) {
    .info-ticker {
      display: block;
    }
  }

  .ticker-track {
    display: flex;
    width: max-content;
    animation: ticker-scroll 30s linear infinite;
  }

  .ticker-track:hover,
  .ticker-track.paused {
    animation-play-state: paused;
  }

  @keyframes ticker-scroll {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  .ticker-content {
    display: flex;
    align-items: center;
    gap: 0;
    padding: var(--space-3) 0;
    white-space: nowrap;
  }

  .ticker-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 0 var(--space-4);
    color: var(--color-text-secondary);
    font-size: 0.8125rem;
  }

  .ticker-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    opacity: 0.7;
  }

  .ticker-value {
    font-weight: 600;
    color: var(--color-text);
    font-variant-numeric: tabular-nums;
  }

  .ticker-label {
    color: var(--color-muted);
    font-size: 0.75rem;
  }

  .ticker-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 1px 5px;
    background: #16a34a;
    color: white;
    border-radius: 3px;
    font-size: 0.625rem;
    font-weight: 700;
    line-height: 1.2;
  }

  .ticker-divider {
    color: var(--color-border);
    font-weight: 300;
    font-size: 1rem;
    padding: 0 var(--space-2);
    opacity: 0.5;
  }

  /* Train delay styling */
  .ticker-value .delay {
    color: #dc2626;
    font-size: 0.6875rem;
    margin-left: 2px;
  }

  /* Reduced motion - no scroll, just static display */
  @media (prefers-reduced-motion: reduce) {
    .ticker-track {
      animation: none;
    }
    
    .ticker-clone {
      display: none;
    }
  }
</style>

<script>
  const WEATHER_API = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
  const TRAIN_API = 'https://dbf.finalrewind.org/Possenhofen.json?version=3';

  function formatTime(iso: string): string {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  // Clone ticker content for seamless loop
  function setupTickerLoop(): void {
    const content = document.getElementById('ticker-content');
    const clone = document.querySelector('.ticker-clone') as HTMLElement;
    if (content && clone) {
      clone.innerHTML = content.innerHTML;
    }
  }

  // Tap to pause/resume
  function setupTapToPause(): void {
    const track = document.getElementById('ticker-track');
    if (!track) return;

    track.addEventListener('click', () => {
      track.classList.toggle('paused');
    });

    // Touch also pauses while touching
    track.addEventListener('touchstart', () => {
      track.classList.add('paused');
    }, { passive: true });

    track.addEventListener('touchend', () => {
      // Resume after short delay
      setTimeout(() => {
        track.classList.remove('paused');
      }, 2000);
    }, { passive: true });
  }

  // Load weather data
  async function loadWeather(): Promise<void> {
    try {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 6000);

      const res = await fetch(WEATHER_API, { signal: ctrl.signal });
      clearTimeout(timer);

      if (!res.ok) throw new Error('API error');
      const data = await res.json();

      // Temperature
      const temp = Math.round(data.current?.temperature_2m || 0);
      document.querySelectorAll('#weather-temp').forEach(el => {
        el.textContent = temp + '°';
      });

      // Sunrise
      const sunrise = data.daily?.sunrise?.[0];
      if (sunrise) {
        document.querySelectorAll('#sunrise-time').forEach(el => {
          el.textContent = formatTime(sunrise);
        });
      }

      // Sunset
      const sunset = data.daily?.sunset?.[0];
      if (sunset) {
        document.querySelectorAll('#sunset-time').forEach(el => {
          el.textContent = formatTime(sunset);
        });
      }
    } catch (e) {
      console.error('Weather error:', e);
    }
  }

  // Load water temperature (seasonal fallback due to CORS)
  async function loadWaterTemp(): Promise<void> {
    // Seasonal estimate for Starnberger See (CORS prevents direct fetch)
    const month = new Date().getMonth();
    let estimate: number;
    if (month >= 5 && month <= 7) {
      estimate = 18 + Math.floor(Math.random() * 5); // Summer: 18-22°C
    } else if (month >= 3 && month <= 4) {
      estimate = 8 + Math.floor(Math.random() * 4); // Spring: 8-11°C
    } else if (month >= 8 && month <= 10) {
      estimate = 12 + Math.floor(Math.random() * 4); // Fall: 12-15°C
    } else {
      estimate = 4 + Math.floor(Math.random() * 2); // Winter: 4-5°C
    }

    document.querySelectorAll('#water-temp').forEach(el => {
      el.textContent = estimate + '°';
    });
  }

  // Load train departures
  async function loadTrains(): Promise<void> {
    try {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 8000);

      const res = await fetch(TRAIN_API, { signal: ctrl.signal });
      clearTimeout(timer);

      if (!res.ok) throw new Error('API error');
      const data = await res.json();

      const departures = data.departures || [];

      // Filter for S-Bahn only
      const sBahns = departures.filter((d: any) =>
        !d.isCancelled && d.train && d.train.startsWith('S ')
      );

      // Find München direction
      const toMunich = sBahns.find((d: any) =>
        d.destination.includes('München') ||
        d.destination.includes('Pasing') ||
        d.destination.includes('Ostbahnhof')
      );

      // Find Tutzing direction
      const toTutzing = sBahns.find((d: any) =>
        d.destination.includes('Tutzing') ||
        d.destination.includes('Starnberg') ||
        (!d.destination.includes('München') && !d.destination.includes('Pasing'))
      );

      // Update München
      if (toMunich) {
        const delay = toMunich.delayDeparture > 0 ? `<span class="delay">+${toMunich.delayDeparture}</span>` : '';
        document.querySelectorAll('#train-munich').forEach(el => {
          el.innerHTML = toMunich.scheduledDeparture + delay;
        });
      }

      // Update Tutzing
      if (toTutzing) {
        const delay = toTutzing.delayDeparture > 0 ? `<span class="delay">+${toTutzing.delayDeparture}</span>` : '';
        document.querySelectorAll('#train-tutzing').forEach(el => {
          el.innerHTML = toTutzing.scheduledDeparture + delay;
        });
      }
    } catch (e) {
      console.error('Train error:', e);
    }
  }

  // Update cloned content after data loads
  function updateClone(): void {
    const content = document.getElementById('ticker-content');
    const clone = document.querySelector('.ticker-clone') as HTMLElement;
    if (content && clone) {
      clone.innerHTML = content.innerHTML;
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    setupTickerLoop();
    setupTapToPause();

    // Load data
    await Promise.all([
      loadWeather(),
      loadWaterTemp(),
      loadTrains()
    ]);

    // Update clone after data loaded
    updateClone();

    // Refresh trains every minute
    setInterval(async () => {
      await loadTrains();
      updateClone();
    }, 60000);
  });
</script>
