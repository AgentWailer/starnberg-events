---
interface Props {
  station?: string;
  stationId?: string;
}

const { station = "Possenhofen", stationId = "8004874" } = Astro.props;
---

<section class="departure-board" data-station-id={stationId}>
  <div class="board-header">
    <div class="station-name">
      <span class="db-logo">DB</span>
      {station}
    </div>
    <div class="board-title">Abfahrt</div>
    <div class="clock" id="station-clock">--:--</div>
  </div>
  
  <div class="board-columns">
    <span class="col-time">Zeit</span>
    <span class="col-train">Zug</span>
    <span class="col-destination">Richtung</span>
    <span class="col-platform">Gl.</span>
  </div>
  
  <div class="departures-list" id="departures">
    <div class="loading-row">
      <span class="loading-text">Daten werden geladen...</span>
    </div>
  </div>
  
  <div class="board-footer">
    <a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" 
       target="_blank" 
       rel="noopener" 
       class="more-link">
      Alle Verbindungen anzeigen →
    </a>
  </div>
</section>

<style>
  .departure-board {
    background: #1a1a2e;
    color: #ffd700;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    font-family: 'Roboto Mono', 'SF Mono', 'Consolas', monospace;
    box-shadow: 
      0 4px 20px rgba(0,0,0,0.4),
      inset 0 1px 0 rgba(255,255,255,0.1);
    border: 2px solid #333;
  }

  .board-header {
    background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 2px solid #333;
  }

  .station-name {
    font-size: 1.1rem;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .db-logo {
    background: #ec0016;
    color: white;
    padding: 0.15rem 0.4rem;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 800;
    letter-spacing: -0.5px;
  }

  .board-title {
    font-size: 0.85rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .clock {
    font-size: 1.4rem;
    font-weight: 700;
    color: #ffd700;
    text-shadow: 0 0 10px rgba(255,215,0,0.5);
  }

  .board-columns {
    display: grid;
    grid-template-columns: 70px 60px 1fr 50px;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #252545;
    font-size: 0.7rem;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 1px solid #333;
  }

  .departures-list {
    min-height: 200px;
  }

  .loading-row {
    padding: 2rem;
    text-align: center;
  }

  .loading-text {
    color: #666;
    font-size: 0.85rem;
    animation: blink 1.5s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .departure-row {
    display: grid;
    grid-template-columns: 70px 60px 1fr 50px;
    gap: 0.5rem;
    padding: 0.6rem 1rem;
    border-bottom: 1px solid #2a2a4a;
    align-items: center;
    transition: background 0.2s;
  }

  .departure-row:hover {
    background: rgba(255,215,0,0.05);
  }

  .departure-row:last-child {
    border-bottom: none;
  }

  .time-cell {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .planned-time {
    font-size: 1.1rem;
    font-weight: 700;
    color: #ffd700;
  }

  .delay-badge {
    font-size: 0.7rem;
    font-weight: 600;
  }

  .delay-badge.late {
    color: #ff4444;
  }

  .delay-badge.on-time {
    color: #44ff44;
  }

  .train-cell {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .line-name {
    font-size: 0.95rem;
    font-weight: 700;
    color: #fff;
    background: #38a169;
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
    display: inline-block;
    width: fit-content;
  }

  .line-name.suburban { background: #38a169; }
  .line-name.regional { background: #3182ce; }

  .destination-cell {
    font-size: 0.95rem;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .via-stops {
    font-size: 0.7rem;
    color: #888;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .platform-cell {
    font-size: 1.1rem;
    font-weight: 700;
    color: #ffd700;
    text-align: center;
  }

  .board-footer {
    background: #252545;
    padding: 0.6rem 1rem;
    text-align: center;
    border-top: 1px solid #333;
  }

  .more-link {
    color: #888;
    text-decoration: none;
    font-size: 0.8rem;
    transition: color 0.2s;
  }

  .more-link:hover {
    color: #ffd700;
  }

  .error-row {
    padding: 1.5rem;
    text-align: center;
    color: #ff6b6b;
    font-size: 0.85rem;
  }

  .info-row {
    padding: 0.75rem 1rem;
    text-align: center;
    color: #ffd700;
    font-size: 0.95rem;
    border-bottom: 1px solid #2a2a4a;
  }

  .info-row.secondary {
    color: #888;
    font-size: 0.85rem;
  }

  .info-row a {
    color: #6b9fff;
    text-decoration: none;
  }

  .info-row a:hover {
    text-decoration: underline;
  }

  @media (max-width: 500px) {
    .board-columns {
      grid-template-columns: 60px 50px 1fr 40px;
      font-size: 0.65rem;
    }

    .departure-row {
      grid-template-columns: 60px 50px 1fr 40px;
      padding: 0.5rem 0.75rem;
    }

    .planned-time {
      font-size: 0.95rem;
    }

    .destination-cell {
      font-size: 0.85rem;
    }

    .platform-cell {
      font-size: 0.95rem;
    }

    .clock {
      font-size: 1.1rem;
    }

    .station-name {
      font-size: 0.95rem;
    }

    .board-title {
      display: none;
    }

    .via-stops {
      display: none;
    }
  }
</style>

<script>
  const API_BASE = 'https://v6.db.transport.rest';
  
  interface Departure {
    when: string | null;
    plannedWhen: string;
    delay: number | null;
    direction: string;
    platform: string | null;
    line: {
      name: string;
      product: string;
    };
    remarks?: Array<{ text: string }>;
  }

  function updateClock(): void {
    const clock = document.getElementById('station-clock');
    if (clock) {
      const now = new Date();
      clock.textContent = now.toLocaleTimeString('de-DE', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }
  }

  async function fetchDepartures(stationId: string, retries = 2): Promise<Departure[]> {
    const url = `${API_BASE}/stops/${stationId}/departures?duration=120&results=15&suburban=true&regional=true`;
    
    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        const response = await fetch(url, {
          headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) {
          if (attempt < retries) {
            await new Promise(r => setTimeout(r, 1000));
            continue;
          }
          throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        return data.departures || [];
      } catch (e) {
        if (attempt === retries) throw e;
        await new Promise(r => setTimeout(r, 1000));
      }
    }
    return [];
  }

  function formatTime(isoString: string): string {
    const date = new Date(isoString);
    return date.toLocaleTimeString('de-DE', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }

  function getDelayInfo(delaySeconds: number | null): { text: string; className: string } {
    if (delaySeconds === null || delaySeconds === undefined || delaySeconds <= 0) {
      return { text: 'pünktlich', className: 'on-time' };
    }
    
    const minutes = Math.round(delaySeconds / 60);
    return { 
      text: `+${minutes} min`, 
      className: 'late' 
    };
  }

  function shortenDestination(dest: string): string {
    // Remove parentheses content and trim
    let short = dest.replace(/\s*\([^)]*\)/g, '').trim();
    
    // Common shortenings
    short = short.replace('München Hbf (tief)', 'München Hbf');
    short = short.replace('Ebersberg(Oberbay)', 'Ebersberg');
    
    return short;
  }

  function renderDepartures(departures: Departure[], container: HTMLElement): void {
    // Filter for trains (S-Bahn and Regional), exclude buses
    const trainDepartures = departures
      .filter(d => d.when && d.line && (d.line.product === 'suburban' || d.line.product === 'regional'))
      .slice(0, 6);
    
    if (trainDepartures.length === 0) {
      // Show fallback with typical schedule info
      container.innerHTML = `
        <div class="info-row">
          <span>S6 Richtung Tutzing / München</span>
        </div>
        <div class="info-row secondary">
          <span>Abfahrten ca. alle 20 Minuten</span>
        </div>
        <div class="info-row secondary">
          <a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank">→ Live-Daten auf bahn.de</a>
        </div>
      `;
      return;
    }
    
    container.innerHTML = trainDepartures.map(dep => {
      const time = formatTime(dep.plannedWhen);
      const delay = getDelayInfo(dep.delay);
      const destination = shortenDestination(dep.direction);
      const platform = dep.platform || '-';
      const lineClass = dep.line.product === 'suburban' ? 'suburban' : 'regional';
      
      return `
        <div class="departure-row">
          <div class="time-cell">
            <span class="planned-time">${time}</span>
            <span class="delay-badge ${delay.className}">${delay.text}</span>
          </div>
          <div class="train-cell">
            <span class="line-name ${lineClass}">${dep.line.name}</span>
          </div>
          <div class="destination-cell">
            ${destination}
          </div>
          <div class="platform-cell">${platform}</div>
        </div>
      `;
    }).join('');
  }

  async function updateDepartures(section: HTMLElement): Promise<void> {
    const stationId = section.dataset.stationId;
    const container = section.querySelector('#departures') as HTMLElement;
    
    if (!stationId || !container) return;
    
    try {
      const departures = await fetchDepartures(stationId);
      renderDepartures(departures, container);
    } catch (error) {
      console.error('Failed to fetch departures:', error);
      container.innerHTML = '<div class="error-row">Verbindungsfehler</div>';
    }
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', () => {
    const board = document.querySelector('.departure-board') as HTMLElement;
    
    if (board) {
      // Clock
      updateClock();
      setInterval(updateClock, 1000);
      
      // Departures
      updateDepartures(board);
      setInterval(() => updateDepartures(board), 60000);
    }
  });
</script>
