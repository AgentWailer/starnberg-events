---
interface Props {
  station?: string;
  stationId?: string;
}

const { station = "Possenhofen", stationId = "8004874" } = Astro.props;
---

<div class="train-widget" data-station-id={stationId}>
  <div class="train-header">
    <div class="train-title">
      <span class="train-icon">ðŸš†</span>
      <span>S-Bahn {station}</span>
    </div>
    <a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank" class="db-link">
      DB Live <span class="arrow">â†’</span>
    </a>
  </div>
  <div class="train-body" id="train-table">
    <div class="train-loading">
      <span class="spinner"></span>
      Abfahrten laden...
    </div>
  </div>
</div>

<style>
  .train-widget {
    background: var(--color-card);
    border-radius: var(--radius-sm);
    overflow: hidden;
    margin-bottom: 24px;
    border: 1px solid var(--color-border-light);
    transition: all 0.2s ease;
  }

  .train-widget:hover {
    box-shadow: var(--shadow-md);
  }

  .train-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #0369a1;
    color: white;
  }

  .train-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .train-icon {
    font-size: 1.1rem;
  }

  .db-link {
    color: white;
    opacity: 0.9;
    font-size: 0.8rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: rgba(255,255,255,0.15);
    border-radius: var(--radius-full);
    transition: all 0.2s;
  }

  .db-link:hover {
    opacity: 1;
    background: rgba(255,255,255,0.25);
    text-decoration: none;
  }

  .train-body {
    min-height: 100px;
  }

  .train-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 32px;
    color: var(--color-muted);
    font-size: 0.9rem;
  }

  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  const API = 'https://v6.db.transport.rest';

  interface Departure {
    when: string | null;
    plannedWhen: string;
    delay: number | null;
    direction: string;
    platform: string | null;
    line: { name: string; product: string };
  }

  async function fetchDepartures(stationId: string): Promise<Departure[]> {
    const res = await fetch(`${API}/stops/${stationId}/departures?duration=120&results=12`);
    if (!res.ok) throw new Error('API error');
    return (await res.json()).departures || [];
  }

  function formatTime(iso: string): string {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  function shortenDest(dest: string): string {
    return dest.replace(/\s*\([^)]*\)/g, '').replace(/ Hbf$/, '').replace(/ Bahnhof$/, '');
  }

  function render(departures: Departure[], container: HTMLElement): void {
    const trains = departures
      .filter(d => d.when && d.line && ['suburban', 'regional'].includes(d.line.product))
      .slice(0, 5);
    
    if (!trains.length) {
      container.innerHTML = `
        <div style="padding:24px;text-align:center;color:var(--color-text-secondary)">
          <p style="font-weight:600;margin-bottom:4px">S6 Tutzing â†” MÃ¼nchen</p>
          <p style="font-size:0.85rem;opacity:0.8">ca. alle 20 Minuten</p>
        </div>
      `;
      return;
    }

    let html = `
      <div style="display:grid;grid-template-columns:auto auto 1fr auto;gap:0 16px;font-size:0.85rem">
        <div style="grid-column:1/-1;display:grid;grid-template-columns:subgrid;padding:10px 16px;background:var(--color-bg);border-bottom:1px solid var(--color-border);font-size:0.7rem;font-weight:600;color:var(--color-muted);text-transform:uppercase;letter-spacing:0.3px">
          <span>Zeit</span>
          <span>Linie</span>
          <span>Richtung</span>
          <span style="text-align:right">Gl.</span>
        </div>
    `;

    trains.forEach((t, i) => {
      const time = formatTime(t.when || t.plannedWhen);
      const delayMin = t.delay && t.delay >= 60 ? Math.round(t.delay / 60) : 0;
      const delayHtml = delayMin > 0 
        ? `<span style="color:#dc2626;font-size:0.75rem;margin-left:4px">+${delayMin}</span>` 
        : '';
      const bg = i % 2 === 0 ? 'var(--color-card)' : 'var(--color-bg)';
      
      html += `
        <div style="grid-column:1/-1;display:grid;grid-template-columns:subgrid;padding:12px 16px;background:${bg};align-items:center;border-bottom:1px solid var(--color-border)">
          <span style="font-weight:600;color:var(--color-primary)">${time}${delayHtml}</span>
          <span style="background:#16a34a;color:white;padding:2px 8px;border-radius:4px;font-weight:600;font-size:0.8rem;justify-self:start">${t.line.name}</span>
          <span style="color:var(--color-text);font-weight:500">${shortenDest(t.direction)}</span>
          <span style="text-align:right;font-weight:500;color:var(--color-text-secondary)">${t.platform || 'â€“'}</span>
        </div>
      `;
    });

    html += '</div>';
    container.innerHTML = html;
  }

  async function update(widget: HTMLElement): Promise<void> {
    const stationId = widget.dataset.stationId;
    const container = widget.querySelector('#train-table') as HTMLElement;
    if (!stationId || !container) return;

    try {
      const departures = await fetchDepartures(stationId);
      render(departures, container);
    } catch {
      container.innerHTML = `
        <div style="padding:24px;text-align:center">
          <a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank" style="color:var(--color-primary);font-weight:500">
            ðŸ”— Live-Abfahrten bei DB Ã¶ffnen
          </a>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const widget = document.querySelector('.train-widget') as HTMLElement;
    if (widget) {
      update(widget);
      setInterval(() => update(widget), 60000);
    }
  });
</script>
