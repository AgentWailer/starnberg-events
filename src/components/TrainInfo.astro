---
interface Props {
  station?: string;
  stationId?: string;
}

const { station = "Possenhofen", stationId = "8004874" } = Astro.props;
---

<div class="train-widget" data-station-id={stationId}>
  <div class="train-header">
    <span>ðŸš† S-Bahn {station}</span>
    <a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank">DB Live â†’</a>
  </div>
  <div class="train-table" id="train-table">
    <div class="train-loading">Laden...</div>
  </div>
</div>

<style>
  .train-widget {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e5e5e5;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .train-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: linear-gradient(135deg, #0066cc, #004499);
    color: #fff;
    font-weight: 600;
  }

  .train-header a {
    color: #fff;
    opacity: 0.85;
    font-size: 0.85rem;
    text-decoration: none;
  }

  .train-header a:hover {
    opacity: 1;
    text-decoration: underline;
  }

  .train-table {
    min-height: 80px;
  }

  .train-loading {
    padding: 24px;
    text-align: center;
    color: #888;
  }
</style>

<script>
  const API = 'https://v6.db.transport.rest';

  interface Dep {
    when: string | null;
    plannedWhen: string;
    delay: number | null;
    direction: string;
    platform: string | null;
    line: { name: string; product: string };
  }

  async function load(id: string): Promise<Dep[]> {
    const r = await fetch(`${API}/stops/${id}/departures?duration=120&results=12`);
    if (!r.ok) throw new Error('API error');
    return (await r.json()).departures || [];
  }

  function time(iso: string): string {
    return new Date(iso).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  function dest(d: string): string {
    return d.replace(/\s*\([^)]*\)/g, '').replace(/ Hbf$/, '').replace(/ Bahnhof$/, '');
  }

  function render(deps: Dep[], el: HTMLElement): void {
    const trains = deps.filter(d => d.when && d.line && ['suburban','regional'].includes(d.line.product)).slice(0, 6);
    
    if (!trains.length) {
      el.innerHTML = `<div style="padding:20px;text-align:center;color:#666">
        <p><b>S6</b> Tutzing â†” MÃ¼nchen</p>
        <p style="font-size:0.9em">ca. alle 20 min</p>
      </div>`;
      return;
    }

    // Table with inline styles for guaranteed rendering
    let html = `<table style="width:100%;border-collapse:collapse;font-family:system-ui,-apple-system,sans-serif">
      <thead>
        <tr style="background:#f5f5f5;font-size:0.75rem;color:#666;text-transform:uppercase">
          <th style="padding:8px 12px;text-align:left;font-weight:600">Zeit</th>
          <th style="padding:8px 12px;text-align:left;font-weight:600">Linie</th>
          <th style="padding:8px 12px;text-align:left;font-weight:600">Ziel</th>
          <th style="padding:8px 12px;text-align:center;font-weight:600">Gleis</th>
        </tr>
      </thead>
      <tbody>`;

    trains.forEach((t, i) => {
      const tm = time(t.when || t.plannedWhen);
      const delay = t.delay && t.delay >= 60 ? `<span style="color:#d32f2f;font-size:0.8em;margin-left:4px">+${Math.round(t.delay/60)}</span>` : '';
      const bg = i % 2 === 0 ? '#fff' : '#fafafa';
      
      html += `<tr style="background:${bg};border-bottom:1px solid #eee">
        <td style="padding:10px 12px;font-weight:700;color:#0066cc;font-size:1rem;white-space:nowrap">${tm}${delay}</td>
        <td style="padding:10px 12px"><span style="background:#43a047;color:#fff;padding:3px 8px;border-radius:4px;font-weight:700;font-size:0.85rem">${t.line.name}</span></td>
        <td style="padding:10px 12px;font-weight:500;color:#222">${dest(t.direction)}</td>
        <td style="padding:10px 12px;text-align:center;font-weight:600;color:#444">${t.platform || 'â€“'}</td>
      </tr>`;
    });

    html += '</tbody></table>';
    el.innerHTML = html;
  }

  async function update(w: HTMLElement): Promise<void> {
    const id = w.dataset.stationId;
    const el = w.querySelector('#train-table') as HTMLElement;
    if (!id || !el) return;

    try {
      const deps = await load(id);
      render(deps, el);
    } catch {
      el.innerHTML = `<div style="padding:20px;text-align:center;color:#666">
        <a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank" style="color:#0066cc">Live-Abfahrten Ã¶ffnen â†’</a>
      </div>`;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const w = document.querySelector('.train-widget') as HTMLElement;
    if (w) {
      update(w);
      setInterval(() => update(w), 60000);
    }
  });
</script>
