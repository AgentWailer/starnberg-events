---
interface Props {
  station?: string;
  stationId?: string;
}

const { station = "Possenhofen", stationId = "8004874" } = Astro.props;
---

<section class="db-board" data-station-id={stationId}>
  <div class="db-header">
    <div class="db-clock" id="db-clock">--:--</div>
    <div class="db-links">
      <a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank">Vollbild</a>
    </div>
    <div class="db-logo">DB</div>
  </div>
  
  <div class="db-title">Abfahrt {station}</div>
  
  <div class="db-columns">
    <span class="col-zeit">Zeit</span>
    <span class="col-nach">Nach</span>
    <span class="col-ueber">Über</span>
    <span class="col-gleis">Gleis</span>
  </div>
  
  <div class="db-departures" id="db-departures">
    <div class="db-loading">Abfahrten werden geladen...</div>
  </div>
</section>

<style>
  .db-board {
    background: #00387b;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .db-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    background: #00387b;
  }

  .db-clock {
    font-size: 1.5rem;
    font-weight: 700;
    color: #ffffff;
  }

  .db-links a {
    color: #6eb5ff;
    font-size: 0.75rem;
    text-decoration: underline;
  }

  .db-logo {
    background: #ec0016;
    color: #ffffff;
    font-weight: 800;
    font-size: 0.9rem;
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
  }

  .db-title {
    background: #00387b;
    color: #ffcc00;
    font-size: 1.3rem;
    font-weight: 700;
    text-align: center;
    padding: 0.5rem;
  }

  .db-columns {
    display: grid;
    grid-template-columns: 75px 1fr 1fr 55px;
    background: #002855;
    color: #ffcc00;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.4rem 0.75rem;
    border-top: 2px solid #001a3a;
    border-bottom: 2px solid #001a3a;
  }

  .col-gleis {
    text-align: right;
  }

  .db-departures {
    background: #00387b;
    min-height: 180px;
  }

  .db-loading {
    color: #ffcc00;
    text-align: center;
    padding: 2rem;
    font-size: 0.9rem;
    opacity: 0.7;
  }

  .db-row {
    display: grid;
    grid-template-columns: 75px 1fr 1fr 55px;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #002855;
    align-items: start;
  }

  .db-row:last-child {
    border-bottom: none;
  }

  .zeit-cell {
    color: #ffcc00;
  }

  .zeit-time {
    font-size: 1.2rem;
    font-weight: 700;
    line-height: 1.2;
  }

  .zeit-line {
    font-size: 0.85rem;
    font-weight: 400;
  }

  .zeit-delay {
    font-size: 0.75rem;
    color: #ff6b6b;
    font-weight: 600;
  }

  .nach-cell {
    color: #ffffff;
    font-weight: 700;
    font-size: 1rem;
    padding-right: 0.5rem;
  }

  .ueber-cell {
    color: #ffcc00;
    font-size: 0.8rem;
    opacity: 0.85;
    padding-right: 0.5rem;
    line-height: 1.3;
  }

  .gleis-cell {
    color: #ffcc00;
    font-size: 1.2rem;
    font-weight: 700;
    text-align: right;
  }

  .db-error {
    color: #ff6b6b;
    text-align: center;
    padding: 1.5rem;
    font-size: 0.9rem;
  }

  .db-fallback {
    color: #ffcc00;
    text-align: center;
    padding: 1rem;
    font-size: 0.9rem;
  }

  .db-fallback a {
    color: #6eb5ff;
    text-decoration: underline;
  }

  @media (max-width: 500px) {
    .db-columns {
      grid-template-columns: 65px 1fr 45px;
      font-size: 0.75rem;
    }

    .col-ueber {
      display: none;
    }

    .db-row {
      grid-template-columns: 65px 1fr 45px;
    }

    .ueber-cell {
      display: none;
    }

    .zeit-time {
      font-size: 1rem;
    }

    .nach-cell {
      font-size: 0.9rem;
    }

    .gleis-cell {
      font-size: 1rem;
    }

    .db-title {
      font-size: 1.1rem;
    }
  }
</style>

<script>
  const API_BASE = 'https://v6.db.transport.rest';

  interface Departure {
    when: string | null;
    plannedWhen: string;
    delay: number | null;
    direction: string;
    platform: string | null;
    line: {
      name: string;
      product: string;
    };
    nextStopovers?: Array<{ stop: { name: string } }>;
  }

  function updateClock(): void {
    const clock = document.getElementById('db-clock');
    if (clock) {
      const now = new Date();
      clock.textContent = now.toLocaleTimeString('de-DE', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }
  }

  async function fetchDepartures(stationId: string, retries = 2): Promise<Departure[]> {
    const url = `${API_BASE}/stops/${stationId}/departures?duration=120&results=15&stopovers=true`;
    
    for (let attempt = 0; attempt <= retries; attempt++) {
      try {
        const response = await fetch(url, {
          headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) {
          if (attempt < retries) {
            await new Promise(r => setTimeout(r, 1000));
            continue;
          }
          throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        return data.departures || [];
      } catch (e) {
        if (attempt === retries) throw e;
        await new Promise(r => setTimeout(r, 1000));
      }
    }
    return [];
  }

  function formatTime(isoString: string): string {
    const date = new Date(isoString);
    return date.toLocaleTimeString('de-DE', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
  }

  function getDelayText(delaySeconds: number | null): string {
    if (delaySeconds === null || delaySeconds === undefined || delaySeconds < 60) {
      return '';
    }
    const minutes = Math.round(delaySeconds / 60);
    return `ca. +${minutes}`;
  }

  function shortenDestination(dest: string): string {
    return dest
      .replace(/\s*\([^)]*\)/g, '')
      .replace('Ebersberg(Oberbay)', 'Ebersberg')
      .replace(' Hbf (tief)', ' Hbf')
      .replace(' Bahnhof', ' Bf')
      .trim();
  }

  function getViaStops(dep: Departure): string {
    if (!dep.nextStopovers || dep.nextStopovers.length < 2) {
      return '';
    }
    // Get first 3 stops after current station
    const stops = dep.nextStopovers
      .slice(1, 4)
      .map(s => s.stop.name.replace(/\s*\([^)]*\)/g, '').replace(', Pöcking', ''))
      .join(', ');
    return stops;
  }

  function renderDepartures(departures: Departure[], container: HTMLElement): void {
    const trainDepartures = departures
      .filter(d => d.when && d.line && (d.line.product === 'suburban' || d.line.product === 'regional'))
      .slice(0, 6);
    
    if (trainDepartures.length === 0) {
      container.innerHTML = `
        <div class="db-fallback">
          <p>S6 Richtung Tutzing / München</p>
          <p>ca. alle 20 Minuten</p>
          <p><a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank">→ Live-Abfahrten öffnen</a></p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = trainDepartures.map(dep => {
      const time = formatTime(dep.plannedWhen);
      const delayText = getDelayText(dep.delay);
      const destination = shortenDestination(dep.direction);
      const via = getViaStops(dep);
      const platform = dep.platform || '-';
      
      return `
        <div class="db-row">
          <div class="zeit-cell">
            <div class="zeit-time">${time}</div>
            <div class="zeit-line">${dep.line.name}</div>
            ${delayText ? `<div class="zeit-delay">${delayText}</div>` : ''}
          </div>
          <div class="nach-cell">${destination}</div>
          <div class="ueber-cell">${via}</div>
          <div class="gleis-cell">${platform}</div>
        </div>
      `;
    }).join('');
  }

  async function updateDepartures(board: HTMLElement): Promise<void> {
    const stationId = board.dataset.stationId;
    const container = board.querySelector('#db-departures') as HTMLElement;
    
    if (!stationId || !container) return;
    
    try {
      const departures = await fetchDepartures(stationId);
      renderDepartures(departures, container);
    } catch (error) {
      console.error('Failed to fetch departures:', error);
      container.innerHTML = `
        <div class="db-fallback">
          <p><a href="https://iris.noncd.db.de/wbt/js/index.html?bhf=MPH" target="_blank">→ Live-Abfahrten öffnen</a></p>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const board = document.querySelector('.db-board') as HTMLElement;
    
    if (board) {
      updateClock();
      setInterval(updateClock, 1000);
      
      updateDepartures(board);
      setInterval(() => updateDepartures(board), 60000);
    }
  });
</script>
