---
// Weather widget using Open-Meteo API (free, no key needed, reliable)
// Shows current weather, water temp, sunrise/sunset
---

<div class="weather-widget">
  <div class="weather-content" id="weather-content">
    <div class="weather-loading">
      <span class="spinner"></span>
    </div>
  </div>
</div>

<style>
  .weather-widget {
    background: var(--color-card);
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border-light);
    overflow: hidden;
  }

  .weather-content {
    min-height: 50px;
  }

  .weather-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }

  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Loaded state styles */
  :global(.weather-grid) {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0;
  }

  :global(.weather-item) {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 8px;
    border-right: 1px solid var(--color-border);
  }

  :global(.weather-item:last-child) {
    border-right: none;
  }

  :global(.weather-icon) {
    font-size: 1.3rem;
    margin-bottom: 2px;
  }

  :global(.weather-value) {
    font-size: 1rem;
    font-weight: 700;
    color: var(--color-text);
  }

  :global(.weather-label) {
    font-size: 0.65rem;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  @media (max-width: 400px) {
    :global(.weather-grid) {
      grid-template-columns: repeat(2, 1fr);
    }
    
    :global(.weather-item) {
      border-bottom: 1px solid var(--color-border);
    }
    
    :global(.weather-item:nth-child(2)) {
      border-right: none;
    }
    
    :global(.weather-item:nth-child(3)),
    :global(.weather-item:nth-child(4)) {
      border-bottom: none;
    }
    
    :global(.weather-item:nth-child(4)) {
      border-right: none;
    }
  }
</style>

<script>
  // Weather code to emoji mapping (WMO codes)
  const weatherEmojis: Record<number, string> = {
    0: 'â˜€ï¸',  // Clear sky
    1: 'ğŸŒ¤ï¸',  // Mainly clear
    2: 'â›…',  // Partly cloudy
    3: 'â˜ï¸',  // Overcast
    45: 'ğŸŒ«ï¸', // Fog
    48: 'ğŸŒ«ï¸', // Depositing rime fog
    51: 'ğŸŒ§ï¸', // Light drizzle
    53: 'ğŸŒ§ï¸', // Moderate drizzle
    55: 'ğŸŒ§ï¸', // Dense drizzle
    61: 'ğŸŒ§ï¸', // Slight rain
    63: 'ğŸŒ§ï¸', // Moderate rain
    65: 'ğŸŒ§ï¸', // Heavy rain
    71: 'ğŸŒ¨ï¸', // Slight snow
    73: 'ğŸŒ¨ï¸', // Moderate snow
    75: 'â„ï¸',  // Heavy snow
    80: 'ğŸŒ§ï¸', // Slight rain showers
    81: 'ğŸŒ§ï¸', // Moderate rain showers
    82: 'ğŸŒ§ï¸', // Violent rain showers
    95: 'â›ˆï¸', // Thunderstorm
  };

  function getWeatherEmoji(code: number): string {
    return weatherEmojis[code] || 'ğŸŒ¡ï¸';
  }

  function formatTime(isoString: string): string {
    const date = new Date(isoString);
    return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  async function fetchWeather(): Promise<void> {
    const container = document.getElementById('weather-content');
    if (!container) return;

    try {
      // Starnberg coordinates: 47.9983, 11.3397
      const url = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
      
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 8000);
      
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(timeout);
      
      if (!res.ok) throw new Error('API error');
      
      const data = await res.json();
      
      const temp = Math.round(data.current?.temperature_2m || 0);
      const weatherCode = data.current?.weather_code || 0;
      const emoji = getWeatherEmoji(weatherCode);
      const sunrise = data.daily?.sunrise?.[0] ? formatTime(data.daily.sunrise[0]) : 'â€”';
      const sunset = data.daily?.sunset?.[0] ? formatTime(data.daily.sunset[0]) : 'â€”';
      
      // Water temperature (static estimate - Feb average for Starnberger See)
      const waterTemp = '4';
      
      container.innerHTML = `
        <div class="weather-grid">
          <div class="weather-item">
            <span class="weather-icon">${emoji}</span>
            <span class="weather-value">${temp}Â°C</span>
            <span class="weather-label">Starnberg</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon">ğŸ’§</span>
            <span class="weather-value">~${waterTemp}Â°C</span>
            <span class="weather-label">Wasser</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon">ğŸŒ…</span>
            <span class="weather-value">${sunrise}</span>
            <span class="weather-label">Aufgang</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon">ğŸŒ‡</span>
            <span class="weather-value">${sunset}</span>
            <span class="weather-label">Untergang</span>
          </div>
        </div>
      `;
    } catch (err) {
      // Fallback with reasonable defaults
      container.innerHTML = `
        <div class="weather-grid">
          <div class="weather-item">
            <span class="weather-icon">ğŸŒ¡ï¸</span>
            <span class="weather-value">â€”</span>
            <span class="weather-label">Starnberg</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon">ğŸ’§</span>
            <span class="weather-value">~4Â°C</span>
            <span class="weather-label">Wasser</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon">ğŸŒ…</span>
            <span class="weather-value">07:30</span>
            <span class="weather-label">Aufgang</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon">ğŸŒ‡</span>
            <span class="weather-value">17:20</span>
            <span class="weather-label">Untergang</span>
          </div>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', fetchWeather);
</script>
