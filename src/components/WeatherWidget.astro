---
// Weather widget using Open-Meteo API
// Clean, minimal design with unified icons
---

<div class="weather-bar" id="weather-bar">
  <div class="weather-loading">
    <span class="spinner"></span>
  </div>
</div>

<style>
  .weather-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 24px;
    padding: 12px 16px;
    background: var(--color-card);
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border-light);
    /* Touch Target consideration + CLS: consistent minimum height */
    min-height: 48px;
    flex-wrap: wrap;
  }

  .weather-loading {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  :global(.weather-item) {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--color-text-secondary);
    font-size: 0.85rem;
  }

  :global(.weather-icon) {
    width: 16px;
    height: 16px;
    opacity: 0.7;
  }

  :global(.weather-value) {
    font-weight: 600;
    color: var(--color-text);
  }

  :global(.weather-divider) {
    width: 1px;
    height: 16px;
    background: var(--color-border);
  }

  @media (max-width: 500px) {
    .weather-bar {
      gap: 16px;
      padding: 8px 12px;
    }
    
    :global(.weather-item) {
      font-size: 0.8rem;
    }
    
    :global(.weather-divider) {
      display: none;
    }
  }
</style>

<script>
  // Simple SVG icons (inline, monochrome)
  const icons = {
    sun: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
    cloud: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>`,
    cloudSun: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32 1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/><circle cx="12" cy="12" r="4"/></svg>`,
    rain: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></svg>`,
    snow: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><line x1="8" y1="16" x2="8.01" y2="16"/><line x1="8" y1="20" x2="8.01" y2="20"/><line x1="12" y1="18" x2="12.01" y2="18"/><line x1="12" y1="22" x2="12.01" y2="22"/><line x1="16" y1="16" x2="16.01" y2="16"/><line x1="16" y1="20" x2="16.01" y2="20"/></svg>`,
    droplet: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>`,
    sunrise: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8 6 12 2 16 6"/></svg>`,
    sunset: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="16 6 12 10 8 6"/></svg>`,
    thermometer: `<svg class="weather-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>`,
  };

  // WMO weather codes to icon
  function getWeatherIcon(code: number): string {
    if (code === 0) return icons.sun;
    if (code <= 3) return icons.cloudSun;
    if (code <= 48) return icons.cloud;
    if (code <= 67) return icons.rain;
    if (code <= 77) return icons.snow;
    if (code <= 82) return icons.rain;
    return icons.cloud;
  }

  function formatTime(isoString: string): string {
    const date = new Date(isoString);
    return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }

  async function fetchWeather(): Promise<void> {
    const container = document.getElementById('weather-bar');
    if (!container) return;

    try {
      const url = 'https://api.open-meteo.com/v1/forecast?latitude=47.9983&longitude=11.3397&current=temperature_2m,weather_code&daily=sunrise,sunset&timezone=Europe%2FBerlin&forecast_days=1';
      
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 8000);
      
      const res = await fetch(url, { signal: controller.signal });
      clearTimeout(timeout);
      
      if (!res.ok) throw new Error('API error');
      
      const data = await res.json();
      
      const temp = Math.round(data.current?.temperature_2m || 0);
      const weatherCode = data.current?.weather_code || 0;
      const weatherIcon = getWeatherIcon(weatherCode);
      const sunrise = data.daily?.sunrise?.[0] ? formatTime(data.daily.sunrise[0]) : '7:30';
      const sunset = data.daily?.sunset?.[0] ? formatTime(data.daily.sunset[0]) : '17:20';
      const waterTemp = '4'; // Feb average

      container.innerHTML = `
        <div class="weather-item">
          ${weatherIcon}
          <span class="weather-value">${temp}°C</span>
        </div>
        <span class="weather-divider"></span>
        <div class="weather-item">
          ${icons.droplet}
          <span class="weather-value">~${waterTemp}°C</span>
        </div>
        <span class="weather-divider"></span>
        <div class="weather-item">
          ${icons.sunrise}
          <span class="weather-value">${sunrise}</span>
        </div>
        <span class="weather-divider"></span>
        <div class="weather-item">
          ${icons.sunset}
          <span class="weather-value">${sunset}</span>
        </div>
      `;
    } catch {
      container.innerHTML = `
        <div class="weather-item">
          ${icons.thermometer}
          <span class="weather-value">—</span>
        </div>
        <span class="weather-divider"></span>
        <div class="weather-item">
          ${icons.droplet}
          <span class="weather-value">~4°C</span>
        </div>
        <span class="weather-divider"></span>
        <div class="weather-item">
          ${icons.sunrise}
          <span class="weather-value">7:30</span>
        </div>
        <span class="weather-divider"></span>
        <div class="weather-item">
          ${icons.sunset}
          <span class="weather-value">17:20</span>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', fetchWeather);
</script>
