---
// Weather widget using wttr.in API
// Shows current weather, water temp, sunrise/sunset
---

<div class="weather-widget">
  <div class="weather-content" id="weather-content">
    <div class="weather-loading">
      <span class="spinner"></span>
    </div>
  </div>
</div>

<style>
  .weather-widget {
    background: var(--color-card);
    border-radius: var(--radius-sm);
    border: 1px solid var(--color-border-light);
    overflow: hidden;
  }

  .weather-content {
    min-height: 60px;
  }

  .weather-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Loaded state styles */
  :global(.weather-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0;
  }

  :global(.weather-item) {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 16px;
    border-right: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
  }

  :global(.weather-item:last-child) {
    border-right: none;
  }

  :global(.weather-icon) {
    font-size: 1.5rem;
    margin-bottom: 4px;
  }

  :global(.weather-value) {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--color-text);
  }

  :global(.weather-label) {
    font-size: 0.7rem;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  :global(.weather-sun) {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  :global(.sun-time) {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text);
  }

  :global(.sun-icon) {
    font-size: 1rem;
  }

  @media (max-width: 500px) {
    :global(.weather-grid) {
      grid-template-columns: repeat(2, 1fr);
    }
    
    :global(.weather-item) {
      border-bottom: 1px solid var(--color-border);
    }
    
    :global(.weather-item:nth-child(2)) {
      border-right: none;
    }
    
    :global(.weather-item:nth-child(3)),
    :global(.weather-item:nth-child(4)) {
      border-bottom: none;
    }
    
    :global(.weather-item:nth-child(4)) {
      border-right: none;
    }
  }
</style>

<script>
  // Weather condition to emoji mapping
  const weatherEmojis: Record<string, string> = {
    'Clear': 'â˜€ï¸',
    'Sunny': 'â˜€ï¸',
    'Partly cloudy': 'â›…',
    'Cloudy': 'â˜ï¸',
    'Overcast': 'â˜ï¸',
    'Mist': 'ğŸŒ«ï¸',
    'Fog': 'ğŸŒ«ï¸',
    'Light rain': 'ğŸŒ§ï¸',
    'Rain': 'ğŸŒ§ï¸',
    'Heavy rain': 'ğŸŒ§ï¸',
    'Light snow': 'ğŸŒ¨ï¸',
    'Snow': 'ğŸŒ¨ï¸',
    'Heavy snow': 'â„ï¸',
    'Thunderstorm': 'â›ˆï¸',
  };

  function getWeatherEmoji(condition: string): string {
    for (const [key, emoji] of Object.entries(weatherEmojis)) {
      if (condition.toLowerCase().includes(key.toLowerCase())) {
        return emoji;
      }
    }
    return 'ğŸŒ¡ï¸';
  }

  async function fetchWeather(): Promise<void> {
    const container = document.getElementById('weather-content');
    if (!container) return;

    try {
      // Fetch weather from wttr.in
      const res = await fetch('https://wttr.in/Starnberg?format=j1', {
        headers: { 'Accept': 'application/json' }
      });
      
      if (!res.ok) throw new Error('Weather API error');
      
      const data = await res.json();
      const current = data.current_condition?.[0];
      const astronomy = data.weather?.[0]?.astronomy?.[0];
      
      if (!current) throw new Error('No weather data');
      
      const temp = current.temp_C;
      const condition = current.weatherDesc?.[0]?.value || 'Unknown';
      const emoji = getWeatherEmoji(condition);
      const sunrise = astronomy?.sunrise?.replace(/^0/, '') || 'â€”';
      const sunset = astronomy?.sunset?.replace(/^0/, '') || 'â€”';
      
      // Water temperature (static for now - no reliable API)
      // Could scrape wassertemperatur.org in the future
      const waterTemp = '4'; // February average
      
      container.innerHTML = `
        <div class="weather-grid">
          <div class="weather-item">
            <span class="weather-icon">${emoji}</span>
            <span class="weather-value">${temp}Â°C</span>
            <span class="weather-label">Starnberg</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon">ğŸ’§</span>
            <span class="weather-value">~${waterTemp}Â°C</span>
            <span class="weather-label">Wassertemp.</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon sun-icon">ğŸŒ…</span>
            <span class="weather-value sun-time">${sunrise}</span>
            <span class="weather-label">Aufgang</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon sun-icon">ğŸŒ‡</span>
            <span class="weather-value sun-time">${sunset}</span>
            <span class="weather-label">Untergang</span>
          </div>
        </div>
      `;
    } catch (err) {
      // Fallback display
      container.innerHTML = `
        <div class="weather-grid">
          <div class="weather-item">
            <span class="weather-icon">ğŸŒ¡ï¸</span>
            <span class="weather-value">â€”</span>
            <span class="weather-label">Starnberg</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon">ğŸ’§</span>
            <span class="weather-value">~4Â°C</span>
            <span class="weather-label">Wassertemp.</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon sun-icon">ğŸŒ…</span>
            <span class="weather-value sun-time">7:30</span>
            <span class="weather-label">Aufgang</span>
          </div>
          <div class="weather-item">
            <span class="weather-icon sun-icon">ğŸŒ‡</span>
            <span class="weather-value sun-time">17:20</span>
            <span class="weather-label">Untergang</span>
          </div>
        </div>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', fetchWeather);
</script>
