---
interface Props {
  events: any[];
  regions: Record<string, { name: string; emoji: string }>;
}

const { events, regions } = Astro.props;

// Count events by category
const counts = {
  all: events.length,
  kinder: events.filter(e => e.category === 'kinder').length,
  familie: events.filter(e => e.category === 'familie').length,
  erwachsene: events.filter(e => e.category === 'erwachsene').length,
};

// Count events by region
const regionCounts: Record<string, number> = {};
Object.keys(regions).forEach(r => {
  regionCounts[r] = events.filter(e => e.region === r).length;
});

// Get unique locations sorted
const locations = [...new Set(events.map(e => e.location))].sort();
---

<!-- Mobile: Bottom Sheet Trigger -->
<button class="filter-fab" id="filter-fab" aria-label="Filter √∂ffnen">
  <span class="fab-icon">‚öôÔ∏è</span>
  <span class="fab-text">Filter</span>
  <span class="fab-badge" id="filter-badge" style="display:none">0</span>
</button>

<!-- Bottom Sheet Overlay -->
<div class="bottom-sheet-overlay" id="sheet-overlay"></div>

<!-- Bottom Sheet -->
<div class="bottom-sheet" id="bottom-sheet">
  <div class="sheet-header">
    <span class="sheet-title">Filter</span>
    <button class="sheet-close" id="sheet-close">‚úï</button>
  </div>
  <div class="sheet-content">
    <!-- Region Filter -->
    <div class="filter-group">
      <label class="filter-label">Region</label>
      <div class="filter-chips">
        <button class="chip active" data-region="all">Alle</button>
        {Object.entries(regions).map(([id, region]) => (
          regionCounts[id] > 0 && (
            <button class="chip region-chip" data-region={id}>
              <span class="chip-emoji">{region.emoji}</span>
              <span class="chip-text">{region.name}</span>
              <span class="chip-count">{regionCounts[id]}</span>
            </button>
          )
        ))}
      </div>
    </div>

    <!-- Category Filter -->
    <div class="filter-group">
      <label class="filter-label">F√ºr wen?</label>
      <div class="filter-chips">
        <button class="chip category-chip active" data-filter="all">Alle</button>
        <button class="chip category-chip" data-filter="kinder" data-color="kinder">
          üë∂ Kinder <span class="chip-count">{counts.kinder}</span>
        </button>
        <button class="chip category-chip" data-filter="familie" data-color="familie">
          üë®‚Äçüë©‚Äçüëß Familie <span class="chip-count">{counts.familie}</span>
        </button>
        <button class="chip category-chip" data-filter="erwachsene" data-color="erwachsene">
          üé≠ Erwachsene <span class="chip-count">{counts.erwachsene}</span>
        </button>
      </div>
    </div>

    <!-- Location Filter -->
    <div class="filter-group">
      <label class="filter-label">Ort</label>
      <select class="location-select" id="location-filter">
        <option value="all">Alle Orte</option>
        {locations.map(loc => (
          <option value={loc}>{loc}</option>
        ))}
      </select>
    </div>

    <!-- Apply Button -->
    <button class="sheet-apply" id="sheet-apply">
      <span id="apply-count">{events.length}</span> Events anzeigen
    </button>
  </div>
</div>

<!-- Desktop: Normal Filter Container -->
<div class="filter-container desktop-only">
  <div class="stats-bar">
    <span class="stat-item">üìä <strong id="desktop-event-count">{events.length}</strong> Events</span>
    <span class="stat-divider">‚Ä¢</span>
    <span class="stat-item">üó∫Ô∏è <strong>{Object.keys(regionCounts).filter(r => regionCounts[r] > 0).length}</strong> Regionen</span>
  </div>

  <div class="filters-row">
    <div class="filter-group">
      <label class="filter-label">Region</label>
      <div class="filter-chips">
        <button class="chip active" data-region="all">Alle</button>
        {Object.entries(regions).map(([id, region]) => (
          regionCounts[id] > 0 && (
            <button class="chip region-chip" data-region={id}>
              <span class="chip-emoji">{region.emoji}</span>
              <span class="chip-text">{region.name}</span>
              <span class="chip-count">{regionCounts[id]}</span>
            </button>
          )
        ))}
      </div>
    </div>

    <div class="filter-group">
      <label class="filter-label">F√ºr wen?</label>
      <div class="filter-chips">
        <button class="chip category-chip active" data-filter="all">Alle</button>
        <button class="chip category-chip" data-filter="kinder" data-color="kinder">
          üë∂ Kinder <span class="chip-count">{counts.kinder}</span>
        </button>
        <button class="chip category-chip" data-filter="familie" data-color="familie">
          üë®‚Äçüë©‚Äçüëß Familie <span class="chip-count">{counts.familie}</span>
        </button>
        <button class="chip category-chip" data-filter="erwachsene" data-color="erwachsene">
          üé≠ Erwachsene <span class="chip-count">{counts.erwachsene}</span>
        </button>
      </div>
    </div>

    <div class="filter-group">
      <label class="filter-label">Ort</label>
      <select class="location-select desktop-location" id="desktop-location-filter">
        <option value="all">Alle Orte</option>
        {locations.map(loc => (
          <option value={loc}>{loc}</option>
        ))}
      </select>
    </div>
  </div>
</div>

<style>
  /* ===== Mobile FAB Button ===== */
  .filter-fab {
    display: flex;
    align-items: center;
    gap: 8px;
    position: fixed;
    bottom: 24px;
    bottom: calc(24px + env(safe-area-inset-bottom, 0px));
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    padding: 14px 24px;
    background: #000;
    color: white;
    border: none;
    border-radius: var(--radius-full);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    transition: all 0.2s;
  }

  .filter-fab:hover {
    transform: translateX(-50%) scale(1.05);
  }

  /* Make sure it's visible on all mobile */
  @media (max-width: 1023px) {
    .filter-fab {
      display: flex !important;
    }
  }

  .fab-icon {
    font-size: 1rem;
  }

  .fab-badge {
    background: #ef4444;
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: var(--radius-full);
    margin-left: 2px;
  }

  /* ===== Bottom Sheet ===== */
  .bottom-sheet-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1001;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .bottom-sheet-overlay.active {
    display: block;
    opacity: 1;
  }

  .bottom-sheet {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1002;
    background: var(--color-card);
    border-radius: 20px 20px 0 0;
    transform: translateY(100%);
    transition: transform 0.3s ease-out, visibility 0s 0.3s;
    max-height: 85vh;
    overflow-y: auto;
    visibility: hidden;
  }

  .bottom-sheet.active {
    transform: translateY(0);
    visibility: visible;
    transition: transform 0.3s ease-out, visibility 0s 0s;
  }

  .sheet-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--color-border);
    position: sticky;
    top: 0;
    background: var(--color-card);
  }

  .sheet-title {
    font-size: 1rem;
    font-weight: 700;
  }

  .sheet-close {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: var(--color-bg);
    border-radius: 50%;
    font-size: 0.9rem;
    cursor: pointer;
    color: var(--color-text-secondary);
  }

  .sheet-content {
    padding: 12px 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .sheet-apply {
    width: 100%;
    padding: 12px;
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    margin-top: 4px;
  }

  /* Hide mobile elements on desktop */
  @media (min-width: 1024px) {
    .filter-fab,
    .bottom-sheet-overlay,
    .bottom-sheet {
      display: none !important;
    }
  }

  /* ===== Desktop Filter Container ===== */
  .desktop-only {
    display: none;
  }

  @media (min-width: 1024px) {
    .desktop-only {
      display: block;
    }
  }

  .filter-container {
    background: var(--color-card);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-bottom: 20px;
    border: 1px solid var(--color-border);
    overflow: hidden;
  }

  /* ===== Shared Styles ===== */
  .stats-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-bottom: 10px;
    margin-bottom: 10px;
    border-bottom: 1px solid var(--color-border);
    font-size: 0.8rem;
    color: var(--color-text-secondary);
  }

  .stat-item strong {
    color: var(--color-text);
  }

  .stat-divider {
    opacity: 0.3;
  }

  .filters-row {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .filter-label {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-muted);
  }

  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    background: var(--color-card);
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
    color: var(--color-text-secondary);
  }

  .chip:hover {
    border-color: var(--color-text);
    color: var(--color-text);
  }

  .chip.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }

  .chip-emoji {
    font-size: 0.8rem;
  }

  .chip-count {
    font-size: 0.65rem;
    padding: 1px 5px;
    background: rgba(0,0,0,0.08);
    border-radius: var(--radius-full);
  }

  .chip.active .chip-count {
    background: rgba(255,255,255,0.25);
  }

  .category-chip[data-color="kinder"]:not(.active):hover {
    border-color: var(--color-kinder);
    color: var(--color-kinder);
  }
  .category-chip[data-color="familie"]:not(.active):hover {
    border-color: var(--color-familie);
    color: var(--color-familie);
  }
  .category-chip[data-color="erwachsene"]:not(.active):hover {
    border-color: var(--color-erwachsene);
    color: var(--color-erwachsene);
  }

  .location-select {
    width: 100%;
    padding: 8px 12px;
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    background: var(--color-card);
    color: var(--color-text);
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .location-select:hover {
    border-color: var(--color-primary);
  }
</style>

<script>
  // Elements
  const fab = document.getElementById('filter-fab');
  const overlay = document.getElementById('sheet-overlay');
  const sheet = document.getElementById('bottom-sheet');
  const closeBtn = document.getElementById('sheet-close');
  const applyBtn = document.getElementById('sheet-apply');
  const badge = document.getElementById('filter-badge');

  // All chips (mobile + desktop)
  const regionChips = document.querySelectorAll('.chip[data-region]');
  const categoryChips = document.querySelectorAll('.chip[data-filter]');
  const locationSelects = document.querySelectorAll('.location-select');
  const eventCards = document.querySelectorAll('.event-card');

  let activeRegion = 'all';
  let activeCategory = 'all';
  let activeLocation = 'all';

  // Open/close sheet
  function openSheet() {
    sheet?.classList.add('active');
    overlay?.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function closeSheet() {
    sheet?.classList.remove('active');
    overlay?.classList.remove('active');
    document.body.style.overflow = '';
  }

  fab?.addEventListener('click', openSheet);
  overlay?.addEventListener('click', closeSheet);
  closeBtn?.addEventListener('click', closeSheet);
  applyBtn?.addEventListener('click', closeSheet);

  // Filter logic
  function filterEvents() {
    let visibleCount = 0;
    
    eventCards.forEach(card => {
      const el = card as HTMLElement;
      const matchesRegion = activeRegion === 'all' || el.dataset.region === activeRegion;
      const matchesCategory = activeCategory === 'all' || el.dataset.category === activeCategory;
      const matchesLocation = activeLocation === 'all' || el.dataset.location === activeLocation;

      if (matchesRegion && matchesCategory && matchesLocation) {
        el.style.display = '';
        visibleCount++;
      } else {
        el.style.display = 'none';
      }
    });

    // Update counts everywhere
    document.querySelectorAll('#mobile-event-count, #desktop-event-count, #apply-count').forEach(el => {
      el.textContent = String(visibleCount);
    });

    // Update badge
    const activeFilters = (activeRegion !== 'all' ? 1 : 0) + (activeCategory !== 'all' ? 1 : 0) + (activeLocation !== 'all' ? 1 : 0);
    if (badge) {
      if (activeFilters > 0) {
        badge.style.display = 'inline';
        badge.textContent = String(activeFilters);
      } else {
        badge.style.display = 'none';
      }
    }
  }

  // Sync chips between mobile and desktop
  function syncChips(type: 'region' | 'category', value: string) {
    const selector = type === 'region' ? '.chip[data-region]' : '.chip[data-filter]';
    document.querySelectorAll(selector).forEach(chip => {
      const chipValue = type === 'region' 
        ? (chip as HTMLElement).dataset.region 
        : (chip as HTMLElement).dataset.filter;
      chip.classList.toggle('active', chipValue === value);
    });
  }

  // Region clicks
  regionChips.forEach(chip => {
    chip.addEventListener('click', () => {
      activeRegion = (chip as HTMLElement).dataset.region || 'all';
      syncChips('region', activeRegion);
      filterEvents();
    });
  });

  // Category clicks
  categoryChips.forEach(chip => {
    chip.addEventListener('click', () => {
      activeCategory = (chip as HTMLElement).dataset.filter || 'all';
      syncChips('category', activeCategory);
      filterEvents();
    });
  });

  // Location selects
  locationSelects.forEach(select => {
    select.addEventListener('change', () => {
      activeLocation = (select as HTMLSelectElement).value;
      // Sync both selects
      locationSelects.forEach(s => {
        (s as HTMLSelectElement).value = activeLocation;
      });
      filterEvents();
    });
  });
</script>
