---
interface Props {
  events: any[];
  regions: Record<string, { name: string; emoji: string }>;
}

const { events, regions } = Astro.props;

// Count events by category
const counts = {
  all: events.length,
  kinder: events.filter(e => e.category === 'kinder').length,
  familie: events.filter(e => e.category === 'familie').length,
  erwachsene: events.filter(e => e.category === 'erwachsene').length,
};

// Count events by region
const regionCounts: Record<string, number> = {};
Object.keys(regions).forEach(r => {
  regionCounts[r] = events.filter(e => e.region === r).length;
});

// Get unique locations sorted
const locations = [...new Set(events.map(e => e.location))].sort();
---

<div class="filter-container">
  <!-- Quick Stats -->
  <div class="stats-bar">
    <span class="stat-item">üìä <strong>{events.length}</strong> Events</span>
    <span class="stat-divider">‚Ä¢</span>
    <span class="stat-item">üó∫Ô∏è <strong>{Object.keys(regionCounts).filter(r => regionCounts[r] > 0).length}</strong> Regionen</span>
  </div>

  <!-- Filters Row -->
  <div class="filters-row">
    <!-- Region Filter (horizontal scroll on mobile) -->
    <div class="filter-group">
      <label class="filter-label">Region</label>
      <div class="filter-scroll hide-scrollbar">
        <button class="chip active" data-region="all">
          Alle
        </button>
        {Object.entries(regions).map(([id, region]) => (
          regionCounts[id] > 0 && (
            <button class="chip region-chip" data-region={id}>
              <span class="chip-emoji">{region.emoji}</span>
              <span class="chip-text">{region.name}</span>
              <span class="chip-count">{regionCounts[id]}</span>
            </button>
          )
        ))}
      </div>
    </div>

    <!-- Category Filter -->
    <div class="filter-group">
      <label class="filter-label">F√ºr wen?</label>
      <div class="filter-scroll hide-scrollbar">
        <button class="chip category-chip active" data-filter="all">Alle</button>
        <button class="chip category-chip" data-filter="kinder" data-color="kinder">
          üë∂ Kinder <span class="chip-count">{counts.kinder}</span>
        </button>
        <button class="chip category-chip" data-filter="familie" data-color="familie">
          üë®‚Äçüë©‚Äçüëß Familie <span class="chip-count">{counts.familie}</span>
        </button>
        <button class="chip category-chip" data-filter="erwachsene" data-color="erwachsene">
          üé≠ Erwachsene <span class="chip-count">{counts.erwachsene}</span>
        </button>
      </div>
    </div>

    <!-- Location Dropdown -->
    <div class="filter-group filter-group-select">
      <label class="filter-label" for="location-filter">Ort</label>
      <select class="location-select" id="location-filter">
        <option value="all">Alle Orte</option>
        {locations.map(loc => (
          <option value={loc}>{loc}</option>
        ))}
      </select>
    </div>
  </div>
</div>

<style>
  .filter-container {
    background: var(--color-card);
    border-radius: var(--radius-lg);
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--color-border);
  }

  .stats-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-bottom: 12px;
    margin-bottom: 12px;
    border-bottom: 1px solid var(--color-border);
    font-size: 0.85rem;
    color: var(--color-text-secondary);
  }

  .stat-item strong {
    color: var(--color-text);
  }

  .stat-divider {
    opacity: 0.3;
  }

  .filters-row {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  @media (min-width: 768px) {
    .filters-row {
      flex-direction: row;
      align-items: flex-end;
      gap: 16px;
    }

    .filter-group {
      flex: 1;
    }

    .filter-group-select {
      flex: 0 0 auto;
      min-width: 180px;
    }
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .filter-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-muted);
  }

  .filter-scroll {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding-bottom: 4px;
    margin-bottom: -4px;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-full);
    background: var(--color-card);
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    white-space: nowrap;
    color: var(--color-text-secondary);
  }

  .chip:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .chip.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }

  .chip-emoji {
    font-size: 0.9rem;
  }

  .chip-count {
    font-size: 0.7rem;
    padding: 1px 5px;
    background: rgba(0,0,0,0.08);
    border-radius: var(--radius-full);
  }

  .chip.active .chip-count {
    background: rgba(255,255,255,0.25);
  }

  /* Category color hints */
  .category-chip[data-color="kinder"]:not(.active):hover {
    border-color: var(--color-kinder);
    color: var(--color-kinder);
  }
  .category-chip[data-color="familie"]:not(.active):hover {
    border-color: var(--color-familie);
    color: var(--color-familie);
  }
  .category-chip[data-color="erwachsene"]:not(.active):hover {
    border-color: var(--color-erwachsene);
    color: var(--color-erwachsene);
  }

  .location-select {
    width: 100%;
    padding: 8px 12px;
    border: 1.5px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    background: var(--color-card);
    color: var(--color-text);
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .location-select:hover {
    border-color: var(--color-primary);
  }
</style>

<script>
  const regionChips = document.querySelectorAll('.chip[data-region]');
  const categoryChips = document.querySelectorAll('.chip[data-filter]');
  const locationSelect = document.getElementById('location-filter') as HTMLSelectElement;
  const eventCards = document.querySelectorAll('.event-card');

  let activeRegion = 'all';
  let activeCategory = 'all';
  let activeLocation = 'all';

  function filterEvents() {
    let visibleCount = 0;
    
    eventCards.forEach(card => {
      const el = card as HTMLElement;
      const matchesRegion = activeRegion === 'all' || el.dataset.region === activeRegion;
      const matchesCategory = activeCategory === 'all' || el.dataset.category === activeCategory;
      const matchesLocation = activeLocation === 'all' || el.dataset.location === activeLocation;

      if (matchesRegion && matchesCategory && matchesLocation) {
        el.style.display = '';
        visibleCount++;
      } else {
        el.style.display = 'none';
      }
    });

    // Update stats
    const statsEl = document.querySelector('.stat-item strong');
    if (statsEl) statsEl.textContent = String(visibleCount);
  }

  regionChips.forEach(chip => {
    chip.addEventListener('click', () => {
      regionChips.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      activeRegion = (chip as HTMLElement).dataset.region || 'all';
      filterEvents();
    });
  });

  categoryChips.forEach(chip => {
    chip.addEventListener('click', () => {
      categoryChips.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      activeCategory = (chip as HTMLElement).dataset.filter || 'all';
      filterEvents();
    });
  });

  locationSelect?.addEventListener('change', () => {
    activeLocation = locationSelect.value;
    filterEvents();
  });
</script>
