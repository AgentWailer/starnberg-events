---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Analytics · Starnberg Events" description="Website-Analytics für Starnberg Events">

<main class="an-page">
  <a href="/" class="an-back">&larr; Zurück zu Events</a>

  <!-- Password Gate -->
  <div class="an-auth" id="an-auth">
    <div class="an-auth-card">
      <h1 class="an-auth-title">Analytics</h1>
      <p class="an-auth-sub">Zugang zum Dashboard</p>
      <form id="an-auth-form">
        <input type="password" id="an-auth-input" class="an-auth-input" placeholder="Passwort eingeben" autocomplete="off" />
        <button type="submit" class="an-auth-btn">Anmelden</button>
      </form>
      <p class="an-auth-error" id="an-auth-error" style="display:none;">Falsches Passwort</p>
    </div>
  </div>

  <!-- Dashboard (hidden until auth) -->
  <div class="an-dashboard" id="an-dashboard" style="display:none;">
    <header class="an-header">
      <div>
        <h1 class="an-header__title">Analytics</h1>
        <p class="an-header__sub">Website-Statistiken</p>
      </div>
      <button class="an-logout" id="an-logout" title="Abmelden">Abmelden</button>
    </header>

    <!-- Period Toggle -->
    <div class="an-period-toggle">
      <button class="an-period-btn" data-days="7">7 Tage</button>
      <button class="an-period-btn active" data-days="30">30 Tage</button>
      <button class="an-period-btn" data-days="90">90 Tage</button>
    </div>

    <!-- Loading -->
    <div class="an-loading" id="an-loading">
      <div class="an-spinner"></div>
      <p>Lade Daten&hellip;</p>
    </div>

    <!-- Content -->
    <div class="an-content" id="an-content" style="display:none;">

      <!-- 1. Summary Cards -->
      <section class="an-card">
        <div class="an-summary">
          <div class="an-sc">
            <span class="an-sc__val" id="sc-pageviews">&ndash;</span>
            <span class="an-sc__lbl">Seitenaufrufe</span>
          </div>
          <div class="an-sc">
            <span class="an-sc__val" id="sc-visitors">&ndash;</span>
            <span class="an-sc__lbl">Besucher</span>
          </div>
          <div class="an-sc">
            <span class="an-sc__val" id="sc-days">&ndash;</span>
            <span class="an-sc__lbl">Aktive Tage</span>
          </div>
          <div class="an-sc">
            <span class="an-sc__val" id="sc-avg">&ndash;</span>
            <span class="an-sc__lbl">&empty; pro Tag</span>
          </div>
        </div>
      </section>

      <!-- 2. Daily Chart -->
      <section class="an-card">
        <h2 class="an-section-title">Tagesverlauf</h2>
        <div class="an-chart-wrap" id="an-daily-chart"></div>
      </section>

      <!-- 3. Top Seiten -->
      <section class="an-card">
        <h2 class="an-section-title">Top Seiten</h2>
        <div class="an-table-wrap" id="an-pages-table"></div>
      </section>

      <!-- 4. Herkunft -->
      <section class="an-card">
        <h2 class="an-section-title">Herkunft</h2>
        <div class="an-table-wrap" id="an-referrers-table"></div>
      </section>

      <!-- 5. Länder -->
      <section class="an-card">
        <h2 class="an-section-title">Länder</h2>
        <div class="an-bar-list" id="an-countries-bars"></div>
      </section>

      <!-- 6. Geräte -->
      <section class="an-card">
        <h2 class="an-section-title">Geräte</h2>
        <div class="an-bar-list" id="an-devices-bars"></div>
      </section>

      <!-- 7. Browser -->
      <section class="an-card">
        <h2 class="an-section-title">Browser</h2>
        <div class="an-bar-list" id="an-browsers-bars"></div>
      </section>
    </div>

    <!-- Footer -->
    <p class="an-meta">
      Selbstgehostete Analyse &middot; Keine Cookies &middot; DSGVO-konform
      <br>
      <a href="/impressum">Impressum</a> &middot; <a href="/datenschutz">Datenschutz</a>
      <br>
      <span class="footer-love">Made with &#10084;&#65039; for Pöcking</span>
    </p>
  </div>
</main>
</Layout>

<style>
  .an-page { max-width: 760px; margin: 0 auto; padding: var(--space-5) var(--space-4); }
  .an-back { display: inline-block; font-size: 0.875rem; color: var(--color-text-secondary); text-decoration: none; margin-bottom: var(--space-4); }
  .an-back:hover { color: var(--color-primary); }

  /* Auth screen */
  .an-auth { display: flex; align-items: center; justify-content: center; min-height: 50vh; }
  .an-auth-card { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-8); max-width: 360px; width: 100%; text-align: center; box-shadow: var(--shadow-md); }
  .an-auth-title { font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--color-text); margin: 0 0 var(--space-2); }
  .an-auth-sub { font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--space-5); }
  .an-auth-input { width: 100%; padding: var(--space-3) var(--space-4); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg-secondary); color: var(--color-text); font-size: 0.9375rem; margin-bottom: var(--space-3); outline: none; transition: border-color var(--duration-fast) ease; }
  .an-auth-input:focus { border-color: var(--color-primary); }
  .an-auth-btn { width: 100%; padding: var(--space-3); border: none; border-radius: var(--radius-md); background: var(--color-primary); color: #fff; font-size: 0.9375rem; font-weight: 600; cursor: pointer; transition: background var(--duration-fast) ease; min-height: 44px; }
  .an-auth-btn:hover { background: var(--color-primary-light); }
  .an-auth-error { color: #dc2626; font-size: 0.8125rem; margin-top: var(--space-3); }
  :root.dark .an-auth-error { color: #f87171; }

  /* Header */
  .an-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-5); }
  .an-header__title { font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--color-text); margin: 0; }
  .an-header__sub { font-size: 0.9375rem; color: var(--color-text-secondary); margin: var(--space-1) 0 0; }
  .an-logout { background: none; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-2) var(--space-3); color: var(--color-text-secondary); font-size: 0.8125rem; cursor: pointer; transition: all var(--duration-fast) ease; min-height: 44px; }
  .an-logout:hover { color: var(--color-text); border-color: var(--color-text-secondary); }

  /* Period toggle */
  .an-period-toggle { display: flex; gap: var(--space-2); margin-bottom: var(--space-5); background: var(--color-bg-secondary); padding: var(--space-1); border-radius: var(--radius-lg); }
  .an-period-btn { flex: 1; padding: var(--space-2) var(--space-3); min-height: 44px; border: none; border-radius: var(--radius-md); background: transparent; color: var(--color-text-secondary); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all var(--duration-fast) ease; -webkit-tap-highlight-color: transparent; }
  .an-period-btn:hover { color: var(--color-text); }
  .an-period-btn.active { background: var(--color-card); color: var(--color-text); box-shadow: var(--shadow-sm); }

  /* Loading */
  .an-loading { text-align: center; padding: var(--space-10) 0; color: var(--color-text-secondary); }
  .an-spinner { width: 32px; height: 32px; border: 3px solid var(--color-border-light); border-top-color: var(--color-primary); border-radius: 50%; margin: 0 auto var(--space-4); animation: an-spin 0.8s linear infinite; }
  @keyframes an-spin { to { transform: rotate(360deg); } }

  /* Cards */
  .an-card { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4); box-shadow: var(--shadow-sm); }
  .an-section-title { font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 600; color: var(--color-text); margin: 0 0 var(--space-4); padding-bottom: var(--space-2); border-bottom: 1px solid var(--color-border-light); }

  /* Summary cards */
  .an-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-3); }
  .an-sc { text-align: center; padding: var(--space-3) var(--space-2); border-radius: var(--radius-md); background: var(--color-bg-secondary); }
  .an-sc__val { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; line-height: 1.1; color: var(--color-primary); }
  .an-sc__lbl { display: block; font-size: 0.75rem; font-weight: 600; margin-top: 4px; color: var(--color-text-secondary); }
  @media (max-width: 480px) { .an-summary { grid-template-columns: repeat(2, 1fr); } .an-sc__val { font-size: 1.5rem; } }

  /* Chart wrapper */
  .an-chart-wrap { width: 100%; overflow: hidden; }
  .an-chart-wrap svg { width: 100%; height: auto; display: block; }

  /* Table */
  .an-table-wrap { overflow-x: auto; }
  .an-tbl { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
  .an-tbl th { text-align: left; font-weight: 600; color: var(--color-text-secondary); padding: var(--space-2); border-bottom: 2px solid var(--color-border-light); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
  .an-tbl th:last-child, .an-tbl td:last-child { text-align: right; }
  .an-tbl th:nth-child(2), .an-tbl td:nth-child(2) { text-align: right; }
  .an-tbl td { padding: var(--space-2); border-bottom: 1px solid var(--color-border-light); color: var(--color-text); }
  .an-tbl td:first-child { font-weight: 500; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .an-tbl .an-num { font-family: 'Space Grotesk', sans-serif; font-weight: 600; font-variant-numeric: tabular-nums; }

  /* Bar list */
  .an-bar-list { display: flex; flex-direction: column; gap: var(--space-3); }
  .an-bar-item { display: flex; flex-direction: column; gap: var(--space-1); }
  .an-bar-header { display: flex; justify-content: space-between; font-size: 0.8125rem; }
  .an-bar-label { font-weight: 500; color: var(--color-text); }
  .an-bar-value { font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: var(--color-text-secondary); font-variant-numeric: tabular-nums; }
  .an-bar-track { height: 24px; background: var(--color-bg-secondary); border-radius: var(--radius-sm); overflow: hidden; }
  .an-bar-fill { height: 100%; border-radius: var(--radius-sm); background: var(--color-primary); transition: width 0.4s ease; min-width: 2px; }

  /* Footer */
  .an-meta { font-size: 0.75rem; color: var(--color-text-tertiary, #999); text-align: center; line-height: 1.6; margin-top: var(--space-4); max-width: none; margin-left: auto; margin-right: auto; }
  .an-meta a { color: var(--color-primary); }
  .footer-love { font-size: 0.65rem; opacity: 0.5; letter-spacing: 0.03em; }

  /* Mobile */
  @media (max-width: 600px) {
    .an-page { padding: var(--space-4) var(--space-3); }
    .an-card { padding: var(--space-4) var(--space-3); }
    .an-header__title { font-size: 1.375rem; }
    .an-tbl { font-size: 0.75rem; }
    .an-tbl th, .an-tbl td { padding: var(--space-1) var(--space-2); }
  }
</style>

<script>
  const API = 'https://train-tracker.steffenvonlindern-be7.workers.dev';
  let currentDays = 30;
  let analyticsKey = localStorage.getItem('analytics_key') || '';

  const $ = (id: string) => document.getElementById(id)!;

  // ── Auth ──
  const authScreen = $('an-auth');
  const dashboard = $('an-dashboard');
  const authForm = $('an-auth-form') as HTMLFormElement;
  const authInput = $('an-auth-input') as HTMLInputElement;
  const authError = $('an-auth-error');

  if (analyticsKey) {
    tryAuth(analyticsKey);
  }

  authForm.addEventListener('submit', (e: Event) => {
    e.preventDefault();
    const val = authInput.value.trim();
    if (!val) return;
    tryAuth(val);
  });

  $('an-logout').addEventListener('click', () => {
    localStorage.removeItem('analytics_key');
    analyticsKey = '';
    dashboard.style.display = 'none';
    authScreen.style.display = '';
    authInput.value = '';
    authError.style.display = 'none';
  });

  async function tryAuth(key: string) {
    try {
      const res = await fetch(`${API}/api/analytics?days=30&key=${encodeURIComponent(key)}`);
      if (res.status === 401) {
        authError.style.display = '';
        return;
      }
      const data = await res.json();
      analyticsKey = key;
      localStorage.setItem('analytics_key', key);
      authScreen.style.display = 'none';
      dashboard.style.display = '';
      authError.style.display = 'none';
      renderDashboard(data);
    } catch {
      authError.style.display = '';
    }
  }

  // ── Period toggle ──
  document.querySelectorAll('.an-period-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelector('.an-period-btn.active')?.classList.remove('active');
      btn.classList.add('active');
      currentDays = parseInt((btn as HTMLElement).dataset.days || '30', 10);
      loadData();
    });
  });

  async function loadData() {
    $('an-loading').style.display = '';
    $('an-content').style.display = 'none';
    try {
      const res = await fetch(`${API}/api/analytics?days=${currentDays}&key=${encodeURIComponent(analyticsKey)}`);
      if (res.status === 401) {
        localStorage.removeItem('analytics_key');
        analyticsKey = '';
        dashboard.style.display = 'none';
        authScreen.style.display = '';
        authError.style.display = '';
        return;
      }
      const data = await res.json();
      renderDashboard(data);
    } catch {
      // silent
    }
  }

  // ── Render ──
  function renderDashboard(data: any) {
    $('an-loading').style.display = 'none';
    $('an-content').style.display = '';

    // Summary
    $('sc-pageviews').textContent = num(data.summary.pageviews);
    $('sc-visitors').textContent = num(data.summary.visitors);
    $('sc-days').textContent = String(data.summary.activeDays);
    $('sc-avg').textContent = num(data.summary.avgPerDay);

    // Daily chart
    renderDailyChart(data.daily);

    // Pages table
    renderPagesTable(data.pages);

    // Referrers table
    renderReferrersTable(data.referrers);

    // Countries
    renderBarList('an-countries-bars', data.countries.map((c: any) => ({ label: c.country || '??', value: c.count })));

    // Devices
    const totalDevices = data.devices.reduce((s: number, d: any) => s + d.count, 0);
    renderBarList('an-devices-bars', data.devices.map((d: any) => ({
      label: d.device.charAt(0).toUpperCase() + d.device.slice(1),
      value: d.count,
      pct: totalDevices > 0 ? Math.round((d.count / totalDevices) * 100) : 0,
    })));

    // Browsers
    const totalBrowsers = data.browsers.reduce((s: number, b: any) => s + b.count, 0);
    renderBarList('an-browsers-bars', data.browsers.map((b: any) => ({
      label: b.browser,
      value: b.count,
      pct: totalBrowsers > 0 ? Math.round((b.count / totalBrowsers) * 100) : 0,
    })));
  }

  // ── Helpers ──
  function num(n: number): string {
    return n.toLocaleString('de-DE');
  }

  function esc(s: string): string {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  // ── Daily Chart (SVG) ──
  function renderDailyChart(daily: any[]) {
    const container = $('an-daily-chart');
    if (!daily || daily.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Noch keine Daten vorhanden.</p>';
      return;
    }

    const W = 700, H = 220, PAD_L = 40, PAD_R = 10, PAD_T = 15, PAD_B = 40;
    const cw = W - PAD_L - PAD_R;
    const ch = H - PAD_T - PAD_B;

    const maxPV = Math.max(...daily.map((d: any) => d.pageviews), 1);
    const maxVal = Math.ceil(maxPV / 5) * 5 || 5;

    const xStep = daily.length > 1 ? cw / (daily.length - 1) : cw / 2;

    // Build points for pageviews area + line
    const pvPoints: string[] = [];
    const visPoints: string[] = [];
    daily.forEach((d: any, i: number) => {
      const x = PAD_L + i * xStep;
      const yPV = PAD_T + ch - (d.pageviews / maxVal) * ch;
      const yVis = PAD_T + ch - (d.visitors / maxVal) * ch;
      pvPoints.push(`${x.toFixed(1)},${yPV.toFixed(1)}`);
      visPoints.push(`${x.toFixed(1)},${yVis.toFixed(1)}`);
    });

    // Area path for pageviews
    const areaPath = `M${PAD_L},${PAD_T + ch} L${pvPoints.join(' L')} L${PAD_L + (daily.length - 1) * xStep},${PAD_T + ch} Z`;
    const pvLine = `M${pvPoints.join(' L')}`;
    const visLine = `M${visPoints.join(' L')}`;

    // Grid lines
    const gridLines: string[] = [];
    const yLabels: string[] = [];
    const gridSteps = 4;
    for (let i = 0; i <= gridSteps; i++) {
      const y = PAD_T + ch - (i / gridSteps) * ch;
      const val = Math.round((i / gridSteps) * maxVal);
      gridLines.push(`<line x1="${PAD_L}" y1="${y.toFixed(1)}" x2="${W - PAD_R}" y2="${y.toFixed(1)}" stroke="var(--color-border-light)" stroke-width="1" />`);
      yLabels.push(`<text x="${PAD_L - 6}" y="${(y + 3).toFixed(1)}" text-anchor="end" fill="var(--color-muted)" font-size="10">${val}</text>`);
    }

    // X-axis labels (show ~7 labels max)
    const xLabels: string[] = [];
    const labelInterval = Math.max(1, Math.floor(daily.length / 7));
    daily.forEach((d: any, i: number) => {
      if (i % labelInterval === 0 || i === daily.length - 1) {
        const x = PAD_L + i * xStep;
        const dateStr = d.date.slice(5); // MM-DD
        xLabels.push(`<text x="${x.toFixed(1)}" y="${H - 8}" text-anchor="middle" fill="var(--color-muted)" font-size="10">${dateStr}</text>`);
      }
    });

    // Dots for pageviews and visitors
    const pvDots: string[] = [];
    const visDots: string[] = [];
    daily.forEach((d: any, i: number) => {
      const x = PAD_L + i * xStep;
      const yPV = PAD_T + ch - (d.pageviews / maxVal) * ch;
      const yVis = PAD_T + ch - (d.visitors / maxVal) * ch;
      pvDots.push(`<circle cx="${x.toFixed(1)}" cy="${yPV.toFixed(1)}" r="3" fill="var(--color-primary)" />`);
      visDots.push(`<circle cx="${x.toFixed(1)}" cy="${yVis.toFixed(1)}" r="3" fill="var(--color-accent)" />`);
    });

    container.innerHTML = `
      <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
        ${gridLines.join('')}
        ${yLabels.join('')}
        ${xLabels.join('')}
        <path d="${areaPath}" fill="var(--color-primary)" opacity="0.12" />
        <path d="${pvLine}" fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" />
        <path d="${visLine}" fill="none" stroke="var(--color-accent)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke-dasharray="6,3" />
        ${pvDots.join('')}
        ${visDots.join('')}
      </svg>
      <div style="display:flex;gap:var(--space-4);justify-content:center;margin-top:var(--space-2);font-size:0.75rem;color:var(--color-text-secondary);">
        <span><span style="display:inline-block;width:12px;height:3px;background:var(--color-primary);vertical-align:middle;margin-right:4px;border-radius:2px;"></span>Seitenaufrufe</span>
        <span><span style="display:inline-block;width:12px;height:3px;background:var(--color-accent);vertical-align:middle;margin-right:4px;border-radius:2px;border-top:1px dashed var(--color-accent);"></span>Besucher</span>
      </div>
    `;
  }

  // ── Pages Table ──
  function renderPagesTable(pages: any[]) {
    const container = $('an-pages-table');
    if (!pages || pages.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }
    let html = `<table class="an-tbl"><thead><tr><th>Seite</th><th>Aufrufe</th><th>Besucher</th></tr></thead><tbody>`;
    pages.forEach((p: any) => {
      html += `<tr><td>${esc(p.path)}</td><td class="an-num">${num(p.views)}</td><td class="an-num">${num(p.visitors)}</td></tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  // ── Referrers Table ──
  function renderReferrersTable(referrers: any[]) {
    const container = $('an-referrers-table');
    if (!referrers || referrers.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Referrer-Daten.</p>';
      return;
    }
    let html = `<table class="an-tbl"><thead><tr><th>Referrer</th><th>Aufrufe</th></tr></thead><tbody>`;
    referrers.forEach((r: any) => {
      html += `<tr><td>${esc(r.referrer)}</td><td class="an-num">${num(r.count)}</td></tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  // ── Bar List (countries, devices, browsers) ──
  function renderBarList(containerId: string, items: Array<{label: string; value: number; pct?: number}>) {
    const container = $(containerId);
    if (!items || items.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }
    const maxVal = Math.max(...items.map(i => i.value), 1);
    let html = '';
    items.forEach(item => {
      const width = Math.max(2, (item.value / maxVal) * 100);
      const display = item.pct !== undefined ? `${num(item.value)} (${item.pct}%)` : num(item.value);
      html += `
        <div class="an-bar-item">
          <div class="an-bar-header">
            <span class="an-bar-label">${esc(item.label)}</span>
            <span class="an-bar-value">${display}</span>
          </div>
          <div class="an-bar-track"><div class="an-bar-fill" style="width:${width.toFixed(1)}%"></div></div>
        </div>`;
    });
    container.innerHTML = html;
  }
</script>
