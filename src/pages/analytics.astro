---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Analytics · Starnberg Events" description="Website-Analytics für Starnberg Events">

<main class="an-page">
  <a href="/" class="an-back">&larr; Zurück zu Events</a>

  <!-- Password Gate -->
  <div class="an-auth" id="an-auth">
    <div class="an-auth-card">
      <h1 class="an-auth-title">Analytics</h1>
      <p class="an-auth-sub">Zugang zum Dashboard</p>
      <form id="an-auth-form">
        <input type="password" id="an-auth-input" class="an-auth-input" placeholder="Passwort eingeben" autocomplete="off" />
        <button type="submit" class="an-auth-btn">Anmelden</button>
      </form>
      <p class="an-auth-error" id="an-auth-error" style="display:none;">Falsches Passwort</p>
    </div>
  </div>

  <!-- Dashboard (hidden until auth) -->
  <div class="an-dashboard" id="an-dashboard" style="display:none;">
    <header class="an-header">
      <div>
        <h1 class="an-header__title">Analytics</h1>
        <p class="an-header__sub">Website-Statistiken</p>
      </div>
      <div class="an-header__right">
        <div class="an-realtime" id="an-realtime" style="display:none;">
          <span class="an-realtime__dot"></span>
          <span class="an-realtime__text" id="an-realtime-text"></span>
        </div>
        <span class="an-updated" id="an-updated"></span>
        <button class="an-logout" id="an-logout" title="Abmelden">Abmelden</button>
      </div>
    </header>

    <!-- Period Toggle -->
    <div class="an-period-toggle">
      <button class="an-period-btn" data-days="7">7 Tage</button>
      <button class="an-period-btn active" data-days="30">30 Tage</button>
      <button class="an-period-btn" data-days="90">90 Tage</button>
    </div>

    <!-- Loading -->
    <div class="an-loading" id="an-loading">
      <div class="an-spinner"></div>
      <p>Lade Daten&hellip;</p>
    </div>

    <!-- Content -->
    <div class="an-content" id="an-content" style="display:none;">

      <!-- 1. Summary Cards -->
      <div class="an-summary" id="an-summary"></div>

      <!-- 2. Tagesverlauf -->
      <section class="an-card">
        <h2 class="an-section-title">Tagesverlauf</h2>
        <div class="an-chart-wrap" id="an-daily-chart"></div>
      </section>

      <!-- 3. Stündliche Verteilung -->
      <section class="an-card">
        <h2 class="an-section-title">Stündliche Verteilung</h2>
        <div class="an-chart-wrap" id="an-hourly-chart"></div>
      </section>

      <!-- 4. Wochentage -->
      <section class="an-card">
        <h2 class="an-section-title">Wochentage</h2>
        <div class="an-chart-wrap" id="an-weekday-bars"></div>
      </section>

      <!-- 5. Neue vs. Wiederkehrende Besucher -->
      <section class="an-card">
        <h2 class="an-section-title">Neue vs. Wiederkehrende Besucher</h2>
        <div id="an-newret"></div>
      </section>

      <!-- 6. Top Seiten -->
      <section class="an-card">
        <h2 class="an-section-title">Top Seiten</h2>
        <div class="an-table-wrap" id="an-pages-table"></div>
      </section>

      <!-- 7. Herkunft -->
      <section class="an-card">
        <h2 class="an-section-title">Herkunft</h2>
        <div class="an-table-wrap" id="an-referrers-table"></div>
      </section>

      <!-- 8. Länder -->
      <section class="an-card">
        <h2 class="an-section-title">Länder</h2>
        <div class="an-bar-list" id="an-countries-bars"></div>
      </section>

      <!-- 9. Geräte -->
      <section class="an-card">
        <h2 class="an-section-title">Geräte</h2>
        <div id="an-devices-bars"></div>
      </section>

      <!-- 10. Browser -->
      <section class="an-card">
        <h2 class="an-section-title">Browser</h2>
        <div id="an-browsers-bars"></div>
      </section>

      <!-- 11. Sprachen -->
      <section class="an-card">
        <h2 class="an-section-title">Sprachen</h2>
        <div class="an-bar-list" id="an-languages-bars"></div>
      </section>
    </div>

    <!-- Footer -->
    <p class="an-meta">
      Selbstgehostete Analyse &middot; Keine Cookies &middot; DSGVO-konform
      <br>
      <a href="/impressum">Impressum</a> &middot; <a href="/datenschutz">Datenschutz</a>
      <br>
      <span class="footer-love">Made with &#10084;&#65039; for Pöcking</span>
    </p>
  </div>
</main>
</Layout>

<style>
  .an-page { max-width: 760px; margin: 0 auto; padding: var(--space-5) var(--space-4); }
  .an-back { display: inline-block; font-size: 0.875rem; color: var(--color-text-secondary); text-decoration: none; margin-bottom: var(--space-4); }
  .an-back:hover { color: var(--color-primary); }

  /* Auth screen */
  .an-auth { display: flex; align-items: center; justify-content: center; min-height: 50vh; }
  .an-auth-card { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-8); max-width: 360px; width: 100%; text-align: center; box-shadow: var(--shadow-md); }
  .an-auth-title { font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--color-text); margin: 0 0 var(--space-2); }
  .an-auth-sub { font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--space-5); }
  .an-auth-input { width: 100%; padding: var(--space-3) var(--space-4); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg-secondary); color: var(--color-text); font-size: 0.9375rem; margin-bottom: var(--space-3); outline: none; transition: border-color var(--duration-fast) ease; }
  .an-auth-input:focus { border-color: var(--color-primary); }
  .an-auth-btn { width: 100%; padding: var(--space-3); border: none; border-radius: var(--radius-md); background: var(--color-primary); color: #fff; font-size: 0.9375rem; font-weight: 600; cursor: pointer; transition: background var(--duration-fast) ease; min-height: 44px; }
  .an-auth-btn:hover { background: var(--color-primary-light); }
  .an-auth-error { color: #dc2626; font-size: 0.8125rem; margin-top: var(--space-3); }
  :root.dark .an-auth-error { color: #f87171; }

  /* Header */
  .an-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: var(--space-5); gap: var(--space-3); }
  .an-header__title { font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--color-text); margin: 0; }
  .an-header__sub { font-size: 0.9375rem; color: var(--color-text-secondary); margin: var(--space-1) 0 0; }
  .an-header__right { display: flex; flex-direction: column; align-items: flex-end; gap: var(--space-2); }
  .an-logout { background: none; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-2) var(--space-3); color: var(--color-text-secondary); font-size: 0.8125rem; cursor: pointer; transition: all var(--duration-fast) ease; min-height: 44px; }
  .an-logout:hover { color: var(--color-text); border-color: var(--color-text-secondary); }
  .an-updated { font-size: 0.6875rem; color: var(--color-muted); }

  /* Real-time indicator */
  .an-realtime { display: flex; align-items: center; gap: var(--space-2); font-size: 0.75rem; color: var(--color-text-secondary); }
  .an-realtime__dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; flex-shrink: 0; animation: an-pulse 2s ease-in-out infinite; }
  @keyframes an-pulse { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); } }
  .an-realtime__text { white-space: nowrap; }

  /* Period toggle */
  .an-period-toggle { display: flex; gap: var(--space-2); margin-bottom: var(--space-5); background: var(--color-bg-secondary); padding: var(--space-1); border-radius: var(--radius-lg); }
  .an-period-btn { flex: 1; padding: var(--space-2) var(--space-3); min-height: 44px; border: none; border-radius: var(--radius-md); background: transparent; color: var(--color-text-secondary); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all var(--duration-fast) ease; -webkit-tap-highlight-color: transparent; }
  .an-period-btn:hover { color: var(--color-text); }
  .an-period-btn.active { background: var(--color-card); color: var(--color-text); box-shadow: var(--shadow-sm); }

  /* Loading */
  .an-loading { text-align: center; padding: var(--space-10) 0; color: var(--color-text-secondary); }
  .an-spinner { width: 32px; height: 32px; border: 3px solid var(--color-border-light); border-top-color: var(--color-primary); border-radius: 50%; margin: 0 auto var(--space-4); animation: an-spin 0.8s linear infinite; }
  @keyframes an-spin { to { transform: rotate(360deg); } }

  /* Cards */
  .an-card { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4); box-shadow: var(--shadow-sm); }
  .an-section-title { font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 600; color: var(--color-text); margin: 0 0 var(--space-4); padding-bottom: var(--space-2); border-bottom: 1px solid var(--color-border-light); }

  /* Summary cards */
  .an-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-3); margin-bottom: var(--space-4); }
  .an-sc { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-4) var(--space-3); text-align: center; box-shadow: var(--shadow-sm); }
  .an-sc__val { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; line-height: 1.1; color: var(--color-primary); }
  .an-sc__spark { display: block; margin: 6px auto 2px; opacity: 0.7; }
  .an-sc__lbl { display: block; font-size: 0.75rem; font-weight: 600; margin-top: 4px; color: var(--color-text-secondary); }
  .an-sc__trend { display: block; font-size: 0.6875rem; margin-top: 6px; font-weight: 600; }
  .an-sc__trend--up { color: #10b981; }
  .an-sc__trend--down { color: #ef4444; }
  .an-sc__trend--flat { color: var(--color-muted); }
  .an-sc__trend-sub { display: block; font-size: 0.625rem; color: var(--color-muted); margin-top: 2px; }
  @media (max-width: 540px) { .an-summary { grid-template-columns: repeat(2, 1fr); } .an-sc__val { font-size: 1.5rem; } }

  /* Chart wrapper */
  .an-chart-wrap { width: 100%; overflow: hidden; }
  .an-chart-wrap svg { width: 100%; height: auto; display: block; }

  /* Table */
  .an-table-wrap { overflow-x: auto; }
  .an-tbl { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
  .an-tbl th { text-align: left; font-weight: 600; color: var(--color-text-secondary); padding: var(--space-2); border-bottom: 2px solid var(--color-border-light); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
  .an-tbl th:last-child, .an-tbl td:last-child { text-align: right; }
  .an-tbl th:nth-child(2), .an-tbl td:nth-child(2) { text-align: right; }
  .an-tbl td { padding: var(--space-2); border-bottom: 1px solid var(--color-border-light); color: var(--color-text); }
  .an-tbl td:first-child { font-weight: 500; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .an-tbl .an-num { font-family: 'Space Grotesk', sans-serif; font-weight: 600; font-variant-numeric: tabular-nums; }

  /* Inline bar inside table cells */
  .an-bar-inline-cell { position: relative; }
  .an-bar-inline { position: absolute; top: 0; left: 0; height: 100%; background: var(--color-primary); opacity: 0.12; border-radius: 2px; pointer-events: none; transition: width 0.6s ease; }
  .an-bar-inline-cell > span { position: relative; z-index: 1; }

  /* Bar list */
  .an-bar-list { display: flex; flex-direction: column; gap: var(--space-3); }
  .an-bar-item { display: flex; flex-direction: column; gap: var(--space-1); }
  .an-bar-header { display: flex; justify-content: space-between; font-size: 0.8125rem; }
  .an-bar-label { font-weight: 500; color: var(--color-text); }
  .an-bar-value { font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: var(--color-text-secondary); font-variant-numeric: tabular-nums; }
  .an-bar-track { height: 28px; background: rgba(255,255,255,0.04); border-radius: var(--radius-sm); overflow: hidden; }
  .an-bar-fill { height: 100%; border-radius: var(--radius-sm); background: var(--color-primary); transition: width 0.6s ease; min-width: 2px; }
  .an-bar-fill--accent { background: var(--color-accent); }

  /* Country bars with labels inside */
  .an-country-item { height: 28px; background: rgba(255,255,255,0.04); border-radius: var(--radius-sm); overflow: hidden; position: relative; margin-bottom: 6px; }
  .an-country-item:last-child { margin-bottom: 0; }
  .an-country-fill { height: 100%; border-radius: var(--radius-sm); background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light)); transition: width 0.6s ease; min-width: 40px; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; }
  .an-country-label { font-size: 0.75rem; font-weight: 600; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); white-space: nowrap; }
  .an-country-value { font-family: 'Space Grotesk', sans-serif; font-size: 0.6875rem; font-weight: 600; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); white-space: nowrap; font-variant-numeric: tabular-nums; }

  /* New vs returning split bar */
  .an-newret-bar { display: flex; height: 40px; border-radius: var(--radius-sm); overflow: hidden; background: var(--color-bg-secondary); }
  .an-newret-bar__new { background: var(--color-accent); transition: width 0.6s ease; display: flex; align-items: center; justify-content: center; min-width: 0; overflow: hidden; }
  .an-newret-bar__ret { background: var(--color-primary); transition: width 0.6s ease; display: flex; align-items: center; justify-content: center; min-width: 0; overflow: hidden; }
  .an-newret-bar__text { font-size: 0.8125rem; font-weight: 700; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.3); white-space: nowrap; }
  .an-newret-labels { display: flex; justify-content: space-between; margin-top: var(--space-3); font-size: 0.8125rem; flex-wrap: wrap; gap: var(--space-2); }
  .an-newret-labels span { display: inline-flex; align-items: center; gap: 5px; }
  .an-newret-labels span:first-child { color: var(--color-accent); font-weight: 600; }
  .an-newret-labels span:last-child { color: var(--color-primary); font-weight: 600; }
  .an-newret-labels svg { flex-shrink: 0; }
  .an-newret-empty { font-size: 0.875rem; color: var(--color-text-secondary); }

  /* Donut chart */
  .an-donut-wrap { display: flex; flex-direction: column; align-items: center; gap: var(--space-4); }
  .an-donut-svg-wrap { position: relative; }
  .an-donut-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: var(--space-2) var(--space-4); }
  .an-donut-legend__item { display: flex; align-items: center; gap: 6px; font-size: 0.8125rem; color: var(--color-text-secondary); }
  .an-donut-legend__dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .an-donut-legend__pct { font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: var(--color-text); font-variant-numeric: tabular-nums; margin-left: 2px; }

  /* Chart legend */
  .an-chart-legend { display: flex; gap: var(--space-4); justify-content: center; margin-top: var(--space-2); font-size: 0.75rem; color: var(--color-text-secondary); }
  .an-chart-legend__swatch { display: inline-block; width: 12px; height: 3px; vertical-align: middle; margin-right: 4px; border-radius: 2px; }

  /* Footer */
  .an-meta { font-size: 0.75rem; color: var(--color-text-tertiary, #999); text-align: center; line-height: 1.6; margin-top: var(--space-4); max-width: none; margin-left: auto; margin-right: auto; }
  .an-meta a { color: var(--color-primary); }
  .footer-love { font-size: 0.65rem; opacity: 0.5; letter-spacing: 0.03em; }

  /* Mobile */
  @media (max-width: 600px) {
    .an-page { padding: var(--space-4) var(--space-3); }
    .an-card { padding: var(--space-4) var(--space-3); }
    .an-header__title { font-size: 1.375rem; }
    .an-header { flex-wrap: wrap; }
    .an-tbl { font-size: 0.75rem; }
    .an-tbl th, .an-tbl td { padding: var(--space-1) var(--space-2); }
    .an-donut-wrap { gap: var(--space-3); }
    .an-country-fill { min-width: 60px; padding: 0 8px; }
    .an-country-label { font-size: 0.6875rem; }
    .an-country-value { font-size: 0.625rem; }
  }
</style>

<script>
  const API = 'https://train-tracker.steffenvonlindern-be7.workers.dev';
  let currentDays = 30;
  let analyticsKey = localStorage.getItem('analytics_key') || '';
  let lastDailyData: any[] | null = null;

  const $ = (id: string) => document.getElementById(id)!;

  const PAGE_NAMES: Record<string, string> = {
    '/': 'Startseite',
    '/s6/': 'S6 Pünktlichkeit',
    '/impressum/': 'Impressum',
    '/datenschutz/': 'Datenschutz',
    '/analytics/': 'Analytics',
  };

  // ── Auth ──
  const authScreen = $('an-auth');
  const dashboard = $('an-dashboard');
  const authForm = $('an-auth-form') as HTMLFormElement;
  const authInput = $('an-auth-input') as HTMLInputElement;
  const authError = $('an-auth-error');

  if (analyticsKey) {
    tryAuth(analyticsKey);
  }

  authForm.addEventListener('submit', (e: Event) => {
    e.preventDefault();
    const val = authInput.value.trim();
    if (!val) return;
    tryAuth(val);
  });

  $('an-logout').addEventListener('click', () => {
    localStorage.removeItem('analytics_key');
    analyticsKey = '';
    dashboard.style.display = 'none';
    authScreen.style.display = '';
    authInput.value = '';
    authError.style.display = 'none';
  });

  async function tryAuth(key: string) {
    try {
      const res = await fetch(`${API}/api/analytics?days=30&key=${encodeURIComponent(key)}`);
      if (res.status === 401) {
        authError.style.display = '';
        return;
      }
      const data = await res.json();
      analyticsKey = key;
      localStorage.setItem('analytics_key', key);
      authScreen.style.display = 'none';
      dashboard.style.display = '';
      authError.style.display = 'none';
      renderDashboard(data);
    } catch {
      authError.style.display = '';
    }
  }

  // ── Period toggle ──
  document.querySelectorAll('.an-period-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelector('.an-period-btn.active')?.classList.remove('active');
      btn.classList.add('active');
      currentDays = parseInt((btn as HTMLElement).dataset.days || '30', 10);
      loadData();
    });
  });

  async function loadData() {
    $('an-loading').style.display = '';
    $('an-content').style.display = 'none';
    try {
      const res = await fetch(`${API}/api/analytics?days=${currentDays}&key=${encodeURIComponent(analyticsKey)}`);
      if (res.status === 401) {
        localStorage.removeItem('analytics_key');
        analyticsKey = '';
        dashboard.style.display = 'none';
        authScreen.style.display = '';
        authError.style.display = '';
        return;
      }
      const data = await res.json();
      renderDashboard(data);
    } catch {
      // silent
    }
  }

  // ── Helpers ──
  function num(n: number): string {
    return n.toLocaleString('de-DE');
  }

  function esc(s: string): string {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function pageName(path: string): string {
    return PAGE_NAMES[path] || path;
  }

  // ── Mini Sparkline helper ──
  function miniSparkline(daily: any[], key: string, color: string): string {
    if (!daily || daily.length < 2) return '';
    const values = daily.map((d: any) => d[key] || 0);
    const max = Math.max(...values, 1);
    const min = Math.min(...values, 0);
    const range = max - min || 1;
    const W = 60, H = 24;
    const points = values.map((v: number, i: number) => {
      const x = (i / (values.length - 1)) * W;
      const y = H - 2 - ((v - min) / range) * (H - 4);
      return `${x.toFixed(1)},${y.toFixed(1)}`;
    }).join(' ');
    return `<svg class="an-sc__spark" viewBox="0 0 ${W} ${H}" width="${W}" height="${H}" preserveAspectRatio="none"><polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" /></svg>`;
  }

  // ── Render Dashboard ──
  function renderDashboard(data: any) {
    $('an-loading').style.display = 'none';
    $('an-content').style.display = '';

    lastDailyData = data.daily || null;

    // Updated timestamp
    const now = new Date();
    $('an-updated').textContent = `Letzte Aktualisierung: ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    // Real-time indicator
    const rtEl = $('an-realtime');
    const rtText = $('an-realtime-text');
    if (data.realtime) {
      if (data.realtime.last5min > 0) {
        rtEl.style.display = 'flex';
        rtText.textContent = `${data.realtime.last5min} aktiv (letzte 5 Min)`;
      } else if (data.realtime.last30min > 0) {
        rtEl.style.display = 'flex';
        rtText.textContent = `${data.realtime.last30min} in letzten 30 Min`;
      } else {
        rtEl.style.display = 'none';
      }
    } else {
      rtEl.style.display = 'none';
    }

    // Summary cards with trends + sparklines
    renderSummaryCards(data);

    // Daily chart
    renderDailyChart(data.daily);

    // Hourly chart
    renderHourlyChart(data.hourly);

    // Weekday vertical bar chart
    renderWeekdayBars(data.weekdays);

    // New vs returning
    renderNewVsReturning(data.newVsReturning);

    // Pages table (with inline bars)
    renderPagesTable(data.pages);

    // Referrers table (with inline bars)
    renderReferrersTable(data.referrers);

    // Countries (gradient bars with labels inside)
    renderCountryBars(data.countries);

    // Devices (donut chart)
    const totalDevices = data.devices.reduce((s: number, d: any) => s + d.count, 0);
    const deviceItems = data.devices.map((d: any) => ({
      label: d.device.charAt(0).toUpperCase() + d.device.slice(1),
      value: d.count,
    }));
    const deviceColors: Record<string, string> = {
      'Desktop': 'var(--color-primary)',
      'Tablet': 'var(--color-accent)',
      'Mobile': '#e07a5f',
      'mobile': '#e07a5f',
    };
    renderDonutChart('an-devices-bars', deviceItems, deviceColors, 'var(--color-muted)');

    // Browsers (donut chart)
    const browserItems = data.browsers.map((b: any) => ({
      label: b.browser,
      value: b.count,
    }));
    const browserColors: Record<string, string> = {
      'Chrome': '#4285f4',
      'Safari': '#8e8e93',
      'Firefox': '#ff7139',
      'Edge': '#0078d4',
      'Samsung Browser': '#1428a0',
      'Opera': '#ff1b2d',
    };
    if (browserItems.length >= 2) {
      renderDonutChart('an-browsers-bars', browserItems, browserColors, 'var(--color-muted)');
    } else {
      // Single browser or empty: show simple bar
      const totalBrowsers = data.browsers.reduce((s: number, b: any) => s + b.count, 0);
      renderBarList('an-browsers-bars', data.browsers.map((b: any) => ({
        label: b.browser,
        value: b.count,
        pct: totalBrowsers > 0 ? Math.round((b.count / totalBrowsers) * 100) : 0,
      })));
    }

    // Languages
    renderBarList('an-languages-bars', (data.languages || []).map((l: any) => ({
      label: l.language,
      value: l.count,
    })));
  }

  // ── Summary Cards with Sparklines ──
  function renderSummaryCards(data: any) {
    const container = $('an-summary');
    const s = data.summary;
    const t = data.trend || {};
    const days = data.period?.days || currentDays;
    const daily = data.daily || [];

    function trendHtml(diff: number): string {
      if (diff > 0) return `<span class="an-sc__trend an-sc__trend--up">&uarr; +${num(diff)}</span>`;
      if (diff < 0) return `<span class="an-sc__trend an-sc__trend--down">&darr; ${num(diff)}</span>`;
      return `<span class="an-sc__trend an-sc__trend--flat">&rarr; 0</span>`;
    }

    const prevLabel = `vs. vorherige ${days} Tage`;
    const pvSpark = miniSparkline(daily, 'pageviews', 'var(--color-primary)');
    const visSpark = miniSparkline(daily, 'visitors', 'var(--color-accent)');

    container.innerHTML = `
      <div class="an-sc">
        <span class="an-sc__val">${num(s.pageviews)}</span>
        ${pvSpark}
        <span class="an-sc__lbl">Seitenaufrufe</span>
        ${t.pageviews !== undefined ? trendHtml(t.pageviews) : ''}
        ${t.pageviews !== undefined ? `<span class="an-sc__trend-sub">${esc(prevLabel)}</span>` : ''}
      </div>
      <div class="an-sc">
        <span class="an-sc__val">${num(s.visitors)}</span>
        ${visSpark}
        <span class="an-sc__lbl">Besucher</span>
        ${t.visitors !== undefined ? trendHtml(t.visitors) : ''}
        ${t.visitors !== undefined ? `<span class="an-sc__trend-sub">${esc(prevLabel)}</span>` : ''}
      </div>
      <div class="an-sc">
        <span class="an-sc__val">${s.activeDays}</span>
        <span class="an-sc__lbl">Aktive Tage</span>
      </div>
      <div class="an-sc">
        <span class="an-sc__val">${num(s.avgPerDay)}</span>
        <span class="an-sc__lbl">&empty; pro Tag</span>
      </div>
    `;
  }

  // ── Daily Chart (SVG) ──
  function renderDailyChart(daily: any[]) {
    const container = $('an-daily-chart');
    if (!daily || daily.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Noch keine Daten vorhanden.</p>';
      return;
    }

    const W = 700, H = 240, PAD_L = 44, PAD_R = 10, PAD_T = 15, PAD_B = 44;
    const cw = W - PAD_L - PAD_R;
    const ch = H - PAD_T - PAD_B;

    const maxPV = Math.max(...daily.map((d: any) => d.pageviews), 1);
    const maxVal = Math.ceil(maxPV * 1.1 / 5) * 5 || 5;

    const xStep = daily.length > 1 ? cw / (daily.length - 1) : cw / 2;

    const pvPoints: string[] = [];
    const visPoints: string[] = [];
    daily.forEach((d: any, i: number) => {
      const x = PAD_L + i * xStep;
      const yPV = PAD_T + ch - (d.pageviews / maxVal) * ch;
      const yVis = PAD_T + ch - (d.visitors / maxVal) * ch;
      pvPoints.push(`${x.toFixed(1)},${yPV.toFixed(1)}`);
      visPoints.push(`${x.toFixed(1)},${yVis.toFixed(1)}`);
    });

    const areaPath = `M${PAD_L},${PAD_T + ch} L${pvPoints.join(' L')} L${(PAD_L + (daily.length - 1) * xStep).toFixed(1)},${PAD_T + ch} Z`;
    const pvLine = `M${pvPoints.join(' L')}`;
    const visLine = `M${visPoints.join(' L')}`;

    // Grid lines + Y labels
    const gridLines: string[] = [];
    const yLabels: string[] = [];
    const gridSteps = 4;
    for (let i = 0; i <= gridSteps; i++) {
      const y = PAD_T + ch - (i / gridSteps) * ch;
      const val = Math.round((i / gridSteps) * maxVal);
      gridLines.push(`<line x1="${PAD_L}" y1="${y.toFixed(1)}" x2="${W - PAD_R}" y2="${y.toFixed(1)}" stroke="var(--color-border-light)" stroke-width="1" />`);
      yLabels.push(`<text x="${PAD_L - 8}" y="${(y + 4).toFixed(1)}" text-anchor="end" fill="var(--color-muted)" font-size="10" font-family="system-ui">${val}</text>`);
    }

    // X-axis labels (max ~10 labels)
    const xLabels: string[] = [];
    const maxLabels = 10;
    const labelInterval = Math.max(1, Math.ceil(daily.length / maxLabels));
    daily.forEach((d: any, i: number) => {
      if (i % labelInterval === 0 || i === daily.length - 1) {
        const x = PAD_L + i * xStep;
        const parts = d.date.split('-');
        const dateStr = `${parts[2]}.${parts[1]}.`;
        xLabels.push(`<text x="${x.toFixed(1)}" y="${H - 8}" text-anchor="middle" fill="var(--color-muted)" font-size="10" font-family="system-ui">${dateStr}</text>`);
      }
    });

    // Dots
    const pvDots = daily.map((d: any, i: number) => {
      const x = PAD_L + i * xStep;
      const y = PAD_T + ch - (d.pageviews / maxVal) * ch;
      return `<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="2.5" fill="var(--color-primary)" />`;
    }).join('');
    const visDots = daily.map((d: any, i: number) => {
      const x = PAD_L + i * xStep;
      const y = PAD_T + ch - (d.visitors / maxVal) * ch;
      return `<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="2.5" fill="var(--color-accent)" />`;
    }).join('');

    container.innerHTML = `
      <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
        ${gridLines.join('')}
        ${yLabels.join('')}
        ${xLabels.join('')}
        <path d="${areaPath}" fill="var(--color-primary)" opacity="0.15" />
        <path d="${pvLine}" fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" />
        <path d="${visLine}" fill="none" stroke="var(--color-accent)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke-dasharray="6,3" />
        ${pvDots}
        ${visDots}
      </svg>
      <div class="an-chart-legend">
        <span><span class="an-chart-legend__swatch" style="background:var(--color-primary)"></span>Seitenaufrufe</span>
        <span><span class="an-chart-legend__swatch" style="background:var(--color-accent);border-top:1px dashed var(--color-accent)"></span>Besucher</span>
      </div>
    `;
  }

  // ── Hourly Bar Chart (SVG) ──
  function renderHourlyChart(hourly: any[]) {
    const container = $('an-hourly-chart');
    if (!hourly || hourly.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }

    const W = 700, H = 200, PAD_L = 44, PAD_R = 10, PAD_T = 10, PAD_B = 32;
    const cw = W - PAD_L - PAD_R;
    const ch = H - PAD_T - PAD_B;

    const maxPV = Math.max(...hourly.map((h: any) => h.pageviews), 1);
    const maxVal = Math.ceil(maxPV * 1.1 / 5) * 5 || 5;
    const barW = cw / 24;
    const gap = barW * 0.15;
    const currentHour = new Date().getHours();

    // Grid lines
    const gridSteps = 3;
    const grid: string[] = [];
    for (let i = 0; i <= gridSteps; i++) {
      const y = PAD_T + ch - (i / gridSteps) * ch;
      const val = Math.round((i / gridSteps) * maxVal);
      grid.push(`<line x1="${PAD_L}" y1="${y.toFixed(1)}" x2="${W - PAD_R}" y2="${y.toFixed(1)}" stroke="var(--color-border-light)" stroke-width="1" />`);
      grid.push(`<text x="${PAD_L - 8}" y="${(y + 4).toFixed(1)}" text-anchor="end" fill="var(--color-muted)" font-size="10" font-family="system-ui">${val}</text>`);
    }

    // Bars
    const bars: string[] = [];
    const labels: string[] = [];
    hourly.forEach((h: any, i: number) => {
      const x = PAD_L + i * barW + gap;
      const w = barW - gap * 2;
      const barH = maxVal > 0 ? (h.pageviews / maxVal) * ch : 0;
      const y = PAD_T + ch - barH;
      const isCurrentHour = i === currentHour;
      const fill = isCurrentHour ? 'var(--color-accent)' : 'var(--color-primary)';
      bars.push(`<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${w.toFixed(1)}" height="${barH.toFixed(1)}" rx="2" fill="${fill}" opacity="${isCurrentHour ? 1 : 0.8}" />`);

      // Labels every 3 hours
      if (i % 3 === 0) {
        labels.push(`<text x="${(PAD_L + i * barW + barW / 2).toFixed(1)}" y="${H - 8}" text-anchor="middle" fill="var(--color-muted)" font-size="10" font-family="system-ui">${i}</text>`);
      }
    });

    container.innerHTML = `
      <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
        ${grid.join('')}
        ${bars.join('')}
        ${labels.join('')}
      </svg>
      <div class="an-chart-legend">
        <span><span class="an-chart-legend__swatch" style="background:var(--color-primary)"></span>Seitenaufrufe pro Stunde</span>
        <span><span class="an-chart-legend__swatch" style="background:var(--color-accent)"></span>Aktuelle Stunde</span>
      </div>
    `;
  }

  // ── Weekday Vertical Bar Chart (SVG) ──
  function renderWeekdayBars(weekdays: any[]) {
    const container = $('an-weekday-bars');
    if (!weekdays || weekdays.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }

    const W = 700, H = 180, PAD_L = 44, PAD_R = 10, PAD_T = 10, PAD_B = 32;
    const cw = W - PAD_L - PAD_R;
    const ch = H - PAD_T - PAD_B;

    const maxPV = Math.max(...weekdays.map((w: any) => w.pageviews), 1);
    const maxVal = Math.ceil(maxPV * 1.1 / 5) * 5 || 5;
    const barW = cw / 7;
    const gap = barW * 0.15;

    // Grid lines + Y labels
    const gridSteps = 3;
    const grid: string[] = [];
    for (let i = 0; i <= gridSteps; i++) {
      const y = PAD_T + ch - (i / gridSteps) * ch;
      const val = Math.round((i / gridSteps) * maxVal);
      grid.push(`<line x1="${PAD_L}" y1="${y.toFixed(1)}" x2="${W - PAD_R}" y2="${y.toFixed(1)}" stroke="var(--color-border-light)" stroke-width="1" />`);
      grid.push(`<text x="${PAD_L - 8}" y="${(y + 4).toFixed(1)}" text-anchor="end" fill="var(--color-muted)" font-size="10" font-family="system-ui">${val}</text>`);
    }

    // Bars + labels
    const dayLabels = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    const bars: string[] = [];
    const xLabels: string[] = [];
    weekdays.forEach((w: any, i: number) => {
      const x = PAD_L + i * barW + gap;
      const bw = barW - gap * 2;
      const barH = maxVal > 0 ? (w.pageviews / maxVal) * ch : 0;
      const y = PAD_T + ch - barH;
      const isWeekend = i >= 5;
      const fill = isWeekend ? 'var(--color-accent)' : 'var(--color-primary)';
      bars.push(`<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${bw.toFixed(1)}" height="${Math.max(barH, 0).toFixed(1)}" rx="3" fill="${fill}" opacity="0.85" />`);

      // Value on top of bar
      if (w.pageviews > 0) {
        bars.push(`<text x="${(x + bw / 2).toFixed(1)}" y="${(y - 5).toFixed(1)}" text-anchor="middle" fill="var(--color-text-secondary)" font-size="9" font-family="'Space Grotesk', sans-serif" font-weight="600">${num(w.pageviews)}</text>`);
      }

      xLabels.push(`<text x="${(PAD_L + i * barW + barW / 2).toFixed(1)}" y="${H - 8}" text-anchor="middle" fill="${isWeekend ? 'var(--color-accent)' : 'var(--color-muted)'}" font-size="11" font-family="system-ui" font-weight="${isWeekend ? '600' : '500'}">${dayLabels[i]}</text>`);
    });

    container.innerHTML = `
      <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
        ${grid.join('')}
        ${bars.join('')}
        ${xLabels.join('')}
      </svg>
      <div class="an-chart-legend">
        <span><span class="an-chart-legend__swatch" style="background:var(--color-primary)"></span>Wochentage</span>
        <span><span class="an-chart-legend__swatch" style="background:var(--color-accent)"></span>Wochenende</span>
      </div>
    `;
  }

  // ── New vs Returning (with icons + text inside bar) ──
  function renderNewVsReturning(nv: any) {
    const container = $('an-newret');
    if (!nv || (nv.new === 0 && nv.returning === 0)) {
      container.innerHTML = '<p class="an-newret-empty">Noch nicht genug Daten</p>';
      return;
    }

    const total = nv.new + nv.returning;
    const newPct = total > 0 ? Math.round((nv.new / total) * 100) : 0;
    const retPct = 100 - newPct;

    const starIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.85"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.27 5.82 22 7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
    const refreshIcon = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.85"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>`;

    container.innerHTML = `
      <div class="an-newret-bar">
        <div class="an-newret-bar__new" style="width:${newPct}%">
          ${newPct >= 12 ? `<span class="an-newret-bar__text">${newPct}%</span>` : ''}
        </div>
        <div class="an-newret-bar__ret" style="width:${retPct}%">
          ${retPct >= 12 ? `<span class="an-newret-bar__text">${retPct}%</span>` : ''}
        </div>
      </div>
      <div class="an-newret-labels">
        <span>${starIcon} Neu: ${num(nv.new)} (${newPct}%)</span>
        <span>${refreshIcon} Wiederkehrend: ${num(nv.returning)} (${retPct}%)</span>
      </div>
    `;
  }

  // ── Pages Table (with inline bars) ──
  function renderPagesTable(pages: any[]) {
    const container = $('an-pages-table');
    if (!pages || pages.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }
    const maxViews = Math.max(...pages.map((p: any) => p.views), 1);
    let html = `<table class="an-tbl"><thead><tr><th>Seite</th><th>Aufrufe</th><th>Besucher</th></tr></thead><tbody>`;
    pages.forEach((p: any) => {
      const barWidth = (p.views / maxViews) * 100;
      html += `<tr><td>${esc(pageName(p.path))}</td><td class="an-num an-bar-inline-cell"><div class="an-bar-inline" style="width:${barWidth.toFixed(1)}%"></div><span>${num(p.views)}</span></td><td class="an-num">${num(p.visitors)}</td></tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  // ── Referrers Table (with inline bars) ──
  function renderReferrersTable(referrers: any[]) {
    const container = $('an-referrers-table');
    if (!referrers || referrers.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Referrer-Daten.</p>';
      return;
    }
    const maxCount = Math.max(...referrers.map((r: any) => r.count), 1);
    let html = `<table class="an-tbl"><thead><tr><th>Referrer</th><th>Aufrufe</th></tr></thead><tbody>`;
    referrers.forEach((r: any) => {
      const barWidth = (r.count / maxCount) * 100;
      html += `<tr><td>${esc(r.referrer)}</td><td class="an-num an-bar-inline-cell"><div class="an-bar-inline" style="width:${barWidth.toFixed(1)}%"></div><span>${num(r.count)}</span></td></tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  // ── Country Bars (gradient with labels inside) ──
  function renderCountryBars(countries: any[]) {
    const container = $('an-countries-bars');
    if (!countries || countries.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }

    const totalCountries = countries.reduce((s: number, c: any) => s + c.count, 0);
    const maxVal = Math.max(...countries.map((c: any) => c.count), 1);

    let html = '';
    countries.forEach((c: any) => {
      const width = Math.max(12, (c.count / maxVal) * 100);
      const pct = totalCountries > 0 ? Math.round((c.count / totalCountries) * 100) : 0;
      const label = c.country || '??';
      html += `
        <div class="an-country-item">
          <div class="an-country-fill" style="width:${width.toFixed(1)}%">
            <span class="an-country-label">${esc(label)}</span>
            <span class="an-country-value">${num(c.count)} (${pct}%)</span>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  }

  // ── Donut Chart (SVG) ──
  function renderDonutChart(containerId: string, items: Array<{label: string; value: number}>, colorMap: Record<string, string>, defaultColor: string) {
    const container = $(containerId);
    const total = items.reduce((s, i) => s + i.value, 0);
    if (!items.length || total === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }

    const R = 60;
    const SW = 24;
    const SIZE = (R + SW / 2 + 6) * 2;
    const C = SIZE / 2;
    const circumference = 2 * Math.PI * R;

    let segments = '';
    let legend = '';

    if (items.length === 1) {
      // Single item: full ring
      const color = colorMap[items[0].label] || defaultColor;
      segments = `<circle cx="${C}" cy="${C}" r="${R}" fill="none" stroke="${color}" stroke-width="${SW}" />`;
      legend = `<div class="an-donut-legend__item"><span class="an-donut-legend__dot" style="background:${color}"></span>${esc(items[0].label)} <span class="an-donut-legend__pct">100%</span></div>`;
    } else {
      let cumulativeLength = 0;
      // Small gap between segments for visual separation
      const gapLen = items.length > 1 ? 2 : 0;

      items.forEach((item) => {
        const pct = item.value / total;
        const segLen = Math.max(pct * circumference - gapLen, 0.5);
        const color = colorMap[item.label] || defaultColor;
        const dashoffset = -cumulativeLength;

        segments += `<circle cx="${C}" cy="${C}" r="${R}" fill="none" stroke="${color}" stroke-width="${SW}" stroke-dasharray="${segLen.toFixed(2)} ${(circumference - segLen).toFixed(2)}" stroke-dashoffset="${dashoffset.toFixed(2)}" transform="rotate(-90 ${C} ${C})" stroke-linecap="round" />`;

        cumulativeLength += pct * circumference;

        const pctLabel = Math.round(pct * 100);
        legend += `<div class="an-donut-legend__item"><span class="an-donut-legend__dot" style="background:${color}"></span>${esc(item.label)} <span class="an-donut-legend__pct">${pctLabel}%</span></div>`;
      });
    }

    container.innerHTML = `
      <div class="an-donut-wrap">
        <div class="an-donut-svg-wrap">
          <svg viewBox="0 0 ${SIZE} ${SIZE}" width="160" height="160">
            <!-- Track ring -->
            <circle cx="${C}" cy="${C}" r="${R}" fill="none" stroke="rgba(255,255,255,0.04)" stroke-width="${SW}" />
            ${segments}
            <text x="${C}" y="${C}" text-anchor="middle" dominant-baseline="central" fill="var(--color-text)" font-family="'Space Grotesk', sans-serif" font-size="22" font-weight="700">${num(total)}</text>
          </svg>
        </div>
        <div class="an-donut-legend">${legend}</div>
      </div>
    `;
  }

  // ── Bar List (for languages + fallback) ──
  function renderBarList(containerId: string, items: Array<{label: string; value: number; pct?: number}>) {
    const container = $(containerId);
    if (!items || items.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }
    const maxVal = Math.max(...items.map(i => i.value), 1);
    let html = '';
    items.forEach(item => {
      const width = Math.max(2, (item.value / maxVal) * 100);
      const display = item.pct !== undefined ? `${num(item.value)} (${item.pct}%)` : num(item.value);
      html += `
        <div class="an-bar-item">
          <div class="an-bar-header">
            <span class="an-bar-label">${esc(item.label)}</span>
            <span class="an-bar-value">${display}</span>
          </div>
          <div class="an-bar-track"><div class="an-bar-fill" style="width:${width.toFixed(1)}%"></div></div>
        </div>`;
    });
    container.innerHTML = html;
  }
</script>
