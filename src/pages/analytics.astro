---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Analytics · Starnberg Events" description="Website-Analytics für Starnberg Events">

<main class="an-page">
  <a href="/" class="an-back">&larr; Zurück zu Events</a>

  <!-- Password Gate -->
  <div class="an-auth" id="an-auth">
    <div class="an-auth-card">
      <h1 class="an-auth-title">Analytics</h1>
      <p class="an-auth-sub">Zugang zum Dashboard</p>
      <form id="an-auth-form">
        <input type="password" id="an-auth-input" class="an-auth-input" placeholder="Passwort eingeben" autocomplete="off" />
        <button type="submit" class="an-auth-btn">Anmelden</button>
      </form>
      <p class="an-auth-error" id="an-auth-error" style="display:none;">Falsches Passwort</p>
    </div>
  </div>

  <!-- Dashboard (hidden until auth) -->
  <div class="an-dashboard" id="an-dashboard" style="display:none;">
    <header class="an-header">
      <div>
        <h1 class="an-header__title">Analytics</h1>
        <p class="an-header__sub">Website-Statistiken</p>
      </div>
      <div class="an-header__right">
        <div class="an-realtime" id="an-realtime" style="display:none;">
          <span class="an-realtime__dot"></span>
          <span class="an-realtime__text" id="an-realtime-text"></span>
        </div>
        <span class="an-updated" id="an-updated"></span>
        <button class="an-logout" id="an-logout" title="Abmelden">Abmelden</button>
      </div>
    </header>

    <!-- Period Toggle -->
    <div class="an-period-toggle">
      <button class="an-period-btn" data-days="7">7 Tage</button>
      <button class="an-period-btn active" data-days="30">30 Tage</button>
      <button class="an-period-btn" data-days="90">90 Tage</button>
    </div>

    <!-- Loading -->
    <div class="an-loading" id="an-loading">
      <div class="an-spinner"></div>
      <p>Lade Daten&hellip;</p>
    </div>

    <!-- Content -->
    <div class="an-content" id="an-content" style="display:none;">

      <!-- 1. Summary Cards -->
      <div class="an-summary" id="an-summary"></div>

      <!-- 2. Tagesverlauf -->
      <section class="an-card">
        <h2 class="an-section-title">Tagesverlauf</h2>
        <div class="an-chart-wrap" id="an-daily-chart"></div>
      </section>

      <!-- 3. Stündliche Verteilung -->
      <section class="an-card">
        <h2 class="an-section-title">Stündliche Verteilung</h2>
        <div class="an-chart-wrap" id="an-hourly-chart"></div>
      </section>

      <!-- 4. Wochentage -->
      <section class="an-card">
        <h2 class="an-section-title">Wochentage</h2>
        <div class="an-bar-list" id="an-weekday-bars"></div>
      </section>

      <!-- 5. Neue vs. Wiederkehrende Besucher -->
      <section class="an-card">
        <h2 class="an-section-title">Neue vs. Wiederkehrende Besucher</h2>
        <div id="an-newret"></div>
      </section>

      <!-- 6. Top Seiten -->
      <section class="an-card">
        <h2 class="an-section-title">Top Seiten</h2>
        <div class="an-table-wrap" id="an-pages-table"></div>
      </section>

      <!-- 7. Herkunft -->
      <section class="an-card">
        <h2 class="an-section-title">Herkunft</h2>
        <div class="an-table-wrap" id="an-referrers-table"></div>
      </section>

      <!-- 8. Länder -->
      <section class="an-card">
        <h2 class="an-section-title">Länder</h2>
        <div class="an-bar-list" id="an-countries-bars"></div>
      </section>

      <!-- 9. Geräte -->
      <section class="an-card">
        <h2 class="an-section-title">Geräte</h2>
        <div class="an-bar-list" id="an-devices-bars"></div>
      </section>

      <!-- 10. Browser -->
      <section class="an-card">
        <h2 class="an-section-title">Browser</h2>
        <div class="an-bar-list" id="an-browsers-bars"></div>
      </section>

      <!-- 11. Sprachen -->
      <section class="an-card">
        <h2 class="an-section-title">Sprachen</h2>
        <div class="an-bar-list" id="an-languages-bars"></div>
      </section>
    </div>

    <!-- Footer -->
    <p class="an-meta">
      Selbstgehostete Analyse &middot; Keine Cookies &middot; DSGVO-konform
      <br>
      <a href="/impressum">Impressum</a> &middot; <a href="/datenschutz">Datenschutz</a>
      <br>
      <span class="footer-love">Made with &#10084;&#65039; for Pöcking</span>
    </p>
  </div>
</main>
</Layout>

<style>
  .an-page { max-width: 760px; margin: 0 auto; padding: var(--space-5) var(--space-4); }
  .an-back { display: inline-block; font-size: 0.875rem; color: var(--color-text-secondary); text-decoration: none; margin-bottom: var(--space-4); }
  .an-back:hover { color: var(--color-primary); }

  /* Auth screen */
  .an-auth { display: flex; align-items: center; justify-content: center; min-height: 50vh; }
  .an-auth-card { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-8); max-width: 360px; width: 100%; text-align: center; box-shadow: var(--shadow-md); }
  .an-auth-title { font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--color-text); margin: 0 0 var(--space-2); }
  .an-auth-sub { font-size: 0.875rem; color: var(--color-text-secondary); margin-bottom: var(--space-5); }
  .an-auth-input { width: 100%; padding: var(--space-3) var(--space-4); border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-bg-secondary); color: var(--color-text); font-size: 0.9375rem; margin-bottom: var(--space-3); outline: none; transition: border-color var(--duration-fast) ease; }
  .an-auth-input:focus { border-color: var(--color-primary); }
  .an-auth-btn { width: 100%; padding: var(--space-3); border: none; border-radius: var(--radius-md); background: var(--color-primary); color: #fff; font-size: 0.9375rem; font-weight: 600; cursor: pointer; transition: background var(--duration-fast) ease; min-height: 44px; }
  .an-auth-btn:hover { background: var(--color-primary-light); }
  .an-auth-error { color: #dc2626; font-size: 0.8125rem; margin-top: var(--space-3); }
  :root.dark .an-auth-error { color: #f87171; }

  /* Header */
  .an-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: var(--space-5); gap: var(--space-3); }
  .an-header__title { font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--color-text); margin: 0; }
  .an-header__sub { font-size: 0.9375rem; color: var(--color-text-secondary); margin: var(--space-1) 0 0; }
  .an-header__right { display: flex; flex-direction: column; align-items: flex-end; gap: var(--space-2); }
  .an-logout { background: none; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-2) var(--space-3); color: var(--color-text-secondary); font-size: 0.8125rem; cursor: pointer; transition: all var(--duration-fast) ease; min-height: 44px; }
  .an-logout:hover { color: var(--color-text); border-color: var(--color-text-secondary); }
  .an-updated { font-size: 0.6875rem; color: var(--color-muted); }

  /* Real-time indicator */
  .an-realtime { display: flex; align-items: center; gap: var(--space-2); font-size: 0.75rem; color: var(--color-text-secondary); }
  .an-realtime__dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; flex-shrink: 0; animation: an-pulse 2s ease-in-out infinite; }
  @keyframes an-pulse { 0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); } }
  .an-realtime__text { white-space: nowrap; }

  /* Period toggle */
  .an-period-toggle { display: flex; gap: var(--space-2); margin-bottom: var(--space-5); background: var(--color-bg-secondary); padding: var(--space-1); border-radius: var(--radius-lg); }
  .an-period-btn { flex: 1; padding: var(--space-2) var(--space-3); min-height: 44px; border: none; border-radius: var(--radius-md); background: transparent; color: var(--color-text-secondary); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all var(--duration-fast) ease; -webkit-tap-highlight-color: transparent; }
  .an-period-btn:hover { color: var(--color-text); }
  .an-period-btn.active { background: var(--color-card); color: var(--color-text); box-shadow: var(--shadow-sm); }

  /* Loading */
  .an-loading { text-align: center; padding: var(--space-10) 0; color: var(--color-text-secondary); }
  .an-spinner { width: 32px; height: 32px; border: 3px solid var(--color-border-light); border-top-color: var(--color-primary); border-radius: 50%; margin: 0 auto var(--space-4); animation: an-spin 0.8s linear infinite; }
  @keyframes an-spin { to { transform: rotate(360deg); } }

  /* Cards */
  .an-card { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4); box-shadow: var(--shadow-sm); }
  .an-section-title { font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 600; color: var(--color-text); margin: 0 0 var(--space-4); padding-bottom: var(--space-2); border-bottom: 1px solid var(--color-border-light); }

  /* Summary cards */
  .an-summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-3); margin-bottom: var(--space-4); }
  .an-sc { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-4) var(--space-3); text-align: center; box-shadow: var(--shadow-sm); }
  .an-sc__val { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; line-height: 1.1; color: var(--color-primary); }
  .an-sc__lbl { display: block; font-size: 0.75rem; font-weight: 600; margin-top: 4px; color: var(--color-text-secondary); }
  .an-sc__trend { display: block; font-size: 0.6875rem; margin-top: 6px; font-weight: 600; }
  .an-sc__trend--up { color: #10b981; }
  .an-sc__trend--down { color: #ef4444; }
  .an-sc__trend--flat { color: var(--color-muted); }
  .an-sc__trend-sub { display: block; font-size: 0.625rem; color: var(--color-muted); margin-top: 2px; }
  @media (max-width: 540px) { .an-summary { grid-template-columns: repeat(2, 1fr); } .an-sc__val { font-size: 1.5rem; } }

  /* Chart wrapper */
  .an-chart-wrap { width: 100%; overflow: hidden; }
  .an-chart-wrap svg { width: 100%; height: auto; display: block; }

  /* Table */
  .an-table-wrap { overflow-x: auto; }
  .an-tbl { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
  .an-tbl th { text-align: left; font-weight: 600; color: var(--color-text-secondary); padding: var(--space-2); border-bottom: 2px solid var(--color-border-light); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
  .an-tbl th:last-child, .an-tbl td:last-child { text-align: right; }
  .an-tbl th:nth-child(2), .an-tbl td:nth-child(2) { text-align: right; }
  .an-tbl td { padding: var(--space-2); border-bottom: 1px solid var(--color-border-light); color: var(--color-text); }
  .an-tbl td:first-child { font-weight: 500; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .an-tbl .an-num { font-family: 'Space Grotesk', sans-serif; font-weight: 600; font-variant-numeric: tabular-nums; }

  /* Bar list */
  .an-bar-list { display: flex; flex-direction: column; gap: var(--space-3); }
  .an-bar-item { display: flex; flex-direction: column; gap: var(--space-1); }
  .an-bar-header { display: flex; justify-content: space-between; font-size: 0.8125rem; }
  .an-bar-label { font-weight: 500; color: var(--color-text); }
  .an-bar-value { font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: var(--color-text-secondary); font-variant-numeric: tabular-nums; }
  .an-bar-track { height: 24px; background: var(--color-bg-secondary); border-radius: var(--radius-sm); overflow: hidden; }
  .an-bar-fill { height: 100%; border-radius: var(--radius-sm); background: var(--color-primary); transition: width 0.6s ease; min-width: 2px; }
  .an-bar-fill--accent { background: var(--color-accent); }

  /* New vs returning split bar */
  .an-newret-bar { display: flex; height: 32px; border-radius: var(--radius-sm); overflow: hidden; background: var(--color-bg-secondary); }
  .an-newret-bar__new { background: var(--color-accent); transition: width 0.6s ease; }
  .an-newret-bar__ret { background: var(--color-primary); transition: width 0.6s ease; }
  .an-newret-labels { display: flex; justify-content: space-between; margin-top: var(--space-2); font-size: 0.8125rem; }
  .an-newret-labels span:first-child { color: var(--color-accent); font-weight: 600; }
  .an-newret-labels span:last-child { color: var(--color-primary); font-weight: 600; }
  .an-newret-empty { font-size: 0.875rem; color: var(--color-text-secondary); }

  /* Chart legend */
  .an-chart-legend { display: flex; gap: var(--space-4); justify-content: center; margin-top: var(--space-2); font-size: 0.75rem; color: var(--color-text-secondary); }
  .an-chart-legend__swatch { display: inline-block; width: 12px; height: 3px; vertical-align: middle; margin-right: 4px; border-radius: 2px; }

  /* Footer */
  .an-meta { font-size: 0.75rem; color: var(--color-text-tertiary, #999); text-align: center; line-height: 1.6; margin-top: var(--space-4); max-width: none; margin-left: auto; margin-right: auto; }
  .an-meta a { color: var(--color-primary); }
  .footer-love { font-size: 0.65rem; opacity: 0.5; letter-spacing: 0.03em; }

  /* Mobile */
  @media (max-width: 600px) {
    .an-page { padding: var(--space-4) var(--space-3); }
    .an-card { padding: var(--space-4) var(--space-3); }
    .an-header__title { font-size: 1.375rem; }
    .an-header { flex-wrap: wrap; }
    .an-tbl { font-size: 0.75rem; }
    .an-tbl th, .an-tbl td { padding: var(--space-1) var(--space-2); }
  }
</style>

<script>
  const API = 'https://train-tracker.steffenvonlindern-be7.workers.dev';
  let currentDays = 30;
  let analyticsKey = localStorage.getItem('analytics_key') || '';

  const $ = (id: string) => document.getElementById(id)!;

  const PAGE_NAMES: Record<string, string> = {
    '/': 'Startseite',
    '/s6/': 'S6 Pünktlichkeit',
    '/impressum/': 'Impressum',
    '/datenschutz/': 'Datenschutz',
    '/analytics/': 'Analytics',
  };

  // ── Auth ──
  const authScreen = $('an-auth');
  const dashboard = $('an-dashboard');
  const authForm = $('an-auth-form') as HTMLFormElement;
  const authInput = $('an-auth-input') as HTMLInputElement;
  const authError = $('an-auth-error');

  if (analyticsKey) {
    tryAuth(analyticsKey);
  }

  authForm.addEventListener('submit', (e: Event) => {
    e.preventDefault();
    const val = authInput.value.trim();
    if (!val) return;
    tryAuth(val);
  });

  $('an-logout').addEventListener('click', () => {
    localStorage.removeItem('analytics_key');
    analyticsKey = '';
    dashboard.style.display = 'none';
    authScreen.style.display = '';
    authInput.value = '';
    authError.style.display = 'none';
  });

  async function tryAuth(key: string) {
    try {
      const res = await fetch(`${API}/api/analytics?days=30&key=${encodeURIComponent(key)}`);
      if (res.status === 401) {
        authError.style.display = '';
        return;
      }
      const data = await res.json();
      analyticsKey = key;
      localStorage.setItem('analytics_key', key);
      authScreen.style.display = 'none';
      dashboard.style.display = '';
      authError.style.display = 'none';
      renderDashboard(data);
    } catch {
      authError.style.display = '';
    }
  }

  // ── Period toggle ──
  document.querySelectorAll('.an-period-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelector('.an-period-btn.active')?.classList.remove('active');
      btn.classList.add('active');
      currentDays = parseInt((btn as HTMLElement).dataset.days || '30', 10);
      loadData();
    });
  });

  async function loadData() {
    $('an-loading').style.display = '';
    $('an-content').style.display = 'none';
    try {
      const res = await fetch(`${API}/api/analytics?days=${currentDays}&key=${encodeURIComponent(analyticsKey)}`);
      if (res.status === 401) {
        localStorage.removeItem('analytics_key');
        analyticsKey = '';
        dashboard.style.display = 'none';
        authScreen.style.display = '';
        authError.style.display = '';
        return;
      }
      const data = await res.json();
      renderDashboard(data);
    } catch {
      // silent
    }
  }

  // ── Helpers ──
  function num(n: number): string {
    return n.toLocaleString('de-DE');
  }

  function esc(s: string): string {
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function pageName(path: string): string {
    return PAGE_NAMES[path] || path;
  }

  // ── Render Dashboard ──
  function renderDashboard(data: any) {
    $('an-loading').style.display = 'none';
    $('an-content').style.display = '';

    // Updated timestamp
    const now = new Date();
    $('an-updated').textContent = `Letzte Aktualisierung: ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    // Real-time indicator
    const rtEl = $('an-realtime');
    const rtText = $('an-realtime-text');
    if (data.realtime) {
      if (data.realtime.last5min > 0) {
        rtEl.style.display = 'flex';
        rtText.textContent = `${data.realtime.last5min} aktiv (letzte 5 Min)`;
      } else if (data.realtime.last30min > 0) {
        rtEl.style.display = 'flex';
        rtText.textContent = `${data.realtime.last30min} in letzten 30 Min`;
      } else {
        rtEl.style.display = 'none';
      }
    } else {
      rtEl.style.display = 'none';
    }

    // Summary cards with trends
    renderSummaryCards(data);

    // Daily chart
    renderDailyChart(data.daily);

    // Hourly chart
    renderHourlyChart(data.hourly);

    // Weekday bars
    renderWeekdayBars(data.weekdays);

    // New vs returning
    renderNewVsReturning(data.newVsReturning);

    // Pages table
    renderPagesTable(data.pages);

    // Referrers table
    renderReferrersTable(data.referrers);

    // Countries
    const totalCountries = data.countries.reduce((s: number, c: any) => s + c.count, 0);
    renderBarList('an-countries-bars', data.countries.map((c: any) => ({
      label: c.country || '??',
      value: c.count,
      pct: totalCountries > 0 ? Math.round((c.count / totalCountries) * 100) : 0,
    })));

    // Devices
    const totalDevices = data.devices.reduce((s: number, d: any) => s + d.count, 0);
    renderBarList('an-devices-bars', data.devices.map((d: any) => ({
      label: d.device.charAt(0).toUpperCase() + d.device.slice(1),
      value: d.count,
      pct: totalDevices > 0 ? Math.round((d.count / totalDevices) * 100) : 0,
    })));

    // Browsers
    const totalBrowsers = data.browsers.reduce((s: number, b: any) => s + b.count, 0);
    renderBarList('an-browsers-bars', data.browsers.map((b: any) => ({
      label: b.browser,
      value: b.count,
      pct: totalBrowsers > 0 ? Math.round((b.count / totalBrowsers) * 100) : 0,
    })));

    // Languages
    renderBarList('an-languages-bars', (data.languages || []).map((l: any) => ({
      label: l.language,
      value: l.count,
    })));
  }

  // ── Summary Cards ──
  function renderSummaryCards(data: any) {
    const container = $('an-summary');
    const s = data.summary;
    const t = data.trend || {};
    const days = data.period?.days || currentDays;

    function trendHtml(diff: number): string {
      if (diff > 0) return `<span class="an-sc__trend an-sc__trend--up">&uarr; +${num(diff)}</span>`;
      if (diff < 0) return `<span class="an-sc__trend an-sc__trend--down">&darr; ${num(diff)}</span>`;
      return `<span class="an-sc__trend an-sc__trend--flat">&rarr; 0</span>`;
    }

    const prevLabel = `vs. vorherige ${days} Tage`;

    container.innerHTML = `
      <div class="an-sc">
        <span class="an-sc__val">${num(s.pageviews)}</span>
        <span class="an-sc__lbl">Seitenaufrufe</span>
        ${t.pageviews !== undefined ? trendHtml(t.pageviews) : ''}
        ${t.pageviews !== undefined ? `<span class="an-sc__trend-sub">${esc(prevLabel)}</span>` : ''}
      </div>
      <div class="an-sc">
        <span class="an-sc__val">${num(s.visitors)}</span>
        <span class="an-sc__lbl">Besucher</span>
        ${t.visitors !== undefined ? trendHtml(t.visitors) : ''}
        ${t.visitors !== undefined ? `<span class="an-sc__trend-sub">${esc(prevLabel)}</span>` : ''}
      </div>
      <div class="an-sc">
        <span class="an-sc__val">${s.activeDays}</span>
        <span class="an-sc__lbl">Aktive Tage</span>
      </div>
      <div class="an-sc">
        <span class="an-sc__val">${num(s.avgPerDay)}</span>
        <span class="an-sc__lbl">&empty; pro Tag</span>
      </div>
    `;
  }

  // ── Daily Chart (SVG) ──
  function renderDailyChart(daily: any[]) {
    const container = $('an-daily-chart');
    if (!daily || daily.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Noch keine Daten vorhanden.</p>';
      return;
    }

    const W = 700, H = 240, PAD_L = 44, PAD_R = 10, PAD_T = 15, PAD_B = 44;
    const cw = W - PAD_L - PAD_R;
    const ch = H - PAD_T - PAD_B;

    const maxPV = Math.max(...daily.map((d: any) => d.pageviews), 1);
    const maxVal = Math.ceil(maxPV * 1.1 / 5) * 5 || 5;

    const xStep = daily.length > 1 ? cw / (daily.length - 1) : cw / 2;

    const pvPoints: string[] = [];
    const visPoints: string[] = [];
    daily.forEach((d: any, i: number) => {
      const x = PAD_L + i * xStep;
      const yPV = PAD_T + ch - (d.pageviews / maxVal) * ch;
      const yVis = PAD_T + ch - (d.visitors / maxVal) * ch;
      pvPoints.push(`${x.toFixed(1)},${yPV.toFixed(1)}`);
      visPoints.push(`${x.toFixed(1)},${yVis.toFixed(1)}`);
    });

    const areaPath = `M${PAD_L},${PAD_T + ch} L${pvPoints.join(' L')} L${(PAD_L + (daily.length - 1) * xStep).toFixed(1)},${PAD_T + ch} Z`;
    const pvLine = `M${pvPoints.join(' L')}`;
    const visLine = `M${visPoints.join(' L')}`;

    // Grid lines + Y labels
    const gridLines: string[] = [];
    const yLabels: string[] = [];
    const gridSteps = 4;
    for (let i = 0; i <= gridSteps; i++) {
      const y = PAD_T + ch - (i / gridSteps) * ch;
      const val = Math.round((i / gridSteps) * maxVal);
      gridLines.push(`<line x1="${PAD_L}" y1="${y.toFixed(1)}" x2="${W - PAD_R}" y2="${y.toFixed(1)}" stroke="var(--color-border-light)" stroke-width="1" />`);
      yLabels.push(`<text x="${PAD_L - 8}" y="${(y + 4).toFixed(1)}" text-anchor="end" fill="var(--color-muted)" font-size="10" font-family="system-ui">${val}</text>`);
    }

    // X-axis labels (max ~10 labels)
    const xLabels: string[] = [];
    const maxLabels = 10;
    const labelInterval = Math.max(1, Math.ceil(daily.length / maxLabels));
    daily.forEach((d: any, i: number) => {
      if (i % labelInterval === 0 || i === daily.length - 1) {
        const x = PAD_L + i * xStep;
        const parts = d.date.split('-');
        const dateStr = `${parts[2]}.${parts[1]}.`;
        xLabels.push(`<text x="${x.toFixed(1)}" y="${H - 8}" text-anchor="middle" fill="var(--color-muted)" font-size="10" font-family="system-ui">${dateStr}</text>`);
      }
    });

    // Dots
    const pvDots = daily.map((d: any, i: number) => {
      const x = PAD_L + i * xStep;
      const y = PAD_T + ch - (d.pageviews / maxVal) * ch;
      return `<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="2.5" fill="var(--color-primary)" />`;
    }).join('');
    const visDots = daily.map((d: any, i: number) => {
      const x = PAD_L + i * xStep;
      const y = PAD_T + ch - (d.visitors / maxVal) * ch;
      return `<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="2.5" fill="var(--color-accent)" />`;
    }).join('');

    container.innerHTML = `
      <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
        ${gridLines.join('')}
        ${yLabels.join('')}
        ${xLabels.join('')}
        <path d="${areaPath}" fill="var(--color-primary)" opacity="0.15" />
        <path d="${pvLine}" fill="none" stroke="var(--color-primary)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" />
        <path d="${visLine}" fill="none" stroke="var(--color-accent)" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke-dasharray="6,3" />
        ${pvDots}
        ${visDots}
      </svg>
      <div class="an-chart-legend">
        <span><span class="an-chart-legend__swatch" style="background:var(--color-primary)"></span>Seitenaufrufe</span>
        <span><span class="an-chart-legend__swatch" style="background:var(--color-accent);border-top:1px dashed var(--color-accent)"></span>Besucher</span>
      </div>
    `;
  }

  // ── Hourly Bar Chart (SVG) ──
  function renderHourlyChart(hourly: any[]) {
    const container = $('an-hourly-chart');
    if (!hourly || hourly.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }

    const W = 700, H = 200, PAD_L = 44, PAD_R = 10, PAD_T = 10, PAD_B = 32;
    const cw = W - PAD_L - PAD_R;
    const ch = H - PAD_T - PAD_B;

    const maxPV = Math.max(...hourly.map((h: any) => h.pageviews), 1);
    const maxVal = Math.ceil(maxPV * 1.1 / 5) * 5 || 5;
    const barW = cw / 24;
    const gap = barW * 0.15;
    const currentHour = new Date().getHours();

    // Grid lines
    const gridSteps = 3;
    const grid: string[] = [];
    for (let i = 0; i <= gridSteps; i++) {
      const y = PAD_T + ch - (i / gridSteps) * ch;
      const val = Math.round((i / gridSteps) * maxVal);
      grid.push(`<line x1="${PAD_L}" y1="${y.toFixed(1)}" x2="${W - PAD_R}" y2="${y.toFixed(1)}" stroke="var(--color-border-light)" stroke-width="1" />`);
      grid.push(`<text x="${PAD_L - 8}" y="${(y + 4).toFixed(1)}" text-anchor="end" fill="var(--color-muted)" font-size="10" font-family="system-ui">${val}</text>`);
    }

    // Bars
    const bars: string[] = [];
    const labels: string[] = [];
    hourly.forEach((h: any, i: number) => {
      const x = PAD_L + i * barW + gap;
      const w = barW - gap * 2;
      const barH = maxVal > 0 ? (h.pageviews / maxVal) * ch : 0;
      const y = PAD_T + ch - barH;
      const isCurrentHour = i === currentHour;
      const fill = isCurrentHour ? 'var(--color-accent)' : 'var(--color-primary)';
      bars.push(`<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${w.toFixed(1)}" height="${barH.toFixed(1)}" rx="2" fill="${fill}" opacity="${isCurrentHour ? 1 : 0.8}" />`);

      // Labels every 3 hours
      if (i % 3 === 0) {
        labels.push(`<text x="${(PAD_L + i * barW + barW / 2).toFixed(1)}" y="${H - 8}" text-anchor="middle" fill="var(--color-muted)" font-size="10" font-family="system-ui">${i}</text>`);
      }
    });

    container.innerHTML = `
      <svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="xMidYMid meet">
        ${grid.join('')}
        ${bars.join('')}
        ${labels.join('')}
      </svg>
      <div class="an-chart-legend">
        <span><span class="an-chart-legend__swatch" style="background:var(--color-primary)"></span>Seitenaufrufe pro Stunde</span>
        <span><span class="an-chart-legend__swatch" style="background:var(--color-accent)"></span>Aktuelle Stunde</span>
      </div>
    `;
  }

  // ── Weekday Bars ──
  function renderWeekdayBars(weekdays: any[]) {
    const container = $('an-weekday-bars');
    if (!weekdays || weekdays.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }

    const maxPV = Math.max(...weekdays.map((w: any) => w.pageviews), 1);
    let html = '';
    weekdays.forEach((w: any, i: number) => {
      const width = Math.max(2, (w.pageviews / maxPV) * 100);
      const isWeekend = i >= 5; // Sa=5, So=6
      const fillClass = isWeekend ? ' an-bar-fill--accent' : '';
      html += `
        <div class="an-bar-item">
          <div class="an-bar-header">
            <span class="an-bar-label">${esc(w.name)}</span>
            <span class="an-bar-value">${num(w.pageviews)} Aufrufe</span>
          </div>
          <div class="an-bar-track"><div class="an-bar-fill${fillClass}" style="width:${width.toFixed(1)}%"></div></div>
        </div>`;
    });
    container.innerHTML = html;
  }

  // ── New vs Returning ──
  function renderNewVsReturning(nv: any) {
    const container = $('an-newret');
    if (!nv || (nv.new === 0 && nv.returning === 0)) {
      container.innerHTML = '<p class="an-newret-empty">Noch nicht genug Daten</p>';
      return;
    }

    const total = nv.new + nv.returning;
    const newPct = total > 0 ? Math.round((nv.new / total) * 100) : 0;
    const retPct = 100 - newPct;

    container.innerHTML = `
      <div class="an-newret-bar">
        <div class="an-newret-bar__new" style="width:${newPct}%"></div>
        <div class="an-newret-bar__ret" style="width:${retPct}%"></div>
      </div>
      <div class="an-newret-labels">
        <span>Neu: ${num(nv.new)} (${newPct}%)</span>
        <span>Wiederkehrend: ${num(nv.returning)} (${retPct}%)</span>
      </div>
    `;
  }

  // ── Pages Table ──
  function renderPagesTable(pages: any[]) {
    const container = $('an-pages-table');
    if (!pages || pages.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }
    let html = `<table class="an-tbl"><thead><tr><th>Seite</th><th>Aufrufe</th><th>Besucher</th></tr></thead><tbody>`;
    pages.forEach((p: any) => {
      html += `<tr><td>${esc(pageName(p.path))}</td><td class="an-num">${num(p.views)}</td><td class="an-num">${num(p.visitors)}</td></tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  // ── Referrers Table ──
  function renderReferrersTable(referrers: any[]) {
    const container = $('an-referrers-table');
    if (!referrers || referrers.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Referrer-Daten.</p>';
      return;
    }
    let html = `<table class="an-tbl"><thead><tr><th>Referrer</th><th>Aufrufe</th></tr></thead><tbody>`;
    referrers.forEach((r: any) => {
      html += `<tr><td>${esc(r.referrer)}</td><td class="an-num">${num(r.count)}</td></tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
  }

  // ── Bar List ──
  function renderBarList(containerId: string, items: Array<{label: string; value: number; pct?: number}>) {
    const container = $(containerId);
    if (!items || items.length === 0) {
      container.innerHTML = '<p style="color:var(--color-text-secondary);font-size:0.875rem;">Keine Daten.</p>';
      return;
    }
    const maxVal = Math.max(...items.map(i => i.value), 1);
    let html = '';
    items.forEach(item => {
      const width = Math.max(2, (item.value / maxVal) * 100);
      const display = item.pct !== undefined ? `${num(item.value)} (${item.pct}%)` : num(item.value);
      html += `
        <div class="an-bar-item">
          <div class="an-bar-header">
            <span class="an-bar-label">${esc(item.label)}</span>
            <span class="an-bar-value">${display}</span>
          </div>
          <div class="an-bar-track"><div class="an-bar-fill" style="width:${width.toFixed(1)}%"></div></div>
        </div>`;
    });
    container.innerHTML = html;
  }
</script>
