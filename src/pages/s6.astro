---
import Layout from '../layouts/Layout.astro';
---

<Layout title="S6 P√ºnktlichkeit ¬∑ Possenhofen" description="Ausf√ºhrliche Analyse der S6-P√ºnktlichkeit am Bahnhof Possenhofen am Starnberger See">

<main class="s6-page">
  <a href="/" class="s6-back">‚Üê Zur√ºck zu Events</a>

  <header class="s6-header">
    <div class="s6-header__icon">üöÜ</div>
    <div>
      <h1 class="s6-header__title">S6 P√ºnktlichkeit</h1>
      <p class="s6-header__sub">Bahnhof Possenhofen ¬∑ Echtzeit-Analyse</p>
    </div>
  </header>

  <!-- Period Toggle -->
  <div class="s6-period-toggle">
    <button class="period-btn" data-period="7">7 Tage</button>
    <button class="period-btn active" data-period="30">30 Tage</button>
    <button class="period-btn" data-period="90">90 Tage</button>
  </div>

  <!-- Loading -->
  <div class="s6-loading" id="s6-loading">
    <div class="s6-spinner"></div>
    <p>Lade Analyse‚Ä¶</p>
  </div>

  <!-- Empty State -->
  <div class="s6-empty" id="s6-empty" style="display:none;">
    <p>üìä Noch keine Daten vorhanden.</p>
    <p class="text-muted">Der Tracker sammelt alle 10 Minuten Daten. Erste Statistiken erscheinen nach wenigen Stunden.</p>
  </div>

  <!-- Content -->
  <div class="s6-content" id="s6-content" style="display:none;">

    <!-- ‚ïê‚ïê 1. Scorecard ‚ïê‚ïê -->
    <section class="s6-card">
      <div class="s6-scorecard">
        <div class="sc sc--green">
          <span class="sc__val" id="sc-ontime">‚Äì</span>
          <span class="sc__lbl">P√ºnktlich</span>
          <span class="sc__sub">‚â§ 5 Min</span>
        </div>
        <div class="sc sc--yellow">
          <span class="sc__val" id="sc-delayed">‚Äì</span>
          <span class="sc__lbl">Versp√§tet</span>
          <span class="sc__sub">&gt; 5 Min</span>
        </div>
        <div class="sc sc--red">
          <span class="sc__val" id="sc-cancelled">‚Äì</span>
          <span class="sc__lbl">Ausgefallen</span>
          <span class="sc__sub">&nbsp;</span>
        </div>
        <div class="sc sc--blue">
          <span class="sc__val" id="sc-total">‚Äì</span>
          <span class="sc__lbl">Gesamt</span>
          <span class="sc__sub" id="sc-period-label">‚Äì</span>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê 2. P√ºnktlichkeitsrate + KPIs ‚ïê‚ïê -->
    <section class="s6-card s6-rate-card">
      <div class="s6-rate">
        <div class="rate-ring">
          <svg viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="52" fill="none" stroke="var(--color-border-light)" stroke-width="8" />
            <circle id="rate-arc" cx="60" cy="60" r="52" fill="none" stroke-width="8"
              stroke-dasharray="326.73" stroke-dashoffset="326.73" stroke-linecap="round"
              transform="rotate(-90 60 60)" />
          </svg>
          <span class="rate-ring__pct" id="rate-pct">‚Äì%</span>
        </div>
        <div class="rate-kpis">
          <h3 class="rate-kpis__title">P√ºnktlichkeitsrate</h3>
          <div class="kpi-row"><span class="kpi-label">√ò Versp√§tung</span><strong id="kpi-avg">‚Äì</strong></div>
          <div class="kpi-row"><span class="kpi-label">Max. Versp√§tung</span><strong id="kpi-max">‚Äì</strong></div>
          <div class="kpi-row"><span class="kpi-label">Erfasst seit</span><strong id="kpi-since">‚Äì</strong></div>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê 3. Richtungsvergleich ‚ïê‚ïê -->
    <section class="s6-card">
      <h2 class="s6-section-title">Nach Richtung</h2>
      <div class="dir-compare">
        <div class="dir-item">
          <span class="dir-item__label">‚Üí M√ºnchen</span>
          <div class="dir-item__bar-track"><div class="dir-item__bar" id="dir-muc-bar"></div></div>
          <span class="dir-item__stats"><strong id="dir-muc-pct">‚Äì%</strong> ¬∑ √ò <span id="dir-muc-avg">‚Äì</span></span>
        </div>
        <div class="dir-item">
          <span class="dir-item__label">‚Üê Tutzing</span>
          <div class="dir-item__bar-track"><div class="dir-item__bar" id="dir-tut-bar"></div></div>
          <span class="dir-item__stats"><strong id="dir-tut-pct">‚Äì%</strong> ¬∑ √ò <span id="dir-tut-avg">‚Äì</span></span>
        </div>
      </div>
    </section>

    <!-- ‚ïê‚ïê 4. Rush Hour Analyse ‚ïê‚ïê -->
    <section class="s6-card">
      <h2 class="s6-section-title">Rush Hour vs. Nebenzeit</h2>
      <div class="rush-grid" id="rush-grid"></div>
    </section>

    <!-- ‚ïê‚ïê 5. Versp√§tungsverteilung ‚ïê‚ïê -->
    <section class="s6-card">
      <h2 class="s6-section-title">Versp√§tungsverteilung</h2>
      <div class="dist-chart" id="dist-chart"></div>
    </section>

    <!-- ‚ïê‚ïê 6. Tagesprofil (nach Stunde) ‚ïê‚ïê -->
    <section class="s6-card">
      <h2 class="s6-section-title">Tagesprofil</h2>
      <p class="text-muted" style="margin-bottom:var(--space-3);font-size:0.8125rem;">P√ºnktlichkeit nach Tageszeit</p>
      <div class="bar-chart" id="hourly-chart"></div>
    </section>

    <!-- ‚ïê‚ïê 7. Wochentag-Analyse ‚ïê‚ïê -->
    <section class="s6-card">
      <h2 class="s6-section-title">Nach Wochentag</h2>
      <div class="bar-chart" id="weekday-chart"></div>
    </section>

    <!-- ‚ïê‚ïê 8. Tagesverlauf ‚ïê‚ïê -->
    <section class="s6-card">
      <h2 class="s6-section-title">Tagesverlauf</h2>
      <div class="bar-chart" id="daily-chart"></div>
    </section>

    <!-- ‚ïê‚ïê 9. Schlimmste Versp√§tungen ‚ïê‚ïê -->
    <section class="s6-card">
      <h2 class="s6-section-title">Gr√∂√üte Versp√§tungen</h2>
      <div class="worst-table" id="worst-table"></div>
    </section>

    <!-- ‚ïê‚ïê 10. Heutige Abfahrten ‚ïê‚ïê -->
    <section class="s6-card">
      <h2 class="s6-section-title">Heutige Abfahrten</h2>
      <div class="departures-list" id="today-deps"></div>
    </section>

    <!-- Footer -->
    <p class="s6-meta">
      Datenerhebung alle 10 Minuten ¬∑ P√ºnktlich = ‚â§ 5 Min Versp√§tung ¬∑
      Quelle: <a href="https://v6.db.transport.rest" target="_blank" rel="noopener">transport.rest API</a>
    </p>
  </div>
</main>
</Layout>

<style>
  .s6-page { max-width: 760px; margin: 0 auto; padding: var(--space-5) var(--space-4); }

  .s6-back { display: inline-block; font-size: 0.875rem; color: var(--color-text-secondary); text-decoration: none; margin-bottom: var(--space-4); }
  .s6-back:hover { color: var(--color-primary); }

  .s6-header { display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-5); }
  .s6-header__icon { font-size: 2.5rem; line-height: 1; }
  .s6-header__title { font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--color-text); margin: 0; }
  .s6-header__sub { font-size: 0.9375rem; color: var(--color-text-secondary); margin: var(--space-1) 0 0; }

  /* Period toggle */
  .s6-period-toggle { display: flex; gap: var(--space-2); margin-bottom: var(--space-5); background: var(--color-bg-secondary); padding: var(--space-1); border-radius: var(--radius-lg); }
  .period-btn { flex: 1; padding: var(--space-2) var(--space-3); border: none; border-radius: var(--radius-md); background: transparent; color: var(--color-text-secondary); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all var(--duration-fast) ease; }
  .period-btn:hover { color: var(--color-text); }
  .period-btn.active { background: var(--color-card); color: var(--color-text); box-shadow: var(--shadow-sm); }

  /* Loading */
  .s6-loading { text-align: center; padding: var(--space-10) 0; color: var(--color-text-secondary); }
  .s6-spinner { width: 32px; height: 32px; border: 3px solid var(--color-border-light); border-top-color: var(--color-primary); border-radius: 50%; margin: 0 auto var(--space-4); animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .s6-empty { text-align: center; padding: var(--space-10) 0; color: var(--color-text-secondary); }
  .text-muted { font-size: 0.875rem; color: var(--color-text-secondary); }

  /* Cards */
  .s6-card { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4); box-shadow: var(--shadow-sm); }
  .s6-section-title { font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 600; color: var(--color-text); margin: 0 0 var(--space-4); padding-bottom: var(--space-2); border-bottom: 1px solid var(--color-border-light); }

  /* Scorecard */
  .s6-scorecard { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-3); }
  .sc { text-align: center; padding: var(--space-3) var(--space-2); border-radius: var(--radius-md); background: var(--color-bg-secondary); }
  .sc__val { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; line-height: 1.1; }
  .sc__lbl { display: block; font-size: 0.75rem; font-weight: 600; margin-top: 2px; color: var(--color-text-secondary); }
  .sc__sub { display: block; font-size: 0.6875rem; color: var(--color-text-tertiary, #aaa); }
  .sc--green .sc__val { color: #16a34a; }
  .sc--yellow .sc__val { color: #d97706; }
  .sc--red .sc__val { color: #dc2626; }
  .sc--blue .sc__val { color: var(--color-primary); }
  :root.dark .sc--green .sc__val { color: #4ade80; }
  :root.dark .sc--yellow .sc__val { color: #fbbf24; }
  :root.dark .sc--red .sc__val { color: #f87171; }
  @media (max-width: 480px) { .s6-scorecard { grid-template-columns: repeat(2, 1fr); } .sc__val { font-size: 1.5rem; } }

  /* Rate ring + KPIs */
  .s6-rate { display: flex; align-items: center; gap: var(--space-6); }
  .rate-ring { position: relative; width: 130px; height: 130px; flex-shrink: 0; }
  .rate-ring svg { width: 100%; height: 100%; }
  .rate-ring__pct { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: 'Space Grotesk', sans-serif; font-size: 1.625rem; font-weight: 700; color: var(--color-text); }
  .rate-kpis { flex: 1; }
  .rate-kpis__title { font-family: 'Space Grotesk', sans-serif; font-size: 1.125rem; font-weight: 600; margin: 0 0 var(--space-3); }
  .kpi-row { display: flex; justify-content: space-between; padding: var(--space-2) 0; border-bottom: 1px solid var(--color-border-light); font-size: 0.875rem; }
  .kpi-row:last-child { border: none; }
  .kpi-label { color: var(--color-text-secondary); }
  @media (max-width: 500px) { .s6-rate { flex-direction: column; text-align: center; } .rate-ring { width: 110px; height: 110px; } .kpi-row { font-size: 0.8125rem; } }

  /* Direction compare */
  .dir-compare { display: flex; flex-direction: column; gap: var(--space-4); }
  .dir-item { display: flex; flex-direction: column; gap: var(--space-2); }
  .dir-item__label { font-size: 0.875rem; font-weight: 600; color: var(--color-text); }
  .dir-item__bar-track { height: 28px; background: var(--color-bg-secondary); border-radius: var(--radius-sm); overflow: hidden; }
  .dir-item__bar { height: 100%; border-radius: var(--radius-sm); background: #16a34a; transition: width 0.6s ease; }
  :root.dark .dir-item__bar { background: #4ade80; }
  .dir-item__stats { font-size: 0.8125rem; color: var(--color-text-secondary); }

  /* Rush hour grid */
  .rush-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); }
  .rush-item { text-align: center; padding: var(--space-4) var(--space-2); border-radius: var(--radius-md); background: var(--color-bg-secondary); }
  .rush-item__label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: var(--space-2); }
  .rush-item__pct { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700; }
  .rush-item__avg { display: block; font-size: 0.75rem; color: var(--color-text-tertiary, #aaa); margin-top: 2px; }
  @media (max-width: 400px) { .rush-grid { grid-template-columns: 1fr; } }

  /* Distribution chart */
  .dist-chart { display: flex; flex-direction: column; gap: var(--space-2); }
  .dist-row { display: grid; grid-template-columns: 70px 1fr 40px; align-items: center; gap: var(--space-2); font-size: 0.8125rem; }
  .dist-row__label { color: var(--color-text-secondary); font-weight: 500; }
  .dist-row__bar { height: 20px; border-radius: var(--radius-sm); transition: width 0.4s ease; }
  .dist-row__val { text-align: right; font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: var(--color-text); }

  /* Generic bar chart rows */
  .bar-chart { display: flex; flex-direction: column; gap: var(--space-2); }
  .bar-row { display: grid; grid-template-columns: 50px 1fr 40px; align-items: center; gap: var(--space-2); font-size: 0.8125rem; }
  .bar-row__label { color: var(--color-text-secondary); font-weight: 500; font-variant-numeric: tabular-nums; }
  .bar-row__track { height: 22px; display: flex; border-radius: var(--radius-sm); overflow: hidden; background: var(--color-bg-secondary); }
  .seg--green { background: #16a34a; } .seg--yellow { background: #d97706; } .seg--red { background: #dc2626; }
  :root.dark .seg--green { background: #4ade80; } :root.dark .seg--yellow { background: #fbbf24; } :root.dark .seg--red { background: #f87171; }
  .bar-row__val { text-align: right; font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: var(--color-text); }

  /* Worst table */
  .worst-table { overflow-x: auto; }
  .worst-tbl { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
  .worst-tbl th { text-align: left; font-weight: 600; color: var(--color-text-secondary); padding: var(--space-2); border-bottom: 2px solid var(--color-border-light); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
  .worst-tbl td { padding: var(--space-2); border-bottom: 1px solid var(--color-border-light); color: var(--color-text); }
  .worst-tbl .delay-val { font-family: 'Space Grotesk', sans-serif; font-weight: 700; color: #dc2626; }
  :root.dark .worst-tbl .delay-val { color: #f87171; }

  /* Departures list */
  .departures-list { display: flex; flex-wrap: wrap; gap: var(--space-2); }
  .dep-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: var(--radius-sm); font-size: 0.75rem; font-family: 'Space Grotesk', sans-serif; font-weight: 500; background: var(--color-bg-secondary); }
  .dep-chip--ok { border-left: 3px solid #16a34a; }
  .dep-chip--late { border-left: 3px solid #d97706; }
  .dep-chip--cancel { border-left: 3px solid #dc2626; text-decoration: line-through; opacity: 0.6; }
  .dep-chip__dir { font-size: 0.625rem; color: var(--color-text-tertiary, #aaa); }
  .dep-chip__delay { color: #d97706; font-weight: 700; }
  :root.dark .dep-chip--ok { border-left-color: #4ade80; }
  :root.dark .dep-chip--late { border-left-color: #fbbf24; }

  /* Footer */
  .s6-meta { font-size: 0.75rem; color: var(--color-text-tertiary, #999); text-align: center; line-height: 1.6; margin-top: var(--space-4); }
  .s6-meta a { color: var(--color-primary); }
</style>

<script>
  const W = 'https://train-tracker.steffenvonlindern-be7.workers.dev';
  let currentDays = 30;

  const $ = (id: string) => document.getElementById(id)!;

  // ‚îÄ‚îÄ Period toggle ‚îÄ‚îÄ
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelector('.period-btn.active')?.classList.remove('active');
      btn.classList.add('active');
      currentDays = parseInt((btn as HTMLElement).dataset.period || '30', 10);
      load();
    });
  });

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function fmtDelay(s: number | null): string {
    if (!s || s <= 0) return '0 Min';
    const m = Math.round(s / 60);
    return m < 1 ? '<1 Min' : `${m} Min`;
  }
  function pct(n: number, total: number): number { return total > 0 ? Math.round((n / total) * 100) : 0; }
  function rateColor(r: number): string { return r >= 80 ? '#16a34a' : r >= 60 ? '#d97706' : '#dc2626'; }
  function fmtDate(d: string): string {
    const dt = new Date(d + 'T12:00:00');
    return dt.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
  }
  function fmtTime(iso: string): string {
    const d = new Date(iso);
    return d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }
  const WEEKDAYS = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

  // ‚îÄ‚îÄ Load ‚îÄ‚îÄ
  async function load() {
    $('s6-loading').style.display = '';
    $('s6-content').style.display = 'none';
    $('s6-empty').style.display = 'none';
    try {
      const resp = await fetch(`${W}/api/analysis?days=${currentDays}`);
      if (!resp.ok) throw new Error(`${resp.status}`);
      const d = await resp.json();
      if (!d.overall || d.overall.total === 0) {
        $('s6-loading').style.display = 'none';
        $('s6-empty').style.display = '';
        return;
      }
      render(d);
      $('s6-loading').style.display = 'none';
      $('s6-content').style.display = '';
    } catch (e) {
      console.error(e);
      $('s6-loading').style.display = 'none';
      $('s6-empty').style.display = '';
      $('s6-empty').querySelector('p')!.textContent = '‚ö†Ô∏è Daten konnten nicht geladen werden.';
    }
  }

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
  function render(d: any) {
    const o = d.overall;
    const onTime = o.on_time || 0, delayed = o.delayed || 0, cancelled = o.cancelled || 0;
    const total = onTime + delayed + cancelled;
    const rate = pct(onTime, total);

    // Scorecard
    $('sc-ontime').textContent = String(onTime);
    $('sc-delayed').textContent = String(delayed);
    $('sc-cancelled').textContent = String(cancelled);
    $('sc-total').textContent = String(total);
    $('sc-period-label').textContent = `${currentDays} Tage`;

    // Rate ring
    const circ = 2 * Math.PI * 52;
    const arc = $('rate-arc') as unknown as SVGCircleElement;
    arc.style.strokeDashoffset = String(circ - (rate / 100) * circ);
    arc.style.stroke = rateColor(rate);
    arc.style.transition = 'stroke-dashoffset 0.8s ease, stroke 0.4s ease';
    $('rate-pct').textContent = `${rate}%`;

    $('kpi-avg').textContent = fmtDelay(o.avg_delay);
    $('kpi-max').textContent = fmtDelay(o.max_delay);
    $('kpi-since').textContent = o.first_date ? fmtDate(o.first_date) : '‚Äì';

    // Directions
    renderDir(d.byDirection, 'muenchen', 'dir-muc');
    renderDir(d.byDirection, 'tutzing', 'dir-tut');

    // Rush hour
    renderRush(d.rushHour);

    // Distribution
    renderDistribution(d.delayDistribution, total);

    // Hourly
    renderBarChart('hourly-chart', d.byHour, (h: any) => `${String(h.hour).padStart(2, '0')}:00`);

    // Weekday
    renderBarChart('weekday-chart', d.byWeekday, (w: any) => WEEKDAYS[w.weekday] || '?');

    // Daily
    renderBarChart('daily-chart', d.daily, (dd: any) => fmtDate(dd.date));

    // Worst delays
    renderWorst(d.worstDelays);

    // Today departures
    renderTodayDeps(d.todayDepartures);
  }

  function renderDir(dirs: any[], key: string, prefix: string) {
    const d = dirs.find((x: any) => x.direction === key);
    if (!d) return;
    const total = (d.on_time || 0) + (d.delayed || 0) + (d.cancelled || 0);
    const r = pct(d.on_time || 0, total);
    $(`${prefix}-bar`).style.width = `${r}%`;
    $(`${prefix}-bar`).style.background = rateColor(r);
    $(`${prefix}-pct`).textContent = `${r}%`;
    $(`${prefix}-avg`).textContent = fmtDelay(d.avg_delay);
  }

  function renderRush(rush: any[]) {
    const labels: Record<string, string> = { morning_rush: 'üåÖ Morgen HVZ\n6:00‚Äì9:00', evening_rush: 'üåÜ Abend HVZ\n16:00‚Äì19:00', off_peak: '‚òÄÔ∏è Nebenzeit\nRest' };
    const grid = $('rush-grid');
    const order = ['morning_rush', 'evening_rush', 'off_peak'];
    grid.innerHTML = order.map(key => {
      const r = rush.find((x: any) => x.period === key);
      if (!r) return `<div class="rush-item"><span class="rush-item__label">${labels[key]?.replace('\n','<br>') || key}</span><span class="rush-item__pct">‚Äì</span></div>`;
      const total = (r.on_time || 0) + (r.delayed || 0) + (r.cancelled || 0);
      const rate = pct(r.on_time || 0, total);
      return `<div class="rush-item">
        <span class="rush-item__label">${labels[key]?.replace('\n','<br>') || key}</span>
        <span class="rush-item__pct" style="color:${rateColor(rate)}">${rate}%</span>
        <span class="rush-item__avg">√ò ${fmtDelay(r.avg_delay)} ¬∑ ${total} Z√ºge</span>
      </div>`;
    }).join('');
  }

  function renderDistribution(dist: any[], total: number) {
    const bucketOrder = ['early', '0-2min', '2-5min', '5-10min', '10-20min', '20min+', 'cancelled'];
    const bucketLabels: Record<string, string> = { early: 'Fr√ºher', '0-2min': '0‚Äì2 Min', '2-5min': '2‚Äì5 Min', '5-10min': '5‚Äì10 Min', '10-20min': '10‚Äì20 Min', '20min+': '20+ Min', cancelled: 'Ausfall' };
    const bucketColors: Record<string, string> = { early: '#16a34a', '0-2min': '#16a34a', '2-5min': '#65a30d', '5-10min': '#d97706', '10-20min': '#ea580c', '20min+': '#dc2626', cancelled: '#dc2626' };
    const maxCount = Math.max(...dist.map((d: any) => d.count || 0), 1);

    $('dist-chart').innerHTML = bucketOrder.map(key => {
      const item = dist.find((d: any) => d.bucket === key);
      const count = item?.count || 0;
      const w = (count / maxCount) * 100;
      return `<div class="dist-row">
        <span class="dist-row__label">${bucketLabels[key] || key}</span>
        <div style="background:var(--color-bg-secondary);border-radius:var(--radius-sm);overflow:hidden;height:20px;">
          <div class="dist-row__bar" style="width:${w}%;height:100%;background:${bucketColors[key] || '#888'}"></div>
        </div>
        <span class="dist-row__val">${count}</span>
      </div>`;
    }).join('');
  }

  function renderBarChart(elId: string, rows: any[], labelFn: (r: any) => string) {
    const el = $(elId);
    if (!rows || rows.length === 0) { el.innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Keine Daten</p>'; return; }
    el.innerHTML = rows.map((r: any) => {
      const total = (r.on_time || 0) + (r.delayed || 0) + (r.cancelled || 0);
      if (total === 0) return '';
      const gPct = ((r.on_time || 0) / total) * 100;
      const yPct = ((r.delayed || 0) / total) * 100;
      const rPct = ((r.cancelled || 0) / total) * 100;
      return `<div class="bar-row">
        <span class="bar-row__label">${labelFn(r)}</span>
        <div class="bar-row__track">
          <div class="seg--green" style="width:${gPct}%"></div>
          <div class="seg--yellow" style="width:${yPct}%"></div>
          <div class="seg--red" style="width:${rPct}%"></div>
        </div>
        <span class="bar-row__val">${pct(r.on_time || 0, total)}%</span>
      </div>`;
    }).join('');
  }

  function renderWorst(delays: any[]) {
    if (!delays || delays.length === 0) {
      $('worst-table').innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Keine Versp√§tungen > 5 Min üéâ</p>';
      return;
    }
    $('worst-table').innerHTML = `<table class="worst-tbl">
      <thead><tr><th>Datum</th><th>Uhrzeit</th><th>Richtung</th><th>Versp√§tung</th></tr></thead>
      <tbody>${delays.map((d: any) => `<tr>
        <td>${fmtDate(d.date)}</td>
        <td>${fmtTime(d.planned_when)}</td>
        <td>${d.direction === 'muenchen' ? '‚Üí M√ºnchen' : '‚Üê Tutzing'}</td>
        <td class="delay-val">+${Math.round(d.delay / 60)} Min</td>
      </tr>`).join('')}</tbody>
    </table>`;
  }

  function renderTodayDeps(deps: any[]) {
    if (!deps || deps.length === 0) {
      $('today-deps').innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Noch keine Abfahrten erfasst</p>';
      return;
    }
    $('today-deps').innerHTML = deps.map((d: any) => {
      const cls = d.cancelled ? 'dep-chip--cancel' : (d.delay && d.delay > 300 ? 'dep-chip--late' : 'dep-chip--ok');
      const time = fmtTime(d.planned_when);
      const dir = d.direction === 'muenchen' ? '‚ÜíMuc' : '‚ÜíTut';
      const delayStr = d.delay && d.delay > 0 ? `<span class="dep-chip__delay">+${Math.round(d.delay / 60)}</span>` : '';
      return `<span class="dep-chip ${cls}">${time} <span class="dep-chip__dir">${dir}</span> ${delayStr}</span>`;
    }).join('');
  }

  load();
</script>
