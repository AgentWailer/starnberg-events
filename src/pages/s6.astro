---
import Layout from '../layouts/Layout.astro';
---

<Layout title="S6 Pünktlichkeit · Possenhofen" description="Ausführliche Analyse der S6-Pünktlichkeit am Bahnhof Possenhofen am Starnberger See">

<main class="s6-page">
  <a href="/" class="s6-back">← Zurück zu Events</a>

  <header class="s6-header">
    <div class="s6-header__icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="16" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="M8 19l-2 3"/><path d="M16 19l2 3"/><circle cx="9" cy="15" r="1" fill="currentColor"/><circle cx="15" cy="15" r="1" fill="currentColor"/></svg></div>
    <div>
      <h1 class="s6-header__title">S6 Pünktlichkeit</h1>
      <p class="s6-header__sub">Bahnhof Possenhofen · Echtzeit-Analyse</p>
    </div>
  </header>

  <!-- Period Toggle -->
  <div class="s6-period-toggle">
    <button class="period-btn" data-period="7">7 Tage</button>
    <button class="period-btn active" data-period="30">30 Tage</button>
    <button class="period-btn" data-period="90">90 Tage</button>
  </div>

  <!-- Loading -->
  <div class="s6-loading" id="s6-loading">
    <div class="s6-spinner"></div>
    <p>Lade Analyse…</p>
  </div>

  <!-- Empty State -->
  <div class="s6-empty" id="s6-empty" style="display:none;">
    <p>Noch keine Daten vorhanden.</p>
    <p class="text-muted">Der Tracker sammelt alle 10 Minuten Daten. Erste Statistiken erscheinen nach wenigen Stunden.</p>
  </div>

  <!-- Content -->
  <div class="s6-content" id="s6-content" style="display:none;">

    <!-- ══ 1. Scorecard ══ -->
    <section class="s6-card">
      <div class="s6-scorecard">
        <div class="sc sc--green">
          <span class="sc__val" id="sc-ontime">–</span>
          <span class="sc__lbl">Pünktlich</span>
          <span class="sc__sub" id="sc-ontime-detail">≤ 5 Min</span>
        </div>
        <div class="sc sc--yellow">
          <span class="sc__val" id="sc-delayed">–</span>
          <span class="sc__lbl">Verspätet</span>
          <span class="sc__sub">&gt; 5 Min</span>
        </div>
        <div class="sc sc--red">
          <span class="sc__val" id="sc-cancelled">–</span>
          <span class="sc__lbl">Ausgefallen</span>
          <span class="sc__sub" id="sc-cancelled-pct">&nbsp;</span>
        </div>
        <div class="sc sc--blue">
          <span class="sc__val" id="sc-total">–</span>
          <span class="sc__lbl">Gesamt</span>
          <span class="sc__sub" id="sc-period-label">–</span>
        </div>
      </div>
    </section>

    <!-- ══ 2. Pünktlichkeitsrate + KPIs ══ -->
    <section class="s6-card s6-rate-card">
      <div class="s6-rate">
        <div class="rate-ring">
          <svg viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="52" fill="none" stroke="var(--color-border-light)" stroke-width="8" />
            <circle id="rate-arc" cx="60" cy="60" r="52" fill="none" stroke-width="8"
              stroke-dasharray="326.73" stroke-dashoffset="326.73" stroke-linecap="round"
              transform="rotate(-90 60 60)" />
          </svg>
          <span class="rate-ring__pct" id="rate-pct">–%</span>
        </div>
        <div class="rate-kpis">
          <h3 class="rate-kpis__title">Pünktlichkeitsrate</h3>
          <div class="kpi-row"><span class="kpi-label">Exakt pünktlich</span><strong id="kpi-exact">–</strong></div>
          <div class="kpi-row"><span class="kpi-label">Ø Verspätung (alle)</span><strong id="kpi-avg">–</strong></div>
          <div class="kpi-row"><span class="kpi-label">Ø nur Verspätete</span><strong id="kpi-avg-late">–</strong></div>
          <div class="kpi-row"><span class="kpi-label">Max. Verspätung</span><strong id="kpi-max">–</strong></div>
          <div class="kpi-row"><span class="kpi-label">Erfasst seit</span><strong id="kpi-since">–</strong></div>
        </div>
      </div>
    </section>

    <!-- ══ 2b. KI-Analyse ══ -->
    <section class="s6-card" id="ai-section" style="display:none;">
      <h2 class="s6-section-title">KI-Analyse</h2>
      <div id="ai-insight" class="ai-insight"></div>
      <p class="ai-meta" id="ai-meta"></p>
    </section>

    <!-- ══ 3. Richtungsvergleich ══ -->
    <section class="s6-card">
      <h2 class="s6-section-title">Nach Richtung</h2>
      <div class="dir-compare">
        <div class="dir-item">
          <span class="dir-item__label">→ München</span>
          <div class="dir-item__bar-track"><div class="dir-item__bar" id="dir-muc-bar"></div></div>
          <span class="dir-item__stats"><strong id="dir-muc-pct">–%</strong> · Ø <span id="dir-muc-avg">–</span></span>
        </div>
        <div class="dir-item">
          <span class="dir-item__label">← Tutzing</span>
          <div class="dir-item__bar-track"><div class="dir-item__bar" id="dir-tut-bar"></div></div>
          <span class="dir-item__stats"><strong id="dir-tut-pct">–%</strong> · Ø <span id="dir-tut-avg">–</span></span>
        </div>
      </div>
    </section>

    <!-- ══ 4. Rush Hour Analyse ══ -->
    <section class="s6-card">
      <h2 class="s6-section-title">Rush Hour vs. Nebenzeit</h2>
      <div class="rush-grid" id="rush-grid"></div>
    </section>

    <!-- ══ 5. Verspätungsverteilung ══ -->
    <section class="s6-card">
      <h2 class="s6-section-title">Verspätungsverteilung</h2>
      <div class="dist-chart" id="dist-chart"></div>
    </section>

    <!-- ══ 6. Wetter-Korrelation ══ -->
    <section class="s6-card" id="weather-section" style="display:none;">
      <h2 class="s6-section-title"><svg class="s6-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 15h.01M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/><path d="M8 21a5 5 0 0 1 0-10h.5A7.5 7.5 0 0 1 16 6a5 5 0 0 1 5 5 4 4 0 0 1-3 3.85"/><path d="M16 17l-2 5"/><path d="M12 17l-2 5"/></svg> Wetter &amp; Pünktlichkeit</h2>
      <p class="text-muted" style="margin-bottom:var(--space-3);font-size:0.8125rem;">Wie beeinflusst das Wetter die S6?</p>
      <div class="weather-grid" id="weather-grid"></div>
    </section>

    <!-- ══ 6b. Temperatur-Korrelation ══ -->
    <section class="s6-card" id="temp-section" style="display:none;">
      <h2 class="s6-section-title"><svg class="s6-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg> Temperatur &amp; Pünktlichkeit</h2>
      <div class="bar-chart" id="temp-chart"></div>
    </section>

    <!-- ══ 7. Tagesprofil (nach Stunde) ══ -->
    <section class="s6-card">
      <h2 class="s6-section-title">Tagesprofil</h2>
      <p class="text-muted" style="margin-bottom:var(--space-3);font-size:0.8125rem;">Pünktlichkeit nach Tageszeit</p>
      <div class="bar-chart" id="hourly-chart"></div>
    </section>

    <!-- ══ 7. Wochentag-Analyse ══ -->
    <section class="s6-card">
      <h2 class="s6-section-title">Nach Wochentag</h2>
      <div class="bar-chart" id="weekday-chart"></div>
    </section>

    <!-- ══ 8. Tagesverlauf ══ -->
    <section class="s6-card">
      <h2 class="s6-section-title">Tagesverlauf</h2>
      <div class="bar-chart" id="daily-chart"></div>
    </section>

    <!-- ══ 9. Schlimmste Verspätungen ══ -->
    <section class="s6-card">
      <h2 class="s6-section-title">Größte Verspätungen</h2>
      <div class="worst-table" id="worst-table"></div>
    </section>

    <!-- ══ 10. Heutige Abfahrten (collapsible) ══ -->
    <section class="s6-card">
      <h2 class="s6-section-title s6-collapse-toggle" id="today-toggle">
        <span>Heutige Abfahrten</span>
        <span class="collapse-summary" id="today-summary"></span>
        <span class="collapse-chevron">▸</span>
      </h2>
      <div class="s6-collapse-body" id="today-deps-wrap">
        <div class="departures-list" id="today-deps"></div>
      </div>
    </section>

    <!-- Footer -->
    <p class="s6-meta">
      Datenerhebung alle 10 Minuten · Pünktlich = ≤ 5 Min Verspätung ·
      Quelle: DB IRIS API · Fallback: <a href="https://v6.db.transport.rest" target="_blank" rel="noopener">transport.rest API</a>
    </p>
  </div>
  <div class="chart-tooltip" id="chart-tooltip"></div>
</main>
</Layout>

<style>
  .s6-page { max-width: 760px; margin: 0 auto; padding: var(--space-5) var(--space-4); }

  .s6-back { display: inline-block; font-size: 0.875rem; color: var(--color-text-secondary); text-decoration: none; margin-bottom: var(--space-4); }
  .s6-back:hover { color: var(--color-primary); }

  .s6-header { display: flex; align-items: center; gap: var(--space-4); margin-bottom: var(--space-5); }
  .s6-header__icon { font-size: 2.5rem; line-height: 1; }
  .s6-header__title { font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--color-text); margin: 0; }
  .s6-header__sub { font-size: 0.9375rem; color: var(--color-text-secondary); margin: var(--space-1) 0 0; }

  /* Period toggle */
  .s6-period-toggle { display: flex; gap: var(--space-2); margin-bottom: var(--space-5); background: var(--color-bg-secondary); padding: var(--space-1); border-radius: var(--radius-lg); }
  .period-btn { flex: 1; padding: var(--space-2) var(--space-3); min-height: 44px; border: none; border-radius: var(--radius-md); background: transparent; color: var(--color-text-secondary); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all var(--duration-fast) ease; -webkit-tap-highlight-color: transparent; }
  .period-btn:hover { color: var(--color-text); }
  .period-btn.active { background: var(--color-card); color: var(--color-text); box-shadow: var(--shadow-sm); }

  /* Loading */
  .s6-loading { text-align: center; padding: var(--space-10) 0; color: var(--color-text-secondary); }
  .s6-spinner { width: 32px; height: 32px; border: 3px solid var(--color-border-light); border-top-color: var(--color-primary); border-radius: 50%; margin: 0 auto var(--space-4); animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .s6-empty { text-align: center; padding: var(--space-10) 0; color: var(--color-text-secondary); }
  .text-muted { font-size: 0.875rem; color: var(--color-text-secondary); }

  /* Cards */
  .s6-card { background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-lg); padding: var(--space-5); margin-bottom: var(--space-4); box-shadow: var(--shadow-sm); }
  .s6-section-title { font-family: 'Space Grotesk', sans-serif; font-size: 1rem; font-weight: 600; color: var(--color-text); margin: 0 0 var(--space-4); padding-bottom: var(--space-2); border-bottom: 1px solid var(--color-border-light); display: flex; align-items: center; gap: var(--space-2); }
  .s6-icon { width: 16px; height: 16px; flex-shrink: 0; color: var(--color-muted); opacity: 0.7; }
  .rush-icon { width: 14px; height: 14px; display: inline-block; vertical-align: -2px; color: var(--color-muted); opacity: 0.6; }
  .weather-svg { width: 18px; height: 18px; color: var(--color-muted); opacity: 0.7; }

  /* AI Insight */
  .ai-insight { font-size: 0.875rem; line-height: 1.7; color: var(--color-text); white-space: pre-line; }
  .ai-meta { font-size: 0.6875rem; color: var(--color-text-tertiary, #aaa); margin-top: var(--space-3); }

  /* Scorecard */
  .s6-scorecard { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-3); }
  .sc { text-align: center; padding: var(--space-3) var(--space-2); border-radius: var(--radius-md); background: var(--color-bg-secondary); }
  .sc__val { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 1.75rem; font-weight: 700; line-height: 1.1; }
  .sc__lbl { display: block; font-size: 0.75rem; font-weight: 600; margin-top: 2px; color: var(--color-text-secondary); }
  .sc__sub { display: block; font-size: 0.6875rem; color: var(--color-text-tertiary, #aaa); }
  .sc--green .sc__val { color: #16a34a; }
  .sc--yellow .sc__val { color: #d97706; }
  .sc--red .sc__val { color: #dc2626; }
  .sc--blue .sc__val { color: var(--color-primary); }
  :root.dark .sc--green .sc__val { color: #4ade80; }
  :root.dark .sc--yellow .sc__val { color: #fbbf24; }
  :root.dark .sc--red .sc__val { color: #f87171; }
  @media (max-width: 480px) { .s6-scorecard { grid-template-columns: repeat(2, 1fr); } .sc__val { font-size: 1.5rem; } }

  /* Rate ring + KPIs */
  .s6-rate { display: flex; align-items: center; gap: var(--space-6); }
  .rate-ring { position: relative; width: 130px; height: 130px; flex-shrink: 0; }
  .rate-ring svg { width: 100%; height: 100%; }
  .rate-ring__pct { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: 'Space Grotesk', sans-serif; font-size: 1.625rem; font-weight: 700; color: var(--color-text); }
  .rate-kpis { flex: 1; }
  .rate-kpis__title { font-family: 'Space Grotesk', sans-serif; font-size: 1.125rem; font-weight: 600; margin: 0 0 var(--space-3); }
  .kpi-row { display: flex; justify-content: space-between; padding: var(--space-2) 0; border-bottom: 1px solid var(--color-border-light); font-size: 0.875rem; }
  .kpi-row:last-child { border: none; }
  .kpi-label { color: var(--color-text-secondary); }
  @media (max-width: 500px) { .s6-rate { flex-direction: column; text-align: center; } .rate-ring { width: 110px; height: 110px; } .kpi-row { font-size: 0.8125rem; } }

  /* Direction compare */
  .dir-compare { display: flex; flex-direction: column; gap: var(--space-4); }
  .dir-item { display: flex; flex-direction: column; gap: var(--space-2); }
  .dir-item__label { font-size: 0.875rem; font-weight: 600; color: var(--color-text); }
  .dir-item__bar-track { height: 28px; background: var(--color-bg-secondary); border-radius: var(--radius-sm); overflow: hidden; }
  .dir-item__bar { height: 100%; border-radius: var(--radius-sm); background: #16a34a; transition: width 0.6s ease; }
  :root.dark .dir-item__bar { background: #4ade80; }
  .dir-item__stats { font-size: 0.8125rem; color: var(--color-text-secondary); }

  /* Rush hour grid */
  .rush-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3); }
  .rush-item { text-align: center; padding: var(--space-4) var(--space-2); border-radius: var(--radius-md); background: var(--color-bg-secondary); }
  .rush-item__label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: var(--space-2); }
  .rush-item__pct { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700; }
  .rush-item__avg { display: block; font-size: 0.75rem; color: var(--color-text-tertiary, #aaa); margin-top: 2px; }
  @media (max-width: 400px) { .rush-grid { grid-template-columns: 1fr; } }

  /* Weather grid */
  .weather-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: var(--space-3); }
  .weather-item { text-align: center; padding: var(--space-4) var(--space-3); border-radius: var(--radius-md); background: var(--color-bg-secondary); }
  .weather-item__icon { font-size: 1.5rem; margin-bottom: var(--space-1); }
  .weather-item__label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--color-text-secondary); margin-bottom: var(--space-2); }
  .weather-item__pct { display: block; font-family: 'Space Grotesk', sans-serif; font-size: 1.375rem; font-weight: 700; }
  .weather-item__detail { display: block; font-size: 0.6875rem; color: var(--color-text-tertiary, #aaa); margin-top: 2px; line-height: 1.4; }

  /* Distribution chart */
  .dist-chart { display: flex; flex-direction: column; gap: var(--space-2); }
  .dist-row { display: grid; grid-template-columns: 70px 1fr 40px; align-items: center; gap: var(--space-2); font-size: 0.8125rem; }
  .dist-row__label { color: var(--color-text-secondary); font-weight: 500; }
  .dist-row__bar { height: 20px; border-radius: var(--radius-sm); transition: width 0.4s ease; }
  .dist-row__val { text-align: right; font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: var(--color-text); }

  /* Generic bar chart rows */
  .bar-chart { display: flex; flex-direction: column; gap: var(--space-2); }
  .bar-row { display: grid; grid-template-columns: 50px 1fr 40px; align-items: center; gap: var(--space-2); font-size: 0.8125rem; }
  .bar-row__label { color: var(--color-text-secondary); font-weight: 500; font-variant-numeric: tabular-nums; }
  .bar-row__track { height: 22px; display: flex; border-radius: var(--radius-sm); overflow: hidden; background: var(--color-bg-secondary); }
  .seg--green { background: #16a34a; } .seg--yellow { background: #d97706; } .seg--red { background: #dc2626; }
  :root.dark .seg--green { background: #4ade80; } :root.dark .seg--yellow { background: #fbbf24; } :root.dark .seg--red { background: #f87171; }
  .bar-row__val { text-align: right; font-family: 'Space Grotesk', sans-serif; font-weight: 600; color: var(--color-text); }

  /* Worst table */
  .worst-table { overflow-x: auto; }
  .worst-tbl { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
  .worst-tbl th { text-align: left; font-weight: 600; color: var(--color-text-secondary); padding: var(--space-2); border-bottom: 2px solid var(--color-border-light); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; }
  .worst-tbl td { padding: var(--space-2); border-bottom: 1px solid var(--color-border-light); color: var(--color-text); }
  .worst-tbl .delay-val { font-family: 'Space Grotesk', sans-serif; font-weight: 700; color: #dc2626; }
  :root.dark .worst-tbl .delay-val { color: #f87171; }

  /* Departures list */
  .departures-list { display: flex; flex-wrap: wrap; gap: var(--space-2); }
  .dep-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: var(--radius-sm); font-size: 0.75rem; font-family: 'Space Grotesk', sans-serif; font-weight: 500; background: var(--color-bg-secondary); }
  .dep-chip--ok { border-left: 3px solid #16a34a; }
  .dep-chip--minor { border-left: 3px solid #84cc16; }
  .dep-chip--late { border-left: 3px solid #d97706; }
  .dep-chip--cancel { border-left: 3px solid #dc2626; text-decoration: line-through; opacity: 0.6; }
  .dep-chip__dir { font-size: 0.625rem; color: var(--color-text-tertiary, #aaa); }
  .dep-chip__delay { color: #d97706; font-weight: 700; }
  .dep-chip__delay--minor { color: #65a30d; font-weight: 600; font-size: 0.6875rem; }
  :root.dark .dep-chip--ok { border-left-color: #4ade80; }
  :root.dark .dep-chip--minor { border-left-color: #a3e635; }
  :root.dark .dep-chip--late { border-left-color: #fbbf24; }
  :root.dark .dep-chip__delay--minor { color: #a3e635; }

  /* Collapsible section */
  .s6-collapse-toggle { cursor: pointer; user-select: none; }
  .s6-collapse-toggle:hover { color: var(--color-primary); }
  .collapse-chevron { margin-left: auto; font-size: 0.875rem; transition: transform 0.2s ease; display: inline-block; }
  .s6-collapse-toggle.open .collapse-chevron { transform: rotate(90deg); }
  .collapse-summary { font-size: 0.75rem; font-weight: 400; color: var(--color-text-secondary); margin-left: var(--space-2); }
  .s6-collapse-toggle.open .collapse-summary { display: none; }
  .s6-collapse-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
  .s6-collapse-body.open { max-height: 2000px; transition: max-height 0.5s ease-in; }

  /* Footer */
  .s6-meta { font-size: 0.75rem; color: var(--color-text-tertiary, #999); text-align: center; line-height: 1.6; margin-top: var(--space-4); }
  .s6-meta a { color: var(--color-primary); }

  /* ── Chart system ── */
  :root { --chart-green: #16a34a; --chart-yellow: #d97706; --chart-red: #dc2626; --chart-line: #3b82f6; --chart-rush-bg: rgba(234,179,8,0.08); --chart-grid: rgba(0,0,0,0.06); }
  :root.dark { --chart-green: #4ade80; --chart-yellow: #fbbf24; --chart-red: #f87171; --chart-line: #60a5fa; --chart-rush-bg: rgba(234,179,8,0.12); --chart-grid: rgba(255,255,255,0.06); }
  .chart-container { width: 100%; overflow: hidden; }
  .chart-container svg { width: 100%; height: auto; display: block; }
  .chart-bar, .dist-bar, .hour-dot { cursor: pointer; }
  .chart-bar:hover, .dist-bar:hover { opacity: 0.8; }
  .hour-dot:hover { r: 7; }
  .chart-tooltip { position: fixed; pointer-events: none; background: var(--color-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-md); padding: 8px 12px; font-size: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.12); z-index: 1000; opacity: 0; transition: opacity 0.15s ease; color: var(--color-text); max-width: 200px; line-height: 1.5; }
  .chart-tooltip.visible { opacity: 1; }

  /* Mobile optimization */
  @media (max-width: 600px) {
    .s6-page { padding: var(--space-4) var(--space-3); }
    .s6-card { padding: var(--space-4) var(--space-3); }
    .s6-header__title { font-size: 1.375rem; }
    .chart-container { margin: 0 -4px; }
    .chart-container svg { font-size: 10px; }
    .rush-item__pct, .weather-item__pct { font-size: 1.125rem; }
    .worst-tbl { font-size: 0.75rem; }
    .worst-tbl th, .worst-tbl td { padding: var(--space-1) var(--space-2); }
  }
  @media (max-width: 400px) {
    .s6-scorecard { gap: var(--space-2); }
    .sc { padding: var(--space-2); }
    .sc__val { font-size: 1.25rem; }
  }
</style>

<script>
  const W = 'https://train-tracker.steffenvonlindern-be7.workers.dev';
  let currentDays = 30;

  const $ = (id: string) => document.getElementById(id)!;

  // ── Period toggle ──
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelector('.period-btn.active')?.classList.remove('active');
      btn.classList.add('active');
      currentDays = parseInt((btn as HTMLElement).dataset.period || '30', 10);
      load();
    });
  });

  // ── Collapsible "Heutige Abfahrten" ──
  const todayToggle = $('today-toggle');
  const todayWrap = $('today-deps-wrap');
  todayToggle.addEventListener('click', () => {
    const isOpen = todayToggle.classList.toggle('open');
    todayWrap.classList.toggle('open', isOpen);
    const chevron = todayToggle.querySelector('.collapse-chevron');
    if (chevron) chevron.textContent = isOpen ? '▾' : '▸';
  });

  // ── Global touch dismiss for tooltips ──
  document.addEventListener('touchstart', (e: TouchEvent) => {
    const tip = $('chart-tooltip');
    if (tip.classList.contains('visible') && !(e.target as HTMLElement).closest('.hour-dot, .weekday-dot, .chart-bar, .dist-bar')) {
      tip.classList.remove('visible');
    }
  });

  // ── Helpers ──
  function fmtDelay(s: number | null): string {
    if (!s || s <= 0) return '0 Min';
    const m = Math.round(s / 60);
    return m < 1 ? '<1 Min' : `${m} Min`;
  }
  function pct(n: number, total: number): number { return total > 0 ? Math.round((n / total) * 100) : 0; }
  function rateColor(r: number): string { return r >= 80 ? '#16a34a' : r >= 60 ? '#d97706' : '#dc2626'; }
  function fmtDate(d: string): string {
    const dt = new Date(d + 'T12:00:00');
    return dt.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
  }
  function fmtTime(iso: string): string {
    const d = new Date(iso);
    return d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  }
  const WEEKDAYS = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];

  // ── Load ──
  async function load() {
    $('s6-loading').style.display = '';
    $('s6-content').style.display = 'none';
    $('s6-empty').style.display = 'none';
    try {
      const resp = await fetch(`${W}/api/analysis?days=${currentDays}`);
      if (!resp.ok) throw new Error(`${resp.status}`);
      const d = await resp.json();
      if (!d.overall || d.overall.total === 0) {
        $('s6-loading').style.display = 'none';
        $('s6-empty').style.display = '';
        return;
      }
      render(d);
      $('s6-loading').style.display = 'none';
      $('s6-content').style.display = '';
      loadAiInsight();
    } catch (e) {
      console.error(e);
      $('s6-loading').style.display = 'none';
      $('s6-empty').style.display = '';
      $('s6-empty').querySelector('p')!.textContent = 'Daten konnten nicht geladen werden.';
    }
  }

  // ── Render ──
  function render(d: any) {
    const o = d.overall;
    const onTime = o.on_time || 0, delayed = o.delayed || 0, cancelled = o.cancelled || 0;
    const total = onTime + delayed + cancelled;
    const rate = pct(onTime, total);

    // Scorecard
    const onTimeExact = o.on_time_exact || 0;
    const minorDelay = o.minor_delay || 0;
    $('sc-ontime').textContent = String(onTime);
    $('sc-delayed').textContent = String(delayed);
    $('sc-cancelled').textContent = String(cancelled);
    const cancelledPct = total > 0 ? ((cancelled / total) * 100).toFixed(1) : '0.0';
    $('sc-cancelled-pct').textContent = `${cancelledPct}%`;
    $('sc-total').textContent = String(total);
    $('sc-period-label').textContent = `${currentDays} Tage`;
    // Sub-detail: wie viele exakt vs. leicht verspätet
    const detailEl = $('sc-ontime-detail');
    if (minorDelay > 0) {
      detailEl.textContent = `${onTimeExact}× exakt · ${minorDelay}× 1-5 Min`;
    } else {
      detailEl.textContent = `${onTimeExact}× exakt pünktlich`;
    }

    // Rate ring
    const circ = 2 * Math.PI * 52;
    const arc = $('rate-arc') as unknown as SVGCircleElement;
    arc.style.strokeDashoffset = String(circ - (rate / 100) * circ);
    arc.style.stroke = rateColor(rate);
    arc.style.transition = 'stroke-dashoffset 0.8s ease, stroke 0.4s ease';
    $('rate-pct').textContent = `${rate}%`;

    // KPIs
    const exactPct = pct(onTimeExact, total);
    $('kpi-exact').textContent = `${onTimeExact} (${exactPct}%)`;
    $('kpi-avg').textContent = fmtDelay(o.avg_delay);
    $('kpi-avg-late').textContent = o.avg_delay_late ? fmtDelay(o.avg_delay_late) : '–';
    $('kpi-max').textContent = fmtDelay(o.max_delay);
    $('kpi-since').textContent = o.first_date ? fmtDate(o.first_date) : '–';

    // Directions
    renderDir(d.byDirection, 'muenchen', 'dir-muc');
    renderDir(d.byDirection, 'tutzing', 'dir-tut');

    // Rush hour
    renderRush(d.rushHour);

    // Distribution (SVG histogram)
    renderDistSVG(d.delayDistribution, total);

    // Hourly (SVG line chart)
    renderHourlyLineChart(d.byHour);

    // Weekday (SVG line chart)
    renderWeekdayLineChart(d.byWeekday);

    // Daily (SVG stacked bar chart)
    renderDailyStackedChart(d.daily);

    // Worst delays
    renderWorst(d.worstDelays);

    // Today departures
    renderTodayDeps(d.todayDepartures);

    // Weather correlation
    renderWeather(d.byWeather);
    renderTemperature(d.byTemperature);
  }

  function renderDir(dirs: any[], key: string, prefix: string) {
    const d = dirs.find((x: any) => x.direction === key);
    if (!d) return;
    const total = (d.on_time || 0) + (d.delayed || 0) + (d.cancelled || 0);
    const r = pct(d.on_time || 0, total);
    $(`${prefix}-bar`).style.width = `${r}%`;
    $(`${prefix}-bar`).style.background = rateColor(r);
    $(`${prefix}-pct`).textContent = `${r}%`;
    $(`${prefix}-avg`).textContent = fmtDelay(d.avg_delay);
  }

  function renderRush(rush: any[]) {
    const svgSunrise = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:-2px;opacity:0.5"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="9" x2="12" y2="2"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="8 6 12 2 16 6"/></svg>';
    const svgSunset = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:-2px;opacity:0.5"><path d="M17 18a5 5 0 0 0-10 0"/><line x1="12" y1="2" x2="12" y2="9"/><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"/><line x1="1" y1="18" x2="3" y2="18"/><line x1="21" y1="18" x2="23" y2="18"/><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"/><line x1="23" y1="22" x2="1" y2="22"/><polyline points="16 6 12 10 8 6"/></svg>';
    const svgClock = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:-2px;opacity:0.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
    const labels: Record<string, string> = { morning_rush: svgSunrise + ' Morning Rush\n6:00–9:00', evening_rush: svgSunset + ' Evening Rush\n16:00–19:00', off_peak: svgClock + ' Nebenzeit\nRest' };
    const grid = $('rush-grid');
    const order = ['morning_rush', 'evening_rush', 'off_peak'];
    const itemStyle = 'text-align:center;padding:var(--space-4) var(--space-3);border-radius:var(--radius-md);background:var(--color-bg-secondary)';
    const labelStyle = 'display:block;font-size:0.75rem;font-weight:600;color:var(--color-text-secondary);margin-bottom:var(--space-2);line-height:1.4';
    const pctStyle = 'display:block;font-size:1.25rem;font-weight:700';
    const avgStyle = 'display:block;font-size:0.6875rem;color:var(--color-muted);margin-top:var(--space-1)';
    grid.innerHTML = order.map(key => {
      const r = rush.find((x: any) => x.period === key);
      if (!r) return `<div style="${itemStyle}"><span style="${labelStyle}">${labels[key]?.replace('\n','<br>') || key}</span><span style="${pctStyle}">–</span></div>`;
      const total = (r.on_time || 0) + (r.delayed || 0) + (r.cancelled || 0);
      const rate = pct(r.on_time || 0, total);
      return `<div style="${itemStyle}">
        <span style="${labelStyle}">${labels[key]?.replace('\n','<br>') || key}</span>
        <span style="${pctStyle};color:${rateColor(rate)}">${rate}%</span>
        <span style="${avgStyle}">Ø ${fmtDelay(r.avg_delay)} · ${total} Züge</span>
      </div>`;
    }).join('');
  }

  function renderDistSVG(dist: any[], total: number) {
    const el = $('dist-chart');
    const bucketOrder = ['exact', '0-1min', '1-2min', '2-3min', '3-4min', '4-5min', '5-10min', '10-20min', '20min+'];
    const bucketLabels: Record<string, string> = { exact: 'Exakt', '0-1min': '0–1', '1-2min': '1–2', '2-3min': '2–3', '3-4min': '3–4', '4-5min': '4–5', '5-10min': '5–10', '10-20min': '10–20', '20min+': '20+' };
    const bucketColors = ['#16a34a', '#22c55e', '#4ade80', '#84cc16', '#a3e635', '#eab308', '#d97706', '#ea580c', '#dc2626'];

    const counts: number[] = [];
    let totalCancelled = 0;
    bucketOrder.forEach((key) => {
      const item = dist.find((d: any) => d.bucket === key);
      const count = item?.count || 0;
      const cc = item?.cancelled_count || 0;
      totalCancelled += cc;
      counts.push(count - cc);
    });
    const maxCount = Math.max(...counts, 1);

    const pad = { top: 20, right: 10, bottom: 46, left: 36 };
    const W = 700, H = 240;
    const cW = W - pad.left - pad.right;
    const cH = H - pad.top - pad.bottom;
    const gap = cW / counts.length;
    const barW = Math.min(44, gap * 0.7);

    let svg = '';
    // Y grid
    const yStep = Math.ceil(maxCount / 4) || 1;
    for (let v = 0; v <= maxCount + yStep; v += yStep) {
      if (v > maxCount * 1.1) break;
      const y = pad.top + cH - (v / maxCount) * cH;
      if (y < pad.top - 5) break;
      svg += `<line x1="${pad.left}" y1="${y}" x2="${W - pad.right}" y2="${y}" stroke="var(--chart-grid)" stroke-width="1"/>`;
      svg += `<text x="${pad.left - 6}" y="${y + 3}" text-anchor="end" fill="var(--color-text-secondary)" font-size="10" font-family="'Space Grotesk',sans-serif">${v}</text>`;
    }

    // Bars
    counts.forEach((count, i) => {
      const x = pad.left + i * gap + gap / 2 - barW / 2;
      const barH = maxCount > 0 ? (count / maxCount) * cH : 0;
      const y = pad.top + cH - barH;
      if (count > 0) {
        svg += `<rect x="${x}" y="${y}" width="${barW}" height="${barH}" fill="${bucketColors[i]}" rx="3" class="dist-bar" data-label="${bucketLabels[bucketOrder[i]]}" data-count="${count}"/>`;
        svg += `<text x="${x + barW / 2}" y="${y - 5}" text-anchor="middle" fill="var(--color-text)" font-size="10" font-weight="600" font-family="'Space Grotesk',sans-serif">${count}</text>`;
      }
      svg += `<text x="${pad.left + i * gap + gap / 2}" y="${H - 10}" text-anchor="middle" fill="var(--color-text-secondary)" font-size="9" font-family="'Space Grotesk',sans-serif">${bucketLabels[bucketOrder[i]]}</text>`;
    });
    svg += `<text x="${pad.left + cW / 2}" y="${H}" text-anchor="middle" fill="var(--color-text-tertiary, #aaa)" font-size="9">Minuten Verspätung</text>`;

    let cancelledHtml = '';
    if (totalCancelled > 0) {
      cancelledHtml = `<p style="font-size:0.75rem;color:var(--chart-red);margin-top:var(--space-2);text-align:center;">+ ${totalCancelled} Ausfälle (nicht in Verteilung enthalten)</p>`;
    }
    el.innerHTML = `<div class="chart-container"><svg viewBox="0 0 ${W} ${H}">${svg}</svg></div>${cancelledHtml}`;

    // Tooltip (mouse + touch)
    el.querySelectorAll('.dist-bar').forEach(bar => {
      const showTip = (t: HTMLElement, x: number, y: number) => {
        const tip = $('chart-tooltip');
        tip.innerHTML = `<strong>${t.dataset.label} Min</strong><br>${t.dataset.count} Züge`;
        tip.classList.add('visible');
        tip.style.left = (x + 12) + 'px';
        tip.style.top = (y - 10) + 'px';
      };
      bar.addEventListener('mouseenter', (e: Event) => { const me = e as MouseEvent; showTip(e.target as HTMLElement, me.clientX, me.clientY); });
      bar.addEventListener('mousemove', (e: Event) => { const me = e as MouseEvent; const tip = $('chart-tooltip'); tip.style.left = (me.clientX + 12) + 'px'; tip.style.top = (me.clientY - 10) + 'px'; });
      bar.addEventListener('mouseleave', () => { $('chart-tooltip').classList.remove('visible'); });
      bar.addEventListener('touchstart', (e: Event) => { e.preventDefault(); const te = e as TouchEvent; const touch = te.touches[0]; showTip(e.target as HTMLElement, touch.clientX, touch.clientY); }, { passive: false } as any);
    });
  }

  function renderBarChart(elId: string, rows: any[], labelFn: (r: any) => string) {
    const el = $(elId);
    if (!rows || rows.length === 0) { el.innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Keine Daten</p>'; return; }
    el.innerHTML = rows.map((r: any) => {
      const total = (r.on_time || 0) + (r.delayed || 0) + (r.cancelled || 0);
      if (total === 0) return '';
      const gPct = ((r.on_time || 0) / total) * 100;
      const yPct = ((r.delayed || 0) / total) * 100;
      const rPct = ((r.cancelled || 0) / total) * 100;
      return `<div class="bar-row">
        <span class="bar-row__label">${labelFn(r)}</span>
        <div class="bar-row__track">
          <div class="seg--green" style="width:${gPct}%"></div>
          <div class="seg--yellow" style="width:${yPct}%"></div>
          <div class="seg--red" style="width:${rPct}%"></div>
        </div>
        <span class="bar-row__val">${pct(r.on_time || 0, total)}%</span>
      </div>`;
    }).join('');
  }

  function renderDailyStackedChart(daily: any[]) {
    const el = $('daily-chart');
    if (!daily || daily.length === 0) { el.innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Keine Daten</p>'; return; }

    const pad = { top: 24, right: 10, bottom: 42, left: 40 };
    const W = 700, H = 280;
    const cW = W - pad.left - pad.right;
    const cH = H - pad.top - pad.bottom;
    const maxTotal = Math.max(...daily.map((d: any) => (d.on_time || 0) + (d.delayed || 0) + (d.cancelled || 0)), 1);
    const gap = cW / daily.length;
    const barW = Math.max(6, Math.min(26, gap * 0.7));

    let svg = '';
    // Y grid
    const yStep = Math.ceil(maxTotal / 4) || 1;
    const yMax = Math.ceil(maxTotal / yStep) * yStep;
    for (let v = 0; v <= yMax; v += yStep) {
      const y = pad.top + cH - (v / yMax) * cH;
      svg += `<line x1="${pad.left}" y1="${y}" x2="${W - pad.right}" y2="${y}" stroke="var(--chart-grid)" stroke-width="1"/>`;
      svg += `<text x="${pad.left - 6}" y="${y + 3}" text-anchor="end" fill="var(--color-text-secondary)" font-size="10" font-family="'Space Grotesk',sans-serif">${v}</text>`;
    }

    // Bars
    const showEvery = daily.length > 14 ? 3 : daily.length > 7 ? 2 : 1;
    daily.forEach((d: any, i: number) => {
      const onTime = d.on_time || 0, delayed = d.delayed || 0, cancelled = d.cancelled || 0;
      const total = onTime + delayed + cancelled;
      const x = pad.left + i * gap + gap / 2 - barW / 2;
      const baseY = pad.top + cH;
      const gH = (onTime / yMax) * cH, yH = (delayed / yMax) * cH, rH = (cancelled / yMax) * cH;
      const attrs = `class="chart-bar" data-day="${fmtDate(d.date)}" data-ontime="${onTime}" data-delayed="${delayed}" data-cancelled="${cancelled}" data-total="${total}"`;
      // Invisible hover target for full bar area
      svg += `<rect x="${x}" y="${baseY - gH - yH - rH}" width="${barW}" height="${gH + yH + rH}" fill="transparent" ${attrs}/>`;
      if (gH > 0.5) svg += `<rect x="${x}" y="${baseY - gH}" width="${barW}" height="${gH}" fill="var(--chart-green)" rx="1" pointer-events="none"/>`;
      if (yH > 0.5) svg += `<rect x="${x}" y="${baseY - gH - yH}" width="${barW}" height="${yH}" fill="var(--chart-yellow)" rx="1" pointer-events="none"/>`;
      if (rH > 0.5) svg += `<rect x="${x}" y="${baseY - gH - yH - rH}" width="${barW}" height="${rH}" fill="var(--chart-red)" rx="1" pointer-events="none"/>`;
      if (i % showEvery === 0) {
        svg += `<text x="${pad.left + i * gap + gap / 2}" y="${H - 6}" text-anchor="middle" fill="var(--color-text-secondary)" font-size="9" font-family="'Space Grotesk',sans-serif">${fmtDate(d.date)}</text>`;
      }
    });

    // Legend
    const lx = W - 185;
    svg += `<rect x="${lx}" y="6" width="10" height="10" rx="2" fill="var(--chart-green)"/><text x="${lx+14}" y="15" font-size="9" fill="var(--color-text-secondary)">Pünktlich</text>`;
    svg += `<rect x="${lx+70}" y="6" width="10" height="10" rx="2" fill="var(--chart-yellow)"/><text x="${lx+84}" y="15" font-size="9" fill="var(--color-text-secondary)">Verspätet</text>`;
    svg += `<rect x="${lx+140}" y="6" width="10" height="10" rx="2" fill="var(--chart-red)"/><text x="${lx+154}" y="15" font-size="9" fill="var(--color-text-secondary)">Ausfall</text>`;

    el.innerHTML = `<div class="chart-container"><svg viewBox="0 0 ${W} ${H}">${svg}</svg></div>`;

    // Tooltip (mouse + touch)
    el.querySelectorAll('.chart-bar').forEach(bar => {
      const showTip = (t: HTMLElement, x: number, y: number) => {
        const tip = $('chart-tooltip');
        const r = t.dataset.total ? pct(parseInt(t.dataset.ontime||'0'), parseInt(t.dataset.total||'1')) : 0;
        tip.innerHTML = `<strong>${t.dataset.day}</strong><br>✓ ${t.dataset.ontime} pünktlich<br>⚠ ${t.dataset.delayed} verspätet<br>✕ ${t.dataset.cancelled} ausgefallen<br>Rate: ${r}%`;
        tip.classList.add('visible');
        tip.style.left = (x + 12) + 'px';
        tip.style.top = (y - 10) + 'px';
      };
      bar.addEventListener('mouseenter', (e: Event) => { const me = e as MouseEvent; showTip(e.target as HTMLElement, me.clientX, me.clientY); });
      bar.addEventListener('mousemove', (e: Event) => { const me = e as MouseEvent; const tip = $('chart-tooltip'); tip.style.left = (me.clientX + 12) + 'px'; tip.style.top = (me.clientY - 10) + 'px'; });
      bar.addEventListener('mouseleave', () => { $('chart-tooltip').classList.remove('visible'); });
      bar.addEventListener('touchstart', (e: Event) => { e.preventDefault(); const te = e as TouchEvent; const touch = te.touches[0]; showTip(e.target as HTMLElement, touch.clientX, touch.clientY); }, { passive: false } as any);
    });
  }

  function renderHourlyLineChart(byHour: any[]) {
    const el = $('hourly-chart');
    if (!byHour || byHour.length === 0) { el.innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Keine Daten</p>'; return; }

    const hours = byHour.map((h: any) => {
      const total = (h.on_time || 0) + (h.delayed || 0) + (h.cancelled || 0);
      return { hour: h.hour, rate: total > 0 ? ((h.on_time || 0) / total) * 100 : 0, total, onTime: h.on_time || 0, delayed: h.delayed || 0, cancelled: h.cancelled || 0 };
    }).sort((a, b) => a.hour - b.hour);

    const pad = { top: 20, right: 15, bottom: 42, left: 42 };
    const W = 700, H = 260;
    const cW = W - pad.left - pad.right;
    const cH = H - pad.top - pad.bottom;
    const minH = hours[0].hour, maxH = hours[hours.length - 1].hour;
    const hRange = maxH - minH || 1;
    const xS = (h: number) => pad.left + ((h - minH) / hRange) * cW;
    const yS = (v: number) => pad.top + cH - (v / 100) * cH;

    let svg = '';

    // Rush hour highlight zones
    [[7, 9], [16, 18]].forEach(([s, e]) => {
      const x1 = Math.max(xS(s), pad.left), x2 = Math.min(xS(e), W - pad.right);
      if (x2 > x1) {
        svg += `<rect x="${x1}" y="${pad.top}" width="${x2 - x1}" height="${cH}" fill="var(--chart-rush-bg)" rx="4"/>`;
        svg += `<text x="${(x1 + x2) / 2}" y="${pad.top + 14}" text-anchor="middle" fill="var(--color-text-tertiary, #aaa)" font-size="8" font-style="italic">Rush Hour</text>`;
      }
    });

    // Y grid
    [0, 25, 50, 75, 100].forEach(v => {
      const y = yS(v);
      svg += `<line x1="${pad.left}" y1="${y}" x2="${W - pad.right}" y2="${y}" stroke="var(--chart-grid)" stroke-width="1"/>`;
      svg += `<text x="${pad.left - 6}" y="${y + 3}" text-anchor="end" fill="var(--color-text-secondary)" font-size="10" font-family="'Space Grotesk',sans-serif">${v}%</text>`;
    });

    // Area fill
    if (hours.length > 1) {
      let area = `M ${xS(hours[0].hour)} ${yS(hours[0].rate)}`;
      hours.slice(1).forEach(h => { area += ` L ${xS(h.hour)} ${yS(h.rate)}`; });
      area += ` L ${xS(hours[hours.length - 1].hour)} ${yS(0)} L ${xS(hours[0].hour)} ${yS(0)} Z`;
      svg += `<path d="${area}" fill="var(--chart-line)" opacity="0.07"/>`;
    }

    // Line
    if (hours.length > 1) {
      let line = `M ${xS(hours[0].hour)} ${yS(hours[0].rate)}`;
      hours.slice(1).forEach(h => { line += ` L ${xS(h.hour)} ${yS(h.rate)}`; });
      svg += `<path d="${line}" fill="none" stroke="var(--chart-line)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>`;
    }

    // Data points + X labels
    hours.forEach(h => {
      const cx = xS(h.hour), cy = yS(h.rate);
      svg += `<circle cx="${cx}" cy="${cy}" r="5" fill="var(--color-card)" stroke="${rateColor(h.rate)}" stroke-width="2.5" class="hour-dot" data-hour="${h.hour}" data-rate="${Math.round(h.rate)}" data-total="${h.total}" data-ontime="${h.onTime}" data-delayed="${h.delayed}" data-cancelled="${h.cancelled}"/>`;
      svg += `<text x="${cx}" y="${H - 8}" text-anchor="middle" fill="var(--color-text-secondary)" font-size="9" font-family="'Space Grotesk',sans-serif">${String(h.hour).padStart(2, '0')}h</text>`;
    });

    el.innerHTML = `<div class="chart-container"><svg viewBox="0 0 ${W} ${H}">${svg}</svg></div>`;

    // Tooltip (mouse + touch)
    el.querySelectorAll('.hour-dot').forEach(dot => {
      const showTip = (t: HTMLElement, x: number, y: number) => {
        const tip = $('chart-tooltip');
        tip.innerHTML = `<strong>${t.dataset.hour}:00 Uhr</strong><br>Rate: ${t.dataset.rate}%<br>✓ ${t.dataset.ontime} pünktlich<br>⚠ ${t.dataset.delayed} verspätet<br>✕ ${t.dataset.cancelled} ausgefallen`;
        tip.classList.add('visible');
        tip.style.left = (x + 12) + 'px';
        tip.style.top = (y - 10) + 'px';
      };
      dot.addEventListener('mouseenter', (e: Event) => { const me = e as MouseEvent; showTip(e.target as HTMLElement, me.clientX, me.clientY); });
      dot.addEventListener('mousemove', (e: Event) => { const me = e as MouseEvent; const tip = $('chart-tooltip'); tip.style.left = (me.clientX + 12) + 'px'; tip.style.top = (me.clientY - 10) + 'px'; });
      dot.addEventListener('mouseleave', () => { $('chart-tooltip').classList.remove('visible'); });
      dot.addEventListener('touchstart', (e: Event) => { e.preventDefault(); const te = e as TouchEvent; const touch = te.touches[0]; showTip(e.target as HTMLElement, touch.clientX, touch.clientY); }, { passive: false } as any);
    });
  }

  function renderWeekdayLineChart(byWeekday: any[]) {
    const el = $('weekday-chart');
    if (!byWeekday || byWeekday.length === 0) { el.innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Keine Daten</p>'; return; }

    // Reorder: Mo(1), Di(2), Mi(3), Do(4), Fr(5), Sa(6), So(0)
    const dayOrder = [1, 2, 3, 4, 5, 6, 0];
    const dayLabels = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];

    const days = dayOrder.map((wd, i) => {
      const d = byWeekday.find((w: any) => w.weekday === wd);
      const total = d ? (d.on_time || 0) + (d.delayed || 0) + (d.cancelled || 0) : 0;
      const rate = total > 0 ? ((d?.on_time || 0) / total) * 100 : 0;
      return { label: dayLabels[i], rate, total, onTime: d?.on_time || 0, delayed: d?.delayed || 0, cancelled: d?.cancelled || 0 };
    }).filter(d => d.total > 0);

    if (days.length === 0) { el.innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Keine Daten</p>'; return; }

    const pad = { top: 20, right: 15, bottom: 42, left: 42 };
    const chartW = 700, chartH = 260;
    const cW = chartW - pad.left - pad.right;
    const cH = chartH - pad.top - pad.bottom;
    const xS = (i: number) => pad.left + (days.length > 1 ? (i / (days.length - 1)) * cW : cW / 2);
    const yS = (v: number) => pad.top + cH - (v / 100) * cH;

    let svg = '';

    // Weekend highlight
    const saIdx = days.findIndex(d => d.label === 'Sa');
    const soIdx = days.findIndex(d => d.label === 'So');
    if (saIdx >= 0 && soIdx >= 0) {
      const x1 = xS(saIdx) - 20;
      const x2 = xS(soIdx) + 20;
      svg += `<rect x="${x1}" y="${pad.top}" width="${x2 - x1}" height="${cH}" fill="var(--chart-rush-bg)" rx="4"/>`;
      svg += `<text x="${(x1 + x2) / 2}" y="${pad.top + 14}" text-anchor="middle" fill="var(--color-text-tertiary, #aaa)" font-size="8" font-style="italic">Wochenende</text>`;
    } else if (saIdx >= 0) {
      const x1 = xS(saIdx) - 20;
      const x2 = xS(saIdx) + 20;
      svg += `<rect x="${x1}" y="${pad.top}" width="${x2 - x1}" height="${cH}" fill="var(--chart-rush-bg)" rx="4"/>`;
    }

    // Y grid
    [0, 25, 50, 75, 100].forEach(v => {
      const y = yS(v);
      svg += `<line x1="${pad.left}" y1="${y}" x2="${chartW - pad.right}" y2="${y}" stroke="var(--chart-grid)" stroke-width="1"/>`;
      svg += `<text x="${pad.left - 6}" y="${y + 3}" text-anchor="end" fill="var(--color-text-secondary)" font-size="10" font-family="'Space Grotesk',sans-serif">${v}%</text>`;
    });

    // Area fill
    if (days.length > 1) {
      let area = `M ${xS(0)} ${yS(days[0].rate)}`;
      days.slice(1).forEach((d, i) => { area += ` L ${xS(i + 1)} ${yS(d.rate)}`; });
      area += ` L ${xS(days.length - 1)} ${yS(0)} L ${xS(0)} ${yS(0)} Z`;
      svg += `<path d="${area}" fill="var(--chart-line)" opacity="0.07"/>`;
    }

    // Line
    if (days.length > 1) {
      let line = `M ${xS(0)} ${yS(days[0].rate)}`;
      days.slice(1).forEach((d, i) => { line += ` L ${xS(i + 1)} ${yS(d.rate)}`; });
      svg += `<path d="${line}" fill="none" stroke="var(--chart-line)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>`;
    }

    // Data points + X labels
    days.forEach((d, i) => {
      const cx = xS(i), cy = yS(d.rate);
      svg += `<circle cx="${cx}" cy="${cy}" r="6" fill="var(--color-card)" stroke="${rateColor(d.rate)}" stroke-width="2.5" class="weekday-dot" data-label="${d.label}" data-rate="${Math.round(d.rate)}" data-total="${d.total}" data-ontime="${d.onTime}" data-delayed="${d.delayed}" data-cancelled="${d.cancelled}"/>`;
      svg += `<text x="${cx}" y="${chartH - 8}" text-anchor="middle" fill="var(--color-text-secondary)" font-size="11" font-weight="600" font-family="'Space Grotesk',sans-serif">${d.label}</text>`;
    });

    el.innerHTML = `<div class="chart-container"><svg viewBox="0 0 ${chartW} ${chartH}">${svg}</svg></div>`;

    // Tooltip (mouse + touch)
    el.querySelectorAll('.weekday-dot').forEach(dot => {
      const showTip = (t: HTMLElement, x: number, y: number) => {
        const tip = $('chart-tooltip');
        tip.innerHTML = `<strong>${t.dataset.label}</strong><br>Rate: ${t.dataset.rate}%<br>✓ ${t.dataset.ontime} pünktlich<br>⚠ ${t.dataset.delayed} verspätet<br>✕ ${t.dataset.cancelled} ausgefallen<br>Gesamt: ${t.dataset.total} Züge`;
        tip.classList.add('visible');
        tip.style.left = (x + 12) + 'px';
        tip.style.top = (y - 10) + 'px';
      };
      dot.addEventListener('mouseenter', (e: Event) => { const me = e as MouseEvent; showTip(e.target as HTMLElement, me.clientX, me.clientY); });
      dot.addEventListener('mousemove', (e: Event) => { const me = e as MouseEvent; const tip = $('chart-tooltip'); tip.style.left = (me.clientX + 12) + 'px'; tip.style.top = (me.clientY - 10) + 'px'; });
      dot.addEventListener('mouseleave', () => { $('chart-tooltip').classList.remove('visible'); });
      dot.addEventListener('touchstart', (e: Event) => { e.preventDefault(); const te = e as TouchEvent; const touch = te.touches[0]; showTip(e.target as HTMLElement, touch.clientX, touch.clientY); }, { passive: false } as any);
    });
  }

  function renderWorst(delays: any[]) {
    if (!delays || delays.length === 0) {
      $('worst-table').innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Keine Verspätungen > 5 Min 🎉</p>';
      return;
    }
    $('worst-table').innerHTML = `<table class="worst-tbl">
      <thead><tr><th>Datum</th><th>Uhrzeit</th><th>Richtung</th><th>Verspätung</th><th></th></tr></thead>
      <tbody>${delays.map((d: any) => `<tr${d.cancelled ? ' style="opacity:0.6"' : ''}>
        <td>${fmtDate(d.date)}</td>
        <td>${fmtTime(d.planned_when)}</td>
        <td>${d.direction === 'muenchen' ? '→ München' : '← Tutzing'}</td>
        <td class="delay-val">+${Math.round(d.delay / 60)} Min</td>
        <td>${d.cancelled ? '<span style="font-size:0.6875rem;color:#dc2626;">Ausfall</span>' : ''}</td>
      </tr>`).join('')}</tbody>
    </table>`;
  }

  function renderTodayDeps(deps: any[]) {
    const summaryEl = $('today-summary');
    if (!deps || deps.length === 0) {
      $('today-deps').innerHTML = '<p class="text-muted" style="font-size:0.8125rem;">Noch keine Abfahrten erfasst</p>';
      summaryEl.textContent = 'Keine Daten';
      return;
    }
    // Summary for collapsed state
    const totalDeps = deps.length;
    const ontimeDeps = deps.filter((d: any) => !d.cancelled && (!d.delay || d.delay <= 300)).length;
    const pctOntime = totalDeps > 0 ? Math.round((ontimeDeps / totalDeps) * 100) : 0;
    summaryEl.textContent = `${totalDeps} Abfahrten · ${pctOntime}% pünktlich`;

    $('today-deps').innerHTML = deps.map((d: any) => {
      const delaySec = d.delay || 0;
      const delayMin = Math.round(delaySec / 60);
      let cls = 'dep-chip--ok';
      if (d.cancelled) cls = 'dep-chip--cancel';
      else if (delaySec > 300) cls = 'dep-chip--late';
      else if (delaySec > 0) cls = 'dep-chip--minor';

      const time = fmtTime(d.planned_when);
      const dir = d.direction === 'muenchen' ? '→Muc' : '→Tut';
      let delayStr = '';
      // Only show delay for non-cancelled trains
      if (d.delay && d.delay > 0 && !d.cancelled) {
        const delayClass = delaySec > 300 ? 'dep-chip__delay' : 'dep-chip__delay--minor';
        delayStr = `<span class="${delayClass}">+${delayMin}</span>`;
      }
      if (d.cancelled) {
        delayStr = '<span style="font-size:0.625rem;color:#dc2626;font-weight:600;">✕</span>';
      }
      return `<span class="dep-chip ${cls}">${time} <span class="dep-chip__dir">${dir}</span> ${delayStr}</span>`;
    }).join('');
  }

  const wi = (d: string) => `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.6;flex-shrink:0">${d}</svg>`;
  const WEATHER_ICONS: Record<string, string> = {
    klar: wi('<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'),
    bewölkt: wi('<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>'),
    nebel: wi('<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><line x1="3" y1="22" x2="21" y2="22" stroke-dasharray="3 3"/>'),
    regen: wi('<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><line x1="8" y1="21" x2="6" y2="24"/><line x1="12" y1="21" x2="10" y2="24"/><line x1="16" y1="21" x2="14" y2="24"/>'),
    schnee: wi('<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><line x1="8" y1="15" x2="8" y2="15.01"/><line x1="12" y1="17" x2="12" y2="17.01"/><line x1="16" y1="15" x2="16" y2="15.01"/>'),
    gewitter: wi('<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/><polyline points="13 16 11 21 15 21 13 24"/>'),
    unbekannt: wi('<circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>')
  };
  const WEATHER_LABELS: Record<string, string> = {
    klar: 'Klar', bewölkt: 'Bewölkt', nebel: 'Nebel', regen: 'Regen',
    schnee: 'Schnee', gewitter: 'Gewitter', unbekannt: 'Unbekannt'
  };

  function renderWeather(data: any[]) {
    if (!data || data.length === 0 || (data.length === 1 && data[0].weather === 'unbekannt')) return;
    const filtered = data.filter((w: any) => w.weather !== 'unbekannt' && w.total > 0);
    if (filtered.length === 0) return;

    $('weather-section').style.display = '';
    $('weather-grid').innerHTML = filtered.map((w: any) => {
      const total = (w.on_time || 0) + (w.delayed || 0) + (w.cancelled || 0);
      const rate = pct(w.on_time || 0, total);
      const icon = WEATHER_ICONS[w.weather] || '❓';
      const label = WEATHER_LABELS[w.weather] || w.weather;
      const avgMin = w.avg_delay ? fmtDelay(w.avg_delay) : '0 Min';
      const cancelStr = w.cancelled > 0 ? `${w.cancelled} Ausfälle` : '';
      const details = [`Ø ${avgMin}`, `${total} Züge`, cancelStr].filter(Boolean).join(' · ');
      return `<div style="text-align:center;padding:var(--space-4) var(--space-3);border-radius:var(--radius-md);background:var(--color-bg-secondary)">
        <span style="display:flex;justify-content:center;margin-bottom:var(--space-1)">${icon}</span>
        <span style="display:block;font-size:0.8125rem;font-weight:600;color:var(--color-text)">${label}</span>
        <span style="display:block;font-size:1.25rem;font-weight:700;color:${rateColor(rate)};margin:var(--space-1) 0">${rate}%</span>
        <span style="display:block;font-size:0.6875rem;color:var(--color-muted)">${details}</span>
      </div>`;
    }).join('');
  }

  function renderTemperature(data: any[]) {
    if (!data || data.length === 0) return;
    const filtered = data.filter((t: any) => t.temp_range !== 'unbekannt' && t.total > 0);
    if (filtered.length === 0) return;

    $('temp-section').style.display = '';
    renderBarChart('temp-chart', filtered.map((t: any) => ({
      ...t,
      on_time: t.on_time || 0,
      delayed: t.delayed || 0,
      cancelled: t.cancelled || 0,
      _label: t.temp_range
    })), (r: any) => r._label || r.temp_range);
  }

  async function loadAiInsight() {
    try {
      const resp = await fetch(`${W}/api/ai-insight?days=${currentDays}`);
      if (!resp.ok) return;
      const data = await resp.json();
      if (data.insight) {
        $('ai-section').style.display = '';
        $('ai-insight').textContent = data.insight;
        const date = new Date(data.generatedAt).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        $('ai-meta').textContent = `Analyse generiert am ${date} — basierend auf ${data.dataPoints} Datenpunkten`;
      } else {
        $('ai-section').style.display = 'none';
      }
    } catch (e) { console.log('AI insight not available'); }
  }

  load();
</script>
