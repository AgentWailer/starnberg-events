---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import InfoTicker from '../components/InfoTicker.astro';
import TrainInfo from '../components/TrainInfo.astro';
import MarketInfo from '../components/MarketInfo.astro';
import WebcamWidget from '../components/WebcamWidget.astro';
import FilterBar from '../components/FilterBar.astro';
import DayGroup from '../components/DayGroup.astro';
import EventModal from '../components/EventModal.astro';
import eventsData from '../data/events.json';

// Get regions from data or use defaults
const regions = eventsData.regions || {
  "poecking": { "name": "PÃ¶cking", "emoji": "ðŸ " },
  "starnberger-see": { "name": "Starnberger See", "emoji": "ðŸ”ï¸" },
  "ammersee": { "name": "Ammersee", "emoji": "â›µ" },
  "muenchen": { "name": "MÃ¼nchen", "emoji": "ðŸ™ï¸" },
  "tegernsee": { "name": "Tegernsee", "emoji": "â›°ï¸" },
  "werdenfels": { "name": "Werdenfelser Land", "emoji": "ðŸŽ¿" }
};

// Get artTags from data
const artTags = eventsData.artTags || {};

// Filter out past events and sort by date
const todayStr = new Date().toISOString().split('T')[0];
const events = eventsData.events
  .filter(e => e.date >= todayStr)
  .sort((a, b) => {
    const dateCompare = a.date.localeCompare(b.date);
    if (dateCompare !== 0) return dateCompare;
    if (!a.time) return 1;
    if (!b.time) return -1;
    return a.time.localeCompare(b.time);
  });

// Get unique sources
const sources = [...new Set(events.map(e => e.source).filter(Boolean))];

// === Group Events by Day ===
interface DayGroup {
  date: Date;
  events: typeof events;
}

const eventsByDay = events.reduce((acc, event) => {
  const dayKey = event.date; // YYYY-MM-DD
  if (!acc[dayKey]) {
    acc[dayKey] = {
      date: new Date(event.date),
      events: []
    };
  }
  acc[dayKey].events.push(event);
  return acc;
}, {} as Record<string, DayGroup>);

// Sort days chronologically
const sortedDays = Object.entries(eventsByDay)
  .sort(([a], [b]) => a.localeCompare(b));

// === Weekend Highlights - get events for next weekend (Sa+So) ===
const today = new Date();
const dayOfWeek = today.getDay();
// If today is Saturday, show this weekend; if Sunday, also show today
const daysUntilSaturday = dayOfWeek === 0 ? -1 : dayOfWeek === 6 ? 0 : (6 - dayOfWeek);

const nextSaturday = new Date(today);
nextSaturday.setDate(today.getDate() + daysUntilSaturday);
nextSaturday.setHours(0, 0, 0, 0);

const nextSunday = new Date(nextSaturday);
nextSunday.setDate(nextSaturday.getDate() + 1);

// Get ALL weekend events
const allWeekendEvents = events.filter(event => {
  const eventDate = new Date(event.date);
  eventDate.setHours(0, 0, 0, 0);
  return eventDate.getTime() === nextSaturday.getTime() || eventDate.getTime() === nextSunday.getTime();
});

// AI-curated: sort by overall score (highest first), then by date/time
const weekendEvents = allWeekendEvents
  .sort((a, b) => {
    const scoreA = a.aiCuration?.scores?.overall ?? 0;
    const scoreB = b.aiCuration?.scores?.overall ?? 0;
    if (scoreB !== scoreA) return scoreB - scoreA;
    const dateCompare = a.date.localeCompare(b.date);
    if (dateCompare !== 0) return dateCompare;
    return (a.time || '99:99').localeCompare(b.time || '99:99');
  })
  // Show ALL weekend events, sorted by score

const hasWeekendEvents = weekendEvents.length > 0;
const hasCuration = weekendEvents.some(e => e.aiCuration);
const weekendTitle = dayOfWeek === 6 ? "Dieses Wochenende" : dayOfWeek === 0 ? "Heute" : "Dieses Wochenende";

---

<Layout title="Starnberg Events â€” Was ist los in und um PÃ¶cking?">
  <Header lastUpdated={eventsData.lastUpdated} />
  
  <!-- Mobile: Sticky Ticker -->
  <div class="mobile-info-bar">
    <InfoTicker />
  </div>

  <main class="main" id="main-content">
    <div class="container">
      <!-- Content Grid: 3 Columns -->
      <div class="content-grid">
        
        <!-- LEFT COLUMN: Filters -->
        <div class="column-left">
          <h3 class="section-heading">Filter</h3>
          <FilterBar events={events} regions={regions} artTags={artTags} />
        </div>

        <!-- CENTER COLUMN: Event List -->
        <div class="column-center">
          <!-- Hidden count for filter JS -->
          <span id="visible-count" style="display:none">{events.length}</span>

          <!-- Weekend Highlights Carousel (Mobile/Tablet only) -->
          {hasWeekendEvents && (
            <section class="wk-carousel-section">
              <h3 class="section-heading">{weekendTitle}</h3>
              <div class="wk-carousel-track">
                {weekendEvents.map(event => {
                  const evDate = new Date(event.date);
                  const evDay = evDate.getDate();
                  const evMonth = evDate.getMonth() + 1;
                  const evWeekday = evDate.toLocaleDateString('de-DE', { weekday: 'short' });
                  const curation = event.aiCuration;
                  const score = curation?.scores?.overall ?? 0;
                  const scoreColor = score >= 8 ? 'var(--wk-score-high)' : score >= 6 ? 'var(--wk-score-mid)' : 'var(--wk-score-low)';
                  return (
                    <button 
                      class="wk-card" 
                      data-event-id={event.id}
                      data-event-title={event.title}
                      data-date={event.date}
                      data-event-time={event.time}
                      data-location={event.location}
                      data-event-address={event.address}
                      data-event-description={event.description}
                      data-event-url={event.url}
                      data-category={event.category}
                      data-art-tags={event.artTags?.join(',')}
                      data-ai-summary={curation?.aiSummary}
                      data-ai-best-for={curation?.bestFor}
                      data-ai-score={score}
                      data-ai-price={curation?.priceInfo}
                      data-ai-tips={curation?.tips}
                      data-ai-age-range={curation?.ageRange}
                      data-ai-family-score={curation?.scores?.family}
                      data-ai-kids-score={curation?.scores?.kids}
                      data-ai-adults-score={curation?.scores?.adults}
                    >
                      <div class="wk-card-top">
                        {curation && (
                          <div class="wk-score-badge" style={`--score-color: ${scoreColor}`}>
                            <span class="wk-score-val">{score}</span>
                            <span class="wk-score-max">/10</span>
                          </div>
                        )}
                        <div class="wk-card-meta">
                          <span class="wk-day">{evWeekday} {evDay}.{evMonth}.</span>
                          {event.time && <span class="wk-time">{event.time} Uhr</span>}
                          <span class={`wk-cat-badge wk-cat--${event.category}`}>{event.category === 'kinder' ? 'Kinder' : event.category === 'familie' ? 'Familie' : 'Erwachsene'}</span>
                        </div>
                      </div>
                      <h4 class="wk-card-title">{event.title}</h4>
                      {curation?.aiSummary && (
                        <p class="wk-card-summary">{curation.aiSummary.length > 80 ? curation.aiSummary.slice(0, 80) + 'â€¦' : curation.aiSummary}</p>
                      )}
                      <div class="wk-card-footer">
                        <div class="wk-card-location">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="wk-loc-icon">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                          </svg>
                          {event.location}
                        </div>
                      </div>
                    </button>
                  );
                })}
              </div>
            </section>
          )}

          <!-- Day Groups -->
          <div class="events-list" id="events-list">
            {sortedDays.map(([dayKey, dayData]) => (
              <DayGroup date={dayData.date} events={dayData.events} regions={regions} artTagsData={artTags} />
            ))}
          </div>

          <!-- Load More Button (Mobile only) -->
          <button class="load-more-btn" id="load-more-btn">
            Weitere Events <span class="load-more-count" id="load-more-count"></span>
          </button>

          <!-- Mobile: Vor Ort -->
          <section class="section section-info section-info--mobile">
            <h3 class="section-heading">Vor Ort</h3>
            <div class="info-grid-single">
              <MarketInfo />
              <WebcamWidget />
            </div>
          </section>
        </div>

        <!-- RIGHT COLUMN: Context (Desktop only) -->
        <aside class="column-right">
          <!-- S-Bahn Info -->
          <h3 class="section-heading">S-Bahn aktuell</h3>
          <div class="context-widget">
            <TrainInfo station="Possenhofen" stationCode="MPH" />
          </div>

          <!-- Weekend Highlights (Vertical, collapsible) -->
          {hasWeekendEvents && (
            <div class="context-widget-group">
              <h3 class="section-heading">{weekendTitle}</h3>
              <div class="highlights-vertical" id="highlights-vertical">
                {weekendEvents.map((event, index) => {
                  const evDate = new Date(event.date);
                  const evDay = evDate.getDate();
                  const evMonth = evDate.getMonth() + 1;
                  const evWeekday = evDate.toLocaleDateString('de-DE', { weekday: 'short' });
                  const curation = event.aiCuration;
                  const score = curation?.scores?.overall ?? 0;
                  return (
                    <button 
                      class={`wh-card ${index >= 3 ? 'wh-card--collapsed' : ''}`}
                      data-event-id={event.id}
                      data-event-title={event.title}
                      data-date={event.date}
                      data-event-time={event.time}
                      data-location={event.location}
                      data-event-address={event.address}
                      data-event-description={event.description}
                      data-event-url={event.url}
                      data-category={event.category}
                      data-art-tags={event.artTags?.join(',')}
                      data-ai-summary={curation?.aiSummary}
                      data-ai-best-for={curation?.bestFor}
                      data-ai-score={score}
                      data-ai-price={curation?.priceInfo}
                      data-ai-tips={curation?.tips}
                      data-ai-age-range={curation?.ageRange}
                      data-ai-family-score={curation?.scores?.family}
                      data-ai-kids-score={curation?.scores?.kids}
                      data-ai-adults-score={curation?.scores?.adults}
                    >
                      {curation && (
                        <div class="wh-score">
                          <span class="wh-score-num">{score}</span>
                          <span class="wh-score-label">/10</span>
                        </div>
                      )}
                      <div class="wh-content">
                        <div class="wh-meta">
                          <span class="wh-date">{evWeekday} {evDay}.{evMonth}.</span>
                          <span class={`wh-cat-badge wh-cat--${event.category}`}>{event.category === 'kinder' ? 'Kinder' : event.category === 'familie' ? 'Familie' : 'Erwachsene'}</span>
                        </div>
                        <h4 class="wh-title">{event.title}</h4>
                        {curation?.aiSummary && (
                          <p class="wh-summary">{curation.aiSummary.length > 90 ? curation.aiSummary.slice(0, 90) + 'â€¦' : curation.aiSummary}</p>
                        )}
                        <div class="wh-location">
                          <svg class="wh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                          </svg>
                          {event.location}
                        </div>
                      </div>
                    </button>
                  );
                })}
              </div>
              {weekendEvents.length > 3 && (
                <button class="wh-show-more" id="wh-show-more">
                  <span class="wh-show-more-text" id="wh-show-more-text">{weekendEvents.length - 3} weitere anzeigen</span>
                  <svg class="wh-show-more-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
              )}
            </div>
          )}

          <!-- Vor Ort Widgets -->
          <h3 class="section-heading">Vor Ort</h3>
          <div class="context-widget">
            <div class="vor-ort-stack">
              <MarketInfo />
              <WebcamWidget />
            </div>
          </div>
        </aside>

      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="footer-text">
        {events.length} Events aus {sources.length} Quellen Â·
        <span class="footer-links">
          <a href="https://www.beccult.de" target="_blank" rel="noopener">beccult</a>,
          <a href="https://www.starnbergammersee.de" target="_blank" rel="noopener">starnbergammersee.de</a>,
          <a href="https://www.muenchen.de" target="_blank" rel="noopener">muenchen.de</a>
        </span>
      </p>
    </div>
  </footer>

  <!-- Event Modal -->
  <EventModal />
</Layout>

<style>
  .main {
    position: relative;
    z-index: 1; /* Keep all scrolling content below fixed header (z:95) & navbar (z:100) */
    padding-bottom: var(--space-16);
  }

  @media (min-width: 768px) {
    .main {
      padding-top: 377px; /* Space for fixed header */
    }
  }

  /* ===== CONTENT GRID ===== */
  .content-grid {
    display: block;
  }

  /* Mobile: Single column (< 768px) */
  @media (max-width: 767px) {
    .column-left {
      display: contents; /* Remove box but keep children â€” mobile filter bar (position:fixed) needs to render */
    }
    .column-left > .section-heading {
      display: none; /* Hide "Filter" heading on mobile */
    }
    .column-right {
      display: none;
    }
  }

  /* Tablet: 2 columns (768px - 1199px) */
  @media (min-width: 768px) and (max-width: 1199px) {
    .content-grid {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: var(--space-8);
      align-items: start;
    }
    
    .column-right {
      display: none; /* Hide right column on tablet */
    }
  }

  /* Desktop: 3 columns (â‰¥ 1200px) */
  @media (min-width: 1200px) {
    .content-grid {
      display: grid;
      grid-template-columns: 340px 1fr 340px;
      gap: var(--space-8); /* 2rem = 32px */
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
    }
  }

  /* ===== LEFT COLUMN (Filter Sidebar) ===== */
  .column-left {
    position: sticky;
    top: 377px;
    max-height: calc(100vh - 377px - 32px);
    overflow-y: auto;
    align-self: start;
  }

  /* ===== CENTER COLUMN (Event List) ===== */
  .column-center {
    min-width: 0; /* Prevent grid blowout */
  }

  @media (min-width: 768px) {
    .column-center {
      max-height: calc(100vh - 377px);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    .column-center::-webkit-scrollbar {
      width: 4px;
    }

    .column-center::-webkit-scrollbar-track {
      background: transparent;
    }

    .column-center::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 2px;
    }
  }

  /* ===== RIGHT COLUMN (Context Sidebar) ===== */
  .column-right {
    display: none;
  }

  @media (min-width: 1200px) {
    .column-right {
      display: block;
      position: sticky;
      top: 377px;
      max-height: calc(100vh - 377px - 32px);
      overflow-y: auto;
      align-self: start;
    }

    /* Sticky section headings inside scrollable right sidebar */
    .column-right > .section-heading,
    .column-right .context-widget-group > .section-heading {
      position: sticky;
      top: 0;
      background: var(--color-bg);
      z-index: 5;
      padding-bottom: var(--space-3);
      margin-bottom: var(--space-4);
    }

    /* Fade below sticky heading in right column */
    .column-right > .section-heading::after,
    .column-right .context-widget-group > .section-heading::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      height: 16px;
      background: linear-gradient(to bottom, var(--color-bg), transparent);
      pointer-events: none;
    }
  }

  .context-widget-group {
    margin-bottom: var(--space-10, 2.5rem);
  }

  .context-widget {
    margin-bottom: var(--space-8);
  }

  .context-widget:last-child {
    margin-bottom: 0;
  }

  .context-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .vor-ort-stack {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* ===== Mobile Info Bar ===== */
  .mobile-info-bar {
    display: block;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  @media (min-width: 768px) {
    .mobile-info-bar {
      display: none;
    }
  }

  /* ===== EVENTS LIST ===== */
  .events-list {
    /* No max-height or overflow on mobile/tablet - normal flow */
  }

  /* ===== WEEKEND HIGHLIGHTS CAROUSEL (Mobile/Tablet) ===== */
  .wk-carousel-section {
    --wk-score-high: #10b981;
    --wk-score-mid: #f59e0b;
    --wk-score-low: #6366f1;
    margin-bottom: var(--space-6);
  }

  @media (min-width: 1200px) {
    .wk-carousel-section {
      display: none; /* Desktop: shown in right sidebar instead */
    }
  }

  .wk-carousel-track {
    display: flex;
    gap: var(--space-4);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding-bottom: var(--space-2);
    /* Allow cards to peek out on the right to hint at scrollability */
    margin-right: calc(-1 * var(--space-4));
    padding-right: var(--space-4);
  }

  .wk-carousel-track::-webkit-scrollbar {
    display: none;
  }

  .wk-card {
    flex: 0 0 280px;
    scroll-snap-align: start;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    padding: var(--space-5);
    background: var(--color-card);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-xl, 16px);
    cursor: pointer;
    transition: all var(--duration-normal) ease;
    font-family: inherit;
    color: inherit;
    text-align: left;
    position: relative;
    overflow: hidden;
  }

  .wk-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--score-color, var(--color-primary)), transparent);
    opacity: 0.7;
  }

  .wk-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg, 0 10px 25px rgba(0,0,0,0.15));
    border-color: var(--color-primary);
  }

  .wk-card:active {
    transform: scale(0.98);
  }

  .wk-card-top {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .wk-score-badge {
    display: flex;
    align-items: baseline;
    gap: 1px;
    background: color-mix(in srgb, var(--score-color) 12%, transparent);
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-full);
    flex-shrink: 0;
  }

  .wk-score-val {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1;
    color: var(--score-color);
  }

  .wk-score-max {
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--score-color);
    opacity: 0.6;
  }

  .wk-card-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .wk-day {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text-secondary);
  }

  .wk-time {
    font-size: 0.75rem;
    color: var(--color-muted);
    padding: 1px 6px;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-full);
  }

  .wk-card-title {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.3;
    color: var(--color-text);
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .wk-card-summary {
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--color-text-secondary);
    margin: 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .wk-card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: auto;
  }

  .wk-card-location {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.8125rem;
    color: var(--color-muted);
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .wk-loc-icon {
    width: 14px;
    height: 14px;
    opacity: 0.5;
    flex-shrink: 0;
  }

  /* Category badge on carousel cards */
  .wk-cat-badge {
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: var(--radius-full);
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .wk-cat--kinder {
    background: color-mix(in srgb, var(--color-kinder) 12%, transparent);
    color: var(--color-kinder);
  }

  .wk-cat--familie {
    background: color-mix(in srgb, var(--color-familie) 12%, transparent);
    color: var(--color-familie);
  }

  .wk-cat--erwachsene {
    background: color-mix(in srgb, var(--color-erwachsene) 12%, transparent);
    color: var(--color-erwachsene);
  }

  /* Tablet: slightly larger cards */
  @media (min-width: 768px) and (max-width: 1199px) {
    .wk-card {
      flex: 0 0 300px;
    }
  }

  /* ===== WEEKEND HIGHLIGHTS (Right Sidebar - Vertical, Collapsible) ===== */
  .highlights-vertical {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* Collapsed cards: hidden by default on desktop */
  .wh-card.wh-card--collapsed {
    display: none;
  }

  .highlights-vertical.expanded .wh-card.wh-card--collapsed {
    display: flex;
  }

  /* "X weitere anzeigen" button */
  .wh-show-more {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    width: 100%;
    margin-top: var(--space-4);
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--duration-fast) ease;
    font-family: inherit;
  }

  .wh-show-more:hover {
    background: var(--color-border-light);
    color: var(--color-primary);
    border-color: var(--color-primary);
  }

  .wh-show-more-chevron {
    width: 16px;
    height: 16px;
    transition: transform var(--duration-fast) ease;
  }

  .wh-show-more.expanded .wh-show-more-chevron {
    transform: rotate(180deg);
  }

  /* Weekend Highlight Card (Vertical Layout) */
  .wh-card {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--color-card);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--duration-normal) ease;
    font-family: inherit;
    color: inherit;
    text-align: left;
  }

  .wh-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }

  .wh-card:active {
    transform: scale(0.99);
  }

  .wh-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 56px;
    height: 56px;
    background: color-mix(in srgb, var(--color-primary) 10%, transparent);
    border-radius: var(--radius-full);
    flex-shrink: 0;
  }

  .wh-score-num {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1;
    color: var(--color-primary);
  }

  .wh-score-label {
    font-size: 0.625rem;
    font-weight: 600;
    color: var(--color-muted);
  }

  .wh-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .wh-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .wh-date {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text-secondary);
  }

  /* Category badge on sidebar weekend cards */
  .wh-cat-badge {
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: var(--radius-full);
    white-space: nowrap;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .wh-cat--kinder {
    background: color-mix(in srgb, var(--color-kinder) 12%, transparent);
    color: var(--color-kinder);
  }

  .wh-cat--familie {
    background: color-mix(in srgb, var(--color-familie) 12%, transparent);
    color: var(--color-familie);
  }

  .wh-cat--erwachsene {
    background: color-mix(in srgb, var(--color-erwachsene) 12%, transparent);
    color: var(--color-erwachsene);
  }

  .wh-title {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.35;
    color: var(--color-text);
    /* NO line-clamp - full readability! */
  }

  .wh-summary {
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--color-text-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .wh-location {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.8125rem;
    color: var(--color-muted);
    margin-top: auto;
  }

  .wh-icon {
    width: 14px;
    height: 14px;
    opacity: 0.6;
  }

  /* ===== MOBILE: VOR ORT SECTION ===== */
  .section-info--mobile {
    display: block;
    padding-top: var(--space-8);
    margin-top: var(--space-8);
    border-top: 1px solid var(--color-border-light);
  }

  @media (min-width: 1200px) {
    .section-info--mobile {
      display: none;
    }
  }

  .section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .info-grid-single {
    display: grid;
    gap: var(--space-4);
  }

  @media (min-width: 640px) {
    .info-grid-single {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-5);
    }
  }

  /* ===== FOOTER ===== */
  .footer {
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border-light);
    background: var(--color-bg-secondary);
  }

  .footer-text {
    font-size: 0.8125rem;
    color: var(--color-muted);
    text-align: center;
  }

  .footer-links a {
    color: var(--color-muted);
    text-decoration: underline;
    text-decoration-color: transparent;
    transition: text-decoration-color var(--duration-fast) ease;
  }

  .footer-links a:hover {
    text-decoration-color: var(--color-muted);
  }
</style>

<style is:global>
  /* First day-group: no extra negative margin needed â€” headings aligned via sticky top values */

  /* ===== LOAD MORE BUTTON ===== */
  #load-more-btn {
    display: block;
    box-sizing: border-box;
    width: 100%;
    margin: var(--space-6) 0 0;
    padding: 16px 24px;
    background: var(--color-border-light);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg, 12px);
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    font-weight: 500;
    font-family: inherit;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  @media (min-width: 1200px) {
    #load-more-btn {
      display: none; /* Hide on desktop - all events visible */
    }
  }

  #load-more-btn:hover {
    background: var(--color-border);
    color: var(--color-primary);
  }

  #load-more-btn:active {
    transform: scale(0.99);
  }

  #load-more-count {
    opacity: 0.5;
    font-weight: 400;
  }
</style>

<script define:vars={{ artTags }}>
  // Make artTags available globally for modal
  (window as any).__artTagsData = artTags;
</script>

<script>
  // Weekend highlight card click â†’ open modal (both sidebar .wh-card and carousel .wk-card)
  function attachHighlightCardHandler(card: Element) {
    card.addEventListener('click', () => {
      const el = card as HTMLElement;
      const eventData = {
        id: el.dataset.eventId,
        title: el.dataset.eventTitle,
        date: el.dataset.date,
        time: el.dataset.eventTime,
        location: el.dataset.location,
        address: el.dataset.eventAddress,
        description: el.dataset.eventDescription,
        category: el.dataset.category,
        url: el.dataset.eventUrl,
        tags: el.dataset.artTags?.split(',').filter(Boolean) || [],
        // AI curation data
        aiSummary: el.dataset.aiSummary || '',
        aiBestFor: el.dataset.aiBestFor || '',
        aiScore: parseInt(el.dataset.aiScore || '0'),
        aiPrice: el.dataset.aiPrice || '',
        aiTips: el.dataset.aiTips || '',
        aiAgeRange: el.dataset.aiAgeRange || '',
        aiFamilyScore: parseInt(el.dataset.aiFamilyScore || '0'),
        aiKidsScore: parseInt(el.dataset.aiKidsScore || '0'),
        aiAdultsScore: parseInt(el.dataset.aiAdultsScore || '0'),
      };
      if (typeof (window as any).openEventModal === 'function') {
        (window as any).openEventModal(eventData);
      }
    });
  }
  document.querySelectorAll('.wh-card').forEach(attachHighlightCardHandler);
  document.querySelectorAll('.wk-card').forEach(attachHighlightCardHandler);

  // === Weekend cards: react to category filter ===
  // Observe the visible-count element for changes (triggered by FilterBar's filterEvents())
  // Then apply the same category filter to weekend cards
  function filterWeekendCards() {
    // Read active category from the desktop sidebar chips (source of truth)
    const activeChips = document.querySelectorAll('.filter-sidebar .chip.active[data-type="category"]');
    const activeCategories = new Set<string>();
    activeChips.forEach(chip => {
      const f = (chip as HTMLElement).dataset.filter;
      if (f) activeCategories.add(f);
    });

    const showAll = activeCategories.has('all') || activeCategories.size === 0;

    // Filter .wk-card (mobile carousel)
    document.querySelectorAll('.wk-card').forEach(card => {
      const el = card as HTMLElement;
      const cat = el.dataset.category || '';
      el.style.display = (showAll || activeCategories.has(cat)) ? '' : 'none';
    });

    // Filter .wh-card (desktop sidebar) â€” respect collapsed state
    const hlContainer = document.getElementById('highlights-vertical');
    const isExpanded = hlContainer?.classList.contains('expanded');
    let visibleIndex = 0;
    let hiddenByCollapse = 0;

    document.querySelectorAll('.wh-card').forEach(card => {
      const el = card as HTMLElement;
      const cat = el.dataset.category || '';
      const matchesCat = showAll || activeCategories.has(cat);

      if (!matchesCat) {
        el.style.display = 'none';
        return;
      }

      // Card matches filter â€” check collapse state
      if (!isExpanded && visibleIndex >= 3) {
        el.style.display = 'none';
        hiddenByCollapse++;
      } else {
        el.style.display = '';
      }
      visibleIndex++;
    });

    // Update "X weitere anzeigen" button count
    const smText = document.getElementById('wh-show-more-text');
    const smBtn = document.getElementById('wh-show-more');
    if (smBtn && smText) {
      if (!isExpanded && hiddenByCollapse > 0) {
        smBtn.style.display = '';
        smText.textContent = `${hiddenByCollapse} weitere anzeigen`;
      } else if (isExpanded) {
        smBtn.style.display = '';
        smText.textContent = 'Weniger anzeigen';
      } else {
        smBtn.style.display = 'none';
      }
    }

    // Hide entire weekend section if no cards visible
    const wkSection = document.querySelector('.wk-carousel-section');
    if (wkSection) {
      const anyVisible = [...document.querySelectorAll('.wk-card')].some(c => (c as HTMLElement).style.display !== 'none');
      (wkSection as HTMLElement).style.display = anyVisible ? '' : 'none';
    }
    const whGroup = document.querySelector('.context-widget-group');
    if (whGroup) {
      const anyVisible = [...document.querySelectorAll('.wh-card')].some(c => (c as HTMLElement).style.display !== 'none');
      (whGroup as HTMLElement).style.display = anyVisible ? '' : 'none';
    }
  }

  // Hook into filter changes by observing visible-count mutations
  const weekendFilterObserver = new MutationObserver(filterWeekendCards);
  const vcEl = document.getElementById('visible-count');
  if (vcEl) {
    weekendFilterObserver.observe(vcEl, { childList: true, characterData: true, subtree: true });
  }

  // === Desktop: Collapsible weekend highlights ===
  const showMoreBtn = document.getElementById('wh-show-more');
  const highlightsContainer = document.getElementById('highlights-vertical');
  const showMoreText = document.getElementById('wh-show-more-text');

  if (showMoreBtn && highlightsContainer) {
    showMoreBtn.addEventListener('click', () => {
      const isExpanded = highlightsContainer.classList.contains('expanded');
      highlightsContainer.classList.toggle('expanded', !isExpanded);
      showMoreBtn.classList.toggle('expanded', !isExpanded);
      // Re-run filter to update visibility + button text
      filterWeekendCards();
    });
  }

  // Load More functionality (mobile/tablet only)
  const BATCH_SIZE = 10;
  const loadMoreBtn = document.getElementById('load-more-btn') as HTMLButtonElement;
  const loadMoreCount = document.getElementById('load-more-count');
  let visibleLimit = 10;
  const isDesktop = () => window.innerWidth >= 1200;

  function applyLoadMoreLimit() {
    if (isDesktop()) {
      return; // Button already hidden via CSS on desktop
    }

    const cards = document.querySelectorAll('.event-card');
    let visibleCount = 0;
    let hiddenByLimit = 0;

    cards.forEach(card => {
      const el = card as HTMLElement;
      // Only count cards not hidden by filters
      const hiddenByFilter = el.style.display === 'none' && !el.hasAttribute('data-load-more-hidden');
      if (hiddenByFilter) return;

      visibleCount++;
      if (visibleCount > visibleLimit) {
        el.style.display = 'none';
        el.setAttribute('data-load-more-hidden', '');
        hiddenByLimit++;
      } else {
        // Only restore if it was hidden by load-more, not by filter
        if (el.hasAttribute('data-load-more-hidden')) {
          el.style.display = '';
          el.removeAttribute('data-load-more-hidden');
        }
      }
    });

    if (hiddenByLimit === 0) {
      loadMoreBtn.style.display = 'none';
    } else {
      loadMoreBtn.style.display = 'block';
      if (loadMoreCount) loadMoreCount.textContent = `Â· ${hiddenByLimit} mehr`;
    }

    // Hide day groups that have no visible event cards
    document.querySelectorAll('.day-group').forEach(group => {
      const cards = group.querySelectorAll('.event-card');
      const hasVisible = [...cards].some(c => {
        const el = c as HTMLElement;
        return el.style.display !== 'none';
      });
      (group as HTMLElement).style.display = hasVisible ? '' : 'none';
    });
  }

  loadMoreBtn?.addEventListener('click', () => {
    visibleLimit += BATCH_SIZE;
    // Remove all load-more-hidden attrs first
    document.querySelectorAll('[data-load-more-hidden]').forEach(el => {
      (el as HTMLElement).style.display = '';
      el.removeAttribute('data-load-more-hidden');
    });
    applyLoadMoreLimit();
  });

  // Re-apply after filters change â€” observe the visible-count text
  const countEl = document.getElementById('visible-count');
  if (countEl) {
    const observer = new MutationObserver(() => {
      document.querySelectorAll('[data-load-more-hidden]').forEach(el => {
        (el as HTMLElement).style.display = '';
        el.removeAttribute('data-load-more-hidden');
      });
      applyLoadMoreLimit();
    });
    observer.observe(countEl, { childList: true, characterData: true, subtree: true });
  }

  // Handle resize
  window.addEventListener('resize', () => {
    if (!isDesktop()) {
      applyLoadMoreLimit();
    }
  });

  // Initial apply
  if (!isDesktop()) {
    applyLoadMoreLimit();
  }
</script>
