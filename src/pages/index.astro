---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import InfoTicker from '../components/InfoTicker.astro';
import TrainInfo from '../components/TrainInfo.astro';
import MarketInfo from '../components/MarketInfo.astro';
import WebcamWidget from '../components/WebcamWidget.astro';
import FilterBar from '../components/FilterBar.astro';
import DayGroup from '../components/DayGroup.astro';
import EventModal from '../components/EventModal.astro';
import eventsData from '../data/events.json';

// Get regions from data or use defaults
const regions = eventsData.regions || {
  "poecking": { "name": "P√∂cking", "emoji": "üè†" },
  "starnberger-see": { "name": "Starnberger See", "emoji": "üèîÔ∏è" },
  "ammersee": { "name": "Ammersee", "emoji": "‚õµ" },
  "muenchen": { "name": "M√ºnchen", "emoji": "üèôÔ∏è" },
  "tegernsee": { "name": "Tegernsee", "emoji": "‚õ∞Ô∏è" },
  "werdenfels": { "name": "Werdenfelser Land", "emoji": "üéø" }
};

// Get artTags from data
const artTags = eventsData.artTags || {};

// Filter out past events and sort by date
const todayStr = new Date().toISOString().split('T')[0];
const events = eventsData.events
  .filter(e => e.date >= todayStr)
  .sort((a, b) => {
    const dateCompare = a.date.localeCompare(b.date);
    if (dateCompare !== 0) return dateCompare;
    if (!a.time) return 1;
    if (!b.time) return -1;
    return a.time.localeCompare(b.time);
  });

// Get unique sources
const sources = [...new Set(events.map(e => e.source).filter(Boolean))];

// === Group Events by Day ===
interface DayGroup {
  date: Date;
  events: typeof events;
}

const eventsByDay = events.reduce((acc, event) => {
  const dayKey = event.date; // YYYY-MM-DD
  if (!acc[dayKey]) {
    acc[dayKey] = {
      date: new Date(event.date),
      events: []
    };
  }
  acc[dayKey].events.push(event);
  return acc;
}, {} as Record<string, DayGroup>);

// Sort days chronologically
const sortedDays = Object.entries(eventsByDay)
  .sort(([a], [b]) => a.localeCompare(b));

// === Weekend Highlights - get events for next weekend (Sa+So) ===
const today = new Date();
const dayOfWeek = today.getDay();
// If today is Saturday, show this weekend; if Sunday, also show today
const daysUntilSaturday = dayOfWeek === 0 ? -1 : dayOfWeek === 6 ? 0 : (6 - dayOfWeek);

const nextSaturday = new Date(today);
nextSaturday.setDate(today.getDate() + daysUntilSaturday);
nextSaturday.setHours(0, 0, 0, 0);

const nextSunday = new Date(nextSaturday);
nextSunday.setDate(nextSaturday.getDate() + 1);

// Get ALL weekend events
const allWeekendEvents = events.filter(event => {
  const eventDate = new Date(event.date);
  eventDate.setHours(0, 0, 0, 0);
  return eventDate.getTime() === nextSaturday.getTime() || eventDate.getTime() === nextSunday.getTime();
});

// AI-curated: sort by overall score (highest first), then by date/time
const weekendEvents = allWeekendEvents
  .sort((a, b) => {
    const scoreA = a.aiCuration?.scores?.overall ?? 0;
    const scoreB = b.aiCuration?.scores?.overall ?? 0;
    if (scoreB !== scoreA) return scoreB - scoreA;
    const dateCompare = a.date.localeCompare(b.date);
    if (dateCompare !== 0) return dateCompare;
    return (a.time || '99:99').localeCompare(b.time || '99:99');
  })
  .slice(0, 6); // Top 6 by AI score

const hasWeekendEvents = weekendEvents.length > 0;
const hasCuration = weekendEvents.some(e => e.aiCuration);
const weekendTitle = dayOfWeek === 6 ? "Dieses Wochenende" : dayOfWeek === 0 ? "Heute" : "Dieses Wochenende";

---

<Layout title="Starnberg Events ‚Äî Was ist los in und um P√∂cking?">
  <Header lastUpdated={eventsData.lastUpdated} />
  
  <!-- Mobile: Sticky Ticker -->
  <div class="mobile-info-bar">
    <InfoTicker />
  </div>

  <main class="main" id="main-content">
    <div class="container">
      <!-- Content Grid: 3 Columns -->
      <div class="content-grid">
        
        <!-- LEFT COLUMN: Filters -->
        <div class="column-left">
          <h3 class="section-heading">Filter</h3>
          <FilterBar events={events} regions={regions} artTags={artTags} />
        </div>

        <!-- CENTER COLUMN: Event List -->
        <div class="column-center">
          <!-- Hidden count for filter JS -->
          <span id="visible-count" style="display:none">{events.length}</span>

          <!-- Day Groups -->
          <div class="events-list" id="events-list">
            {sortedDays.map(([dayKey, dayData]) => (
              <DayGroup date={dayData.date} events={dayData.events} regions={regions} artTagsData={artTags} />
            ))}
          </div>

          <!-- Load More Button (Mobile only) -->
          <button class="load-more-btn" id="load-more-btn">
            Weitere Events <span class="load-more-count" id="load-more-count"></span>
          </button>

          <!-- Mobile: Vor Ort -->
          <section class="section section-info section-info--mobile">
            <h2 class="section-title">Vor Ort</h2>
            <div class="info-grid-single">
              <MarketInfo />
              <WebcamWidget />
            </div>
          </section>
        </div>

        <!-- RIGHT COLUMN: Context (Desktop only) -->
        <aside class="column-right">
          <!-- S-Bahn Info -->
          <h3 class="section-heading">S-Bahn aktuell</h3>
          <div class="context-widget">
            <TrainInfo station="Possenhofen" stationCode="MPH" />
          </div>

          <!-- Weekend Highlights (Vertical) -->
          {hasWeekendEvents && (
            <div class="context-widget-group">
              <h3 class="section-heading">{weekendTitle}</h3>
              <div class="highlights-vertical">
                {weekendEvents.map(event => {
                  const evDate = new Date(event.date);
                  const evDay = evDate.getDate();
                  const evMonth = evDate.getMonth() + 1;
                  const evWeekday = evDate.toLocaleDateString('de-DE', { weekday: 'short' });
                  const curation = event.aiCuration;
                  const score = curation?.scores?.overall ?? 0;
                  const bestFor = curation?.bestFor;
                  const bestForEmoji = bestFor === 'familie' ? 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' : bestFor === 'kinder' ? 'üßí' : bestFor === 'erwachsene' ? 'üë´' : bestFor === 'alle' ? 'üåü' : '';
                  const bestForLabel = bestFor === 'familie' ? 'Familie' : bestFor === 'kinder' ? 'Kinder' : bestFor === 'erwachsene' ? 'Erwachsene' : bestFor === 'alle' ? 'Alle' : '';
                  return (
                    <button 
                      class="wh-card" 
                      data-event-id={event.id}
                      data-event-title={event.title}
                      data-date={event.date}
                      data-event-time={event.time}
                      data-location={event.location}
                      data-event-address={event.address}
                      data-event-description={event.description}
                      data-event-url={event.url}
                      data-category={event.category}
                      data-art-tags={event.artTags?.join(',')}
                      data-ai-summary={curation?.aiSummary}
                      data-ai-best-for={bestFor}
                      data-ai-score={score}
                      data-ai-price={curation?.priceInfo}
                      data-ai-tips={curation?.tips}
                      data-ai-age-range={curation?.ageRange}
                      data-ai-family-score={curation?.scores?.family}
                      data-ai-kids-score={curation?.scores?.kids}
                      data-ai-adults-score={curation?.scores?.adults}
                    >
                      {curation && (
                        <div class="wh-score">
                          <span class="wh-score-num">{score}</span>
                          <span class="wh-score-label">/10</span>
                        </div>
                      )}
                      <div class="wh-content">
                        <div class="wh-meta">
                          <span class="wh-date">{evWeekday} {evDay}.{evMonth}.</span>
                          {bestFor && <span class={`wh-badge wh-badge--${bestFor}`}>{bestForEmoji} {bestForLabel}</span>}
                        </div>
                        <h4 class="wh-title">{event.title}</h4>
                        {curation?.aiSummary && (
                          <p class="wh-summary">{curation.aiSummary.length > 90 ? curation.aiSummary.slice(0, 90) + '‚Ä¶' : curation.aiSummary}</p>
                        )}
                        <div class="wh-location">
                          <svg class="wh-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                          </svg>
                          {event.location}
                        </div>
                      </div>
                    </button>
                  );
                })}
              </div>
            </div>
          )}

          <!-- Vor Ort Widgets -->
          <h3 class="section-heading">Vor Ort</h3>
          <div class="context-widget">
            <div class="vor-ort-stack">
              <MarketInfo />
              <WebcamWidget />
            </div>
          </div>
        </aside>

      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="footer-text">
        {events.length} Events aus {sources.length} Quellen ¬∑
        <span class="footer-links">
          <a href="https://www.beccult.de" target="_blank" rel="noopener">beccult</a>,
          <a href="https://www.starnbergammersee.de" target="_blank" rel="noopener">starnbergammersee.de</a>,
          <a href="https://www.muenchen.de" target="_blank" rel="noopener">muenchen.de</a>
        </span>
      </p>
    </div>
  </footer>

  <!-- Event Modal -->
  <EventModal />
</Layout>

<style>
  .main {
    position: relative;
    z-index: 1; /* Keep all scrolling content below fixed header (z:95) & navbar (z:100) */
    padding-bottom: var(--space-16);
  }

  @media (min-width: 768px) {
    .main {
      padding-top: 377px; /* Space for fixed header */
    }
  }

  /* ===== CONTENT GRID ===== */
  .content-grid {
    display: block;
  }

  /* Mobile: Single column (< 768px) */
  @media (max-width: 767px) {
    .column-left {
      display: contents; /* Remove box but keep children ‚Äî mobile filter bar (position:fixed) needs to render */
    }
    .column-left > .section-heading {
      display: none; /* Hide "Filter" heading on mobile */
    }
    .column-right {
      display: none;
    }
  }

  /* Tablet: 2 columns (768px - 1199px) */
  @media (min-width: 768px) and (max-width: 1199px) {
    .content-grid {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: var(--space-8);
      align-items: start;
    }
    
    .column-right {
      display: none; /* Hide right column on tablet */
    }
  }

  /* Desktop: 3 columns (‚â• 1200px) */
  @media (min-width: 1200px) {
    .content-grid {
      display: grid;
      grid-template-columns: 340px 1fr 340px;
      gap: var(--space-8); /* 2rem = 32px */
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
    }
  }

  /* ===== LEFT COLUMN (Filter Sidebar) ===== */
  .column-left {
    position: sticky;
    top: 377px;
    max-height: calc(100vh - 377px - 32px);
    overflow-y: auto;
    align-self: start;
  }

  /* ===== CENTER COLUMN (Event List) ===== */
  .column-center {
    min-width: 0; /* Prevent grid blowout */
  }

  /* ===== RIGHT COLUMN (Context Sidebar) ===== */
  .column-right {
    display: none;
  }

  @media (min-width: 1200px) {
    .column-right {
      display: block;
      position: sticky;
      top: 377px;
      max-height: calc(100vh - 377px - 32px);
      overflow-y: auto;
      align-self: start;
    }
  }

  .context-widget {
    margin-bottom: var(--space-8);
  }

  .context-widget:last-child {
    margin-bottom: 0;
  }

  .context-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .vor-ort-stack {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* ===== Mobile Info Bar ===== */
  .mobile-info-bar {
    display: block;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  @media (min-width: 768px) {
    .mobile-info-bar {
      display: none;
    }
  }

  /* ===== EVENTS LIST ===== */
  .events-list {
    /* No max-height or overflow on mobile/tablet - normal flow */
  }

  /* ===== WEEKEND HIGHLIGHTS (Right Sidebar - Vertical) ===== */
  .highlights-vertical {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  /* Weekend Highlight Card (Vertical Layout) */
  .wh-card {
    display: flex;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--color-card);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--duration-normal) ease;
    font-family: inherit;
    color: inherit;
    text-align: left;
  }

  .wh-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }

  .wh-card:active {
    transform: scale(0.99);
  }

  .wh-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 56px;
    height: 56px;
    background: color-mix(in srgb, var(--color-primary) 10%, transparent);
    border-radius: var(--radius-full);
    flex-shrink: 0;
  }

  .wh-score-num {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 1.25rem;
    font-weight: 700;
    line-height: 1;
    color: var(--color-primary);
  }

  .wh-score-label {
    font-size: 0.625rem;
    font-weight: 600;
    color: var(--color-muted);
  }

  .wh-content {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .wh-meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .wh-date {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text-secondary);
  }

  .wh-badge {
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: var(--radius-full);
    white-space: nowrap;
  }

  .wh-badge--familie {
    background: color-mix(in srgb, #10b981 12%, transparent);
    color: #059669;
  }

  .wh-badge--kinder {
    background: color-mix(in srgb, #f59e0b 12%, transparent);
    color: #d97706;
  }

  .wh-badge--erwachsene {
    background: color-mix(in srgb, #6366f1 12%, transparent);
    color: #4f46e5;
  }

  .wh-badge--alle {
    background: color-mix(in srgb, var(--color-primary) 12%, transparent);
    color: var(--color-primary);
  }

  .wh-title {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.35;
    color: var(--color-text);
    /* NO line-clamp - full readability! */
  }

  .wh-summary {
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--color-text-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .wh-location {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.8125rem;
    color: var(--color-muted);
    margin-top: auto;
  }

  .wh-icon {
    width: 14px;
    height: 14px;
    opacity: 0.6;
  }

  /* ===== MOBILE: VOR ORT SECTION ===== */
  .section-info--mobile {
    display: block;
    padding-top: var(--space-8);
    margin-top: var(--space-8);
    border-top: 1px solid var(--color-border-light);
  }

  @media (min-width: 1200px) {
    .section-info--mobile {
      display: none;
    }
  }

  .section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .info-grid-single {
    display: grid;
    gap: var(--space-4);
  }

  @media (min-width: 640px) {
    .info-grid-single {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-5);
    }
  }

  /* ===== FOOTER ===== */
  .footer {
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border-light);
    background: var(--color-bg-secondary);
  }

  .footer-text {
    font-size: 0.8125rem;
    color: var(--color-muted);
    text-align: center;
  }

  .footer-links a {
    color: var(--color-muted);
    text-decoration: underline;
    text-decoration-color: transparent;
    transition: text-decoration-color var(--duration-fast) ease;
  }

  .footer-links a:hover {
    text-decoration-color: var(--color-muted);
  }
</style>

<style is:global>
  /* ===== ALIGNMENT FIX: First day-group heading should align with sidebar headings ===== */
  @media (min-width: 768px) {
    #events-list > .day-group:first-child > .section-heading {
      padding-top: 0 !important;
    }
  }

  /* ===== LOAD MORE BUTTON ===== */
  #load-more-btn {
    display: block;
    box-sizing: border-box;
    width: 100%;
    margin: var(--space-6) 0 0;
    padding: 16px 24px;
    background: var(--color-border-light);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg, 12px);
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    font-weight: 500;
    font-family: inherit;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  @media (min-width: 1200px) {
    #load-more-btn {
      display: none; /* Hide on desktop - all events visible */
    }
  }

  #load-more-btn:hover {
    background: var(--color-border);
    color: var(--color-primary);
  }

  #load-more-btn:active {
    transform: scale(0.99);
  }

  #load-more-count {
    opacity: 0.5;
    font-weight: 400;
  }
</style>

<script define:vars={{ artTags }}>
  // Make artTags available globally for modal
  (window as any).__artTagsData = artTags;
</script>

<script>
  // Weekend highlight card click ‚Üí open modal
  document.querySelectorAll('.wh-card').forEach(card => {
    card.addEventListener('click', () => {
      const el = card as HTMLElement;
      const eventData = {
        id: el.dataset.eventId,
        title: el.dataset.eventTitle,
        date: el.dataset.date,
        time: el.dataset.eventTime,
        location: el.dataset.location,
        address: el.dataset.eventAddress,
        description: el.dataset.eventDescription,
        category: el.dataset.category,
        url: el.dataset.eventUrl,
        tags: el.dataset.artTags?.split(',').filter(Boolean) || [],
        // AI curation data
        aiSummary: el.dataset.aiSummary || '',
        aiBestFor: el.dataset.aiBestFor || '',
        aiScore: parseInt(el.dataset.aiScore || '0'),
        aiPrice: el.dataset.aiPrice || '',
        aiTips: el.dataset.aiTips || '',
        aiAgeRange: el.dataset.aiAgeRange || '',
        aiFamilyScore: parseInt(el.dataset.aiFamilyScore || '0'),
        aiKidsScore: parseInt(el.dataset.aiKidsScore || '0'),
        aiAdultsScore: parseInt(el.dataset.aiAdultsScore || '0'),
      };
      if (typeof (window as any).openEventModal === 'function') {
        (window as any).openEventModal(eventData);
      }
    });
  });

  // Load More functionality (mobile/tablet only)
  const BATCH_SIZE = 10;
  const loadMoreBtn = document.getElementById('load-more-btn') as HTMLButtonElement;
  const loadMoreCount = document.getElementById('load-more-count');
  let visibleLimit = 10;
  const isDesktop = () => window.innerWidth >= 1200;

  function applyLoadMoreLimit() {
    if (isDesktop()) {
      return; // Button already hidden via CSS on desktop
    }

    const cards = document.querySelectorAll('.event-card');
    let visibleCount = 0;
    let hiddenByLimit = 0;

    cards.forEach(card => {
      const el = card as HTMLElement;
      // Only count cards not hidden by filters
      const hiddenByFilter = el.style.display === 'none' && !el.hasAttribute('data-load-more-hidden');
      if (hiddenByFilter) return;

      visibleCount++;
      if (visibleCount > visibleLimit) {
        el.style.display = 'none';
        el.setAttribute('data-load-more-hidden', '');
        hiddenByLimit++;
      } else {
        // Only restore if it was hidden by load-more, not by filter
        if (el.hasAttribute('data-load-more-hidden')) {
          el.style.display = '';
          el.removeAttribute('data-load-more-hidden');
        }
      }
    });

    if (hiddenByLimit === 0) {
      loadMoreBtn.style.display = 'none';
    } else {
      loadMoreBtn.style.display = 'block';
      if (loadMoreCount) loadMoreCount.textContent = `¬∑ ${hiddenByLimit} mehr`;
    }

    // Hide day groups that have no visible event cards
    document.querySelectorAll('.day-group').forEach(group => {
      const cards = group.querySelectorAll('.event-card');
      const hasVisible = [...cards].some(c => {
        const el = c as HTMLElement;
        return el.style.display !== 'none';
      });
      (group as HTMLElement).style.display = hasVisible ? '' : 'none';
    });
  }

  loadMoreBtn?.addEventListener('click', () => {
    visibleLimit += BATCH_SIZE;
    // Remove all load-more-hidden attrs first
    document.querySelectorAll('[data-load-more-hidden]').forEach(el => {
      (el as HTMLElement).style.display = '';
      el.removeAttribute('data-load-more-hidden');
    });
    applyLoadMoreLimit();
  });

  // Re-apply after filters change ‚Äî observe the visible-count text
  const countEl = document.getElementById('visible-count');
  if (countEl) {
    const observer = new MutationObserver(() => {
      document.querySelectorAll('[data-load-more-hidden]').forEach(el => {
        (el as HTMLElement).style.display = '';
        el.removeAttribute('data-load-more-hidden');
      });
      applyLoadMoreLimit();
    });
    observer.observe(countEl, { childList: true, characterData: true, subtree: true });
  }

  // Handle resize
  window.addEventListener('resize', () => {
    if (!isDesktop()) {
      applyLoadMoreLimit();
    }
  });

  // Initial apply
  if (!isDesktop()) {
    applyLoadMoreLimit();
  }
</script>
