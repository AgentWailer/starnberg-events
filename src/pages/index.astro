---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import TrainInfo from '../components/TrainInfo.astro';
import FilterBar from '../components/FilterBar.astro';
import EventCard from '../components/EventCard.astro';
import eventsData from '../data/events.json';

// Get regions from data or use defaults
const regions = eventsData.regions || {
  "poecking": { "name": "P√∂cking", "emoji": "üè†" },
  "starnberg-ammersee": { "name": "Starnberg-Ammersee", "emoji": "üèîÔ∏è" },
  "muenchen": { "name": "M√ºnchen", "emoji": "üèôÔ∏è" },
  "tegernsee": { "name": "Tegernsee", "emoji": "‚õ∞Ô∏è" },
  "werdenfels": { "name": "Werdenfelser Land", "emoji": "üéø" }
};

// Sort events by date
const events = eventsData.events.sort((a, b) => {
  const dateCompare = a.date.localeCompare(b.date);
  if (dateCompare !== 0) return dateCompare;
  if (!a.time) return 1;
  if (!b.time) return -1;
  return a.time.localeCompare(b.time);
});

// Get unique sources
const sources = [...new Set(events.map(e => e.source).filter(Boolean))];
---

<Layout title="Events Oberbayern - Veranstaltungen f√ºr Familien">
  <Header lastUpdated={eventsData.lastUpdated} />
  
  <main class="main">
    <div class="container">
      <!-- Train Info Widget (above layout on desktop) -->
      <section class="section-train">
        <TrainInfo station="Possenhofen" stationCode="MPH" />
      </section>
      
      <!-- Filter Component (handles mobile FAB + bottom sheet + desktop sidebar) -->
      <FilterBar events={events} regions={regions} />
      
      <!-- Main Content Area -->
      <div class="main-content">
        <div class="events-list">
          {events.map(event => (
            <EventCard event={event} regions={regions} />
          ))}
        </div>
      </div>
      
      <!-- Footer -->
      <footer class="footer">
        <div class="footer-content">
          <p class="footer-stats">
            <strong>{events.length}</strong> Events aus <strong>{sources.length}</strong> Quellen
          </p>
          <div class="footer-sources">
            Daten von
            <a href="https://www.beccult.de" target="_blank">beccult</a>,
            <a href="https://www.starnbergammersee.de" target="_blank">starnbergammersee.de</a>,
            <a href="https://www.muenchen.de" target="_blank">muenchen.de</a>,
            <a href="https://www.olympiapark.de" target="_blank">olympiapark.de</a>
            & mehr
          </div>
          <p class="footer-credit">Made with ‚ù§Ô∏è f√ºr Oberbayern</p>
        </div>
      </footer>
    </div>
  </main>
</Layout>

<style>
  .main {
    padding-top: 20px;
    padding-bottom: 40px;
  }

  .section-train {
    margin-bottom: 16px;
  }

  /* Desktop: sidebar + content layout */
  @media (min-width: 1024px) {
    .container {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      grid-template-rows: auto auto 1fr auto;
    }
    
    .section-train {
      grid-column: 1 / -1;
    }
    
    /* FilterBar's .desktop-only sidebar */
    .container > :global(.filter-container) {
      position: sticky;
      top: 20px;
      align-self: start;
    }
    
    .main-content {
      grid-column: 2;
      grid-row: 2 / 4;
    }
    
    .footer {
      grid-column: 1 / -1;
    }
  }

  .events-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  @media (min-width: 640px) {
    .events-list {
      gap: 16px;
    }
  }

  .footer {
    margin-top: 48px;
    padding-top: 24px;
    border-top: 1px solid var(--color-border);
    text-align: center;
  }

  .footer-content {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .footer-stats {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
  }

  .footer-stats strong {
    color: var(--color-primary);
  }

  .footer-sources {
    font-size: 0.75rem;
    color: var(--color-muted);
  }

  .footer-sources a {
    color: var(--color-muted);
    margin: 0 2px;
  }

  .footer-sources a:hover {
    color: var(--color-primary);
  }

  .footer-credit {
    font-size: 0.8rem;
    color: var(--color-muted);
    margin-top: 8px;
  }
</style>
