---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import InfoTicker from '../components/InfoTicker.astro';
// WeatherWidget moved to navbar
import TrainInfo from '../components/TrainInfo.astro';
import MarketInfo from '../components/MarketInfo.astro';
import WebcamWidget from '../components/WebcamWidget.astro';
import FilterBar from '../components/FilterBar.astro';
import EventCard from '../components/EventCard.astro';
import EventModal from '../components/EventModal.astro';
import eventsData from '../data/events.json';

// Get regions from data or use defaults
const regions = eventsData.regions || {
  "poecking": { "name": "P√∂cking", "emoji": "üè†" },
  "starnberger-see": { "name": "Starnberger See", "emoji": "üèîÔ∏è" },
  "ammersee": { "name": "Ammersee", "emoji": "‚õµ" },
  "muenchen": { "name": "M√ºnchen", "emoji": "üèôÔ∏è" },
  "tegernsee": { "name": "Tegernsee", "emoji": "‚õ∞Ô∏è" },
  "werdenfels": { "name": "Werdenfelser Land", "emoji": "üéø" }
};

// Get artTags from data
const artTags = eventsData.artTags || {};

// Filter out past events and sort by date
const todayStr = new Date().toISOString().split('T')[0];
const events = eventsData.events
  .filter(e => e.date >= todayStr)
  .sort((a, b) => {
    const dateCompare = a.date.localeCompare(b.date);
    if (dateCompare !== 0) return dateCompare;
    if (!a.time) return 1;
    if (!b.time) return -1;
    return a.time.localeCompare(b.time);
  });

// Get unique sources
const sources = [...new Set(events.map(e => e.source).filter(Boolean))];

// Weekend Highlights - get events for next weekend (Sa+So)
const today = new Date();
const dayOfWeek = today.getDay();
// If today is Saturday, show this weekend; if Sunday, also show today
const daysUntilSaturday = dayOfWeek === 0 ? -1 : dayOfWeek === 6 ? 0 : (6 - dayOfWeek);

const nextSaturday = new Date(today);
nextSaturday.setDate(today.getDate() + daysUntilSaturday);
nextSaturday.setHours(0, 0, 0, 0);

const nextSunday = new Date(nextSaturday);
nextSunday.setDate(nextSaturday.getDate() + 1);

// Get ALL weekend events
const allWeekendEvents = events.filter(event => {
  const eventDate = new Date(event.date);
  eventDate.setHours(0, 0, 0, 0);
  return eventDate.getTime() === nextSaturday.getTime() || eventDate.getTime() === nextSunday.getTime();
});

// AI-curated: sort by overall score (highest first), then by date/time
const weekendEvents = allWeekendEvents
  .sort((a, b) => {
    const scoreA = a.aiCuration?.scores?.overall ?? 0;
    const scoreB = b.aiCuration?.scores?.overall ?? 0;
    if (scoreB !== scoreA) return scoreB - scoreA;
    const dateCompare = a.date.localeCompare(b.date);
    if (dateCompare !== 0) return dateCompare;
    return (a.time || '99:99').localeCompare(b.time || '99:99');
  })
  .slice(0, 6); // Top 6 by AI score

const hasWeekendEvents = weekendEvents.length > 0;
const hasCuration = weekendEvents.some(e => e.aiCuration);
const weekendTitle = dayOfWeek === 6 ? "Dieses Wochenende" : dayOfWeek === 0 ? "Heute" : "Dieses Wochenende";

---

<Layout title="Starnberg Events ‚Äî Was ist los in und um P√∂cking?">
  <Header lastUpdated={eventsData.lastUpdated} />
  
  <!-- Mobile: Sticky Ticker -->
  <div class="mobile-info-bar">
    <InfoTicker />
  </div>

  <main class="main" id="main-content">
    <div class="container">
      <!-- Content Grid: Sidebar + Main Content -->
      <div class="content-grid">
        <!-- Desktop Sidebar -->
        <FilterBar events={events} regions={regions} artTags={artTags} />

        <!-- Main Content Column -->
        <div class="main-content">
          <!-- Desktop: Quick Transport Info -->
          <section class="section section-transport desktop-only">
            <TrainInfo station="Possenhofen" stationCode="MPH" />
          </section>

          <!-- Weekend Highlights ‚Äì AI-curated top picks -->
          {hasWeekendEvents && (
            <section class="section-highlights">
              <div class="highlights-header">
                <h2 class="highlights-title">{weekendTitle}</h2>
                <div class="highlights-meta">
                  {hasCuration && <span class="highlights-ai-badge" title="KI-kuratierte Auswahl der besten Events">‚ú® KI-Empfehlungen</span>}
                  <span class="highlights-count">{allWeekendEvents.length} Events ¬∑ Top {weekendEvents.length}</span>
                </div>
              </div>
              <div class="highlights-scroll">
                {weekendEvents.map(event => {
                  const evDate = new Date(event.date);
                  const evDay = evDate.getDate();
                  const evMonth = evDate.getMonth() + 1;
                  const evWeekday = evDate.toLocaleDateString('de-DE', { weekday: 'short' });
                  const curation = event.aiCuration;
                  const score = curation?.scores?.overall ?? 0;
                  const bestFor = curation?.bestFor;
                  const bestForEmoji = bestFor === 'familie' ? 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' : bestFor === 'kinder' ? 'üßí' : bestFor === 'erwachsene' ? 'üë´' : bestFor === 'alle' ? 'üåü' : '';
                  const bestForLabel = bestFor === 'familie' ? 'Familien' : bestFor === 'kinder' ? 'Kinder' : bestFor === 'erwachsene' ? 'Erwachsene' : bestFor === 'alle' ? 'Alle' : '';
                  return (
                    <button 
                      class="highlight-card" 
                      data-event-id={event.id}
                      data-event-title={event.title}
                      data-date={event.date}
                      data-event-time={event.time}
                      data-location={event.location}
                      data-event-address={event.address}
                      data-event-description={event.description}
                      data-event-url={event.url}
                      data-category={event.category}
                      data-art-tags={event.artTags?.join(',')}
                      data-ai-summary={curation?.aiSummary}
                      data-ai-best-for={bestFor}
                      data-ai-score={score}
                      data-ai-price={curation?.priceInfo}
                      data-ai-tips={curation?.tips}
                      data-ai-age-range={curation?.ageRange}
                      data-ai-family-score={curation?.scores?.family}
                      data-ai-kids-score={curation?.scores?.kids}
                      data-ai-adults-score={curation?.scores?.adults}
                    >
                      {curation && (
                        <div class="highlight-card__score">
                          <span class="highlight-card__score-num">{score}</span>
                          <span class="highlight-card__score-label">/10</span>
                        </div>
                      )}
                      <div class="highlight-card__content">
                        <div class="highlight-card__meta">
                          <span class="highlight-card__date-inline">{evWeekday} {evDay}.{evMonth}.</span>
                          {event.time && <span class="highlight-card__time">{event.time} Uhr</span>}
                          {bestFor && <span class={`highlight-card__badge highlight-card__badge--${bestFor}`}>{bestForEmoji} {bestForLabel}</span>}
                        </div>
                        <span class="highlight-card__title">{event.title}</span>
                        {curation?.aiSummary && (
                          <span class="highlight-card__ai-summary">{curation.aiSummary.length > 120 ? curation.aiSummary.slice(0, 120) + '‚Ä¶' : curation.aiSummary}</span>
                        )}
                        <span class="highlight-card__location">
                          <svg class="highlight-card__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                          </svg>
                          {event.location}
                        </span>
                      </div>
                    </button>
                  );
                })}
              </div>
            </section>
          )}

          <!-- Events List -->
          <section class="section-events">
            <div class="events-header">
              <div class="events-header-top">
                <h2 class="events-title">Kommende Events</h2>
                <p class="events-count"><span id="visible-count">{events.length}</span> Veranstaltungen</p>
              </div>
              <div class="events-search-bar" id="desktop-search-bar">
                <div class="search-wrapper">
                  <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                  </svg>
                  <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="Event, Ort oder Stichwort..."
                    autocomplete="off"
                  />
                  <button class="search-clear" id="search-clear" aria-label="Suche l√∂schen" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            
            <div class="events-list" id="events-list">
              {events.map(event => (
                <EventCard event={event} regions={regions} artTagsData={artTags} />
              ))}
            </div>

            <button class="load-more-btn" id="load-more-btn">
              Weitere Events <span class="load-more-count" id="load-more-count"></span>
            </button>
          </section>

          <!-- Mobile: Vor Ort (after events, reachable thanks to load-more) -->
          <section class="section section-info section-info--mobile">
            <h2 class="section-title">Vor Ort</h2>
            <div class="info-grid-single">
              <MarketInfo />
              <WebcamWidget />
            </div>
          </section>
        </div>
      </div>

      <!-- Desktop: Vor Ort (after events) -->
      <section class="section section-info section-info--desktop">
        <h2 class="section-title">Vor Ort</h2>
        <div class="info-grid-single">
          <MarketInfo />
          <WebcamWidget />
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="footer-text">
        {events.length} Events aus {sources.length} Quellen ¬∑
        <span class="footer-links">
          <a href="https://www.beccult.de" target="_blank" rel="noopener">beccult</a>,
          <a href="https://www.starnbergammersee.de" target="_blank" rel="noopener">starnbergammersee.de</a>,
          <a href="https://www.muenchen.de" target="_blank" rel="noopener">muenchen.de</a>
        </span>
      </p>
    </div>
  </footer>

  <!-- Event Modal -->
  <EventModal />
</Layout>

<style>
  .main {
    padding-bottom: var(--space-16);
  }

  @media (min-width: 768px) {
    .main {
      padding-top: 357px; /* Space for fixed header + equal gap as between sections */
    }
  }

  /* Content Grid: Sidebar + Main Content */
  .content-grid {
    display: block;
  }

  @media (min-width: 1200px) {
    .content-grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: var(--space-6);
      align-items: start;
    }
  }

  .main-content {
    min-width: 0; /* Prevent grid blowout */
  }

  .section {
    margin-bottom: var(--space-10);
  }

  @media (min-width: 640px) {
    .section {
      margin-bottom: var(--space-12);
    }
  }

  /* Mobile Info Bar - sticky at top */
  .mobile-info-bar {
    display: block;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  @media (min-width: 768px) {
    .mobile-info-bar {
      display: none;
    }
  }

  /* Desktop only elements */
  .desktop-only {
    display: none;
  }

  @media (min-width: 768px) {
    .desktop-only {
      display: block;
    }
  }

  /* Weather */
  .section-weather {
    margin-top: calc(-1 * var(--space-6));
    position: relative;
    z-index: 10;
  }

  @media (min-width: 768px) {
    .section-weather {
      margin-top: calc(-1 * var(--space-8));
    }
  }

  /* Transport */
  .section-transport {
    margin-bottom: var(--space-8);
  }

  /* Weekend Highlights ‚Äî matches design system */
  .section-highlights {
    margin-bottom: var(--space-10);
  }

  @media (min-width: 640px) {
    .section-highlights {
      margin-bottom: var(--space-12);
    }
  }

  .highlights-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    margin-bottom: var(--space-5);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border-light);
  }

  .highlights-title {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .highlights-meta {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .highlights-count {
    font-size: 0.875rem;
    color: var(--color-muted);
  }

  .highlights-ai-badge {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-primary);
    background: color-mix(in srgb, var(--color-primary) 10%, transparent);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    white-space: nowrap;
  }

  .highlights-scroll {
    display: flex;
    gap: var(--space-4);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: var(--space-2);
  }

  .highlights-scroll::-webkit-scrollbar {
    height: 4px;
  }
  .highlights-scroll::-webkit-scrollbar-track {
    background: transparent;
  }
  .highlights-scroll::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 2px;
  }

  /* Highlight card ‚Äî AI-curated design */
  .highlight-card {
    flex: 0 0 300px;
    display: flex;
    align-items: start;
    gap: var(--space-3);
    background: var(--color-card);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-lg);
    overflow: hidden;
    text-align: left;
    cursor: pointer;
    scroll-snap-align: start;
    padding: var(--space-4);
    font-family: inherit;
    color: inherit;
    box-shadow: var(--shadow-sm);
    transition: 
      transform var(--duration-normal) ease,
      box-shadow var(--duration-normal) ease;
  }

  @media (hover: hover) {
    .highlight-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .highlight-card:hover .highlight-card__title {
      color: var(--color-primary);
    }
  }

  .highlight-card:active {
    transform: scale(0.99);
  }

  /* Score circle */
  .highlight-card__score {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    height: 44px;
    background: color-mix(in srgb, var(--color-primary) 10%, transparent);
    border-radius: var(--radius-full);
    flex-shrink: 0;
  }

  .highlight-card__score-num {
    font-family: 'Space Grotesk', system-ui, sans-serif;
    font-size: 1.125rem;
    font-weight: 700;
    line-height: 1;
    color: var(--color-primary);
  }

  .highlight-card__score-label {
    font-size: 0.55rem;
    font-weight: 500;
    color: var(--color-muted);
    margin-top: 1px;
  }

  .highlight-card__content {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
    min-width: 0;
    flex: 1;
  }

  .highlight-card__meta {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .highlight-card__date-inline {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-text-secondary);
  }

  .highlight-card__time {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-muted);
  }

  .highlight-card__badge {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: var(--radius-full);
    white-space: nowrap;
  }

  .highlight-card__badge--familie {
    background: color-mix(in srgb, #10b981 12%, transparent);
    color: #059669;
  }

  .highlight-card__badge--kinder {
    background: color-mix(in srgb, #f59e0b 12%, transparent);
    color: #d97706;
  }

  .highlight-card__badge--erwachsene {
    background: color-mix(in srgb, #6366f1 12%, transparent);
    color: #4f46e5;
  }

  .highlight-card__badge--alle {
    background: color-mix(in srgb, var(--color-primary) 12%, transparent);
    color: var(--color-primary);
  }

  .highlight-card__title {
    font-size: 0.9375rem;
    font-weight: 600;
    line-height: 1.35;
    color: var(--color-text);
    transition: color var(--duration-fast) ease;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .highlight-card__ai-summary {
    font-size: 0.8125rem;
    line-height: 1.4;
    color: var(--color-text-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-top: 2px;
  }

  .highlight-card__location {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: 0.8125rem;
    color: var(--color-muted);
    margin-top: 2px;
  }

  .highlight-card__icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
    opacity: 0.6;
  }

  /* Desktop: wrapping grid */
  @media (min-width: 1200px) {
    .highlights-scroll {
      flex-wrap: wrap;
      overflow-x: visible;
    }
    .highlight-card {
      flex: 1 1 calc(33.333% - var(--space-4));
      min-width: 260px;
    }
  }

  .section-events {
    min-width: 0;
  }

  /* Events */
  .events-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border-light);
  }

  .events-header-top {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
  }

  .events-title {
    font-size: 1.25rem;
    font-weight: 600;
  }

  .events-count {
    font-size: 0.875rem;
    color: var(--color-muted);
  }

  /* Desktop search bar in events header */
  .events-search-bar {
    display: none;
  }

  @media (min-width: 1200px) {
    .events-search-bar {
      display: block;
      max-width: 400px;
    }
  }

  .events-search-bar .search-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .events-search-bar .search-icon {
    position: absolute;
    left: 12px;
    width: 16px;
    height: 16px;
    color: var(--color-muted);
    pointer-events: none;
  }

  .events-search-bar .search-input {
    width: 100%;
    padding: var(--space-3) var(--space-10) var(--space-3) var(--space-10);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg);
    font-size: 0.875rem;
    color: var(--color-text);
    transition: border-color var(--duration-fast) ease;
  }

  .events-search-bar .search-input:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .events-search-bar .search-input::placeholder {
    color: var(--color-muted);
  }

  .events-search-bar .search-clear {
    position: absolute;
    right: 8px;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    background: none;
    color: var(--color-muted);
    cursor: pointer;
    border-radius: var(--radius-full);
    transition: background var(--duration-fast) ease;
  }

  .events-search-bar .search-clear:hover {
    background: var(--color-bg-secondary);
  }

  .events-search-bar .search-clear svg {
    width: 14px;
    height: 14px;
  }

  .events-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  @media (min-width: 640px) {
    .events-list {
      gap: var(--space-5);
    }
  }

  /* Desktop: scrollable event list with fixed height */
  @media (min-width: 1200px) {
    .events-list {
      max-height: calc(100vh - 160px);
      overflow-y: auto;
      padding-right: var(--space-2);
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    .events-list::-webkit-scrollbar {
      width: 5px;
    }
    .events-list::-webkit-scrollbar-track {
      background: transparent;
    }
    .events-list::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 3px;
    }
    .events-list::-webkit-scrollbar-thumb:hover {
      background: var(--color-muted);
    }
  }

  /* Info Section ‚Äî Mobile version (after events) */
  .section-info--mobile {
    display: block;
    padding-top: var(--space-8);
    margin-top: var(--space-4);
    border-top: 1px solid var(--color-border-light);
  }

  @media (min-width: 1200px) {
    .section-info--mobile {
      display: none;
    }
  }

  /* Info Section ‚Äî Desktop version (after events) */
  .section-info--desktop {
    display: none;
    padding-top: var(--space-8);
    border-top: 1px solid var(--color-border-light);
  }

  @media (min-width: 1200px) {
    .section-info--desktop {
      display: block;
    }
  }

  /* Info Section shared */
  .section-info {

  .section-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .info-grid-single {
    display: grid;
    gap: var(--space-4);
  }

  @media (min-width: 640px) {
    .info-grid-single {
      grid-template-columns: 1fr 1fr;
      gap: var(--space-5);
    }
  }

  /* Footer */
  .footer {
    padding: var(--space-8) 0;
    border-top: 1px solid var(--color-border-light);
    background: var(--color-bg-secondary);
  }

  .footer-text {
    font-size: 0.8125rem;
    color: var(--color-muted);
    text-align: center;
  }

  .footer-links a {
    color: var(--color-muted);
    text-decoration: underline;
    text-decoration-color: transparent;
    transition: text-decoration-color var(--duration-fast) ease;
  }

  .footer-links a:hover {
    text-decoration-color: var(--color-muted);
  }

  /* Load More ‚Äî see <style is:global> below */
</style>

<style is:global>
  #load-more-btn {
    display: block;
    box-sizing: border-box;
    width: 100%;
    margin: var(--space-4) 0 0;
    padding: 16px 24px;
    background: var(--color-border-light);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg, 12px);
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    font-weight: 500;
    font-family: inherit;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #load-more-btn:hover {
    background: var(--color-border);
    color: var(--color-primary);
  }

  #load-more-btn:active {
    transform: scale(0.99);
  }

  #load-more-count {
    opacity: 0.5;
    font-weight: 400;
  }
</style>

<script define:vars={{ artTags }}>
  // Make artTags available globally for modal
  (window as any).__artTagsData = artTags;
</script>

<script>
  // Highlight card click ‚Üí open modal
  document.querySelectorAll('.highlight-card').forEach(card => {
    card.addEventListener('click', () => {
      const el = card as HTMLElement;
      const eventData = {
        id: el.dataset.eventId,
        title: el.dataset.eventTitle,
        date: el.dataset.date,
        time: el.dataset.eventTime,
        location: el.dataset.location,
        address: el.dataset.eventAddress,
        description: el.dataset.eventDescription,
        category: el.dataset.category,
        url: el.dataset.eventUrl,
        tags: el.dataset.artTags?.split(',').filter(Boolean) || [],
        // AI curation data
        aiSummary: el.dataset.aiSummary || '',
        aiBestFor: el.dataset.aiBestFor || '',
        aiScore: parseInt(el.dataset.aiScore || '0'),
        aiPrice: el.dataset.aiPrice || '',
        aiTips: el.dataset.aiTips || '',
        aiAgeRange: el.dataset.aiAgeRange || '',
        aiFamilyScore: parseInt(el.dataset.aiFamilyScore || '0'),
        aiKidsScore: parseInt(el.dataset.aiKidsScore || '0'),
        aiAdultsScore: parseInt(el.dataset.aiAdultsScore || '0'),
      };
      if (typeof (window as any).openEventModal === 'function') {
        (window as any).openEventModal(eventData);
      }
    });
  });

  // Load More functionality (mobile only)
  const BATCH_SIZE = 10;
  const loadMoreBtn = document.getElementById('load-more-btn') as HTMLButtonElement;
  const loadMoreCount = document.getElementById('load-more-count');
  let visibleLimit = 10;
  const isDesktop = () => window.innerWidth >= 1200;

  function applyLoadMoreLimit() {
    if (isDesktop()) {
      loadMoreBtn.style.display = 'none';
      return;
    }

    const cards = document.querySelectorAll('.event-card');
    let visibleCount = 0;
    let hiddenByLimit = 0;

    cards.forEach(card => {
      const el = card as HTMLElement;
      // Only count cards not hidden by filters
      const hiddenByFilter = el.style.display === 'none' && !el.hasAttribute('data-load-more-hidden');
      if (hiddenByFilter) return;

      visibleCount++;
      if (visibleCount > visibleLimit) {
        el.style.display = 'none';
        el.setAttribute('data-load-more-hidden', '');
        hiddenByLimit++;
      } else {
        // Only restore if it was hidden by load-more, not by filter
        if (el.hasAttribute('data-load-more-hidden')) {
          el.style.display = '';
          el.removeAttribute('data-load-more-hidden');
        }
      }
    });

    if (hiddenByLimit === 0) {
      loadMoreBtn.style.display = 'none';
    } else {
      loadMoreBtn.style.display = 'block';
      if (loadMoreCount) loadMoreCount.textContent = `¬∑ ${hiddenByLimit} mehr`;
    }
  }

  loadMoreBtn?.addEventListener('click', () => {
    visibleLimit += BATCH_SIZE;
    // Remove all load-more-hidden attrs first
    document.querySelectorAll('[data-load-more-hidden]').forEach(el => {
      (el as HTMLElement).style.display = '';
      el.removeAttribute('data-load-more-hidden');
    });
    applyLoadMoreLimit();
  });

  // Re-apply after filters change ‚Äî observe the visible-count text
  const countEl = document.getElementById('visible-count');
  if (countEl) {
    const observer = new MutationObserver(() => {
      document.querySelectorAll('[data-load-more-hidden]').forEach(el => {
        (el as HTMLElement).style.display = '';
        el.removeAttribute('data-load-more-hidden');
      });
      applyLoadMoreLimit();
    });
    observer.observe(countEl, { childList: true, characterData: true, subtree: true });
  }

  // Handle resize
  window.addEventListener('resize', () => applyLoadMoreLimit());

  // Initial apply
  applyLoadMoreLimit();
</script>
